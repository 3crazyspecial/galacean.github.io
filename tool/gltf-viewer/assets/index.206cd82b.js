import{G as e,x as t}from"./vendor.1cb6e1fc.js";var n,i,r,a;!function(e=".",t="__import__"){try{self[t]=new Function("u","return import(u)")}catch(n){const i=new URL(e,location),r=e=>{URL.revokeObjectURL(e.src),e.remove()};self[t]=e=>new Promise(((n,a)=>{const o=new URL(e,i);if(self[t].moduleMap[o])return n(self[t].moduleMap[o]);const s=new Blob([`import * as m from '${o}';`,`${t}.moduleMap['${o}']=m;`],{type:"text/javascript"}),c=Object.assign(document.createElement("script"),{type:"module",src:URL.createObjectURL(s),onerror(){a(new Error(`Failed to import: ${e}`)),r(c)},onload(){n(self[t].moduleMap[o]),r(c)}});document.head.appendChild(c)})),self[t].moduleMap={}}}("/tool/gltf-viewer/assets/"),(i=n||(n={}))[i.Disjoint=0]="Disjoint",i[i.Contains=1]="Contains",i[i.Intersects=2]="Intersects",(a=r||(r={}))[a.Back=0]="Back",a[a.Front=1]="Front",a[a.Intersecting=2]="Intersecting";var o=function(){function e(){}return e.clamp=function(e,t,n){return Math.max(t,Math.min(n,e))},e.equals=function(t,n){return Math.abs(t-n)<=e.zeroTolerance},e.isPowerOf2=function(e){return 0==(e&e-1)},e.radianToDegree=function(t){return t*e.radToDegreeFactor},e.degreeToRadian=function(t){return t*e.degreeToRadFactor},e}();o.zeroTolerance=1e-6,o.radToDegreeFactor=180/Math.PI,o.degreeToRadFactor=Math.PI/180;var s=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=void 0,this.y=void 0,this.z=void 0,this.x=e,this.y=t,this.z=n}e.add=function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y,n.z=e.z+t.z},e.subtract=function(e,t,n){n.x=e.x-t.x,n.y=e.y-t.y,n.z=e.z-t.z},e.multiply=function(e,t,n){n.x=e.x*t.x,n.y=e.y*t.y,n.z=e.z*t.z},e.divide=function(e,t,n){n.x=e.x/t.x,n.y=e.y/t.y,n.z=e.z/t.z},e.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},e.cross=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.x,s=t.y,c=t.z;n.x=r*c-a*s,n.y=a*o-i*c,n.z=i*s-r*o},e.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return Math.sqrt(n*n+i*i+r*r)},e.distanceSquared=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return n*n+i*i+r*r},e.equals=function(e,t){return o.equals(e.x,t.x)&&o.equals(e.y,t.y)&&o.equals(e.z,t.z)},e.lerp=function(e,t,n,i){var r=e.x,a=e.y,o=e.z;i.x=r+(t.x-r)*n,i.y=a+(t.y-a)*n,i.z=o+(t.z-o)*n},e.max=function(e,t,n){n.x=Math.max(e.x,t.x),n.y=Math.max(e.y,t.y),n.z=Math.max(e.z,t.z)},e.min=function(e,t,n){n.x=Math.min(e.x,t.x),n.y=Math.min(e.y,t.y),n.z=Math.min(e.z,t.z)},e.negate=function(e,t){t.x=-e.x,t.y=-e.y,t.z=-e.z},e.normalize=function(e,t){var n=e.x,i=e.y,r=e.z,a=Math.sqrt(n*n+i*i+r*r);a>0&&(a=1/a,t.x=n*a,t.y=i*a,t.z=r*a)},e.scale=function(e,t,n){n.x=e.x*t,n.y=e.y*t,n.z=e.z*t},e.transformNormal=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.elements;n.x=i*o[0]+r*o[4]+a*o[8],n.y=i*o[1]+r*o[5]+a*o[9],n.z=i*o[2]+r*o[6]+a*o[10]},e.transformToVec3=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.elements;n.x=i*o[0]+r*o[4]+a*o[8]+o[12],n.y=i*o[1]+r*o[5]+a*o[9]+o[13],n.z=i*o[2]+r*o[6]+a*o[10]+o[14]},e.transformToVec4=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.elements;n.x=i*o[0]+r*o[4]+a*o[8]+o[12],n.y=i*o[1]+r*o[5]+a*o[9]+o[13],n.z=i*o[2]+r*o[6]+a*o[10]+o[14],n.w=i*o[3]+r*o[7]+a*o[11]+o[15]},e.transformCoordinate=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.elements,s=i*o[3]+r*o[7]+a*o[11]+o[15];s=1/s,n.x=(i*o[0]+r*o[4]+a*o[8]+o[12])*s,n.y=(i*o[1]+r*o[5]+a*o[9]+o[13])*s,n.z=(i*o[2]+r*o[6]+a*o[10]+o[14])*s},e.transformByQuat=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.x,s=t.y,c=t.z,l=t.w,u=l*i+s*a-c*r,h=l*r+c*i-o*a,d=l*a+o*r-s*i,f=-o*i-s*r-c*a;n.x=u*l-f*o-h*c+d*s,n.y=h*l-f*s-d*o+u*c,n.z=d*l-f*c-u*s+h*o};var t=e.prototype;return t.setValue=function(e,t,n){return this.x=e,this.y=t,this.z=n,this},t.setValueByArray=function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this},t.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},t.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},t.multiply=function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this},t.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},t.length=function(){var e=this.x,t=this.y,n=this.z;return Math.sqrt(e*e+t*t+n*n)},t.lengthSquared=function(){var e=this.x,t=this.y,n=this.z;return e*e+t*t+n*n},t.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},t.normalize=function(){return e.normalize(this,this),this},t.scale=function(e){return this.x*=e,this.y*=e,this.z*=e,this},t.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z},t.clone=function(){return new e(this.x,this.y,this.z)},t.cloneTo=function(e){return e.x=this.x,e.y=this.y,e.z=this.z,e},t.transformNormal=function(t){return e.transformNormal(this,t,this),this},t.transformToVec3=function(t){return e.transformToVec3(this,t,this),this},t.transformCoordinate=function(t){return e.transformCoordinate(this,t,this),this},t.transformByQuat=function(t){return e.transformByQuat(this,t,this),this},e}();s._zero=new s(0,0,0),s._one=new s(1,1,1),s._tempVector3=new s;var c=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=0),this.center=new s,this.radius=0,e&&e.cloneTo(this.center),this.radius=t}e.fromPoints=function(t,n){if(!t||0===t.length)throw new Error("points must be array and length must > 0");var i=t.length,r=e._tempVec30;r.x=r.y=r.z=0;for(var a=0;a<i;++a)s.add(t[a],r,r);s.scale(r,1/i,n.center);for(var o=0,c=0;c<i;++c){var l=s.distanceSquared(r,t[c]);l>o&&(o=l)}n.radius=Math.sqrt(o)},e.fromBox=function(e,t){var n=t.center,i=e.min,r=e.max;n.x=.5*(i.x+r.x),n.y=.5*(i.y+r.y),n.z=.5*(i.z+r.z),t.radius=s.distance(n,r)};var t=e.prototype;return t.clone=function(){return new e(this.center,this.radius)},t.cloneTo=function(e){return this.center.cloneTo(e.center),e.radius=this.radius,e},e}();c._tempVec30=new s;var l=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this.min=new s,this.max=new s,e&&e.cloneTo(this.min),t&&t.cloneTo(this.max)}e.fromCenterAndExtent=function(e,t,n){s.subtract(e,t,n.min),s.add(e,t,n.max)},e.fromPoints=function(e,t){if(!e||0===e.length)throw new Error("points must be array and length must > 0");var n=t.min,i=t.max;n.x=n.y=n.z=Number.MAX_VALUE,i.x=i.y=i.z=-Number.MAX_VALUE;for(var r=0,a=e.length;r<a;++r){var o=e[r];s.min(n,o,n),s.max(i,o,i)}},e.fromSphere=function(e,t){var n=e.center,i=e.radius,r=t.min,a=t.max;r.x=n.x-i,r.y=n.y-i,r.z=n.z-i,a.x=n.x+i,a.y=n.y+i,a.z=n.z+i},e.transform=function(t,n,i){var r=e._tempVec30,a=e._tempVec31;t.getCenter(r),t.getExtent(a),s.transformCoordinate(r,n,r);var o=a.x,c=a.y,l=a.z,u=n.elements;a.x=Math.abs(o*u[0])+Math.abs(c*u[4])+Math.abs(l*u[8]),a.y=Math.abs(o*u[1])+Math.abs(c*u[5])+Math.abs(l*u[9]),a.z=Math.abs(o*u[2])+Math.abs(c*u[6])+Math.abs(l*u[10]),s.subtract(r,a,i.min),s.add(r,a,i.max)},e.merge=function(e,t,n){return s.min(e.min,t.min,n.min),s.max(e.max,t.max,n.max),n};var t=e.prototype;return t.clone=function(){return new e(this.min,this.max)},t.cloneTo=function(e){return this.min.cloneTo(e.min),this.max.cloneTo(e.max),e},t.getCenter=function(e){return s.add(this.min,this.max,e),s.scale(e,.5,e),e},t.getExtent=function(e){return s.subtract(this.max,this.min,e),s.scale(e,.5,e),e},t.getCorners=function(e){void 0===e&&(e=[]);var t=this.min,n=this.max,i=t.x,r=t.y,a=t.z,o=n.x,c=n.y,l=n.z,u=e.length;if(u<8)for(var h=0,d=8-u;h<d;++h)e[u+h]=new s;return e[0].setValue(i,c,l),e[1].setValue(o,c,l),e[2].setValue(o,r,l),e[3].setValue(i,r,l),e[4].setValue(i,c,a),e[5].setValue(o,c,a),e[6].setValue(o,r,a),e[7].setValue(i,r,a),e},t.transform=function(t){return e.transform(this,t,this),this},e}();l._tempVec30=new s,l._tempVec31=new s;var u=function(){function e(){}return e.distancePlaneAndPoint=function(e,t){return s.dot(e.normal,t)+e.distance},e.intersectsPlaneAndPoint=function(t,n){var i=e.distancePlaneAndPoint(t,n);return i>0?r.Front:i<0?r.Back:r.Intersecting},e.intersectsPlaneAndBox=function(t,n){var i=n.min,a=n.max,o=t.normal,s=e._tempVec30,c=e._tempVec31;return o.x>=0?(s.x=a.x,c.x=i.x):(s.x=i.x,c.x=a.x),o.y>=0?(s.y=a.y,c.y=i.y):(s.y=i.y,c.y=a.y),o.z>=0?(s.z=a.z,c.z=i.z):(s.z=i.z,c.z=a.z),e.distancePlaneAndPoint(t,s)<0?r.Back:e.distancePlaneAndPoint(t,c)>0?r.Front:r.Intersecting},e.intersectsPlaneAndSphere=function(t,n){var i=n.center,a=n.radius,o=e.distancePlaneAndPoint(t,i);return o>a?r.Front:o<-a?r.Back:r.Intersecting},e.intersectsRayAndPlane=function(e,t){var n=t.normal,i=o.zeroTolerance,r=s.dot(n,e.direction);if(Math.abs(r)<i)return-1;var a=s.dot(n,e.origin),c=(-t.distance-a)/r;if(c<0){if(c<-i)return-1;c=0}return c},e.intersectsRayAndBox=function(e,t){var n=o.zeroTolerance,i=e.origin,r=e.direction,a=t.min,s=t.max,c=r.x,l=r.y,u=r.z,h=i.x,d=i.y,f=i.z,_=0,p=Number.MAX_VALUE;if(Math.abs(c)<n){if(h<a.x||h>s.x)return-1}else{var g=1/c,v=(a.x-h)*g,m=(s.x-h)*g;if(v>m){var y=v;v=m,m=y}if((_=Math.max(v,_))>(p=Math.min(m,p)))return-1}if(Math.abs(l)<n){if(d<a.y||d>s.y)return-1}else{var x=1/l,w=(a.y-d)*x,b=(s.y-d)*x;if(w>b){var A=w;w=b,b=A}if((_=Math.max(w,_))>(p=Math.min(b,p)))return-1}if(Math.abs(u)<n){if(f<a.z||f>s.z)return-1}else{var T=1/u,M=(a.z-f)*T,C=(s.z-f)*T;if(M>C){var P=M;M=C,C=P}if((_=Math.max(M,_))>(p=Math.min(C,p)))return-1}return _},e.intersectsRayAndSphere=function(t,n){var i=t.origin,r=t.direction,a=n.center,o=n.radius,c=e._tempVec30;s.subtract(i,a,c);var l=s.dot(c,r),u=s.dot(c,c)-o*o;if(l>0&&u>0)return-1;var h=l*l-u;if(h<0)return-1;var d=-l-Math.sqrt(h);return d<0&&(d=0),d},e.intersectsFrustumAndBox=function(t,n){for(var i=n.min,r=n.max,a=e._tempVec30,o=0;o<6;++o){var c=t.getPlane(o),l=c.normal;if(a.x=l.x>=0?i.x:r.x,a.y=l.y>=0?i.y:r.y,a.z=l.z>=0?i.z:r.z,s.dot(c.normal,a)>-c.distance)return!1}return!0},e.frustumContainsBox=function(t,i){for(var a=i.min,o=i.max,s=e._tempVec30,c=e._tempVec31,l=n.Contains,u=0;u<6;++u){var h=t.getPlane(u),d=h.normal;if(d.x>=0?(s.x=o.x,c.x=a.x):(s.x=a.x,c.x=o.x),d.y>=0?(s.y=o.y,c.y=a.y):(s.y=a.y,c.y=o.y),d.z>=0?(s.z=o.z,c.z=a.z):(s.z=a.z,c.z=o.z),e.intersectsPlaneAndPoint(h,c)===r.Front)return n.Disjoint;e.intersectsPlaneAndPoint(h,s)===r.Front&&(l=n.Intersects)}return l},e.frustumContainsSphere=function(t,i){for(var a=n.Contains,o=0;o<6;++o){var s=t.getPlane(o),c=e.intersectsPlaneAndSphere(s,i);if(c===r.Front)return n.Disjoint;if(c===r.Intersecting){a=n.Intersects;break}}return a},e}();u._tempVec30=new s,u._tempVec31=new s;var h=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=0),this.normal=new s,this.distance=0,e&&e.cloneTo(this.normal),this.distance=t}e.normalize=function(e,t){var n=e.normal,i=1/n.length(),r=t.normal;r.x=n.x*i,r.y=n.y*i,r.z=n.z*i,t.distance=e.distance*i},e.fromPoints=function(e,t,n,i){var r=e.x,a=e.y,o=e.z,s=t.x-r,c=t.y-a,l=t.z-o,u=n.x-r,h=n.y-a,d=n.z-o,f=c*d-l*h,_=l*u-s*d,p=s*h-c*u,g=1/Math.sqrt(f*f+_*_+p*p),v=f*g,m=_*g,y=p*g,x=i.normal;x.x=v,x.y=m,x.z=y,i.distance=-(v*r+m*a+y*o)};var t=e.prototype;return t.normalize=function(){return e.normalize(this,this),this},t.clone=function(){var t=new e;return this.cloneTo(t),t},t.cloneTo=function(e){return this.normal.cloneTo(e.normal),e.distance=this.distance,e},e}(),d=function(){function e(e){void 0===e&&(e=null),this.near=void 0,this.far=void 0,this.left=void 0,this.right=void 0,this.top=void 0,this.bottom=void 0,this.near=new h,this.far=new h,this.left=new h,this.right=new h,this.top=new h,this.bottom=new h,e&&this.calculateFromMatrix(e)}var t=e.prototype;return t.clone=function(){var t=new e;return this.cloneTo(t),t},t.cloneTo=function(e){return this.near.cloneTo(e.near),this.far.cloneTo(e.far),this.left.cloneTo(e.left),this.right.cloneTo(e.right),this.top.cloneTo(e.top),this.bottom.cloneTo(e.bottom),e},t.getPlane=function(e){switch(e){case 0:return this.near;case 1:return this.far;case 2:return this.left;case 3:return this.right;case 4:return this.top;case 5:return this.bottom;default:return null}},t.calculateFromMatrix=function(e){var t=e.elements,n=t[0],i=t[1],r=t[2],a=t[3],o=t[4],s=t[5],c=t[6],l=t[7],u=t[8],h=t[9],d=t[10],f=t[11],_=t[12],p=t[13],g=t[14],v=t[15],m=this.near.normal;m.x=-a-r,m.y=-l-c,m.z=-f-d,this.near.distance=-v-g,this.near.normalize();var y=this.far.normal;y.x=r-a,y.y=c-l,y.z=d-f,this.far.distance=g-v,this.far.normalize();var x=this.left.normal;x.x=-a-n,x.y=-l-o,x.z=-f-u,this.left.distance=-v-_,this.left.normalize();var w=this.right.normal;w.x=n-a,w.y=o-l,w.z=u-f,this.right.distance=_-v,this.right.normalize();var b=this.top.normal;b.x=i-a,b.y=s-l,b.z=h-f,this.top.distance=p-v,this.top.normalize();var A=this.bottom.normal;A.x=-a-i,A.y=-l-s,A.z=-f-h,this.bottom.distance=-v-p,this.bottom.normalize()},t.intersectsBox=function(e){return u.intersectsFrustumAndBox(this,e)},t.intersectsSphere=function(e){return u.frustumContainsSphere(this,e)!==n.Disjoint},e}(),f=function(){function e(e,t,n,i,r,a,o,s,c){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===a&&(a=0),void 0===o&&(o=0),void 0===s&&(s=0),void 0===c&&(c=1),this.elements=new Float32Array(9);var l=this.elements;l[0]=e,l[1]=t,l[2]=n,l[3]=i,l[4]=r,l[5]=a,l[6]=o,l[7]=s,l[8]=c}e.add=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements;a[0]=i[0]+r[0],a[1]=i[1]+r[1],a[2]=i[2]+r[2],a[3]=i[3]+r[3],a[4]=i[4]+r[4],a[5]=i[5]+r[5],a[6]=i[6]+r[6],a[7]=i[7]+r[7],a[8]=i[8]+r[8]},e.subtract=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements;a[0]=i[0]-r[0],a[1]=i[1]-r[1],a[2]=i[2]-r[2],a[3]=i[3]-r[3],a[4]=i[4]-r[4],a[5]=i[5]-r[5],a[6]=i[6]-r[6],a[7]=i[7]-r[7],a[8]=i[8]-r[8]},e.multiply=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,o=i[0],s=i[1],c=i[2],l=i[3],u=i[4],h=i[5],d=i[6],f=i[7],_=i[8],p=r[0],g=r[1],v=r[2],m=r[3],y=r[4],x=r[5],w=r[6],b=r[7],A=r[8];a[0]=o*p+l*g+d*v,a[1]=s*p+u*g+f*v,a[2]=c*p+h*g+_*v,a[3]=o*m+l*y+d*x,a[4]=s*m+u*y+f*x,a[5]=c*m+h*y+_*x,a[6]=o*w+l*b+d*A,a[7]=s*w+u*b+f*A,a[8]=c*w+h*b+_*A},e.equals=function(e,t){var n=e.elements,i=t.elements;return o.equals(n[0],i[0])&&o.equals(n[1],i[1])&&o.equals(n[2],i[2])&&o.equals(n[3],i[3])&&o.equals(n[4],i[4])&&o.equals(n[5],i[5])&&o.equals(n[6],i[6])&&o.equals(n[7],i[7])&&o.equals(n[8],i[8])},e.rotationQuaternion=function(e,t){var n=t.elements,i=e.x,r=e.y,a=e.z,o=e.w,s=i+i,c=r+r,l=a+a,u=i*s,h=r*s,d=r*c,f=a*s,_=a*c,p=a*l,g=o*s,v=o*c,m=o*l;n[0]=1-d-p,n[3]=h-m,n[6]=f+v,n[1]=h+m,n[4]=1-u-p,n[7]=_-g,n[2]=f-v,n[5]=_+g,n[8]=1-u-d},e.scaling=function(e,t){var n=t.elements;n[0]=e.x,n[1]=0,n[2]=0,n[3]=0,n[4]=e.y,n[5]=0,n[6]=0,n[7]=0,n[8]=1},e.translation=function(e,t){var n=t.elements;n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=e.x,n[7]=e.y,n[8]=1},e.invert=function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],o=n[2],s=n[3],c=n[4],l=n[5],u=n[6],h=n[7],d=n[8],f=d*c-l*h,_=-d*s+l*u,p=h*s-c*u,g=r*f+a*_+o*p;g&&(g=1/g,i[0]=f*g,i[1]=(-d*a+o*h)*g,i[2]=(l*a-o*c)*g,i[3]=_*g,i[4]=(d*r-o*u)*g,i[5]=(-l*r+o*s)*g,i[6]=p*g,i[7]=(-h*r+a*u)*g,i[8]=(c*r-a*s)*g)},e.normalMatrix=function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],o=n[2],s=n[3],c=n[4],l=n[5],u=n[6],h=n[7],d=n[8],f=n[9],_=n[10],p=n[11],g=n[12],v=n[13],m=n[14],y=n[15],x=r*l-a*c,w=r*u-o*c,b=r*h-s*c,A=a*u-o*l,T=a*h-s*l,M=o*h-s*u,C=d*v-f*g,P=d*m-_*g,S=d*y-p*g,R=f*m-_*v,E=f*y-p*v,L=_*y-p*m,F=x*L-w*E+b*R+A*S-T*P+M*C;if(!F)return null;F=1/F,i[0]=(l*L-u*E+h*R)*F,i[1]=(u*S-c*L-h*P)*F,i[2]=(c*E-l*S+h*C)*F,i[3]=(o*E-a*L-s*R)*F,i[4]=(r*L-o*S+s*P)*F,i[5]=(a*S-r*E-s*C)*F,i[6]=(v*M-m*T+y*A)*F,i[7]=(m*b-g*M-y*w)*F,i[8]=(g*T-v*b+y*x)*F},e.rotate=function(e,t,n){var i=e.elements,r=n.elements,a=Math.sin(t),o=Math.cos(t),s=i[0],c=i[1],l=i[2],u=i[3],h=i[4],d=i[5],f=i[6],_=i[7],p=i[8];r[0]=o*s+a*u,r[1]=o*c+a*h,r[2]=o*l+a*d,r[3]=o*u-a*s,r[4]=o*h-a*c,r[5]=o*d-a*l,r[6]=f,r[7]=_,r[8]=p},e.scale=function(e,t,n){var i=t.x,r=t.y,a=e.elements,o=n.elements;o[0]=i*a[0],o[1]=i*a[1],o[2]=i*a[2],o[3]=r*a[3],o[4]=r*a[4],o[5]=r*a[5],o[6]=a[6],o[7]=a[7],o[8]=a[8]},e.translate=function(e,t,n){var i=t.x,r=t.y,a=e.elements,o=n.elements,s=a[0],c=a[1],l=a[2],u=a[3],h=a[4],d=a[5],f=a[6],_=a[7],p=a[8];o[0]=s,o[1]=c,o[2]=l,o[3]=u,o[4]=h,o[5]=d,o[6]=i*s+r*u+f,o[7]=i*c+r*h+_,o[8]=i*l+r*d+p},e.transpose=function(e,t){var n=e.elements,i=t.elements;if(t===e){var r=n[1],a=n[2],o=n[5];i[1]=n[3],i[2]=n[6],i[3]=r,i[5]=n[7],i[6]=a,i[7]=o}else i[0]=n[0],i[1]=n[3],i[2]=n[6],i[3]=n[1],i[4]=n[4],i[5]=n[7],i[6]=n[2],i[7]=n[5],i[8]=n[8]};var t=e.prototype;return t.setValue=function(e,t,n,i,r,a,o,s,c){var l=this.elements;return l[0]=e,l[1]=t,l[2]=n,l[3]=i,l[4]=r,l[5]=a,l[6]=o,l[7]=s,l[8]=c,this},t.setValueByArray=function(e,t){void 0===t&&(t=0);for(var n=this.elements,i=0;i<12;i++)n[i]=e[i+t];return this},t.setValueByMatrix=function(e){var t=e.elements,n=this.elements;return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[4],n[4]=t[5],n[5]=t[6],n[6]=t[8],n[7]=t[9],n[8]=t[10],this},t.toArray=function(e,t){void 0===t&&(t=0);var n=this.elements;e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8]},t.clone=function(){var t=this.elements;return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},t.cloneTo=function(e){var t=this.elements,n=e.elements;return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],e},t.add=function(t){return e.add(this,t,this),this},t.subtract=function(t){return e.subtract(this,t,this),this},t.multiply=function(t){return e.multiply(this,t,this),this},t.determinant=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],a=e[4],o=e[5],s=e[6],c=e[7],l=e[8];return t*(l*a-o*c)+n*(-l*r+o*s)+i*(c*r-a*s)},t.identity=function(){var e=this.elements;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this},t.invert=function(){return e.invert(this,this),this},t.rotate=function(t){return e.rotate(this,t,this),this},t.scale=function(t){return e.scale(this,t,this),this},t.translate=function(t){return e.translate(this,t,this),this},t.transpose=function(){return e.transpose(this,this),this},e}(),_=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,this.x=e,this.y=t,this.z=n,this.w=i}e.add=function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y,n.z=e.z+t.z,n.w=e.w+t.w},e.multiply=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w,s=t.x,c=t.y,l=t.z,u=t.w;n.x=i*u+o*s+r*l-a*c,n.y=r*u+o*c+a*s-i*l,n.z=a*u+o*l+i*c-r*s,n.w=o*u-i*s-r*c-a*l},e.conjugate=function(e,t){t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w},e.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},e.equals=function(e,t){return o.equals(e.x,t.x)&&o.equals(e.y,t.y)&&o.equals(e.z,t.z)&&o.equals(e.w,t.w)},e.rotationAxisAngle=function(t,n,i){var r=e._tempVector3;s.normalize(t,r),n*=.5;var a=Math.sin(n);i.x=r.x*a,i.y=r.y*a,i.z=r.z*a,i.w=Math.cos(n)},e.rotationEuler=function(t,n,i,r){e.rotationYawPitchRoll(n,t,i,r)},e.rotationYawPitchRoll=function(e,t,n,i){var r=.5*n,a=.5*t,o=.5*e,s=Math.sin(r),c=Math.cos(r),l=Math.sin(a),u=Math.cos(a),h=Math.sin(o),d=Math.cos(o),f=d*u,_=h*l;i.x=d*l*c+h*u*s,i.y=h*u*c-d*l*s,i.z=f*s-_*c,i.w=f*c+_*s},e.rotationMatrix3x3=function(e,t){var n,i,r=e.elements,a=r[0],o=r[1],s=r[2],c=r[3],l=r[4],u=r[5],h=r[6],d=r[7],f=r[8],_=a+l+f;_>0?(n=Math.sqrt(_+1),t.w=.5*n,n=.5/n,t.x=(u-d)*n,t.y=(h-s)*n,t.z=(o-c)*n):a>=l&&a>=f?(i=.5/(n=Math.sqrt(1+a-l-f)),t.x=.5*n,t.y=(o+c)*i,t.z=(s+h)*i,t.w=(u-d)*i):l>f?(i=.5/(n=Math.sqrt(1+l-a-f)),t.x=(c+o)*i,t.y=.5*n,t.z=(d+u)*i,t.w=(h-s)*i):(i=.5/(n=Math.sqrt(1+f-a-l)),t.x=(s+h)*i,t.y=(u+d)*i,t.z=.5*n,t.w=(o-c)*i)},e.invert=function(e,t){var n=e.x,i=e.y,r=e.z,a=e.w,s=n*n+i*i+r*r+a*a;if(s>o.zeroTolerance){var c=1/s;t.x=-n*c,t.y=-i*c,t.z=-r*c,t.w=a*c}},e.lerp=function(t,n,i,r){var a=1-i;e.dot(t,n)>=0?(r.x=t.x*a+n.x*i,r.y=t.y*a+n.y*i,r.z=t.z*a+n.z*i,r.w=t.w*a+n.w*i):(r.x=t.x*a-n.x*i,r.y=t.y*a-n.y*i,r.z=t.z*a-n.z*i,r.w=t.w*a-n.w*i),r.normalize()},e.slerp=function(e,t,n,i){var r,a,s=e.x,c=e.y,l=e.z,u=e.w,h=t.x,d=t.y,f=t.z,_=t.w,p=s*h+c*d+l*f+u*_;if(p<0&&(p=-p,h=-h,d=-d,f=-f,_=-_),1-p>o.zeroTolerance){var g=Math.acos(p),v=Math.sin(g);r=Math.sin((1-n)*g)/v,a=Math.sin(n*g)/v}else r=1-n,a=n;i.x=r*s+a*h,i.y=r*c+a*d,i.z=r*l+a*f,i.w=r*u+a*_},e.normalize=function(e,t){var n=e.x,i=e.y,r=e.z,a=e.w,s=Math.sqrt(n*n+i*i+r*r+a*a);s>o.zeroTolerance&&(s=1/s,t.x=n*s,t.y=i*s,t.z=r*s,t.w=a*s)},e.rotationX=function(e,t){e*=.5;var n=Math.sin(e),i=Math.cos(e);t.x=n,t.y=0,t.z=0,t.w=i},e.rotationY=function(e,t){e*=.5;var n=Math.sin(e),i=Math.cos(e);t.x=0,t.y=n,t.z=0,t.w=i},e.rotationZ=function(e,t){e*=.5;var n=Math.sin(e),i=Math.cos(e);t.x=0,t.y=0,t.z=n,t.w=i},e.rotateX=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w;t*=.5;var s=Math.sin(t),c=Math.cos(t);n.x=i*c+o*s,n.y=r*c+a*s,n.z=a*c-r*s,n.w=o*c-i*s},e.rotateY=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w;t*=.5;var s=Math.sin(t),c=Math.cos(t);n.x=i*c-a*s,n.y=r*c+o*s,n.z=a*c+i*s,n.w=o*c-r*s},e.rotateZ=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w;t*=.5;var s=Math.sin(t),c=Math.cos(t);n.x=i*c+r*s,n.y=r*c-i*s,n.z=a*c+o*s,n.w=o*c-a*s},e.scale=function(e,t,n){n.x=e.x*t,n.y=e.y*t,n.z=e.z*t,n.w=e.w*t};var t=e.prototype;return t.setValue=function(e,t,n,i){return this.x=e,this.y=t,this.z=n,this.w=i,this},t.setValueByArray=function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this},t.conjugate=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},t.getAxisAngle=function(e){var t=this.x,n=this.y,i=this.z,r=t*t+n*n+i*i;if(r<o.zeroTolerance)return e.x=1,e.y=0,e.z=0,0;var a=1/r;return e.x=this.x*a,e.y=this.y*a,e.z=this.z*a,2*Math.acos(this.w)},t.identity=function(){return this.x=0,this.y=0,this.z=0,this.w=1,this},t.length=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return Math.sqrt(e*e+t*t+n*n+i*i)},t.lengthSquared=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return e*e+t*t+n*n+i*i},t.normalize=function(){return e.normalize(this,this),this},t.toEuler=function(e){this.toYawPitchRoll(e);var t=e.x;return e.x=e.y,e.y=t,e},t.toYawPitchRoll=function(e){var t=this.x,n=this.y,i=this.z,r=this.w,a=t*t,s=n*n,c=i*i,l=t*n,u=i*r,h=i*t,d=n*r,f=n*i,_=t*r;return e.y=Math.asin(2*(_-f)),Math.cos(e.y)>o.zeroTolerance?(e.z=Math.atan2(2*(l+u),1-2*(c+a)),e.x=Math.atan2(2*(h+d),1-2*(s+a))):(e.z=Math.atan2(-2*(l-u),1-2*(s+c)),e.x=0),e},t.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w},t.clone=function(){return new e(this.x,this.y,this.z,this.w)},t.cloneTo=function(e){return e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w,e},t.rotateX=function(t){return e.rotateX(this,t,this),this},t.rotateY=function(t){return e.rotateY(this,t,this),this},t.rotateZ=function(t){return e.rotateZ(this,t,this),this},t.rotationAxisAngle=function(t,n){return e.rotationAxisAngle(t,n,this),this},t.multiply=function(t){return e.multiply(this,t,this),this},t.invert=function(){return e.invert(this,this),this},t.dot=function(t){return e.dot(this,t)},t.lerp=function(t,n){return e.lerp(this,t,n,this),this},e}();_._tempVector3=new s;var p=function(){function e(e,t,n,i,r,a,o,s,c,l,u,h,d,f,_,p){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=1),void 0===o&&(o=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===d&&(d=0),void 0===f&&(f=0),void 0===_&&(_=0),void 0===p&&(p=1),this.elements=new Float32Array(16);var g=this.elements;g[0]=e,g[1]=t,g[2]=n,g[3]=i,g[4]=r,g[5]=a,g[6]=o,g[7]=s,g[8]=c,g[9]=l,g[10]=u,g[11]=h,g[12]=d,g[13]=f,g[14]=_,g[15]=p}e.multiply=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,o=i[0],s=i[1],c=i[2],l=i[3],u=i[4],h=i[5],d=i[6],f=i[7],_=i[8],p=i[9],g=i[10],v=i[11],m=i[12],y=i[13],x=i[14],w=i[15],b=r[0],A=r[1],T=r[2],M=r[3],C=r[4],P=r[5],S=r[6],R=r[7],E=r[8],L=r[9],F=r[10],O=r[11],I=r[12],z=r[13],D=r[14],B=r[15];a[0]=o*b+u*A+_*T+m*M,a[1]=s*b+h*A+p*T+y*M,a[2]=c*b+d*A+g*T+x*M,a[3]=l*b+f*A+v*T+w*M,a[4]=o*C+u*P+_*S+m*R,a[5]=s*C+h*P+p*S+y*R,a[6]=c*C+d*P+g*S+x*R,a[7]=l*C+f*P+v*S+w*R,a[8]=o*E+u*L+_*F+m*O,a[9]=s*E+h*L+p*F+y*O,a[10]=c*E+d*L+g*F+x*O,a[11]=l*E+f*L+v*F+w*O,a[12]=o*I+u*z+_*D+m*B,a[13]=s*I+h*z+p*D+y*B,a[14]=c*I+d*z+g*D+x*B,a[15]=l*I+f*z+v*D+w*B},e.equals=function(e,t){var n=e.elements,i=t.elements;return o.equals(n[0],i[0])&&o.equals(n[1],i[1])&&o.equals(n[2],i[2])&&o.equals(n[3],i[3])&&o.equals(n[4],i[4])&&o.equals(n[5],i[5])&&o.equals(n[6],i[6])&&o.equals(n[7],i[7])&&o.equals(n[8],i[8])&&o.equals(n[9],i[9])&&o.equals(n[10],i[10])&&o.equals(n[11],i[11])&&o.equals(n[12],i[12])&&o.equals(n[13],i[13])&&o.equals(n[14],i[14])&&o.equals(n[15],i[15])},e.rotationQuaternion=function(e,t){var n=t.elements,i=e.x,r=e.y,a=e.z,o=e.w,s=i+i,c=r+r,l=a+a,u=i*s,h=r*s,d=r*c,f=a*s,_=a*c,p=a*l,g=o*s,v=o*c,m=o*l;n[0]=1-d-p,n[1]=h+m,n[2]=f-v,n[3]=0,n[4]=h-m,n[5]=1-u-p,n[6]=_+g,n[7]=0,n[8]=f+v,n[9]=_-g,n[10]=1-u-d,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1},e.rotationAxisAngle=function(e,t,n){var i,r,a,s=n.elements,c=e.x,l=e.y,u=e.z,h=Math.sqrt(c*c+l*l+u*u);Math.abs(h)<o.zeroTolerance||(c*=h=1/h,l*=h,u*=h,i=Math.sin(t),a=1-(r=Math.cos(t)),s[0]=c*c*a+r,s[1]=l*c*a+u*i,s[2]=u*c*a-l*i,s[3]=0,s[4]=c*l*a-u*i,s[5]=l*l*a+r,s[6]=u*l*a+c*i,s[7]=0,s[8]=c*u*a+l*i,s[9]=l*u*a-c*i,s[10]=u*u*a+r,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1)},e.rotationTranslation=function(t,n,i){e.rotationQuaternion(t,i);var r=i.elements;r[12]=n.x,r[13]=n.y,r[14]=n.z},e.affineTransformation=function(e,t,n,i){var r=i.elements,a=t.x,o=t.y,s=t.z,c=t.w,l=a+a,u=o+o,h=s+s,d=a*l,f=a*u,_=a*h,p=o*u,g=o*h,v=s*h,m=c*l,y=c*u,x=c*h,w=e.x,b=e.y,A=e.z;r[0]=(1-(p+v))*w,r[1]=(f+x)*w,r[2]=(_-y)*w,r[3]=0,r[4]=(f-x)*b,r[5]=(1-(d+v))*b,r[6]=(g+m)*b,r[7]=0,r[8]=(_+y)*A,r[9]=(g-m)*A,r[10]=(1-(d+p))*A,r[11]=0,r[12]=n.x,r[13]=n.y,r[14]=n.z,r[15]=1},e.scaling=function(e,t){var n=t.elements;n[0]=e.x,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e.y,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=e.z,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1},e.translation=function(e,t){var n=t.elements;n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=e.x,n[13]=e.y,n[14]=e.z,n[15]=1},e.invert=function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],o=n[2],s=n[3],c=n[4],l=n[5],u=n[6],h=n[7],d=n[8],f=n[9],_=n[10],p=n[11],g=n[12],v=n[13],m=n[14],y=n[15],x=r*l-a*c,w=r*u-o*c,b=r*h-s*c,A=a*u-o*l,T=a*h-s*l,M=o*h-s*u,C=d*v-f*g,P=d*m-_*g,S=d*y-p*g,R=f*m-_*v,E=f*y-p*v,L=_*y-p*m,F=x*L-w*E+b*R+A*S-T*P+M*C;if(!F)return null;F=1/F,i[0]=(l*L-u*E+h*R)*F,i[1]=(o*E-a*L-s*R)*F,i[2]=(v*M-m*T+y*A)*F,i[3]=(_*T-f*M-p*A)*F,i[4]=(u*S-c*L-h*P)*F,i[5]=(r*L-o*S+s*P)*F,i[6]=(m*b-g*M-y*w)*F,i[7]=(d*M-_*b+p*w)*F,i[8]=(c*E-l*S+h*C)*F,i[9]=(a*S-r*E-s*C)*F,i[10]=(g*T-v*b+y*x)*F,i[11]=(f*b-d*T-p*x)*F,i[12]=(l*P-c*R-u*C)*F,i[13]=(r*R-a*P+o*C)*F,i[14]=(v*w-g*A-m*x)*F,i[15]=(d*A-f*w+_*x)*F},e.lookAt=function(t,n,i,r){var a=r.elements,o=e._tempVec30,c=e._tempVec31,l=e._tempVec32;s.subtract(t,n,l),l.normalize(),s.cross(i,l,o),o.normalize(),s.cross(l,o,c),a[0]=o.x,a[1]=c.x,a[2]=l.x,a[3]=0,a[4]=o.y,a[5]=c.y,a[6]=l.y,a[7]=0,a[8]=o.z,a[9]=c.z,a[10]=l.z,a[11]=0,a[12]=-s.dot(o,t),a[13]=-s.dot(c,t),a[14]=-s.dot(l,t),a[15]=1},e.ortho=function(e,t,n,i,r,a,o){var s=o.elements,c=1/(e-t),l=1/(n-i),u=1/(r-a);s[0]=-2*c,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*l,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*u,s[11]=0,s[12]=(e+t)*c,s[13]=(i+n)*l,s[14]=(a+r)*u,s[15]=1},e.perspective=function(e,t,n,i,r){var a=r.elements,o=1/Math.tan(e/2),s=1/(n-i);a[0]=o/t,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=o,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=(i+n)*s,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*i*n*s,a[15]=0},e.rotateAxisAngle=function(e,t,n,i){var r=t.x,a=t.y,s=t.z,c=Math.sqrt(r*r+a*a+s*s);if(!(Math.abs(c)<o.zeroTolerance)){var l,u,h,d=e.elements,f=i.elements;r*=c=1/c,a*=c,s*=c,l=Math.sin(n),h=1-(u=Math.cos(n));var _=d[0],p=d[1],g=d[2],v=d[3],m=d[4],y=d[5],x=d[6],w=d[7],b=d[8],A=d[9],T=d[10],M=d[11],C=r*r*h+u,P=a*r*h+s*l,S=s*r*h-a*l,R=r*a*h-s*l,E=a*a*h+u,L=s*a*h+r*l,F=r*s*h+a*l,O=a*s*h-r*l,I=s*s*h+u;f[0]=_*C+m*P+b*S,f[1]=p*C+y*P+A*S,f[2]=g*C+x*P+T*S,f[3]=v*C+w*P+M*S,f[4]=_*R+m*E+b*L,f[5]=p*R+y*E+A*L,f[6]=g*R+x*E+T*L,f[7]=v*R+w*E+M*L,f[8]=_*F+m*O+b*I,f[9]=p*F+y*O+A*I,f[10]=g*F+x*O+T*I,f[11]=v*F+w*O+M*I,e!==i&&(f[12]=d[12],f[13]=d[13],f[14]=d[14],f[15]=d[15])}},e.scale=function(e,t,n){var i=e.elements,r=n.elements,a=t.x,o=t.y,s=t.z;r[0]=i[0]*a,r[1]=i[1]*a,r[2]=i[2]*a,r[3]=i[3]*a,r[4]=i[4]*o,r[5]=i[5]*o,r[6]=i[6]*o,r[7]=i[7]*o,r[8]=i[8]*s,r[9]=i[9]*s,r[10]=i[10]*s,r[11]=i[11]*s,r[12]=i[12],r[13]=i[13],r[14]=i[14],r[15]=i[15]},e.translate=function(e,t,n){var i=e.elements,r=n.elements,a=t.x,o=t.y,s=t.z;if(e===n)r[12]=i[0]*a+i[4]*o+i[8]*s+i[12],r[13]=i[1]*a+i[5]*o+i[9]*s+i[13],r[14]=i[2]*a+i[6]*o+i[10]*s+i[14],r[15]=i[3]*a+i[7]*o+i[11]*s+i[15];else{var c=i[0],l=i[1],u=i[2],h=i[3],d=i[4],f=i[5],_=i[6],p=i[7],g=i[8],v=i[9],m=i[10],y=i[11];r[0]=c,r[1]=l,r[2]=u,r[3]=h,r[4]=d,r[5]=f,r[6]=_,r[7]=p,r[8]=g,r[9]=v,r[10]=m,r[11]=y,r[12]=c*a+d*o+g*s+i[12],r[13]=l*a+f*o+v*s+i[13],r[14]=u*a+_*o+m*s+i[14],r[15]=h*a+p*o+y*s+i[15]}},e.transpose=function(e,t){var n=e.elements,i=t.elements;if(t===e){var r=n[1],a=n[2],o=n[3],s=n[6],c=n[7],l=n[11];i[1]=n[4],i[2]=n[8],i[3]=n[12],i[4]=r,i[6]=n[9],i[7]=n[13],i[8]=a,i[9]=s,i[11]=n[14],i[12]=o,i[13]=c,i[14]=l}else i[0]=n[0],i[1]=n[4],i[2]=n[8],i[3]=n[12],i[4]=n[1],i[5]=n[5],i[6]=n[9],i[7]=n[13],i[8]=n[2],i[9]=n[6],i[10]=n[10],i[11]=n[14],i[12]=n[3],i[13]=n[7],i[14]=n[11],i[15]=n[15]};var t=e.prototype;return t.setValue=function(e,t,n,i,r,a,o,s,c,l,u,h,d,f,_,p){var g=this.elements;return g[0]=e,g[1]=t,g[2]=n,g[3]=i,g[4]=r,g[5]=a,g[6]=o,g[7]=s,g[8]=c,g[9]=l,g[10]=u,g[11]=h,g[12]=d,g[13]=f,g[14]=_,g[15]=p,this},t.setValueByArray=function(e,t){void 0===t&&(t=0);for(var n=this.elements,i=0;i<16;i++)n[i]=e[i+t];return this},t.toArray=function(e,t){void 0===t&&(t=0);var n=this.elements;e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e[t+9]=n[9],e[t+10]=n[10],e[t+11]=n[11],e[t+12]=n[12],e[t+13]=n[13],e[t+14]=n[14],e[t+15]=n[15]},t.clone=function(){var t=this.elements;return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])},t.cloneTo=function(e){var t=this.elements,n=e.elements;return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],e},t.multiply=function(t){return e.multiply(this,t,this),this},t.determinant=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],a=e[4],o=e[5],s=e[6],c=e[7],l=e[8],u=e[9],h=e[10],d=e[11],f=e[12],_=e[13],p=e[14],g=e[15];return(t*o-n*a)*(h*g-d*p)-(t*s-i*a)*(u*g-d*_)+(t*c-r*a)*(u*p-h*_)+(n*s-i*o)*(l*g-d*f)-(n*c-r*o)*(l*p-h*f)+(i*c-r*s)*(l*_-u*f)},t.decompose=function(t,n,i){var r=e._tempMat30,a=this.elements,s=r.elements,c=a[0],l=a[1],u=a[2],h=a[3],d=a[4],f=a[5],p=a[6],g=a[7],v=a[8],m=a[9],y=a[10],x=a[11];t.x=a[12],t.y=a[13],t.z=a[14];var w=Math.sign(c*l*u*h)<0?-1:1,b=Math.sign(d*f*p*g)<0?-1:1,A=Math.sign(v*m*y*x)<0?-1:1,T=w*Math.sqrt(c*c+l*l+u*u),M=b*Math.sqrt(d*d+f*f+p*p),C=A*Math.sqrt(v*v+m*m+y*y);if(i.x=T,i.y=M,i.z=C,Math.abs(T)<o.zeroTolerance||Math.abs(M)<o.zeroTolerance||Math.abs(C)<o.zeroTolerance)return n.identity(),!1;var P=1/T,S=1/M,R=1/C;return s[0]=c*P,s[1]=l*P,s[2]=u*P,s[3]=d*S,s[4]=f*S,s[5]=p*S,s[6]=v*R,s[7]=m*R,s[8]=y*R,_.rotationMatrix3x3(r,n),!0},t.getRotation=function(e){var t=this.elements,n=t[0]+t[5]+t[10];if(n>o.zeroTolerance){var i=2*Math.sqrt(n+1);e.w=.25*i,e.x=(t[6]-t[9])/i,e.y=(t[8]-t[2])/i,e.z=(t[1]-t[4])/i}else if(t[0]>t[5]&&t[0]>t[10]){var r=2*Math.sqrt(1+t[0]-t[5]-t[10]);e.w=(t[6]-t[9])/r,e.x=.25*r,e.y=(t[1]+t[4])/r,e.z=(t[8]+t[2])/r}else if(t[5]>t[10]){var a=2*Math.sqrt(1+t[5]-t[0]-t[10]);e.w=(t[8]-t[2])/a,e.x=(t[1]+t[4])/a,e.y=.25*a,e.z=(t[6]+t[9])/a}else{var s=2*Math.sqrt(1+t[10]-t[0]-t[5]);e.w=(t[1]-t[4])/s,e.x=(t[8]+t[2])/s,e.y=(t[6]+t[9])/s,e.z=.25*s}return e},t.getScaling=function(e){var t=this.elements,n=t[0],i=t[1],r=t[2],a=t[4],o=t[5],s=t[6],c=t[8],l=t[9],u=t[10];return e.x=Math.sqrt(n*n+i*i+r*r),e.y=Math.sqrt(a*a+o*o+s*s),e.z=Math.sqrt(c*c+l*l+u*u),e},t.getTranslation=function(e){var t=this.elements;return e.x=t[12],e.y=t[13],e.z=t[14],e},t.identity=function(){var e=this.elements;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},t.invert=function(){return e.invert(this,this),this},t.rotateAxisAngle=function(t,n){return e.rotateAxisAngle(this,t,n,this),this},t.scale=function(t){return e.scale(this,t,this),this},t.translate=function(t){return e.translate(this,t,this),this},t.transpose=function(){return e.transpose(this,this),this},e}();p._tempVec30=new s,p._tempVec31=new s,p._tempVec32=new s,p._tempMat30=new f,p._identity=new p(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);var g=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this.origin=new s,this.direction=new s,e&&e.cloneTo(this.origin),t&&t.cloneTo(this.direction)}var t=e.prototype;return t.intersectPlane=function(e){return u.intersectsRayAndPlane(this,e)},t.intersectSphere=function(e){return u.intersectsRayAndSphere(this,e)},t.intersectBox=function(e){return u.intersectsRayAndBox(this,e)},t.getPoint=function(e,t){return s.scale(this.direction,e,t),t.add(this.origin)},e}(),v=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.x=void 0,this.y=void 0,this.x=e,this.y=t}e.add=function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y},e.subtract=function(e,t,n){n.x=e.x-t.x,n.y=e.y-t.y},e.multiply=function(e,t,n){n.x=e.x*t.x,n.y=e.y*t.y},e.divide=function(e,t,n){n.x=e.x/t.x,n.y=e.y/t.y},e.dot=function(e,t){return e.x*t.x+e.y*t.y},e.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)},e.distanceSquared=function(e,t){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i},e.equals=function(e,t){return o.equals(e.x,t.x)&&o.equals(e.y,t.y)},e.lerp=function(e,t,n,i){var r=e.x,a=e.y;i.x=r+(t.x-r)*n,i.y=a+(t.y-a)*n},e.max=function(e,t,n){n.x=Math.max(e.x,t.x),n.y=Math.max(e.y,t.y)},e.min=function(e,t,n){n.x=Math.min(e.x,t.x),n.y=Math.min(e.y,t.y)},e.negate=function(e,t){t.x=-e.x,t.y=-e.y},e.normalize=function(e,t){var n=e.x,i=e.y,r=Math.sqrt(n*n+i*i);r>o.zeroTolerance&&(r=1/r,t.x=n*r,t.y=i*r)},e.scale=function(e,t,n){n.x=e.x*t,n.y=e.y*t};var t=e.prototype;return t.setValue=function(e,t){return this.x=e,this.y=t,this},t.setValueByArray=function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this},t.add=function(e){return this.x+=e.x,this.y+=e.y,this},t.subtract=function(e){return this.x-=e.x,this.y-=e.y,this},t.multiply=function(e){return this.x*=e.x,this.y*=e.y,this},t.divide=function(e){return this.x/=e.x,this.y/=e.y,this},t.length=function(){var e=this.x,t=this.y;return Math.sqrt(e*e+t*t)},t.lengthSquared=function(){var e=this.x,t=this.y;return e*e+t*t},t.negate=function(){return this.x=-this.x,this.y=-this.y,this},t.normalize=function(){return e.normalize(this,this),this},t.scale=function(e){return this.x*=e,this.y*=e,this},t.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y},t.clone=function(){return new e(this.x,this.y)},t.cloneTo=function(e){return e.x=this.x,e.y=this.y,e},e}();v._zero=new v(0,0),v._one=new v(1,1);var m=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,this.x=e,this.y=t,this.z=n,this.w=i}e.add=function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y,n.z=e.z+t.z,n.w=e.w+t.w},e.subtract=function(e,t,n){n.x=e.x-t.x,n.y=e.y-t.y,n.z=e.z-t.z,n.w=e.w-t.w},e.multiply=function(e,t,n){n.x=e.x*t.x,n.y=e.y*t.y,n.z=e.z*t.z,n.w=e.w*t.w},e.divide=function(e,t,n){n.x=e.x/t.x,n.y=e.y/t.y,n.z=e.z/t.z,n.w=e.w/t.w},e.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},e.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return Math.sqrt(n*n+i*i+r*r+a*a)},e.distanceSquared=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return n*n+i*i+r*r+a*a},e.equals=function(e,t){return o.equals(e.x,t.x)&&o.equals(e.y,t.y)&&o.equals(e.z,t.z)&&o.equals(e.w,t.w)},e.lerp=function(e,t,n,i){var r=e.x,a=e.y,o=e.z,s=e.w;i.x=r+(t.x-r)*n,i.y=a+(t.y-a)*n,i.z=o+(t.z-o)*n,i.w=s+(t.w-s)*n},e.max=function(e,t,n){n.x=Math.max(e.x,t.x),n.y=Math.max(e.y,t.y),n.z=Math.max(e.z,t.z),n.w=Math.max(e.w,t.w)},e.min=function(e,t,n){n.x=Math.min(e.x,t.x),n.y=Math.min(e.y,t.y),n.z=Math.min(e.z,t.z),n.w=Math.min(e.w,t.w)},e.negate=function(e,t){t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=-e.w},e.normalize=function(e,t){var n=e.x,i=e.y,r=e.z,a=e.w,s=Math.sqrt(n*n+i*i+r*r+a*a);s>o.zeroTolerance&&(s=1/s,t.x=n*s,t.y=i*s,t.z=r*s,t.w=a*s)},e.scale=function(e,t,n){n.x=e.x*t,n.y=e.y*t,n.z=e.z*t,n.w=e.w*t},e.transform=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w,s=t.elements;n.x=i*s[0]+r*s[4]+a*s[8]+o*s[12],n.y=i*s[1]+r*s[5]+a*s[9]+o*s[13],n.z=i*s[2]+r*s[6]+a*s[10]+o*s[14],n.w=i*s[3]+r*s[7]+a*s[11]+o*s[15]},e.transformByQuat=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w,s=t.x,c=t.y,l=t.z,u=t.w,h=u*i+c*a-l*r,d=u*r+l*i-s*a,f=u*a+s*r-c*i,_=-s*i-c*r-l*a;n.x=h*u-_*s-d*l+f*c,n.y=d*u-_*c-f*s+h*l,n.z=f*u-_*l-h*c+d*s,n.w=o};var t=e.prototype;return t.setValue=function(e,t,n,i){return this.x=e,this.y=t,this.z=n,this.w=i,this},t.setValueByArray=function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this},t.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},t.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},t.multiply=function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},t.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this},t.length=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return Math.sqrt(e*e+t*t+n*n+i*i)},t.lengthSquared=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return e*e+t*t+n*n+i*i},t.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},t.normalize=function(){return e.normalize(this,this),this},t.scale=function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},t.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w},t.clone=function(){return new e(this.x,this.y,this.z,this.w)},t.cloneTo=function(e){return e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w,e},e}();m._zero=new m(0,0,0,0),m._one=new m(1,1,1,1);var y,x,w=function(){function e(e,t,n,i){void 0===e&&(e=1),void 0===t&&(t=1),void 0===n&&(n=1),void 0===i&&(i=1),this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0,this.r=e,this.g=t,this.b=n,this.a=i}e.gammaToLinearSpace=function(e){return e<=0?0:e<=.04045?e/12.92:e<1?Math.pow((e+.055)/1.055,2.4):Math.pow(e,2.4)},e.linearToGammaSpace=function(e){return e<=0?0:e<.0031308?12.92*e:e<1?1.055*Math.pow(e,.41666)-.055:Math.pow(e,.41666)},e.equals=function(e,t){return o.equals(e.r,t.r)&&o.equals(e.g,t.g)&&o.equals(e.b,t.b)&&o.equals(e.a,t.a)};var t=e.prototype;return t.setValue=function(e,t,n,i){return this.r=e,this.g=t,this.b=n,this.a=i,this},t.clone=function(){return new e(this.r,this.g,this.b,this.a)},t.cloneTo=function(e){return e.r=this.r,e.g=this.g,e.b=this.b,e.a=this.a,e},t.toLinear=function(t){return t.r=e.gammaToLinearSpace(this.r),t.g=e.gammaToLinearSpace(this.g),t.b=e.gammaToLinearSpace(this.b),t},t.toGamma=function(t){return t.r=e.linearToGammaSpace(this.r),t.g=e.linearToGammaSpace(this.g),t.b=e.linearToGammaSpace(this.b),t},e}(),b=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.width=void 0,this.height=void 0,this.x=e,this.y=t,this.width=n,this.height=i}var t=e.prototype;return t.setValue=function(e,t,n,i){return this.x=e,this.y=t,this.width=n,this.height=i,this},t.clone=function(){return new e(this.x,this.y,this.width,this.height)},t.cloneTo=function(e){return e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e},e}();function A(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function T(e,t,n){return t&&A(e.prototype,t),n&&A(e,n),e}function M(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function C(){return(C=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function P(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function S(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?P(Object(n),!0).forEach((function(t){M(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):P(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function R(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,L(e,t)}function E(e){return(E=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function L(e,t){return(L=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function F(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function O(e,t,n){return(O=F()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&L(r,n.prototype),r}).apply(null,arguments)}function I(e){var t="function"==typeof Map?new Map:void 0;return(I=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return O(e,arguments,E(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),L(i,e)})(e)}function z(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function D(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function B(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return D(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?D(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function N(e,t,n,i){n&&Object.defineProperty(e,t,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function U(e,t,n,i,r){var a={};return Object.keys(i).forEach((function(e){a[e]=i[e]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=n.slice().reverse().reduce((function(n,i){return i(e,t,n)||n}),a),r&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}(x=y||(y={}))[x.Success=0]="Success",x[x.Pending=1]="Pending",x[x.Failed=2]="Failed";var G=function(e){R(n,e),n.all=function(e){return new n((function(t,n,i){if(!Array.isArray(e))return t([e]);var r=0,a=e.length,o=new Array(a);e.forEach((function(e,s){Promise.resolve(e).then((function(e){o[s]=e,i((r+=1)/a),r==a&&t(o)})).catch((function(e){return n(e)}))}))}))};var t=n.prototype;function n(t){var n,i,r=function(e){if(!(e<=n._progress)){n._progress=e;for(var t,i=B(n._listeners);!(t=i()).done;){(0,t.value)(e)}}};return(n=e.call(this,(function(e,a){t((function(t){Promise.resolve().then((function(){r(1),n._status=y.Success,e(t)}))}),i=function(e){Promise.resolve().then((function(){n._status=y.Failed,a(e)}))},(function(e){Promise.resolve().then((function(){r(e)}))}))}))||this)._status=void 0,n._progress=void 0,n._reject=void 0,n._listeners=void 0,n._reject=i,n._listeners=new Set,n._progress=0,n._status=y.Pending,n}return t.onProgress=function(e){return this._listeners.add(e),this},t.cancel=function(){return this._status!==y.Pending||this._reject("Promise Canceled"),this},T(n,[{key:"status",get:function(){return this._status}},{key:"progress",get:function(){return this._progress}}]),n}(I(Promise));function k(e){return Object.keys(e).map((function(t){return e[t]}))}var V=function(){function e(e){this.engine=e,this.retryCount=1,this.retryInterval=0,this.timeout=2e4,this._assetPool=Object.create(null),this._assetUrlPool=Object.create(null),this._refObjectPool=Object.create(null),this._loadingPromises={}}e._addLoader=function(e,t,n){this._loaders[e]=t;for(var i=0,r=n.length;i<r;i++)this._extTypeMapping[n[i]]=e},e._getTypeByUrl=function(e){var t=e.split("?")[0];return this._extTypeMapping[t.substring(t.lastIndexOf(".")+1)]};var t=e.prototype;return t.load=function(e){var t=this;if(!Array.isArray(e))return this._loadSingleItem(e);var n=e.map((function(e){return t._loadSingleItem(e)}));return G.all(n)},t.cancelNotLoaded=function(e){var t=this;if(e)if("string"==typeof e){var n;null===(n=this._loadingPromises[e])||void 0===n||n.cancel()}else e.forEach((function(e){var n;null===(n=t._loadingPromises[e])||void 0===n||n.cancel()}));else k(this._loadingPromises).forEach((function(e){e.cancel()}))},t.gc=function(){for(var e=k(this._refObjectPool),t=0,n=e.length;t<n;t++)e[t].isGCIgnored||e[t].destroy()},t.getAssetPath=function(e){return this._assetPool[e]},t._addAsset=function(e,t){this._assetPool[t.instanceId]=e,this._assetUrlPool[e]=t},t._deleteAsset=function(e){var t=e.instanceId,n=this._assetPool[t];n&&(delete this._assetPool[t],delete this._assetUrlPool[n])},t._addRefObject=function(e,t){this._refObjectPool[e]=t},t._deleteRefObject=function(e){delete this._refObjectPool[e]},t._assignDefaultOptions=function(t){var n,i,r,a,o;if(t.type=null!=(n=t.type)?n:e._getTypeByUrl(t.url),void 0===t.type)throw"asset type should be specified: "+t.url;return t.retryCount=null!=(i=t.retryCount)?i:this.retryCount,t.timeout=null!=(r=t.timeout)?r:this.timeout,t.retryInterval=null!=(a=t.retryInterval)?a:this.retryInterval,t.url=null!=(o=t.url)?o:t.urls.join(","),t},t._loadSingleItem=function(t){var n=this,i=this._assignDefaultOptions("string"==typeof t?{url:t}:t),r=i.url;if(this._assetUrlPool[r])return new G((function(e){e(n._assetUrlPool[r])}));if(this._loadingPromises[r])return this._loadingPromises[i.url];var a=e._loaders[i.type],o=a.load(i,this);return this._loadingPromises[r]=o,o.then((function(e){a.useCache&&n._addAsset(r,e),delete n._loadingPromises[r]})).catch((function(){})),o},e}();function H(e,t,n){return void 0===n&&(n=!0),function(i){var r=new i(n);V._addLoader(e,r,t)}}V._loaders={},V._extTypeMapping={};var j,W,X=function(){function e(e,t,n,i){void 0===t&&(t=null),void 0===n&&(n={}),void 0===i&&(i=!0),this.data=void 0,this._timeStamp=void 0,this._target=void 0,this._currentTarget=void 0,this._bubbles=void 0,this._propagationStopped=void 0,this._type=void 0,this._timeStamp=(new Date).getTime(),this._target=t,this.data=n,this._currentTarget=null,this._bubbles=i,this._propagationStopped=!1,this._type=e}return e.prototype.stopPropagation=function(){this._propagationStopped=!0},T(e,[{key:"propagationStopped",get:function(){return this._propagationStopped}},{key:"target",get:function(){return this._target},set:function(e){this._target=e}},{key:"timeStamp",get:function(){return this._timeStamp}},{key:"currentTarget",get:function(){return this._currentTarget},set:function(e){this._currentTarget=e}},{key:"bubbles",get:function(){return this._bubbles}},{key:"type",get:function(){return this._type}}]),e}();function K(e,t){ne.registerCloneMode(e,t,j.Ignore)}function q(e,t){ne.registerCloneMode(e,t,j.Assignment)}function Y(e,t){ne.registerCloneMode(e,t,j.Shallow)}function Q(e,t){ne.registerCloneMode(e,t,j.Deep)}(W=j||(j={}))[W.Ignore=0]="Ignore",W[W.Assignment=1]="Assignment",W[W.Shallow=2]="Shallow",W[W.Deep=3]="Deep";var Z,J,$,ee,te,ne=function(){function e(){}return e.registerCloneMode=function(t,n,i){var r=e._subCloneModeMap.get(t.constructor);r||(r=Object.create(null),e._subCloneModeMap.set(t.constructor,r)),r[n]=i},e.getCloneMode=function(t){var n=e._cloneModeMap.get(t);if(!n){n=Object.create(null),e._cloneModeMap.set(t,n);for(var i=e._obejctType,r=e._subCloneModeMap;t!==i;){var a=r.get(t);a&&C(n,a),t=Object.getPrototypeOf(t)}}return n},e.deepCloneObject=function(t,n){switch(t.constructor){case Uint8Array:case Uint16Array:case Uint32Array:case Int8Array:case Int16Array:case Int32Array:case Float32Array:case Float64Array:n.set(t);break;case Array:for(var i=0,r=t.length;i<r;i++)e._deepCloneObjectItem(t,n,i);break;default:var a=t;if(a.clone&&a.cloneTo)a.cloneTo(n);else for(var o=Object.keys(t),s=0,c=o.length;s<c;s++)e._deepCloneObjectItem(t,n,o[s])}},e._deepCloneObjectItem=function(t,n,i){var r=t[i];if(r instanceof Object)switch(r.constructor){case Uint8Array:case Uint16Array:case Uint32Array:case Int8Array:case Int16Array:case Int32Array:case Float32Array:case Float64Array:var a=r,o=n[i];null==o?n[i]=a.slice():o.set(a);break;case Array:var s=r,c=n[i];null==c?n[i]=new Array(s.length):c.length=s.length,e.deepCloneObject(s,c);break;default:if(!r.clone||!r.cloneTo){var l=n[i];null==l&&(n[i]=l=new r.constructor),e.deepCloneObject(r,l);break}var u=r,h=n[i];h?u.cloneTo(h):n[i]=u.clone()}else n[i]=r},e}();ne._subCloneModeMap=new Map,ne._cloneModeMap=new Map,ne._obejctType=Object.getPrototypeOf(Object);var ie,re,ae,oe,se,ce,le,ue,he=(te=ee=function(e){N(this,"instanceId",J,this),N(this,"_engine",$,this),this._engine=e},ee._instanceIdCounter=0,J=U((Z=te).prototype,"instanceId",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return++he._instanceIdCounter}}),$=U(Z.prototype,"_engine",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Z),de=(re=U((ie=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return N(t=e.call.apply(e,[this].concat(i))||this,"_evts",re,z(t)),t._evtCount=0,t}R(t,e);var n=t.prototype;return n.hasEvent=function(e){return null!=this._evts[e]},n.eventNames=function(){return 0===this._evtCount?[]:Object.keys(this._evts)},n.listenerCount=function(e){var t=this._evts[e];return t?t.fn?1:t.length:0},n.dispatch=function(e,t){if(!this._evts[e])return!1;var n=this._evts[e];if(n.fn)n.once&&this.removeEventListener(e,n.fn),n.fn(t);else for(var i=n.length,r=0;r<i;r++)n[r].once&&this.removeEventListener(e,n[r].fn),n[r].fn(t);return!0},n.on=function(e,t){return this.addEventListener(e,t)},n.once=function(e,t){return this.addEventListener(e,t,!0)},n.addEventListener=function(e,t,n){var i={fn:t,once:n},r=this._evts;return r[e]?r[e].fn?r[e]=[r[e],i]:r[e].push(i):(r[e]=i,this._evtCount++),this},n.off=function(e,t){if(!this._evts[e])return this;if(!t)return this._clearEvent(e),this;var n=this._evts[e];if(n.fn&&n.fn===t)this._clearEvent(e);else{var i=n.indexOf(t);if(i>-1){var r=n[n.length-1];n[i]=r,n.length--,1===n.length&&(this._evts[e]=n[0])}}return this},n.removeEventListener=function(e,t){return this.off(e,t)},n.removeAllEventListeners=function(e){e?this._evts[e]&&this._clearEvent(e):(this._evts=Object.create(null),this._evtCount=0)},n.trigger=function(e){this.dispatch(e.type,e.data)},n._clearEvent=function(e){0==--this._evtCount?this._evts=Object.create(null):delete this._evts[e]},t}(he)).prototype,"_evts",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Object.create(null)}}),ie),fe=function(e){},_e=console.log.bind(console),pe=console.info.bind(console),ge=console.warn.bind(console),ve=console.error.bind(console),me={debug:fe,info:fe,warn:fe,error:fe,isEnabled:!1,enable:function(){this.debug=_e,this.info=pe,this.warn=ge,this.error=ve,this.isEnabled=!0},disable:function(){this.debug=fe,this.info=fe,this.warn=fe,this.error=fe,this.isEnabled=!1}},ye=function(){function e(){this._clock=void 0,this._timeScale=void 0,this._deltaTime=void 0,this._startTime=void 0,this._lastTickTime=void 0,this._clock=performance||Date,this._timeScale=1,this._deltaTime=1e-4;var e=this._clock.now();this._startTime=e,this._lastTickTime=e}var t=e.prototype;return t.reset=function(){this._lastTickTime=this._clock.now()},t.tick=function(){var e=this.nowTime;this._deltaTime=(e-this._lastTickTime)*this._timeScale,this._lastTickTime=e},T(e,[{key:"nowTime",get:function(){return this._clock.now()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"timeScale",get:function(){return this._timeScale},set:function(e){this._timeScale=e}},{key:"unscaledDeltaTime",get:function(){return this._deltaTime/this._timeScale}},{key:"timeSinceStartup",get:function(){return this.nowTime-this._startTime}}]),e}();(oe=ae||(ae={}))[oe.DONT_CLEAR=0]="DONT_CLEAR",oe[oe.SOLID_COLOR=1]="SOLID_COLOR",oe[oe.DEPTH_ONLY=2]="DEPTH_ONLY",oe[oe.COLOR_ONLY=3]="COLOR_ONLY",oe[oe.STENCIL_ONLY=4]="STENCIL_ONLY",oe[oe.ALL_CLEAR=5]="ALL_CLEAR",(ce=se||(se={}))[ce.FLOAT=5126]="FLOAT",ce[ce.FLOAT_VEC2=35664]="FLOAT_VEC2",ce[ce.FLOAT_VEC3=35665]="FLOAT_VEC3",ce[ce.FLOAT_VEC4=35666]="FLOAT_VEC4",ce[ce.INT=5124]="INT",ce[ce.INT_VEC2=35667]="INT_VEC2",ce[ce.INT_VEC3=35668]="INT_VEC3",ce[ce.INT_VEC4=35669]="INT_VEC4",ce[ce.BOOL=35670]="BOOL",ce[ce.BOOL_VEC2=35671]="BOOL_VEC2",ce[ce.BOOL_VEC3=35672]="BOOL_VEC3",ce[ce.BOOL_VEC4=35673]="BOOL_VEC4",ce[ce.FLOAT_MAT2=35674]="FLOAT_MAT2",ce[ce.FLOAT_MAT3=35675]="FLOAT_MAT3",ce[ce.FLOAT_MAT4=35676]="FLOAT_MAT4",ce[ce.FLOAT_ARRAY=35677]="FLOAT_ARRAY",ce[ce.FLOAT_VEC2_ARRAY=1e5]="FLOAT_VEC2_ARRAY",ce[ce.FLOAT_VEC3_ARRAY=100001]="FLOAT_VEC3_ARRAY",ce[ce.FLOAT_VEC4_ARRAY=100002]="FLOAT_VEC4_ARRAY",ce[ce.INT_ARRAY=100003]="INT_ARRAY",ce[ce.INT_VEC2_ARRAY=100004]="INT_VEC2_ARRAY",ce[ce.INT_VEC3_ARRAY=100005]="INT_VEC3_ARRAY",ce[ce.INT_VEC4_ARRAY=100006]="INT_VEC4_ARRAY",ce[ce.FLOAT_MAT2_ARRAY=100007]="FLOAT_MAT2_ARRAY",ce[ce.FLOAT_MAT3_ARRAY=100008]="FLOAT_MAT3_ARRAY",ce[ce.FLOAT_MAT4_ARRAY=100009]="FLOAT_MAT4_ARRAY",ce[ce.SAMPLER_2D_ARRAY=100010]="SAMPLER_2D_ARRAY",ce[ce.SAMPLER_CUBE_ARRAY=100011]="SAMPLER_CUBE_ARRAY",ce[ce.SAMPLER_2D=35678]="SAMPLER_2D",ce[ce.SAMPLER_CUBE=35680]="SAMPLER_CUBE",ce[ce.BYTE=5120]="BYTE",ce[ce.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",ce[ce.SHORT=5122]="SHORT",ce[ce.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",ce[ce.UNSIGNED_INT=5125]="UNSIGNED_INT",(ue=le||(le={})).standardDerivatives="OES_standard_derivatives",ue.shaderTextureLod="EXT_shader_texture_lod",ue.elementIndexUint="OES_element_index_uint",ue.depthTexture="WEBGL_depth_texture",ue.drawBuffers="WEBGL_draw_buffers",ue.vertexArrayObject="OES_vertex_array_object",ue.instancedArrays="ANGLE_instanced_arrays",ue.multipleSample="multipleSampleOnlySupportedInWebGL2",ue.textureFloat="OES_texture_float",ue.textureFloatLinear="OES_texture_float_linear",ue.textureHalfFloat="OES_texture_half_float",ue.textureHalfFloatLinear="OES_texture_half_float_linear",ue.WEBGL_colorBufferFloat="WEBGL_color_buffer_float",ue.colorBufferFloat="EXT_color_buffer_float",ue.colorBufferHalfFloat="EXT_color_buffer_half_float",ue.textureFilterAnisotropic="EXT_texture_filter_anisotropic",ue.blendMinMax="EXT_blend_minmax",ue.astc="WEBGL_compressed_texture_astc",ue.astc_webkit="WEBKIT_WEBGL_compressed_texture_astc",ue.etc="WEBGL_compressed_texture_etc",ue.etc_webkit="WEBKIT_WEBGL_compressed_texture_etc",ue.etc1="WEBGL_compressed_texture_etc1",ue.etc1_webkit="WEBKIT_WEBGL_compressed_texture_etc1",ue.pvrtc="WEBGL_compressed_texture_pvrtc",ue.pvrtc_webkit="WEBKIT_WEBGL_compressed_texture_pvrtc",ue.s3tc="WEBGL_compressed_texture_s3tc",ue.s3tc_webkit="WEBKIT_WEBGL_compressed_texture_s3tc";var xe=function(){function e(e){void 0===e&&(e=0),this._elements=void 0,this.length=0,this._elements=new Array(e)}var t=e.prototype;return t.add=function(e){this.length===this._elements.length?this._elements.push(e):this._elements[this.length]=e,this.length++},t.delete=function(e){var t=this._elements.indexOf(e);this.deleteByIndex(t)},t.deleteByIndex=function(e){var t=this._elements,n=null,i=this.length-1;return e!==i&&(n=t[i],t[e]=n),this.length--,n},t.garbageCollection=function(){this._elements.length=this.length},e}(),we=function(){function e(){this._mask=[],this._length=0}e.unionCollection=function(e,t,n){var i,r,a,o,s=n._mask;e._length<t._length?(i=e._length,r=t._length,a=e._mask,o=t._mask):(i=t._length,r=e._length,a=t._mask,o=e._mask);var c=0;for(s.length<r&&(s.length=r);c<i;c++)s[c]=a[c]|o[c];for(;c<r;c++)s[c]=o[c];n._length=r};var t=e.prototype;return t.enable=function(e){var t=e._index,n=t+1,i=this._mask,r=this._length;if(r<n){for(i.length<n&&(i.length=n);r<t;r++)i[r]=0;i[t]=e._value,this._length=n}else i[t]|=e._value},t.disable=function(e){var t=e._index,n=this._mask,i=this._length-1;if(!(t>i)){var r=n[t]&~e._value;t==i&&0===r?this._length--:n[t]=r}},t.unionCollection=function(e){var t=e._mask,n=e._length,i=this._mask,r=this._length;if(r<n){i.length<n&&(i.length=n);for(var a=0;a<r;a++)i[a]|=t[a];for(;a<n;a++)i[a]=t[a];this._length=n}else for(var o=0;o<n;o++)i[o]|=t[o]},t.complementaryCollection=function(e){for(var t=e._mask,n=this._mask,i=this._length-1,r=Math.min(e._length-1,i);r>=0;r--){var a=n[r]&~t[r];r==i&&0===a?(i--,this._length--):n[r]=a}},t.intersectionCollection=function(e){for(var t=e._mask,n=this._mask,i=this._length-1;i>=0;i--){var r=n[i]&t[i];0==r&&i==this._length-1?this._length--:n[i]=r}},t.isEnable=function(e){var t=e._index;return!(t>=this._length)&&0!=(this._mask[t]&e._value)},t.clear=function(){this._length=0},e}(),be=function(){function e(){this._onStartScripts=new xe,this._onUpdateScripts=new xe,this._onLateUpdateScripts=new xe,this._destoryComponents=[],this._onUpdateAnimations=new xe,this._renderers=new xe,this._onUpdateRenderers=new xe,this._componentsContainerPool=[]}var t=e.prototype;return t.addRenderer=function(e){e._rendererIndex=this._renderers.length,this._renderers.add(e)},t.removeRenderer=function(e){var t=this._renderers.deleteByIndex(e._rendererIndex);t&&(t._rendererIndex=e._rendererIndex),e._rendererIndex=-1},t.addOnStartScript=function(e){e._onStartIndex=this._onStartScripts.length,this._onStartScripts.add(e)},t.removeOnStartScript=function(e){var t=this._onStartScripts.deleteByIndex(e._onStartIndex);t&&(t._onStartIndex=e._onStartIndex),e._onStartIndex=-1},t.addOnUpdateScript=function(e){e._onUpdateIndex=this._onUpdateScripts.length,this._onUpdateScripts.add(e)},t.removeOnUpdateScript=function(e){var t=this._onUpdateScripts.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1},t.addOnLateUpdateScript=function(e){e._onLateUpdateIndex=this._onLateUpdateScripts.length,this._onLateUpdateScripts.add(e)},t.removeOnLateUpdateScript=function(e){var t=this._onLateUpdateScripts.deleteByIndex(e._onLateUpdateIndex);t&&(t._onLateUpdateIndex=e._onLateUpdateIndex),e._onLateUpdateIndex=-1},t.addOnUpdateAnimations=function(e){e._onUpdateIndex=this._onUpdateAnimations.length,this._onUpdateAnimations.add(e)},t.removeOnUpdateAnimations=function(e){var t=this._onUpdateAnimations.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1},t.addOnUpdateRenderers=function(e){e._onUpdateIndex=this._onUpdateRenderers.length,this._onUpdateRenderers.add(e)},t.removeOnUpdateRenderers=function(e){var t=this._onUpdateRenderers.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1},t.addDestoryComponent=function(e){this._destoryComponents.push(e)},t.callScriptOnStart=function(){var e=this._onStartScripts;if(e.length>0){for(var t=e._elements,n=0;n<e.length;n++){var i=t[n];i._started=!0,i._onStartIndex=-1,i.onStart()}e.length=0}},t.callScriptOnUpdate=function(e){for(var t=this._onUpdateScripts._elements,n=this._onUpdateScripts.length-1;n>=0;--n){var i=t[n];i._started&&i.onUpdate(e)}},t.callScriptOnLateUpdate=function(e){for(var t=this._onLateUpdateScripts._elements,n=this._onLateUpdateScripts.length-1;n>=0;--n){var i=t[n];i._started&&i.onLateUpdate(e)}},t.callAnimationUpdate=function(e){for(var t=this._onUpdateAnimations._elements,n=this._onUpdateAnimations.length-1;n>=0;--n)t[n].update(e)},t.callRendererOnUpdate=function(e){for(var t=this._onUpdateRenderers._elements,n=this._onUpdateRenderers.length-1;n>=0;--n)t[n].update(e)},t.callRender=function(t){for(var n=t._camera,i=this._renderers._elements,r=this._renderers.length-1;r>=0;--r){var a=i[r];n.cullingMask&a._entity.layer&&(n.enableFrustumCulling&&(a.isCulled=!n._frustum.intersectsBox(a.bounds),a.isCulled)||(a._distanceForSort=s.distanceSquared(a.bounds.getCenter(e._tempVector),n.entity.transform.worldPosition),a._updateShaderData(t),we.unionCollection(n._globalShaderMacro,a.shaderData._macroCollection,a._globalShaderMacro),a._render(n)))}},t.callComponentDestory=function(){var e=this._destoryComponents,t=e.length;if(t>0){for(var n=t-1;n>=0;--n)e[n].onDestroy();e.length=0}},t.callCameraOnBeginRender=function(e){for(var t=e.entity._components,n=t.length-1;n>=0;--n){var i=t[n];i.onBeginRender&&i.onBeginRender(e)}},t.callCameraOnEndRender=function(e){for(var t=e.entity._components,n=t.length-1;n>=0;--n){var i=t[n];i.onBeginRender&&i.onEndRender(e)}},t.getActiveChangedTempList=function(){return this._componentsContainerPool.length?this._componentsContainerPool.pop():[]},t.putActiveChangedTempList=function(e){e.length=0,this._componentsContainerPool.push(e)},e}();be._tempVector=new s;var Ae,Te,Me,Ce,Pe,Se,Re,Ee=function(){function e(){}return e.cloneComponent=function(e,t){for(var n=ne.getCloneMode(e.constructor),i=Object.keys(e),r=0,a=i.length;r<a;r++){var o=i[r];switch(n[o]){case void 0:case j.Assignment:t[o]=e[o];break;case j.Shallow:var s=e[o];if(s instanceof Object){var c=t[o];null==c&&(c=t[o]=s.constructor()),C(c,s)}else t[o]=s;break;case j.Deep:var l=e[o];if(l instanceof Object){var u=t[o];null==u&&(u=t[o]=l.constructor()),ne.deepCloneObject(l,u)}else t[o]=l}}e._cloneTo&&e._cloneTo(t)},e}(),Le=function(){function e(){}return e.register=function(e,t){this._addDependency(e,t,this._dependenciesMap),this._addDependency(t,e,this._invDependenciesMap)},e._addCheck=function(t,n){var i=e._dependenciesMap.get(n);if(i)for(var r=0,a=i.length;r<a;r++)if(!t.getComponent(i[r]))throw"you should add "+i[r]+" before adding "+n},e._removeCheck=function(t,n){var i=e._invDependenciesMap.get(n);if(i)for(var r=0,a=i.length;r<a;r++)if(t.getComponent(i[r]))throw"you should remove "+i[r]+" before adding "+n},e._addDependency=function(e,t,n){var i=n.get(e);i||(i=[],n.set(e,i)),-1===i.indexOf(t)&&i.push(t)},e}();Le._dependenciesMap=new Map,Le._invDependenciesMap=new Map,(Te=Ae||(Ae={}))[Te.Layer0=1]="Layer0",Te[Te.Layer1=2]="Layer1",Te[Te.Layer2=4]="Layer2",Te[Te.Layer3=8]="Layer3",Te[Te.Layer4=16]="Layer4",Te[Te.Layer5=32]="Layer5",Te[Te.Layer6=64]="Layer6",Te[Te.Layer7=128]="Layer7",Te[Te.Layer8=256]="Layer8",Te[Te.Layer9=512]="Layer9",Te[Te.Layer10=1024]="Layer10",Te[Te.Layer11=2048]="Layer11",Te[Te.Layer12=4096]="Layer12",Te[Te.Layer13=8192]="Layer13",Te[Te.Layer14=16384]="Layer14",Te[Te.Layer15=32768]="Layer15",Te[Te.Layer16=65536]="Layer16",Te[Te.Layer17=131072]="Layer17",Te[Te.Layer18=262144]="Layer18",Te[Te.Layer19=524288]="Layer19",Te[Te.Layer20=1048576]="Layer20",Te[Te.Layer21=2097152]="Layer21",Te[Te.Layer22=4194304]="Layer22",Te[Te.Layer23=8388608]="Layer23",Te[Te.Layer24=16777216]="Layer24",Te[Te.Layer25=33554432]="Layer25",Te[Te.Layer26=67108864]="Layer26",Te[Te.Layer27=134217728]="Layer27",Te[Te.Layer28=268435456]="Layer28",Te[Te.Layer29=536870912]="Layer29",Te[Te.Layer30=1073741824]="Layer30",Te[Te.Layer31=2147483648]="Layer31",Te[Te.Everything=4294967295]="Everything",Te[Te.Nothing=0]="Nothing";var Fe,Oe,Ie,ze,De,Be,Ne,Ue,Ge,ke,Ve,He,je,We,Xe,Ke,qe,Ye,Qe=(Ce=U((Me=function(e){function t(t){var n;return N(n=e.call(this,t.engine)||this,"_entity",Ce,z(n)),N(n,"_destroyed",Pe,z(n)),N(n,"_enabled",Se,z(n)),N(n,"_awaked",Re,z(n)),n._entity=t,n}R(t,e);var n=t.prototype;return n.destroy=function(){this._destroyed||(this._entity._removeComponent(this),this._entity.isActiveInHierarchy&&(this._enabled&&this._onDisable(),this._onInActive()),this._destroyed=!0,this._onDestroy())},n._onAwake=function(){},n._onEnable=function(){},n._onDisable=function(){},n._onDestroy=function(){},n._onActive=function(){},n._onInActive=function(){},n._setActive=function(e){e?(this._awaked||(this._awaked=!0,this._onAwake()),this._entity._isActiveInHierarchy&&(this._onActive(),this._enabled&&this._onEnable())):(this._enabled&&this._onDisable(),this._onInActive())},T(t,[{key:"enabled",get:function(){return this._enabled},set:function(e){e!==this._enabled&&(this._enabled=e,e?this._entity.isActiveInHierarchy&&this._onEnable():this._entity.isActiveInHierarchy&&this._onDisable())}},{key:"destroyed",get:function(){return this._destroyed}},{key:"entity",get:function(){return this._entity}},{key:"scene",get:function(){return this._entity.scene}},{key:"engine",get:function(){return this._entity.engine}}]),t}(he)).prototype,"_entity",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Pe=U(Me.prototype,"_destroyed",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Se=U(Me.prototype,"_enabled",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Re=U(Me.prototype,"_awaked",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Me),Ze=function(){function e(e){void 0===e&&(e=[]),this._flags=e,this.flag=!0,this._flags.push(this)}return e.prototype.destroy=function(){!function(e,t){var n=e.indexOf(t);if(n<0)return!1;var i=e.length-1;if(n!==i){var r=e[i];e[n]=r}e.length--}(this._flags,this),this._flags=null},e}(),Je=(Ke=Xe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return N(t=e.call.apply(e,[this].concat(i))||this,"_position",Oe,z(t)),N(t,"_rotation",Ie,z(t)),N(t,"_rotationQuaternion",ze,z(t)),N(t,"_scale",De,z(t)),N(t,"_worldPosition",Be,z(t)),N(t,"_worldRotation",Ne,z(t)),N(t,"_worldRotationQuaternion",Ue,z(t)),N(t,"_lossyWorldScale",Ge,z(t)),N(t,"_localMatrix",ke,z(t)),N(t,"_worldMatrix",Ve,z(t)),N(t,"_changeFlags",He,z(t)),N(t,"_isParentDirty",je,z(t)),N(t,"_parentTransformCache",We,z(t)),t._dirtyFlag=qe.WmWpWeWqWs,t}R(t,e);var n=t.prototype;return n.setPosition=function(e,t,n){this._position.setValue(e,t,n),this.position=this._position},n.setRotation=function(e,t,n){this._rotation.setValue(e,t,n),this.rotation=this._rotation},n.setRotationQuaternion=function(e,t,n,i){this._rotationQuaternion.setValue(e,t,n,i),this.rotationQuaternion=this._rotationQuaternion},n.setScale=function(e,t,n){this._scale.setValue(e,t,n),this.scale=this._scale},n.setWorldPosition=function(e,t,n){this._worldPosition.setValue(e,t,n),this.worldPosition=this._worldPosition},n.setWorldRotation=function(e,t,n){this._worldRotation.setValue(e,t,n),this.worldRotation=this._worldRotation},n.setWorldRotationQuaternion=function(e,t,n,i){this._worldRotationQuaternion.setValue(e,t,n,i),this.worldRotationQuaternion=this._worldRotationQuaternion},n.getWorldForward=function(e){var t=this.worldMatrix.elements;return e.setValue(-t[8],-t[9],-t[10]),e.normalize()},n.getWorldRight=function(e){var t=this.worldMatrix.elements;return e.setValue(t[0],t[1],t[2]),e.normalize()},n.getWorldUp=function(e){var t=this.worldMatrix.elements;return e.setValue(t[4],t[5],t[6]),e.normalize()},n.translate=function(e,n,i,r){if("number"==typeof e){var a=t._tempVec3;a.setValue(e,n,i),this._translate(a,r)}else this._translate(e,n)},n.rotate=function(e,t,n,i){"number"==typeof e?this._rotateXYZ(e,t,n,i):this._rotateXYZ(e.x,e.y,e.z,t)},n.rotateByAxis=function(e,n,i){void 0===i&&(i=!0);var r=n*o.degreeToRadFactor;_.rotationAxisAngle(e,r,t._tempQuat0),this._rotateByQuat(t._tempQuat0,i)},n.lookAt=function(e,n){var i,r=this.worldPosition,a=o.zeroTolerance;if(!(Math.abs(r.x-e.x)<a&&Math.abs(r.y-e.y)<a&&Math.abs(r.z-e.z)<a)){var s=t._tempMat43,c=this._worldRotationQuaternion;n=null!=(i=n)?i:t._tempVec3.setValue(0,1,0),p.lookAt(r,e,n,s),s.getRotation(c).invert(),this.worldRotationQuaternion=c}},n.registerWorldChangeFlag=function(){return new Ze(this._changeFlags)},n._parentChange=function(){this._isParentDirty=!0,this._updateAllWorldFlag()},n._updateWorldPositionFlag=function(){if(!this._isContainDirtyFlags(qe.WmWp)){this._worldAssociatedChange(qe.WmWp);for(var e=this._entity._children,t=0,n=e.length;t<n;t++){var i;null===(i=e[t].transform)||void 0===i||i._updateWorldPositionFlag()}}},n._updateWorldRotationFlag=function(){if(!this._isContainDirtyFlags(qe.WmWeWq)){this._worldAssociatedChange(qe.WmWeWq);for(var e=this._entity._children,t=0,n=e.length;t<n;t++){var i;null===(i=e[t].transform)||void 0===i||i._updateWorldPositionAndRotationFlag()}}},n._updateWorldPositionAndRotationFlag=function(){if(!this._isContainDirtyFlags(qe.WmWpWeWq)){this._worldAssociatedChange(qe.WmWpWeWq);for(var e=this._entity._children,t=0,n=e.length;t<n;t++){var i;null===(i=e[t].transform)||void 0===i||i._updateWorldPositionAndRotationFlag()}}},n._updateWorldScaleFlag=function(){if(!this._isContainDirtyFlags(qe.WmWs)){this._worldAssociatedChange(qe.WmWs);for(var e=this._entity._children,t=0,n=e.length;t<n;t++){var i;null===(i=e[t].transform)||void 0===i||i._updateWorldPositionAndScaleFlag()}}},n._updateWorldPositionAndScaleFlag=function(){if(!this._isContainDirtyFlags(qe.WmWpWs)){this._worldAssociatedChange(qe.WmWpWs);for(var e=this._entity._children,t=0,n=e.length;t<n;t++){var i;null===(i=e[t].transform)||void 0===i||i._updateWorldPositionAndScaleFlag()}}},n._updateAllWorldFlag=function(){if(!this._isContainDirtyFlags(qe.WmWpWeWqWs)){this._worldAssociatedChange(qe.WmWpWeWqWs);for(var e=this._entity._children,t=0,n=e.length;t<n;t++){var i;null===(i=e[t].transform)||void 0===i||i._updateAllWorldFlag()}}},n._getParentTransform=function(){if(!this._isParentDirty)return this._parentTransformCache;for(var e=null,t=this._entity.parent;t;){var n=t.transform;if(n){e=n;break}t=t.parent}return this._parentTransformCache=e,this._isParentDirty=!1,e},n._getScaleMatrix=function(){var e=t._tempQuat0,n=t._tempMat30,i=t._tempMat31,r=t._tempMat32;return i.setValueByMatrix(this.worldMatrix),_.invert(this.worldRotationQuaternion,e),f.rotationQuaternion(e,n),f.multiply(n,i,r),r},n._isContainDirtyFlags=function(e){return(this._dirtyFlag&e)===e},n._isContainDirtyFlag=function(e){return 0!=(this._dirtyFlag&e)},n._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},n._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},n._worldAssociatedChange=function(e){this._dirtyFlag|=e;for(var t=this._changeFlags.length-1;t>=0;t--)this._changeFlags[t].flag=!0},n._rotateByQuat=function(e,t){t?(_.multiply(this.rotationQuaternion,e,this._rotationQuaternion),this.rotationQuaternion=this._rotationQuaternion):(_.multiply(this.worldRotationQuaternion,e,this._worldRotationQuaternion),this.worldRotationQuaternion=this._worldRotationQuaternion)},n._translate=function(e,n){if(void 0===n&&(n=!0),n){var i=t._tempMat40;p.rotationQuaternion(this.rotationQuaternion,i),s.transformCoordinate(e,i,t._tempVec3),this.position=this._position.add(t._tempVec3)}else this.worldPosition=this._worldPosition.add(e)},n._rotateXYZ=function(e,n,i,r){void 0===r&&(r=!0);var a=o.degreeToRadFactor,s=t._tempQuat0;_.rotationEuler(e*a,n*a,i*a,s),this._rotateByQuat(s,r)},T(t,[{key:"position",get:function(){return this._position},set:function(e){this._position!==e&&e.cloneTo(this._position),this._setDirtyFlagTrue(qe.LocalMatrix),this._updateWorldPositionFlag()}},{key:"worldPosition",get:function(){return this._isContainDirtyFlag(qe.WorldPosition)&&(this._getParentTransform()?this.worldMatrix.getTranslation(this._worldPosition):this._position.cloneTo(this._worldPosition),this._setDirtyFlagFalse(qe.WorldPosition)),this._worldPosition},set:function(e){this._worldPosition!==e&&e.cloneTo(this._worldPosition);var n=this._getParentTransform();n?(p.invert(n.worldMatrix,t._tempMat41),s.transformCoordinate(e,t._tempMat41,this._position)):e.cloneTo(this._position),this.position=this._position,this._setDirtyFlagFalse(qe.WorldPosition)}},{key:"rotation",get:function(){return this._isContainDirtyFlag(qe.LocalEuler)&&(this._rotationQuaternion.toEuler(this._rotation),this._rotation.scale(o.radToDegreeFactor),this._setDirtyFlagFalse(qe.LocalEuler)),this._rotation},set:function(e){this._rotation!==e&&e.cloneTo(this._rotation),this._setDirtyFlagTrue(qe.LocalMatrix|qe.LocalQuat),this._setDirtyFlagFalse(qe.LocalEuler),this._updateWorldRotationFlag()}},{key:"worldRotation",get:function(){return this._isContainDirtyFlag(qe.WorldEuler)&&(this.worldRotationQuaternion.toEuler(this._worldRotation),this._worldRotation.scale(o.radToDegreeFactor),this._setDirtyFlagFalse(qe.WorldEuler)),this._worldRotation},set:function(e){this._worldRotation!==e&&e.cloneTo(this._worldRotation),_.rotationEuler(o.degreeToRadian(e.x),o.degreeToRadian(e.y),o.degreeToRadian(e.z),this._worldRotationQuaternion),this.worldRotationQuaternion=this._worldRotationQuaternion,this._setDirtyFlagFalse(qe.WorldEuler)}},{key:"rotationQuaternion",get:function(){return this._isContainDirtyFlag(qe.LocalQuat)&&(_.rotationEuler(o.degreeToRadian(this._rotation.x),o.degreeToRadian(this._rotation.y),o.degreeToRadian(this._rotation.z),this._rotationQuaternion),this._setDirtyFlagFalse(qe.LocalQuat)),this._rotationQuaternion},set:function(e){this._rotationQuaternion!==e&&e.cloneTo(this._rotationQuaternion),this._setDirtyFlagTrue(qe.LocalMatrix|qe.LocalEuler),this._setDirtyFlagFalse(qe.LocalQuat),this._updateWorldRotationFlag()}},{key:"worldRotationQuaternion",get:function(){if(this._isContainDirtyFlag(qe.WorldQuat)){var e=this._getParentTransform();null!=e?_.multiply(e.worldRotationQuaternion,this.rotationQuaternion,this._worldRotationQuaternion):this.rotationQuaternion.cloneTo(this._worldRotationQuaternion),this._setDirtyFlagFalse(qe.WorldQuat)}return this._worldRotationQuaternion},set:function(e){this._worldRotationQuaternion!==e&&e.cloneTo(this._worldRotationQuaternion);var n=this._getParentTransform();n?(_.invert(n.worldRotationQuaternion,t._tempQuat0),_.multiply(e,t._tempQuat0,this._rotationQuaternion)):e.cloneTo(this._rotationQuaternion),this.rotationQuaternion=this._rotationQuaternion,this._setDirtyFlagFalse(qe.WorldQuat)}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale!==e&&e.cloneTo(this._scale),this._setDirtyFlagTrue(qe.LocalMatrix),this._updateWorldScaleFlag()}},{key:"lossyWorldScale",get:function(){if(this._isContainDirtyFlag(qe.WorldScale)){if(this._getParentTransform()){var e=this._getScaleMatrix().elements;this._lossyWorldScale.setValue(e[0],e[4],e[8])}else this._scale.cloneTo(this._lossyWorldScale);this._setDirtyFlagFalse(qe.WorldScale)}return this._lossyWorldScale}},{key:"localMatrix",get:function(){return this._isContainDirtyFlag(qe.LocalMatrix)&&(p.affineTransformation(this._scale,this.rotationQuaternion,this._position,this._localMatrix),this._setDirtyFlagFalse(qe.LocalMatrix)),this._localMatrix},set:function(e){this._localMatrix!==e&&e.cloneTo(this._localMatrix),this._localMatrix.decompose(this._position,this._rotationQuaternion,this._scale),this._setDirtyFlagTrue(qe.LocalEuler),this._setDirtyFlagFalse(qe.LocalMatrix),this._updateAllWorldFlag()}},{key:"worldMatrix",get:function(){if(this._isContainDirtyFlag(qe.WorldMatrix)){var e=this._getParentTransform();e?p.multiply(e.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._setDirtyFlagFalse(qe.WorldMatrix)}return this._worldMatrix},set:function(e){this._worldMatrix!==e&&e.cloneTo(this._worldMatrix);var n=this._getParentTransform();n?(p.invert(n.worldMatrix,t._tempMat42),p.multiply(e,t._tempMat42,this._localMatrix)):e.cloneTo(this._localMatrix),this.localMatrix=this._localMatrix,this._setDirtyFlagFalse(qe.WorldMatrix)}}]),t}(Qe),Xe._tempQuat0=new _,Xe._tempVec3=new s,Xe._tempMat30=new f,Xe._tempMat31=new f,Xe._tempMat32=new f,Xe._tempMat40=new p,Xe._tempMat41=new p,Xe._tempMat42=new p,Xe._tempMat43=new p,Oe=U((Fe=Ke).prototype,"_position",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new s}}),Ie=U(Fe.prototype,"_rotation",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new s}}),ze=U(Fe.prototype,"_rotationQuaternion",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _}}),De=U(Fe.prototype,"_scale",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new s(1,1,1)}}),Be=U(Fe.prototype,"_worldPosition",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new s}}),Ne=U(Fe.prototype,"_worldRotation",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new s}}),Ue=U(Fe.prototype,"_worldRotationQuaternion",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _}}),Ge=U(Fe.prototype,"_lossyWorldScale",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new s(1,1,1)}}),ke=U(Fe.prototype,"_localMatrix",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new p}}),Ve=U(Fe.prototype,"_worldMatrix",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new p}}),He=U(Fe.prototype,"_changeFlags",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),je=U(Fe.prototype,"_isParentDirty",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),We=U(Fe.prototype,"_parentTransformCache",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fe);(Ye=qe||(qe={}))[Ye.LocalEuler=1]="LocalEuler",Ye[Ye.LocalQuat=2]="LocalQuat",Ye[Ye.WorldPosition=4]="WorldPosition",Ye[Ye.WorldEuler=8]="WorldEuler",Ye[Ye.WorldQuat=16]="WorldQuat",Ye[Ye.WorldScale=32]="WorldScale",Ye[Ye.LocalMatrix=64]="LocalMatrix",Ye[Ye.WorldMatrix=128]="WorldMatrix",Ye[Ye.WmWp=132]="WmWp",Ye[Ye.WmWeWq=152]="WmWeWq",Ye[Ye.WmWpWeWq=156]="WmWpWeWq",Ye[Ye.WmWs=160]="WmWs",Ye[Ye.WmWpWs=164]="WmWpWs",Ye[Ye.WmWpWeWqWs=188]="WmWpWeWqWs";var $e=function(e){function t(t,n){var i;return(i=e.call(this,t)||this).name=void 0,i.layer=Ae.Layer0,i.transform=void 0,i._isActiveInHierarchy=!1,i._components=[],i._children=[],i._scene=void 0,i._isRoot=!1,i._isActive=!0,i._parent=null,i._activeChangedComponents=void 0,i._invModelMatrix=new p,i._inverseWorldMatFlag=void 0,i.name=n,i.transform=i.addComponent(Je),i._inverseWorldMatFlag=i.transform.registerWorldChangeFlag(),i}R(t,e),t._findChildByName=function(e,t){for(var n=e._children,i=n.length-1;i>=0;i--){var r=n[i];if(r.name===t)return r}return null},t._traverseSetOwnerScene=function(e,t){e._scene=t;for(var n=e._children,i=e.childCount-1;i>=0;i--)this._traverseSetOwnerScene(n[i],t)};var n=t.prototype;return n.addComponent=function(e){Le._addCheck(this,e);var t=new e(this);return this._components.push(t),this._isActiveInHierarchy&&t._setActive(!0),t},n.getComponent=function(e){for(var t=this._components.length-1;t>=0;t--){var n=this._components[t];if(n instanceof e)return n}},n.getComponents=function(e,t){t.length=0;for(var n=this._components.length-1;n>=0;n--){var i=this._components[n];i instanceof e&&t.push(i)}return t},n.getComponentsIncludeChildren=function(e,t){return t.length=0,this._getComponentsInChildren(e,t),t},n.addChild=function(e){e.parent=this},n.removeChild=function(e){e.parent=null},n.getChild=function(e){return this._children[e]},n.findByName=function(e){var n=this._children,i=t._findChildByName(this,e);if(i)return i;for(var r=n.length-1;r>=0;r--){var a=n[r].findByName(e);if(a)return a}return null},n.findByPath=function(e){for(var n=e.split("/"),i=this,r=0,a=n.length;r<a;++r){var o=n[r];if(o&&!(i=t._findChildByName(i,o)))return null}return i},n.createChild=function(e){var n=new t(this.engine,e);return n.layer=this.layer,n.parent=this,n},n.clearChildren=function(){for(var e=this._children,n=e.length-1;n>=0;n--){var i=e[n];i._parent=null,i._isActiveInHierarchy&&i._processInActive(),t._traverseSetOwnerScene(i,null)}e.length=0},n.clone=function(){var e=new t(this._engine,this.name);e._isActive=this._isActive,e.transform.localMatrix=this.transform.localMatrix;for(var n=this._children,i=0,r=this._children.length;i<r;i++){var a=n[i];e.addChild(a.clone())}for(var o=this._components,s=0,c=o.length;s<c;s++){var l=o[s];if(!(l instanceof Je)){var u=e.addComponent(l.constructor);Ee.cloneComponent(l,u)}}return e},n.destroy=function(){for(var e=this._components,t=e.length-1;t>=0;t--)e[t].destroy();this._components.length=0;for(var n=this._children,i=n.length-1;i>=0;i--)n[i].destroy();if(this._children.length=0,null!=this._parent){var r=this._parent._children;r.splice(r.indexOf(this),1)}this._parent=null},n._removeComponent=function(e){Le._removeCheck(this,e.constructor);var t=this._components;t.splice(t.indexOf(e),1)},n._removeFromParent=function(){var e=this._parent;if(null!=e){var t=e._children;t.splice(t.indexOf(this),1),this._parent=null}return e},n._processActive=function(){if(this._activeChangedComponents)throw"Note: can't set the 'main inActive entity' active in hierarchy, if the operation is in main inActive entity or it's children script's onDisable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!0)},n._processInActive=function(){if(this._activeChangedComponents)throw"Note: can't set the 'main active entity' inActive in hierarchy, if the operation is in main active entity or it's children script's onEnable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setInActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!1)},n._getComponentsInChildren=function(e,t){for(var n=this._components.length-1;n>=0;n--){var i=this._components[n];i instanceof e&&t.push(i)}for(var r=this._children.length-1;r>=0;r--)this._children[r]._getComponentsInChildren(e,t)},n._setActiveComponents=function(e){for(var t=this._activeChangedComponents,n=0,i=t.length;n<i;++n)t[n]._setActive(e);this._engine._componentsManager.putActiveChangedTempList(t),this._activeChangedComponents=null},n._setActiveInHierarchy=function(e){this._isActiveInHierarchy=!0;for(var t=this._components,n=t.length-1;n>=0;n--)e.push(t[n]);for(var i=this._children,r=i.length-1;r>=0;r--){var a=i[r];a.isActive&&a._setActiveInHierarchy(e)}},n._setInActiveInHierarchy=function(e){this._isActiveInHierarchy=!1;for(var t=this._components,n=t.length-1;n>=0;n--)e.push(t[n]);for(var i=this._children,r=i.length-1;r>=0;r--){var a=i[r];a.isActive&&a._setInActiveInHierarchy(e)}},n._setTransformDirty=function(){if(this.transform)this.transform._parentChange();else for(var e=0,t=this._children.length;e<t;e++)this._children[e]._setTransformDirty()},n.getInvModelMatrix=function(){return this._inverseWorldMatFlag.flag&&(p.invert(this.transform.worldMatrix,this._invModelMatrix),this._inverseWorldMatFlag.flag=!1),this._invModelMatrix},T(t,[{key:"isActive",get:function(){return this._isActive},set:function(e){if(e!==this._isActive)if(this._isActive=e,e){var t=this._parent;(null!=t&&t._isActiveInHierarchy||this._isRoot&&this._scene._isActiveInEngine)&&this._processActive()}else this._isActiveInHierarchy&&this._processInActive()}},{key:"isActiveInHierarchy",get:function(){return this._isActiveInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){if(e!==this._parent){var n=this._removeFromParent(),i=this._parent=e;if(i){i._children.push(this);var r=i._scene;this._scene!==r&&t._traverseSetOwnerScene(this,r),i._isActiveInHierarchy?!this._isActiveInHierarchy&&this._isActive&&this._processActive():this._isActiveInHierarchy&&this._processInActive()}else this._isActiveInHierarchy&&this._processInActive(),n&&t._traverseSetOwnerScene(this,null);this._setTransformDirty()}}},{key:"children",get:function(){return this._children}},{key:"childCount",get:function(){return this._children.length}},{key:"scene",get:function(){return this._scene}},{key:"engine",get:function(){return this._engine}},{key:"position",get:function(){return this.transform.position},set:function(e){this.transform.position=e}},{key:"worldPosition",get:function(){return this.transform.worldPosition},set:function(e){this.transform.worldPosition=e}},{key:"rotation",get:function(){return this.transform.rotationQuaternion},set:function(e){this.transform.rotationQuaternion=e}},{key:"scale",get:function(){return this.transform.scale},set:function(e){this.transform.scale=e}}]),t}(he),et=function(){function e(){this._features=[],this._objects=[]}var t=e.prototype;return t.registerFeature=function(e){for(var t=this._features,n=0,i=t.length;n<i;n++)if(t[n]===e)return;t.push(e);for(var r=this._objects,a=0,o=r.length;a<o;a++)r[a].features.push(new e)},t.addObject=function(e){e.features=[];for(var t=0,n=this._features.length;t<n;t++){var i;e.features.push(new this._features[t](null!=(i=e.engine)?i:e))}this._objects.push(e)},t.callFeatureMethod=function(e,t,n){for(var i=e.features,r=i.length,a=0;a<r;a++){var o=i[a];o[t]&&o[t].apply(o,n)}},t.findFeature=function(e,t){for(var n=e.features,i=n.length,r=0;r<i;r++){var a=n[r];if(a.constructor===t)return a}},e}(),tt=function(){function e(e){this._elementPoolIndex=0,this._elementPool=[],this._type=void 0,this._type=e}var t=e.prototype;return t.getFromPool=function(){var e=this._elementPoolIndex,t=this._elementPool;if(this._elementPoolIndex++,t.length===e){var n=new this._type;return t.push(n),n}return t[e]},t.restPool=function(){this._elementPoolIndex=0},e}(),nt=function(){function e(){this._camera=void 0,this._viewProjectMatrix=new p}return e.prototype._setContext=function(e){this._camera=e,p.multiply(e.projectionMatrix,e.viewMatrix,this._viewProjectMatrix)},e}(),it=function(){function e(){this.component=void 0,this.mesh=void 0,this.subMesh=void 0,this.material=void 0}return e.getFromPool=function(){var t=e._elementPoolIndex,n=e._elementPool;if(e._elementPoolIndex++,n.length===t){var i=new e;return n.push(i),i}return n[t]},e._restPool=function(){e._elementPoolIndex=0},e.prototype.setValue=function(e,t,n,i){this.component=e,this.mesh=t,this.subMesh=n,this.material=i},e}();it._elementPoolIndex=0,it._elementPool=[];var rt=function(){function e(){this.component=void 0,this.positions=void 0,this.uv=void 0,this.triangles=void 0,this.color=void 0,this.material=void 0,this.camera=void 0}return e.getFromPool=function(){var t=e._elementPoolIndex,n=e._elementPool;if(e._elementPoolIndex++,n.length===t){var i=new e;return n.push(i),i}return n[t]},e._restPool=function(){e._elementPoolIndex=0},e.prototype.setValue=function(e,t,n,i,r,a,o){this.component=e,this.positions=t,this.uv=n,this.triangles=i,this.color=r,this.material=a,this.camera=o},e}();rt._elementPoolIndex=0,rt._elementPool=[];var at,ot,st,ct,lt,ut,ht,dt,ft,_t,pt,gt,vt=function(){function e(){}var t=e.prototype;return t.preUpdate=function(e){},t.postUpdate=function(e){},t.preRender=function(e,t){},t.postRender=function(e,t){},t.destroy=function(e){},e}();(ot=at||(at={}))[ot.Zero=0]="Zero",ot[ot.One=1]="One",ot[ot.SourceColor=2]="SourceColor",ot[ot.OneMinusSourceColor=3]="OneMinusSourceColor",ot[ot.DestinationColor=4]="DestinationColor",ot[ot.OneMinusDestinationColor=5]="OneMinusDestinationColor",ot[ot.SourceAlpha=6]="SourceAlpha",ot[ot.OneMinusSourceAlpha=7]="OneMinusSourceAlpha",ot[ot.DestinationAlpha=8]="DestinationAlpha",ot[ot.OneMinusDestinationAlpha=9]="OneMinusDestinationAlpha",ot[ot.SourceAlphaSaturate=10]="SourceAlphaSaturate",ot[ot.BlendColor=11]="BlendColor",ot[ot.OneMinusBlendColor=12]="OneMinusBlendColor",(ct=st||(st={}))[ct.Add=0]="Add",ct[ct.Subtract=1]="Subtract",ct[ct.ReverseSubtract=2]="ReverseSubtract",ct[ct.Min=3]="Min",ct[ct.Max=4]="Max",(ut=lt||(lt={}))[ut.None=0]="None",ut[ut.Red=1]="Red",ut[ut.Green=2]="Green",ut[ut.Blue=4]="Blue",ut[ut.Alpha=8]="Alpha",ut[ut.All=15]="All",(dt=ht||(ht={}))[dt.Never=0]="Never",dt[dt.Less=1]="Less",dt[dt.Equal=2]="Equal",dt[dt.LessEqual=3]="LessEqual",dt[dt.Greater=4]="Greater",dt[dt.NotEqual=5]="NotEqual",dt[dt.GreaterEqual=6]="GreaterEqual",dt[dt.Always=7]="Always",(_t=ft||(ft={}))[_t.Off=0]="Off",_t[_t.Front=1]="Front",_t[_t.Back=2]="Back",(gt=pt||(pt={}))[gt.Keep=0]="Keep",gt[gt.Zero=1]="Zero",gt[gt.Replace=2]="Replace",gt[gt.IncrementSaturate=3]="IncrementSaturate",gt[gt.DecrementSaturate=4]="DecrementSaturate",gt[gt.Invert=5]="Invert",gt[gt.IncrementWrap=6]="IncrementWrap",gt[gt.DecrementWrap=7]="DecrementWrap";var mt,yt,xt=S(S({common:"#define GLSLIFY 1\n#define PI 3.14159265359\n#define LOG2 1.442695\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\n",common_vert:"#define GLSLIFY 1\nattribute vec3 POSITION;\n#ifdef O3_HAS_UV\nattribute vec2 TEXCOORD_0;\n#endif\n#ifdef O3_HAS_SKIN\nattribute vec4 JOINTS_0;attribute vec4 WEIGHTS_0;\n#ifdef O3_USE_JOINT_TEXTURE\nuniform sampler2D u_jointSampler;uniform float u_jointCount;mat4 getJointMatrix(sampler2D smp,float index){float base=index/u_jointCount;float hf=0.5/u_jointCount;float v=base+hf;vec4 m0=texture2D(smp,vec2(0.125,v));vec4 m1=texture2D(smp,vec2(0.375,v));vec4 m2=texture2D(smp,vec2(0.625,v));vec4 m3=texture2D(smp,vec2(0.875,v));return mat4(m0,m1,m2,m3);}\n#else\nuniform mat4 u_jointMatrix[O3_JOINTS_NUM];\n#endif\n#endif\n#ifdef O3_HAS_VERTEXCOLOR\nattribute vec4 COLOR_0;\n#endif\nuniform mat4 u_localMat;uniform mat4 u_modelMat;uniform mat4 u_viewMat;uniform mat4 u_projMat;uniform mat4 u_MVMat;uniform mat4 u_MVPMat;uniform mat4 u_normalMat;uniform vec3 u_cameraPos;uniform vec4 u_tilingOffset;\n#ifndef OMIT_NORMAL\n#ifdef O3_HAS_NORMAL\nattribute vec3 NORMAL;\n#endif\n#ifdef O3_HAS_TANGENT\nattribute vec4 TANGENT;\n#endif\n#endif\n",common_frag:"#define GLSLIFY 1\nuniform O3_VERTEX_PRECISION mat4 u_localMat;uniform O3_VERTEX_PRECISION mat4 u_modelMat;uniform O3_VERTEX_PRECISION mat4 u_viewMat;uniform O3_VERTEX_PRECISION mat4 u_projMat;uniform O3_VERTEX_PRECISION mat4 u_MVMat;uniform O3_VERTEX_PRECISION mat4 u_MVPMat;uniform O3_VERTEX_PRECISION mat4 u_normalMat;uniform O3_VERTEX_PRECISION vec3 u_cameraPos;",color_share:"#define GLSLIFY 1\n#ifdef O3_HAS_VERTEXCOLOR\nvarying vec4 v_color;\n#endif\n",normal_share:"#define GLSLIFY 1\n#ifdef O3_HAS_NORMAL\n#if defined( O3_HAS_TANGENT ) && defined( O3_NORMAL_TEXTURE )\nvarying mat3 v_TBN;\n#else\nvarying vec3 v_normal;\n#endif\n#endif\n",uv_share:"#define GLSLIFY 1\nvarying vec2 v_uv;",worldpos_share:"#define GLSLIFY 1\n#ifdef O3_NEED_WORLDPOS\nvarying vec3 v_pos;\n#endif\n",shadow_share:"#define GLSLIFY 1\n#ifdef O3_GENERATE_SHADOW_MAP\nuniform mat4 u_viewMatFromLight;uniform mat4 u_projMatFromLight;\n#endif\n#ifdef O3_SHADOW_MAP_COUNT\nuniform mat4 u_viewMatFromLight[O3_SHADOW_MAP_COUNT];uniform mat4 u_projMatFromLight[O3_SHADOW_MAP_COUNT];varying vec4 v_PositionFromLight[O3_SHADOW_MAP_COUNT];\n#endif\n",fog_share:"#define GLSLIFY 1\n#ifdef O3_HAS_FOG\nvarying vec3 v_fogDepth;uniform O3_VERTEX_PRECISION vec3 u_fogColor;\n#ifdef O3_FOG_EXP2\nuniform O3_VERTEX_PRECISION float u_fogDensity;\n#else\nuniform O3_VERTEX_PRECISION float u_fogNear;uniform O3_VERTEX_PRECISION float u_fogFar;\n#endif\n#endif\n",begin_normal_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_NORMAL\nvec3 normal=vec3(NORMAL);\n#if defined( O3_HAS_TANGENT ) && defined( O3_NORMAL_TEXTURE )\nvec4 tangent=vec4(TANGENT);\n#endif\n#endif\n",begin_position_vert:"#define GLSLIFY 1\nvec4 position=vec4(POSITION,1.0);",position_vert:"#define GLSLIFY 1\n#ifndef O3_GENERATE_SHADOW_MAP\ngl_Position=u_MVPMat*position;\n#endif\n",color_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_VERTEXCOLOR\nv_color=COLOR_0;\n#endif\n",normal_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_NORMAL\n#if defined( O3_HAS_TANGENT ) && defined( O3_NORMAL_TEXTURE )\nvec3 normalW=normalize(mat3(u_normalMat)*normal.xyz);vec3 tangentW=normalize(mat3(u_normalMat)*tangent.xyz);vec3 bitangentW=cross(normalW,tangentW)*tangent.w;v_TBN=mat3(tangentW,bitangentW,normalW);\n#else\nv_normal=normalize(mat3(u_normalMat)*normal);\n#endif\n#endif\n",skinning_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_SKIN\n#ifdef O3_USE_JOINT_TEXTURE\nmat4 skinMatrix=WEIGHTS_0.x*getJointMatrix(u_jointSampler,JOINTS_0.x)+WEIGHTS_0.y*getJointMatrix(u_jointSampler,JOINTS_0.y)+WEIGHTS_0.z*getJointMatrix(u_jointSampler,JOINTS_0.z)+WEIGHTS_0.w*getJointMatrix(u_jointSampler,JOINTS_0.w);\n#else\nmat4 skinMatrix=WEIGHTS_0.x*u_jointMatrix[int(JOINTS_0.x)]+WEIGHTS_0.y*u_jointMatrix[int(JOINTS_0.y)]+WEIGHTS_0.z*u_jointMatrix[int(JOINTS_0.z)]+WEIGHTS_0.w*u_jointMatrix[int(JOINTS_0.w)];\n#endif\nposition=skinMatrix*position;\n#if defined(O3_HAS_NORMAL) && !defined(OMIT_NORMAL)\nnormal=vec4(skinMatrix*vec4(normal,0.0)).xyz;\n#if defined( O3_HAS_TANGENT ) && defined( O3_NORMAL_TEXTURE )\ntangent.xyz=vec4(skinMatrix*vec4(tangent.xyz,0.0)).xyz;\n#endif\n#endif\n#endif\n",uv_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_UV\nv_uv=TEXCOORD_0;\n#else\nv_uv=vec2(0.,0.);\n#endif\n#ifdef O3_NEED_TILINGOFFSET\nv_uv=v_uv*u_tilingOffset.xy+u_tilingOffset.zw;\n#endif\n",worldpos_vert:"#define GLSLIFY 1\n#ifdef O3_NEED_WORLDPOS\nvec4 temp_pos=u_modelMat*position;v_pos=temp_pos.xyz/temp_pos.w;\n#endif\n",shadow_vert:"#define GLSLIFY 1\n#ifdef O3_GENERATE_SHADOW_MAP\ngl_Position=u_projMatFromLight*u_viewMatFromLight*u_modelMat*position;\n#endif\n#ifdef O3_SHADOW_MAP_COUNT\nfor(int i=0;i<O3_SHADOW_MAP_COUNT;i++){v_PositionFromLight[i]=u_projMatFromLight[i]*u_viewMatFromLight[i]*u_modelMat*vec4(POSITION,1.0);}\n#endif\n",fog_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_FOG\nv_fogDepth=(u_MVMat*position).xyz;\n#endif\n",ambient_light_frag:"#define GLSLIFY 1\n#ifdef O3_HAS_AMBIENT_LIGHT\nuniform vec3 u_ambientLightColor;\n#endif\n",direct_light_frag:"#define GLSLIFY 1\n#ifdef O3_DIRECT_LIGHT_COUNT\nstruct DirectLight{vec3 color;vec3 direction;};uniform vec3 u_directLightColor[O3_DIRECT_LIGHT_COUNT];uniform vec3 u_directLightDirection[O3_DIRECT_LIGHT_COUNT];\n#endif\n",point_light_frag:"#define GLSLIFY 1\n#ifdef O3_POINT_LIGHT_COUNT\nstruct PointLight{vec3 color;vec3 position;float distance;float decay;};uniform vec3 u_pointLightColor[O3_POINT_LIGHT_COUNT];uniform vec3 u_pointLightPosition[O3_POINT_LIGHT_COUNT];uniform float u_pointLightDistance[O3_POINT_LIGHT_COUNT];uniform float u_pointLightDecay[O3_POINT_LIGHT_COUNT];\n#endif\n",spot_light_frag:"#define GLSLIFY 1\n#ifdef O3_SPOT_LIGHT_COUNT\nstruct SpotLight{vec3 color;vec3 position;vec3 direction;float distance;float decay;float angle;float penumbra;float penumbraCos;float coneCos;};uniform vec3 u_spotLightColor[O3_SPOT_LIGHT_COUNT];uniform vec3 u_spotLightPosition[O3_SPOT_LIGHT_COUNT];uniform vec3 u_spotLightDirection[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightDistance[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightDecay[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightAngle[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightPenumbra[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightPenumbraCos[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightConeCos[O3_SPOT_LIGHT_COUNT];\n#endif\n",mobile_material_frag:"#define GLSLIFY 1\nuniform vec4 u_emissiveColor;uniform vec4 u_diffuseColor;uniform vec4 u_specularColor;uniform float u_shininess;uniform float u_normalIntensity;uniform float u_alphaCutoff;\n#ifdef O3_EMISSIVE_TEXTURE\nuniform sampler2D u_emissiveTexture;\n#endif\n#ifdef O3_DIFFUSE_TEXTURE\nuniform sampler2D u_diffuseTexture;\n#endif\n#ifdef O3_SPECULAR_TEXTURE\nuniform sampler2D u_specularTexture;\n#endif\n#ifdef O3_NORMAL_TEXTURE\nuniform sampler2D u_normalTexture;\n#endif\n",fog_frag:"#define GLSLIFY 1\n#ifdef O3_HAS_FOG\nfloat fogDepth=length(v_fogDepth);\n#ifdef O3_FOG_EXP2\nfloat fogFactor=whiteCompliment(exp2(-u_fogDensity*u_fogDensity*fogDepth*fogDepth*LOG2));\n#else\nfloat fogFactor=smoothstep(u_fogNear,u_fogFar,fogDepth);\n#endif\ngl_FragColor.rgb=mix(gl_FragColor.rgb,u_fogColor,fogFactor);\n#endif\n",begin_mobile_frag:"#define GLSLIFY 1\nvec4 ambient=vec4(0.0);vec4 emission=u_emissiveColor;vec4 diffuse=u_diffuseColor;vec4 specular=u_specularColor;\n#ifdef O3_EMISSIVE_TEXTURE\nemission*=texture2D(u_emissiveTexture,v_uv);\n#endif\n#ifdef O3_DIFFUSE_TEXTURE\ndiffuse*=texture2D(u_diffuseTexture,v_uv);\n#endif\n#ifdef O3_SPECULAR_TEXTURE\nspecular*=texture2D(u_specularTexture,v_uv);\n#endif\n#ifdef O3_HAS_AMBIENT_LIGHT\nambient=vec4(u_ambientLightColor,1.0)*diffuse;\n#endif\n",begin_viewdir_frag:"#define GLSLIFY 1\n#ifdef O3_NEED_WORLDPOS\nvec3 V=normalize(u_cameraPos-v_pos);\n#endif\n",mobile_blinnphong_frag:"#define GLSLIFY 1\nvec3 N=getNormal();vec3 lightDiffuse=vec3(0.0,0.0,0.0);vec3 lightSpecular=vec3(0.0,0.0,0.0);\n#ifdef O3_DIRECT_LIGHT_COUNT\nDirectLight lgt;for(int i=0;i<O3_DIRECT_LIGHT_COUNT;i++){lgt.color=u_directLightColor[i];lgt.direction=u_directLightDirection[i];float d=max(dot(N,-lgt.direction),0.0);lightDiffuse+=lgt.color*d;vec3 halfDir=normalize(V-lgt.direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess);lightSpecular+=lgt.color*s;}\n#endif\n#ifdef O3_POINT_LIGHT_COUNT\nPointLight lgt;for(int i=0;i<O3_POINT_LIGHT_COUNT;i++){lgt.color=u_pointLightColor[i];lgt.position=u_pointLightPosition[i];lgt.distance=u_pointLightDistance[i];lgt.decay=u_pointLightDecay[i];vec3 direction=v_pos-lgt.position;float dist=length(direction);direction/=dist;float decay=pow(max(0.0,1.0-dist/lgt.distance),2.0);float d=max(dot(N,-direction),0.0)*decay;lightDiffuse+=lgt.color*d;vec3 halfDir=normalize(V-direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess)*decay;lightSpecular+=lgt.color*s;}\n#endif\n#ifdef O3_SPOT_LIGHT_COUNT\nSpotLight lgt;for(int i=0;i<O3_SPOT_LIGHT_COUNT;i++){lgt.color=u_spotLightColor[i];lgt.position=u_spotLightPosition[i];lgt.direction=u_spotLightDirection[i];lgt.distance=u_spotLightDistance[i];lgt.decay=u_spotLightDecay[i];lgt.angle=u_spotLightAngle[i];lgt.penumbra=u_spotLightPenumbra[i];vec3 direction=v_pos-lgt.position;float angle=acos(dot(normalize(direction),normalize(lgt.direction)));float dist=length(direction);direction/=dist;float decay=pow(max(0.0,1.0-dist/lgt.distance),2.0);float hasLight=step(angle,lgt.angle);float hasPenumbra=step(lgt.angle,angle)*step(angle,lgt.angle*(1.0+lgt.penumbra));float penumbra=hasPenumbra*(1.0-(angle-lgt.angle)/(lgt.angle*lgt.penumbra));float d=max(dot(N,-direction),0.0)*decay*(penumbra+hasLight);lightDiffuse+=lgt.color*d;vec3 halfDir=normalize(V-direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess)*decay*(penumbra+hasLight);lightSpecular+=lgt.color*s;}\n#endif\ndiffuse*=vec4(lightDiffuse,1.0);specular*=vec4(lightSpecular,1.0);\n#ifdef ALPHA_CUTOFF\nif(diffuse.a<u_alphaCutoff){discard;}\n#endif\n",noise_common:"#define GLSLIFY 1\nvec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec2 mod289(vec2 x){return x-floor(x*(1.0/289.0))*289.0;}float mod289(float x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod7(vec4 x){return x-floor(x*(1.0/7.0))*7.0;}vec3 mod7(vec3 x){return x-floor(x*(1.0/7.0))*7.0;}vec4 permute(vec4 x){return mod289((34.0*x+1.0)*x);}vec3 permute(vec3 x){return mod289((34.0*x+1.0)*x);}float permute(float x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}float taylorInvSqrt(float r){return 1.79284291400159-0.85373472095314*r;}vec4 fade(vec4 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec3 fade(vec3 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec2 fade(vec2 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}\n#define K 0.142857142857\n#define Ko 0.428571428571\n#define K2 0.020408163265306\n#define Kd2 0.0714285714285\n#define Kz 0.166666666667\n#define Kzo 0.416666666667\n#define jitter 1.0\n#define jitter1 0.8\n",noise_cellular_2D:"#define GLSLIFY 1\nvec2 cellular(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec3 oi=vec3(-1.0,0.0,1.0);vec3 of=vec3(-0.5,0.5,1.5);vec3 px=permute(Pi.x+oi);vec3 p=permute(px.x+Pi.y+oi);vec3 ox=fract(p*K)-Ko;vec3 oy=mod7(floor(p*K))*K-Ko;vec3 dx=Pf.x+0.5+jitter*ox;vec3 dy=Pf.y-of+jitter*oy;vec3 d1=dx*dx+dy*dy;p=permute(px.y+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-0.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d2=dx*dx+dy*dy;p=permute(px.z+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-1.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d3=dx*dx+dy*dy;vec3 d1a=min(d1,d2);d2=max(d1,d2);d2=min(d2,d3);d1=min(d1a,d2);d2=max(d1a,d2);d1.xy=(d1.x<d1.y)? d1.xy : d1.yx;d1.xz=(d1.x<d1.z)? d1.xz : d1.zx;d1.yz=min(d1.yz,d2.yz);d1.y=min(d1.y,d1.z);d1.y=min(d1.y,d2.x);return sqrt(d1.xy);}",noise_cellular_2x2:"#define GLSLIFY 1\nvec2 cellular2x2(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec4 Pfx=Pf.x+vec4(-0.5,-1.5,-0.5,-1.5);vec4 Pfy=Pf.y+vec4(-0.5,-0.5,-1.5,-1.5);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 ox=mod7(p)*K+Kd2;vec4 oy=mod7(floor(p*K))*K+Kd2;vec4 dx=Pfx+jitter1*ox;vec4 dy=Pfy+jitter1*oy;vec4 d=dx*dx+dy*dy;d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.y=min(d.y,d.z);d.y=min(d.y,d.w);return sqrt(d.xy);}",noise_cellular_2x2x2:"#define GLSLIFY 1\nvec2 cellular2x2x2(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P);vec4 Pfx=Pf.x+vec4(0.0,-1.0,0.0,-1.0);vec4 Pfy=Pf.y+vec4(0.0,0.0,-1.0,-1.0);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 p1=permute(p+Pi.z);vec4 p2=permute(p+Pi.z+vec4(1.0));vec4 ox1=fract(p1*K)-Ko;vec4 oy1=mod7(floor(p1*K))*K-Ko;vec4 oz1=floor(p1*K2)*Kz-Kzo;vec4 ox2=fract(p2*K)-Ko;vec4 oy2=mod7(floor(p2*K))*K-Ko;vec4 oz2=floor(p2*K2)*Kz-Kzo;vec4 dx1=Pfx+jitter1*ox1;vec4 dy1=Pfy+jitter1*oy1;vec4 dz1=Pf.z+jitter1*oz1;vec4 dx2=Pfx+jitter1*ox2;vec4 dy2=Pfy+jitter1*oy2;vec4 dz2=Pf.z-1.0+jitter1*oz2;vec4 d1=dx1*dx1+dy1*dy1+dz1*dz1;vec4 d2=dx2*dx2+dy2*dy2+dz2*dz2;vec4 d=min(d1,d2);d2=max(d1,d2);d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.yzw=min(d.yzw,d2.yzw);d.y=min(d.y,d.z);d.y=min(d.y,d.w);d.y=min(d.y,d2.x);return sqrt(d.xy);}",noise_cellular_3D:"#define GLSLIFY 1\nvec2 cellular(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P)-0.5;vec3 Pfx=Pf.x+vec3(1.0,0.0,-1.0);vec3 Pfy=Pf.y+vec3(1.0,0.0,-1.0);vec3 Pfz=Pf.z+vec3(1.0,0.0,-1.0);vec3 p=permute(Pi.x+vec3(-1.0,0.0,1.0));vec3 p1=permute(p+Pi.y-1.0);vec3 p2=permute(p+Pi.y);vec3 p3=permute(p+Pi.y+1.0);vec3 p11=permute(p1+Pi.z-1.0);vec3 p12=permute(p1+Pi.z);vec3 p13=permute(p1+Pi.z+1.0);vec3 p21=permute(p2+Pi.z-1.0);vec3 p22=permute(p2+Pi.z);vec3 p23=permute(p2+Pi.z+1.0);vec3 p31=permute(p3+Pi.z-1.0);vec3 p32=permute(p3+Pi.z);vec3 p33=permute(p3+Pi.z+1.0);vec3 ox11=fract(p11*K)-Ko;vec3 oy11=mod7(floor(p11*K))*K-Ko;vec3 oz11=floor(p11*K2)*Kz-Kzo;vec3 ox12=fract(p12*K)-Ko;vec3 oy12=mod7(floor(p12*K))*K-Ko;vec3 oz12=floor(p12*K2)*Kz-Kzo;vec3 ox13=fract(p13*K)-Ko;vec3 oy13=mod7(floor(p13*K))*K-Ko;vec3 oz13=floor(p13*K2)*Kz-Kzo;vec3 ox21=fract(p21*K)-Ko;vec3 oy21=mod7(floor(p21*K))*K-Ko;vec3 oz21=floor(p21*K2)*Kz-Kzo;vec3 ox22=fract(p22*K)-Ko;vec3 oy22=mod7(floor(p22*K))*K-Ko;vec3 oz22=floor(p22*K2)*Kz-Kzo;vec3 ox23=fract(p23*K)-Ko;vec3 oy23=mod7(floor(p23*K))*K-Ko;vec3 oz23=floor(p23*K2)*Kz-Kzo;vec3 ox31=fract(p31*K)-Ko;vec3 oy31=mod7(floor(p31*K))*K-Ko;vec3 oz31=floor(p31*K2)*Kz-Kzo;vec3 ox32=fract(p32*K)-Ko;vec3 oy32=mod7(floor(p32*K))*K-Ko;vec3 oz32=floor(p32*K2)*Kz-Kzo;vec3 ox33=fract(p33*K)-Ko;vec3 oy33=mod7(floor(p33*K))*K-Ko;vec3 oz33=floor(p33*K2)*Kz-Kzo;vec3 dx11=Pfx+jitter*ox11;vec3 dy11=Pfy.x+jitter*oy11;vec3 dz11=Pfz.x+jitter*oz11;vec3 dx12=Pfx+jitter*ox12;vec3 dy12=Pfy.x+jitter*oy12;vec3 dz12=Pfz.y+jitter*oz12;vec3 dx13=Pfx+jitter*ox13;vec3 dy13=Pfy.x+jitter*oy13;vec3 dz13=Pfz.z+jitter*oz13;vec3 dx21=Pfx+jitter*ox21;vec3 dy21=Pfy.y+jitter*oy21;vec3 dz21=Pfz.x+jitter*oz21;vec3 dx22=Pfx+jitter*ox22;vec3 dy22=Pfy.y+jitter*oy22;vec3 dz22=Pfz.y+jitter*oz22;vec3 dx23=Pfx+jitter*ox23;vec3 dy23=Pfy.y+jitter*oy23;vec3 dz23=Pfz.z+jitter*oz23;vec3 dx31=Pfx+jitter*ox31;vec3 dy31=Pfy.z+jitter*oy31;vec3 dz31=Pfz.x+jitter*oz31;vec3 dx32=Pfx+jitter*ox32;vec3 dy32=Pfy.z+jitter*oy32;vec3 dz32=Pfz.y+jitter*oz32;vec3 dx33=Pfx+jitter*ox33;vec3 dy33=Pfy.z+jitter*oy33;vec3 dz33=Pfz.z+jitter*oz33;vec3 d11=dx11*dx11+dy11*dy11+dz11*dz11;vec3 d12=dx12*dx12+dy12*dy12+dz12*dz12;vec3 d13=dx13*dx13+dy13*dy13+dz13*dz13;vec3 d21=dx21*dx21+dy21*dy21+dz21*dz21;vec3 d22=dx22*dx22+dy22*dy22+dz22*dz22;vec3 d23=dx23*dx23+dy23*dy23+dz23*dz23;vec3 d31=dx31*dx31+dy31*dy31+dz31*dz31;vec3 d32=dx32*dx32+dy32*dy32+dz32*dz32;vec3 d33=dx33*dx33+dy33*dy33+dz33*dz33;vec3 d1a=min(d11,d12);d12=max(d11,d12);d11=min(d1a,d13);d13=max(d1a,d13);d12=min(d12,d13);vec3 d2a=min(d21,d22);d22=max(d21,d22);d21=min(d2a,d23);d23=max(d2a,d23);d22=min(d22,d23);vec3 d3a=min(d31,d32);d32=max(d31,d32);d31=min(d3a,d33);d33=max(d3a,d33);d32=min(d32,d33);vec3 da=min(d11,d21);d21=max(d11,d21);d11=min(da,d31);d31=max(da,d31);d11.xy=(d11.x<d11.y)? d11.xy : d11.yx;d11.xz=(d11.x<d11.z)? d11.xz : d11.zx;d12=min(d12,d21);d12=min(d12,d22);d12=min(d12,d31);d12=min(d12,d32);d11.yz=min(d11.yz,d12.xy);d11.y=min(d11.y,d12.z);d11.y=min(d11.y,d11.z);return sqrt(d11.xy);}",noise_cellular:"#define GLSLIFY 1\n#include <noise_cellular_2D>\n#include <noise_cellular_3D>\n#include <noise_cellular_2x2>\n#include <noise_cellular_2x2x2>\n",noise_perlin_2D:"#define GLSLIFY 1\nfloat perlin(vec2 P){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}float perlin(vec2 P,vec2 rep){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod(Pi,rep.xyxy);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}",noise_perlin_3D:"#define GLSLIFY 1\nfloat perlin(vec3 P){vec3 Pi0=floor(P);vec3 Pi1=Pi0+vec3(1.0);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}float perlin(vec3 P,vec3 rep){vec3 Pi0=mod(floor(P),rep);vec3 Pi1=mod(Pi0+vec3(1.0),rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}",noise_perlin_4D:"#define GLSLIFY 1\nfloat perlin(vec4 P){vec4 Pi0=floor(P);vec4 Pi1=Pi0+1.0;Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}float perlin(vec4 P,vec4 rep){vec4 Pi0=mod(floor(P),rep);vec4 Pi1=mod(Pi0+1.0,rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}",noise_perlin:"#define GLSLIFY 1\n#include <noise_perlin_2D>\n#include <noise_perlin_3D>\n#include <noise_perlin_4D>\n",noise_psrd_2D:"#define GLSLIFY 1\nvec2 rgrad2(vec2 p,float rot){float u=permute(permute(p.x)+p.y)*0.0243902439+rot;u=fract(u)*6.28318530718;return vec2(cos(u),sin(u));}vec3 psrdnoise(vec2 pos,vec2 per,float rot){pos.y+=0.01;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 psdnoise(vec2 pos,vec2 per){return psrdnoise(pos,per,0.0);}float psrnoise(vec2 pos,vec2 per,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float psnoise(vec2 pos,vec2 per){return psrnoise(pos,per,0.0);}vec3 srdnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 sdnoise(vec2 pos){return srdnoise(pos,0.0);}float srnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float snoise(vec2 pos){return srnoise(pos,0.0);}",noise_simplex_2D:"#define GLSLIFY 1\nfloat simplex(vec2 v){const vec4 C=vec4(0.211324865405187,0.366025403784439,-0.577350269189626,0.024390243902439);vec2 i=floor(v+dot(v,C.yy));vec2 x0=v-i+dot(i,C.xx);vec2 i1;i1=(x0.x>x0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec4 x12=x0.xyxy+C.xxzz;x12.xy-=i1;i=mod289(i);vec3 p=permute(permute(i.y+vec3(0.0,i1.y,1.0))+i.x+vec3(0.0,i1.x,1.0));vec3 m=max(0.5-vec3(dot(x0,x0),dot(x12.xy,x12.xy),dot(x12.zw,x12.zw)),0.0);m=m*m;m=m*m;vec3 x=2.0*fract(p*C.www)-1.0;vec3 h=abs(x)-0.5;vec3 ox=floor(x+0.5);vec3 a0=x-ox;m*=1.79284291400159-0.85373472095314*(a0*a0+h*h);vec3 g;g.x=a0.x*x0.x+h.x*x0.y;g.yz=a0.yz*x12.xz+h.yz*x12.yw;return 130.0*dot(m,g);}",noise_simplex_3D_grad:"#define GLSLIFY 1\nfloat simplex(vec3 v,out vec3 gradient){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);vec4 m2=m*m;vec4 m4=m2*m2;vec4 pdotx=vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3));vec4 temp=m2*m*pdotx;gradient=-8.0*(temp.x*x0+temp.y*x1+temp.z*x2+temp.w*x3);gradient+=m4.x*p0+m4.y*p1+m4.z*p2+m4.w*p3;gradient*=42.0;return 42.0*dot(m4,pdotx);}",noise_simplex_3D:"#define GLSLIFY 1\nfloat simplex(vec3 v){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);m=m*m;return 42.0*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));}",noise_simplex_4D:"#define GLSLIFY 1\nvec4 grad4(float j,vec4 ip){const vec4 ones=vec4(1.0,1.0,1.0,-1.0);vec4 p,s;p.xyz=floor(fract(vec3(j)*ip.xyz)*7.0)*ip.z-1.0;p.w=1.5-dot(abs(p.xyz),ones.xyz);s=vec4(lessThan(p,vec4(0.0)));p.xyz=p.xyz+(s.xyz*2.0-1.0)*s.www;return p;}\n#define F4 0.309016994374947451\nfloat simplex(vec4 v){const vec4 C=vec4(0.138196601125011,0.276393202250021,0.414589803375032,-0.447213595499958);vec4 i=floor(v+dot(v,vec4(F4)));vec4 x0=v-i+dot(i,C.xxxx);vec4 i0;vec3 isX=step(x0.yzw,x0.xxx);vec3 isYZ=step(x0.zww,x0.yyz);i0.x=isX.x+isX.y+isX.z;i0.yzw=1.0-isX;i0.y+=isYZ.x+isYZ.y;i0.zw+=1.0-isYZ.xy;i0.z+=isYZ.z;i0.w+=1.0-isYZ.z;vec4 i3=clamp(i0,0.0,1.0);vec4 i2=clamp(i0-1.0,0.0,1.0);vec4 i1=clamp(i0-2.0,0.0,1.0);vec4 x1=x0-i1+C.xxxx;vec4 x2=x0-i2+C.yyyy;vec4 x3=x0-i3+C.zzzz;vec4 x4=x0+C.wwww;i=mod289(i);float j0=permute(permute(permute(permute(i.w)+i.z)+i.y)+i.x);vec4 j1=permute(permute(permute(permute(i.w+vec4(i1.w,i2.w,i3.w,1.0))+i.z+vec4(i1.z,i2.z,i3.z,1.0))+i.y+vec4(i1.y,i2.y,i3.y,1.0))+i.x+vec4(i1.x,i2.x,i3.x,1.0));vec4 ip=vec4(1.0/294.0,1.0/49.0,1.0/7.0,0.0);vec4 p0=grad4(j0,ip);vec4 p1=grad4(j1.x,ip);vec4 p2=grad4(j1.y,ip);vec4 p3=grad4(j1.z,ip);vec4 p4=grad4(j1.w,ip);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;p4*=taylorInvSqrt(dot(p4,p4));vec3 m0=max(0.6-vec3(dot(x0,x0),dot(x1,x1),dot(x2,x2)),0.0);vec2 m1=max(0.6-vec2(dot(x3,x3),dot(x4,x4)),0.0);m0=m0*m0;m1=m1*m1;return 49.0*(dot(m0*m0,vec3(dot(p0,x0),dot(p1,x1),dot(p2,x2)))+dot(m1*m1,vec2(dot(p3,x3),dot(p4,x4))));}",noise_simplex:"#define GLSLIFY 1\n#include <noise_simplex_2D>\n#include <noise_simplex_3D>\n#include <noise_simplex_3D_grad>\n#include <noise_simplex_4D>\n",perturbation_share:"#define GLSLIFY 1\n#ifdef HAS_PERTURBATIONMAP\nuniform sampler2D u_perturbationSampler;uniform float u_perturbationUOffset;uniform float u_perturbationVOffset;\n#endif\n",perturbation_frag:"#define GLSLIFY 1\n#ifdef HAS_PERTURBATIONMAP\nvec2 getScreenUv(){return gl_FragCoord.xy/u_resolution;}vec4 screenColor=texture2D(u_perturbationSampler,getScreenUv()+normalize(u_viewMat*vec4(normal,1.)).xy*vec2(u_perturbationUOffset,u_perturbationVOffset));gl_FragColor=mix(screenColor,gl_FragColor,gl_FragColor.a);\n#endif\n",refraction_share:"#define GLSLIFY 1\n#ifdef HAS_REFRACTIONMAP\nuniform sampler2D u_refractionSampler;uniform mat4 u_PTMMatrix;uniform float u_refractionDepth;\n#endif\n",refraction_frag:"#define GLSLIFY 1\n#ifdef HAS_REFRACTIONMAP\nvec4 refractionColor=vec4(0.);vec3 refractDir=normalize(refract(-geometry.viewDir,geometry.normal,u_refractionRatio));vec3 newPos=v_pos+refractDir*u_refractionDepth;vec4 projectionPos=u_PTMMatrix*u_projMat*u_viewMat*vec4(newPos,1.0);vec2 projectionUv=projectionPos.xy/projectionPos.w;refractionColor=texture2D(u_refractionSampler,projectionUv);gl_FragColor=mix(refractionColor,gl_FragColor,gl_FragColor.a);\n#endif\n",gamma_frag:"#define GLSLIFY 1\n#ifdef GAMMA\nfloat gamma=2.2;gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(1.0/gamma));\n#endif\n"},{pbr_common_frag_define:"#define GLSLIFY 1\n#ifndef EPSILON\n#define EPSILON 1e-6\n#endif\n#ifndef RECIPROCAL_PI\n#define RECIPROCAL_PI 0.31830988618\n#endif\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\n#define RE_Direct RE_Direct_Physical\n#define RE_IndirectDiffuse RE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular RE_IndirectSpecular_Physical\n#define Material_BlinnShininessExponent( material ) GGXRoughnessToBlinnExponent( material.specularRoughness )\n",pbr_util_frag_define:"#define GLSLIFY 1\nvec4 SRGBtoLINEAR(vec4 srgbIn){\n#ifdef MANUAL_SRGB\n#ifdef SRGB_FAST_APPROXIMATION\nvec3 linOut=pow(srgbIn.xyz,vec3(2.2));\n#else\nvec3 bLess=step(vec3(0.04045),srgbIn.xyz);vec3 linOut=mix(srgbIn.xyz/vec3(12.92),pow((srgbIn.xyz+vec3(0.055))/vec3(1.055),vec3(2.4)),bLess);\n#endif\nreturn vec4(linOut,srgbIn.w);;\n#else\nreturn srgbIn;\n#endif\n}float pow2(const in float x){return x*x;}vec3 inverseTransformDirection(in vec3 dir,in mat4 matrix){return normalize((vec4(dir,0.0)*matrix).xyz);}float punctualLightIntensityToIrradianceFactor(const in float lightDistance,const in float cutoffDistance,const in float decayExponent){if(decayExponent>0.0){\n#if defined ( PHYSICALLY_CORRECT_LIGHTS )\nfloat distanceFalloff=1.0/max(pow(lightDistance,decayExponent),0.01);float maxDistanceCutoffFactor=pow2(saturate(1.0-pow4(lightDistance/cutoffDistance)));return distanceFalloff*maxDistanceCutoffFactor;\n#else\nreturn pow(saturate(-lightDistance/cutoffDistance+1.0),decayExponent);\n#endif\n}return 1.0;}vec3 BRDF_Diffuse_Lambert(const in vec3 diffuseColor){return RECIPROCAL_PI*diffuseColor;}float GGXRoughnessToBlinnExponent(const in float ggxRoughness){return(2.0/pow2(ggxRoughness+0.0001)-2.0);}float computeSpecularOcclusion(const in float dotNV,const in float ambientOcclusion,const in float roughness){return saturate(pow(dotNV+ambientOcclusion,exp2(-16.0*roughness-1.0))-1.0+ambientOcclusion);}float getLuminance(vec3 color){return dot(color,vec3(0.2126,0.7152,0.0722));}",pbr_envmap_light_frag_define:"#define GLSLIFY 1\n#ifdef O3_HAS_ENVMAP_LIGHT\nstruct EnvMapLight{vec3 diffuse;vec3 specular;float mipMapLevel;float diffuseIntensity;float specularIntensity;mat4 transformMatrix;};uniform EnvMapLight u_envMapLight;\n#ifdef O3_USE_DIFFUSE_ENV\nuniform samplerCube u_env_diffuseSampler;\n#endif\n#ifdef O3_USE_SPECULAR_ENV\nuniform samplerCube u_env_specularSampler;\n#endif\n#endif\n",pbr_base_frag_define:"#define GLSLIFY 1\nuniform float u_alphaCutoff;uniform vec4 u_baseColorFactor;uniform float u_metal;uniform float u_roughness;uniform vec3 u_specularFactor;uniform float u_glossinessFactor;uniform vec3 u_emissiveFactor;uniform float u_envMapIntensity;uniform float u_refractionRatio;uniform vec2 u_resolution;uniform float u_normalIntensity;uniform float u_occlusionStrength;",pbr_texture_frag_define:"#define GLSLIFY 1\n#ifdef HAS_BASECOLORMAP\nuniform sampler2D u_baseColorSampler;\n#endif\n#ifdef O3_NORMAL_TEXTURE\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_EMISSIVEMAP\nuniform sampler2D u_emissiveSampler;\n#endif\n#ifdef HAS_METALMAP\nuniform sampler2D u_metallicSampler;\n#endif\n#ifdef HAS_ROUGHNESSMAP\nuniform sampler2D u_roughnessSampler;\n#endif\n#ifdef HAS_METALROUGHNESSMAP\nuniform sampler2D u_metallicRoughnessSampler;\n#endif\n#ifdef HAS_SPECULARGLOSSINESSMAP\nuniform sampler2D u_specularGlossinessSampler;\n#endif\n#ifdef HAS_OCCLUSIONMAP\nuniform sampler2D u_occlusionSampler;\n#endif\n#ifdef HAS_OPACITYMAP\nuniform sampler2D u_opacitySampler;\n#endif\n#ifdef HAS_REFLECTIONMAP\nuniform samplerCube u_reflectionSampler;\n#endif\n",pbr_runtime_frag_define:"#define GLSLIFY 1\nstruct IncidentLight{vec3 color;vec3 direction;bool visible;};struct ReflectedLight{vec3 directDiffuse;vec3 directSpecular;vec3 indirectDiffuse;vec3 indirectSpecular;};struct GeometricContext{vec3 position;vec3 normal;vec3 viewDir;};struct PhysicalMaterial{vec3 diffuseColor;float specularRoughness;vec3 specularColor;};",pbr_brdf_cook_torrance_frag_define:"#define GLSLIFY 1\nvec3 F_Schlick(const in vec3 specularColor,const in float dotLH){float fresnel=exp2((-5.55473*dotLH-6.98316)*dotLH);return(1.0-specularColor)*fresnel+specularColor;}float G_GGX_SmithCorrelated(const in float alpha,const in float dotNL,const in float dotNV){float a2=pow2(alpha);float gv=dotNL*sqrt(a2+(1.0-a2)*pow2(dotNV));float gl=dotNV*sqrt(a2+(1.0-a2)*pow2(dotNL));return 0.5/max(gv+gl,EPSILON);}float D_GGX(const in float alpha,const in float dotNH){float a2=pow2(alpha);float denom=pow2(dotNH)*(a2-1.0)+1.0;return RECIPROCAL_PI*a2/pow2(denom);}vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight,const in GeometricContext geometry,const in vec3 specularColor,const in float roughness){float alpha=pow2(roughness);vec3 halfDir=normalize(incidentLight.direction+geometry.viewDir);float dotNL=saturate(dot(geometry.normal,incidentLight.direction));float dotNV=saturate(dot(geometry.normal,geometry.viewDir));float dotNH=saturate(dot(geometry.normal,halfDir));float dotLH=saturate(dot(incidentLight.direction,halfDir));vec3 F=F_Schlick(specularColor,dotLH);float G=G_GGX_SmithCorrelated(alpha,dotNL,dotNV);float D=D_GGX(alpha,dotNH);return F*(G*D);}",pbr_direct_irradiance_frag_define:"#define GLSLIFY 1\nvoid RE_Direct_Physical(const in IncidentLight directLight,const in GeometricContext geometry,const in PhysicalMaterial material,inout ReflectedLight reflectedLight){float dotNL=saturate(dot(geometry.normal,directLight.direction));vec3 irradiance=dotNL*directLight.color;\n#ifndef PHYSICALLY_CORRECT_LIGHTS\nirradiance*=PI;\n#endif\nreflectedLight.directSpecular+=irradiance*BRDF_Specular_GGX(directLight,geometry,material.specularColor,material.specularRoughness);reflectedLight.directDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);}\n#ifdef O3_DIRECT_LIGHT_COUNT\nvoid getDirectionalDirectLightIrradiance(const in DirectLight directionalLight,const in GeometricContext geometry,out IncidentLight directLight){directLight.color=directionalLight.color;directLight.direction=-directionalLight.direction;directLight.visible=true;}\n#endif\n#ifdef O3_POINT_LIGHT_COUNT\nvoid getPointDirectLightIrradiance(const in PointLight pointLight,const in GeometricContext geometry,out IncidentLight directLight){vec3 lVector=pointLight.position-geometry.position;directLight.direction=normalize(lVector);float lightDistance=length(lVector);directLight.color=pointLight.color;directLight.color*=punctualLightIntensityToIrradianceFactor(lightDistance,pointLight.distance,pointLight.decay);directLight.visible=(directLight.color!=vec3(0.0));}\n#endif\n#ifdef O3_SPOT_LIGHT_COUNT\nvoid getSpotDirectLightIrradiance(const in SpotLight spotLight,const in GeometricContext geometry,out IncidentLight directLight){vec3 lVector=spotLight.position-geometry.position;directLight.direction=normalize(lVector);float lightDistance=length(lVector);float angleCos=dot(directLight.direction,-spotLight.direction);if(angleCos>spotLight.coneCos){float spotEffect=smoothstep(spotLight.coneCos,spotLight.penumbraCos,angleCos);directLight.color=spotLight.color;directLight.color*=spotEffect*punctualLightIntensityToIrradianceFactor(lightDistance,spotLight.distance,spotLight.decay);directLight.visible=true;}else{directLight.color=vec3(0.0);directLight.visible=false;}}\n#endif\n",pbr_ibl_specular_frag_define:"#define GLSLIFY 1\nvec3 BRDF_Specular_GGX_Environment(const in GeometricContext geometry,const in vec3 specularColor,const in float roughness){float dotNV=saturate(dot(geometry.normal,geometry.viewDir));const vec4 c0=vec4(-1,-0.0275,-0.572,0.022);const vec4 c1=vec4(1,0.0425,1.04,-0.04);vec4 r=roughness*c0+c1;float a004=min(r.x*r.x,exp2(-9.28*dotNV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}float getSpecularMIPLevel(const in float blinnShininessExponent,const in int maxMIPLevel){float maxMIPLevelScalar=float(maxMIPLevel);float desiredMIPLevel=maxMIPLevelScalar+0.79248-0.5*log2(pow2(blinnShininessExponent)+1.0);return clamp(desiredMIPLevel,0.0,maxMIPLevelScalar);}\n#ifdef O3_HAS_ENVMAP_LIGHT\nvec3 getLightProbeIndirectRadiance(const in GeometricContext geometry,const in float blinnShininessExponent,const in int maxMIPLevel){\n#if !defined(O3_USE_SPECULAR_ENV) && !defined(HAS_REFLECTIONMAP)\nreturn u_envMapLight.specular*u_envMapLight.specularIntensity*u_envMapIntensity;\n#else\n#ifdef ENVMAPMODE_REFRACT\nvec3 reflectVec=refract(-geometry.viewDir,geometry.normal,u_refractionRatio);\n#else\nvec3 reflectVec=reflect(-geometry.viewDir,geometry.normal);\n#endif\nreflectVec=mat3(u_envMapLight.transformMatrix)*reflectVec;float specularMIPLevel=getSpecularMIPLevel(blinnShininessExponent,maxMIPLevel);\n#ifdef HAS_TEX_LOD\n#ifdef HAS_REFLECTIONMAP\nvec4 envMapColor=textureCubeLodEXT(u_reflectionSampler,reflectVec,specularMIPLevel);\n#else\nvec4 envMapColor=textureCubeLodEXT(u_env_specularSampler,reflectVec,specularMIPLevel);\n#endif\n#else\n#ifdef HAS_REFLECTIONMAP\nvec4 envMapColor=textureCube(u_reflectionSampler,reflectVec,specularMIPLevel);\n#else\nvec4 envMapColor=textureCube(u_env_specularSampler,reflectVec,specularMIPLevel);\n#endif\n#endif\nenvMapColor.rgb=SRGBtoLINEAR(envMapColor*u_envMapLight.specularIntensity*u_envMapIntensity).rgb;return envMapColor.rgb;\n#endif\n}\n#endif\nvoid RE_IndirectSpecular_Physical(const in vec3 radiance,const in GeometricContext geometry,const in PhysicalMaterial material,inout ReflectedLight reflectedLight){float dotNV=saturate(dot(geometry.normal,geometry.viewDir));float dotNL=dotNV;reflectedLight.indirectSpecular+=radiance*BRDF_Specular_GGX_Environment(geometry,material.specularColor,material.specularRoughness);}",pbr_ibl_diffuse_frag_define:"#define GLSLIFY 1\nvoid RE_IndirectDiffuse_Physical(const in vec3 irradiance,const in GeometricContext geometry,const in PhysicalMaterial material,inout ReflectedLight reflectedLight){reflectedLight.indirectDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);}\n#ifdef O3_HAS_AMBIENT_LIGHT\nvec3 getAmbientLightIrradiance(const in vec3 ambientLightColor){vec3 irradiance=ambientLightColor;\n#ifndef PHYSICALLY_CORRECT_LIGHTS\nirradiance*=PI;\n#endif\nreturn irradiance;}\n#endif\n",pbr_begin_frag:"#define GLSLIFY 1\nvec3 normal=getNormal();vec4 diffuseColor=u_baseColorFactor;vec3 totalEmissiveRadiance=u_emissiveFactor;float metalnessFactor=u_metal;float roughnessFactor=u_roughness;vec3 specularFactor=u_specularFactor;float glossinessFactor=u_glossinessFactor;ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));PhysicalMaterial material;GeometricContext geometry;IncidentLight directLight;\n#ifdef HAS_BASECOLORMAP\nvec4 baseMapColor=texture2D(u_baseColorSampler,v_uv);baseMapColor=SRGBtoLINEAR(baseMapColor);diffuseColor*=baseMapColor;\n#endif\n#ifdef O3_HAS_VERTEXCOLOR\ndiffuseColor.rgb*=v_color.rgb;\n#ifdef O3_HAS_VERTEXALPHA\ndiffuseColor.a*=v_color.a;\n#endif\n#endif\n#if defined(ALPHA_BLEND) && defined(HAS_OPACITYMAP)\n#ifdef GETOPACITYFROMRGB\ndiffuseColor.a*=getLuminance(texture2D(u_opacitySampler,v_uv).rgb);\n#else\ndiffuseColor.a*=texture2D(u_opacitySampler,v_uv).a;\n#endif\n#endif\n#ifdef ALPHA_CUTOFF\nif(diffuseColor.a<u_alphaCutoff){discard;}\n#endif\n#ifdef HAS_METALROUGHNESSMAP\nvec4 metalRoughMapColor=texture2D(u_metallicRoughnessSampler,v_uv);metalnessFactor*=metalRoughMapColor.b;roughnessFactor*=metalRoughMapColor.g;\n#else\n#ifdef HAS_METALMAP\nvec4 metalMapColor=texture2D(u_metallicSampler,v_uv);metalnessFactor*=metalMapColor.b;\n#endif\n#ifdef HAS_ROUGHNESSMAP\nvec4 roughMapColor=texture2D(u_roughnessSampler,v_uv);roughnessFactor*=roughMapColor.g;\n#endif\n#endif\n#ifdef HAS_SPECULARGLOSSINESSMAP\nvec4 specularGlossinessColor=texture2D(u_specularGlossinessSampler,v_uv);specularFactor*=specularGlossinessColor.rgb;glossinessFactor*=specularGlossinessColor.a;\n#endif\n#ifdef IS_METALLIC_WORKFLOW\nmaterial.diffuseColor=diffuseColor.rgb*(1.0-metalnessFactor);material.specularRoughness=clamp(roughnessFactor,0.04,1.0);material.specularColor=mix(vec3(MAXIMUM_SPECULAR_COEFFICIENT),diffuseColor.rgb,metalnessFactor);\n#else\nfloat specularStrength=max(max(specularFactor.r,specularFactor.g),specularFactor.b);material.diffuseColor=diffuseColor.rgb*(1.0-specularStrength);material.specularRoughness=clamp(1.0-glossinessFactor,0.04,1.0);material.specularColor=specularFactor;\n#endif\ngeometry.position=v_pos;geometry.normal=normal;geometry.viewDir=normalize(u_cameraPos-v_pos);",pbr_direct_irradiance_frag:"#define GLSLIFY 1\n#if defined( O3_DIRECT_LIGHT_COUNT ) && defined( RE_Direct )\nDirectLight directionalLight;for(int i=0;i<O3_DIRECT_LIGHT_COUNT;i++){directionalLight.color=u_directLightColor[i];directionalLight.direction=u_directLightDirection[i];getDirectionalDirectLightIrradiance(directionalLight,geometry,directLight);RE_Direct(directLight,geometry,material,reflectedLight);}\n#endif\n#if defined( O3_POINT_LIGHT_COUNT ) && defined( RE_Direct )\nPointLight pointLight;for(int i=0;i<O3_POINT_LIGHT_COUNT;i++){pointLight.color=u_pointLightColor[i];pointLight.position=u_pointLightPosition[i];pointLight.distance=u_pointLightDistance[i];pointLight.decay=u_pointLightDecay[i];getPointDirectLightIrradiance(pointLight,geometry,directLight);RE_Direct(directLight,geometry,material,reflectedLight);}\n#endif\n#if defined( O3_SPOT_LIGHT_COUNT ) && defined( RE_Direct )\nSpotLight spotLight;for(int i=0;i<O3_SPOT_LIGHT_COUNT;i++){spotLight.color=u_spotLightColor[i];spotLight.position=u_spotLightPosition[i];spotLight.direction=u_spotLightDirection[i];spotLight.distance=u_spotLightDistance[i];spotLight.decay=u_spotLightDecay[i];spotLight.angle=u_spotLightAngle[i];spotLight.penumbra=u_spotLightPenumbra[i];spotLight.penumbraCos=u_spotLightPenumbraCos[i];spotLight.coneCos=u_spotLightConeCos[i];getSpotDirectLightIrradiance(spotLight,geometry,directLight);RE_Direct(directLight,geometry,material,reflectedLight);}\n#endif\n",pbr_ibl_diffuse_frag:"#define GLSLIFY 1\n#if defined(RE_IndirectDiffuse)\nvec3 irradiance=vec3(0);\n#if defined(O3_HAS_AMBIENT_LIGHT)\nirradiance+=getAmbientLightIrradiance(u_ambientLightColor);\n#endif\n#if defined(O3_HAS_ENVMAP_LIGHT)\n#ifdef O3_USE_DIFFUSE_ENV\nvec3 lightMapIrradiance=textureCube(u_env_diffuseSampler,geometry.normal).rgb*u_envMapLight.diffuseIntensity;\n#else\nvec3 lightMapIrradiance=u_envMapLight.diffuse*u_envMapLight.diffuseIntensity;\n#endif\n#ifndef PHYSICALLY_CORRECT_LIGHTS\nlightMapIrradiance*=PI;\n#endif\nirradiance+=lightMapIrradiance;\n#endif\nRE_IndirectDiffuse(irradiance,geometry,material,reflectedLight);\n#endif\n",pbr_ibl_specular_frag:"#define GLSLIFY 1\n#if defined( RE_IndirectSpecular )\nvec3 radiance=vec3(0.0);\n#endif\n#if defined( O3_HAS_ENVMAP_LIGHT ) && defined( RE_IndirectSpecular )\nradiance+=getLightProbeIndirectRadiance(geometry,Material_BlinnShininessExponent(material),int(u_envMapLight.mipMapLevel));\n#endif\n#if defined( RE_IndirectSpecular )\nRE_IndirectSpecular(radiance,geometry,material,reflectedLight);\n#endif\n",pbr_end_frag:"#define GLSLIFY 1\n#ifdef HAS_OCCLUSIONMAP\nfloat ambientOcclusion=(texture2D(u_occlusionSampler,v_uv).r-1.0)*u_occlusionStrength+1.0;reflectedLight.indirectDiffuse*=ambientOcclusion;\n#if defined(O3_USE_SPECULAR_ENV)\nfloat dotNV=saturate(dot(geometry.normal,geometry.viewDir));reflectedLight.indirectSpecular*=computeSpecularOcclusion(dotNV,ambientOcclusion,material.specularRoughness);\n#endif\n#endif\n#ifdef HAS_EMISSIVEMAP\nvec4 emissiveMapColor=texture2D(u_emissiveSampler,v_uv);emissiveMapColor=SRGBtoLINEAR(emissiveMapColor);totalEmissiveRadiance*=emissiveMapColor.rgb;\n#endif\nvec3 outgoingLight=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+totalEmissiveRadiance;gl_FragColor=vec4(outgoingLight,diffuseColor.a);"}),{},{normal_get:"#define GLSLIFY 1\nvec3 getNormal(){\n#ifdef O3_NORMAL_TEXTURE\n#ifndef O3_HAS_TANGENT\n#ifdef HAS_DERIVATIVES\nvec3 pos_dx=dFdx(v_pos);vec3 pos_dy=dFdy(v_pos);vec3 tex_dx=dFdx(vec3(v_uv,0.0));vec3 tex_dy=dFdy(vec3(v_uv,0.0));vec3 t=(tex_dy.t*pos_dx-tex_dx.t*pos_dy)/(tex_dx.s*tex_dy.t-tex_dy.s*tex_dx.t);\n#ifdef O3_HAS_NORMAL\nvec3 ng=normalize(v_normal);\n#else\nvec3 ng=normalize(cross(pos_dx,pos_dy));\n#endif\nt=normalize(t-ng*dot(ng,t));vec3 b=normalize(cross(ng,t));mat3 tbn=mat3(t,b,ng);\n#else\n#ifdef O3_HAS_NORMAL\nvec3 ng=normalize(v_normal);\n#else\nvec3 ng=vec3(0.0,0.0,1.0);\n#endif\nmat3 tbn=mat3(vec3(0.0),vec3(0.0),ng);\n#endif\n#else\nmat3 tbn=v_TBN;\n#endif\nvec3 n=texture2D(u_normalTexture,v_uv).rgb;n=normalize(tbn*((2.0*n-1.0)*vec3(u_normalIntensity,u_normalIntensity,1.0)));\n#else\n#ifdef O3_HAS_NORMAL\nvec3 n=normalize(v_normal);\n#elif defined(HAS_DERIVATIVES)\nvec3 pos_dx=dFdx(v_pos);vec3 pos_dy=dFdy(v_pos);vec3 n=normalize(cross(pos_dx,pos_dy));\n#else\nvec3 n=vec3(0.0,0.0,1.0);\n#endif\n#endif\nn*=float(gl_FrontFacing)*2.0-1.0;return n;}"}),wt=function(){function e(){}return e.parseShaderName=function(e){return"#define O3_SHADER_NAME "+e+"\n"},e.parseCustomMacros=function(e){return"#define O3_CUSTOM_MACROS_START\n"+e.map((function(e){return"#define "+e+"\n"})).join("")+"#define O3_CUSTOM_MACROS_END\n"},e.parseIncludes=function(t){return t.replace(/^[ \t]*#include +<([\w\d.]+)>/gm,(function(t,n){var i=xt[n];return void 0===i?(me.error('Shader slice "'+t.trim()+'" not founded.'),""):e.parseIncludes(i)}))},e.parseExtension=function(e){return"#define O3_EXTENSION_START\n"+e.map((function(e){return"#extension "+e+" : enable\n"})).join("")+"#define O3_EXTENSION_END\n"},e.convertTo300=function(e,t){if(e=(e=(e=(e=e.replace(/\battribute\b/g,"in")).replace(/\bvarying\b/g,t?"in":"out")).replace(/\btexture(2D|Cube)\s*\(/g,"texture(")).replace(/\btexture(2D|Cube)LodEXT\s*\(/g,"textureLod("),t)if(/\bgl_FragData\[.+?\]/g.test(e)){var n=(e=e.replace(/\bgl_FragColor\b/g,"gl_FragData[0]")).match(/\bgl_FragData\[.+?\]/g);e=this._replaceMRTShader(e,n)}else e=(e=e.replace(/void\s+?main\s*\(/g,"out vec4 glFragColor;\nvoid main(")).replace(/\bgl_FragColor\b/g,"glFragColor");return e},e._replaceMRTShader=function(e,t){for(var n="",i=new Set,r=0;r<t.length;r++){var a=t[r].match(/\bgl_FragData\[(.+?)\]/);i.add(a[1])}return i.forEach((function(e){n+="layout(location="+e+") out vec4 fragOutColor"+e+";\n"})),n+="void main(",e=(e=e.replace(/\bgl_FragData\[(.+?)\]/g,"fragOutColor$1")).replace(/void\s+?main\s*\(/g,n)},e}(),bt=function(e,t,n){this.name=void 0,this._index=void 0,this._value=void 0,this.name=e,this._index=t,this._value=n};(yt=mt||(mt={}))[yt.Scene=0]="Scene",yt[yt.Camera=1]="Camera",yt[yt.Renderer=2]="Renderer",yt[yt.Material=3]="Material";var At=function(){function e(e){this.name=void 0,this.propertyId=void 0,this.location=void 0,this.textureIndex=void 0,this.applyFunc=void 0,this.cacheValue=void 0,this._rhi=void 0,this._gl=void 0;var t=e._hardwareRenderer;this._rhi=t,this._gl=t.gl}var t=e.prototype;return t.upload1f=function(e,t){this.cacheValue!==t&&(this._gl.uniform1f(e.location,t),this.cacheValue=t)},t.upload1fv=function(e,t){this._gl.uniform1fv(e.location,t)},t.upload2f=function(e,t){var n=this.cacheValue;void 0!==t.r?n.x===t.r&&n.y===t.g||(this._gl.uniform2f(e.location,t.r,t.g),n.x=t.r,n.y=t.g):n.x===t.x&&n.y===t.y||(this._gl.uniform2f(e.location,t.x,t.y),n.x=t.x,n.y=t.y)},t.upload2fv=function(e,t){this._gl.uniform2fv(e.location,t)},t.upload3f=function(e,t){var n=this.cacheValue;void 0!==t.r?n.x===t.r&&n.y===t.g&&n.z===t.b||(this._gl.uniform3f(e.location,t.r,t.g,t.b),n.x=t.r,n.y=t.g,n.z=t.b):n.x===t.x&&n.y===t.y&&n.z===t.z||(this._gl.uniform3f(e.location,t.x,t.y,t.z),n.x=t.x,n.y=t.y,n.z=t.z)},t.upload3fv=function(e,t){this._gl.uniform3fv(e.location,t)},t.upload4f=function(e,t){var n=this.cacheValue;void 0!==t.r?n.x===t.r&&n.y===t.g&&n.z===t.b&&n.w===t.a||(this._gl.uniform4f(e.location,t.r,t.g,t.b,t.a),n.x=t.r,n.y=t.g,n.z=t.b,n.w=t.a):n.x===t.x&&n.y===t.y&&n.z===t.z&&n.w===t.w||(this._gl.uniform4f(e.location,t.x,t.y,t.z,t.w),n.x=t.x,n.y=t.y,n.z=t.z,n.w=t.w)},t.upload4fv=function(e,t){this._gl.uniform4fv(e.location,t)},t.upload1i=function(e,t){this.cacheValue!==t&&(this._gl.uniform1i(e.location,t),this.cacheValue=t)},t.upload1iv=function(e,t){this._gl.uniform1iv(e.location,t)},t.upload2i=function(e,t){var n=this.cacheValue;void 0!==t.r?n.x===t.r&&n.y===t.g||(this._gl.uniform2i(e.location,t.r,t.g),n.x=t.r,n.y=t.g):n.x===t.x&&n.y===t.y||(this._gl.uniform2i(e.location,t.x,t.y),n.x=t.x,n.y=t.y)},t.upload2iv=function(e,t){this._gl.uniform2iv(e.location,t)},t.upload3i=function(e,t){var n=this.cacheValue;void 0!==t.r?n.x===t.r&&n.y===t.g&&n.z===t.b||(this._gl.uniform3i(e.location,t.r,t.g,t.b),n.x=t.r,n.y=t.g,n.z=t.b):n.x===t.x&&n.y===t.y&&n.z===t.z||(this._gl.uniform3i(e.location,t.x,t.y,t.z),n.x=t.x,n.y=t.y,n.z=t.z)},t.upload3iv=function(e,t){this._gl.uniform3iv(e.location,t)},t.upload4i=function(e,t){var n=this.cacheValue;void 0!==t.r?n.x===t.r&&n.y===t.g&&n.z===t.b&&n.w===t.a||(this._gl.uniform4i(e.location,t.r,t.g,t.b,t.a),n.x=t.r,n.y=t.g,n.z=t.b,n.w=t.a):n.x===t.x&&n.y===t.y&&n.z===t.z&&n.w===t.w||(this._gl.uniform4i(e.location,t.x,t.y,t.z,t.w),n.x=t.x,n.y=t.y,n.z=t.z,n.w=t.w)},t.upload4iv=function(e,t){this._gl.uniform4iv(e.location,t)},t.uploadMat4=function(e,t){this._gl.uniformMatrix4fv(e.location,!1,t.elements)},t.uploadMat4v=function(e,t){this._gl.uniformMatrix4fv(e.location,!1,t)},t.uploadTexture=function(e,t){var n=this._rhi;n.activeTexture(e.textureIndex),n.bindTexture(t._platformTexture)},t.uploadTextureArray=function(e,t){for(var n=this._rhi,i=e.textureIndex,r=0;r<t.length;r++){var a=t[r];n.activeTexture(i[r]),n.bindTexture(a._platformTexture)}},e}(),Tt=function(){this.constUniforms=[],this.textureUniforms=[]},Mt=function(){function e(t,n,i){this.id=void 0,this.sceneUniformBlock=new Tt,this.cameraUniformBlock=new Tt,this.rendererUniformBlock=new Tt,this.materialUniformBlock=new Tt,this.otherUniformBlock=new Tt,this._uploadRenderCount=-1,this._uploadCamera=void 0,this._uploadRenderer=void 0,this._uploadMaterial=void 0,this.attributeLocation=Object.create(null),this._isValid=void 0,this._engine=void 0,this._gl=void 0,this._vertexShader=void 0,this._fragmentShader=void 0,this._glProgram=void 0,this._activeTextureUint=0,this._engine=t,this._gl=t._hardwareRenderer.gl,this._glProgram=this._createProgram(n,i),this._glProgram?(this._isValid=!0,this._recordLocation()):this._isValid=!1,this.id=e._counter++}e._addLineNum=function(e){var t,n=e.split("\n"),i=(n.length+1).toString().length+6;return n.map((function(e,n){if((t="0:"+(n+1)).length>=i)return t.substring(0,i)+e;for(var r=0;r<i-t.length;r++)t+=" ";return t+e})).join("\n")};var t=e.prototype;return t.uploadAll=function(e,t){this.uploadUniforms(e,t),this.uploadTextures(e,t)},t.uploadUniforms=function(e,t){for(var n=t._properties,i=e.constUniforms,r=0,a=i.length;r<a;r++){var o=i[r],s=n[o.propertyId];null!=s&&o.applyFunc(o,s)}},t.uploadTextures=function(e,t){var n=t._properties,i=e.textureUniforms;if(i)for(var r=0,a=i.length;r<a;r++){var o=i[r],s=n[o.propertyId];null!=s&&o.applyFunc(o,s)}},t.groupingOtherUniformBlock=function(){var e=this.otherUniformBlock,t=e.constUniforms,n=e.textureUniforms;t.length>0&&this._groupingSubOtherUniforms(t,!1),n.length>0&&this._groupingSubOtherUniforms(n,!0)},t.bind=function(){var e=this._engine._hardwareRenderer;return e._currentBind!==this&&(this._gl.useProgram(this._glProgram),e._currentBind=this,!0)},t.destroy=function(){var e=this._gl;this._vertexShader&&e.deleteShader(this._vertexShader),this._fragmentShader&&e.deleteShader(this._fragmentShader),this._glProgram&&e.deleteProgram(this._glProgram)},t._groupingSubOtherUniforms=function(e,t){for(var n=e.length-1;n>=0;n--){var i=e[n],r=Pt._getShaderPropertyGroup(i.name);void 0!==r&&(e.splice(e.indexOf(i),1),this._groupingUniform(i,r,t))}},t._groupingUniform=function(e,t,n){switch(t){case mt.Scene:n?this.sceneUniformBlock.textureUniforms.push(e):this.sceneUniformBlock.constUniforms.push(e);break;case mt.Camera:n?this.cameraUniformBlock.textureUniforms.push(e):this.cameraUniformBlock.constUniforms.push(e);break;case mt.Renderer:n?this.rendererUniformBlock.textureUniforms.push(e):this.rendererUniformBlock.constUniforms.push(e);break;case mt.Material:n?this.materialUniformBlock.textureUniforms.push(e):this.materialUniformBlock.constUniforms.push(e);break;default:n?this.otherUniformBlock.textureUniforms.push(e):this.otherUniformBlock.constUniforms.push(e)}},t._createProgram=function(e,t){var n=this._gl,i=this._createShader(n.VERTEX_SHADER,e);if(!i)return null;var r=this._createShader(n.FRAGMENT_SHADER,t);if(!r)return null;var a=n.createProgram();return n.attachShader(a,i),n.attachShader(a,r),n.linkProgram(a),n.validateProgram(a),n.isContextLost()?(me.error("Contex lost while linking program."),n.deleteShader(i),n.deleteShader(r),null):n.getProgramParameter(a,n.LINK_STATUS)?(this._vertexShader=i,this._fragmentShader=r,a):(me.error("Could not link WebGL program. \n"+n.getProgramInfoLog(a)),n.deleteProgram(a),null)},t._createShader=function(t,n){var i=this._gl,r=i.createShader(t);return r?(i.shaderSource(r,n),i.compileShader(r),i.isContextLost()?(me.error("Context lost while compiling shader."),i.deleteShader(r),null):i.getShaderParameter(r,i.COMPILE_STATUS)?r:(me.error("Could not compile WebGL shader.\n"+i.getShaderInfoLog(r),e._addLineNum(n)),i.deleteShader(r),null)):(me.error("Context lost while create shader."),null)},t._recordLocation=function(){var e=this,t=this._gl,n=this._glProgram,i=this._getUniformInfos(),r=this._getAttributeInfos();i.forEach((function(i){var r=i.name,a=i.size,o=i.type,c=new At(e._engine),l=!1,u=!1;r.indexOf("[0]")>0&&(r=r.substr(0,r.length-3),l=!0);var h=Pt._getShaderPropertyGroup(r),d=t.getUniformLocation(n,r);switch(c.name=r,c.propertyId=Pt.getPropertyByName(r)._uniqueId,c.location=d,o){case t.FLOAT:l?c.applyFunc=c.upload1fv:(c.applyFunc=c.upload1f,c.cacheValue=0);break;case t.FLOAT_VEC2:l?c.applyFunc=c.upload2fv:(c.applyFunc=c.upload2f,c.cacheValue=new v(0,0));break;case t.FLOAT_VEC3:l?c.applyFunc=c.upload3fv:(c.applyFunc=c.upload3f,c.cacheValue=new s(0,0,0));break;case t.FLOAT_VEC4:l?c.applyFunc=c.upload4fv:(c.applyFunc=c.upload4f,c.cacheValue=new m(0,0,0,0));break;case t.BOOL:case t.INT:l?c.applyFunc=c.upload1iv:(c.applyFunc=c.upload1i,c.cacheValue=0);break;case t.BOOL_VEC2:case t.INT_VEC2:l?c.applyFunc=c.upload2iv:(c.applyFunc=c.upload2i,c.cacheValue=new v(0,0));break;case t.BOOL_VEC3:case t.INT_VEC3:c.applyFunc=l?c.upload3iv:c.upload3i,c.cacheValue=new s(0,0,0);break;case t.BOOL_VEC4:case t.INT_VEC4:l?c.applyFunc=c.upload4iv:(c.applyFunc=c.upload4i,c.cacheValue=new m(0,0,0));break;case t.FLOAT_MAT4:c.applyFunc=l?c.uploadMat4v:c.uploadMat4;break;case t.SAMPLER_2D:case t.SAMPLER_CUBE:if(u=!0,l){for(var f=new Int32Array(a),_=new Array(a),p=0;p<a;p++)f[p]=e._activeTextureUint,_[p]=t.TEXTURE0+e._activeTextureUint++;c.textureIndex=_,c.applyFunc=c.uploadTextureArray,e.bind(),t.uniform1iv(d,f)}else{var g=t.TEXTURE0+e._activeTextureUint;c.textureIndex=g,c.applyFunc=c.uploadTexture,e.bind(),t.uniform1i(d,e._activeTextureUint++)}}e._groupingUniform(c,h,u)})),r.forEach((function(i){var r=i.name;e.attributeLocation[r]=t.getAttribLocation(n,r)}))},t._getUniformInfos=function(){for(var e=this._gl,t=this._glProgram,n=[],i=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),r=0;r<i;++r){var a=e.getActiveUniform(t,r);n[r]=a}return n},t._getAttributeInfos=function(){for(var e=this._gl,t=this._glProgram,n=[],i=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),r=0;r<i;++r){var a=e.getActiveAttrib(t,r);n[r]=a}return n},T(e,[{key:"isValid",get:function(){return this._isValid}}]),e}();Mt._counter=0;var Ct=function e(){this._uniqueId=void 0,this._group=void 0,this._uniqueId=e._propertyNameCounter++};Ct._propertyNameCounter=0;var Pt=function(){function e(t,n,i){this.name=void 0,this._shaderId=0,this._vertexSource=void 0,this._fragmentSource=void 0,this._shaderId=e._shaderCounter++,this.name=t,this._vertexSource=n,this._fragmentSource=i}e.create=function(t,n,i){var r=e._shaderMap;if(r[t])throw'Shader named "'+t+'" already exists.';return r[t]=new e(t,n,i)},e.find=function(t){return e._shaderMap[t]},e.getMacroByName=function(t){var n=e._macroMap[t];if(!n){var i=e._macroMaskMap,r=e._macroCounter,a=Math.floor(r/32),o=r%32;n=new bt(t,a,1<<o),e._macroMap[t]=n,a==i.length&&(i.length++,i[a]=new Array(32)),i[a][o]=t,e._macroCounter++}return n},e.getPropertyByName=function(t){var n=e._propertyNameMap;if(null!=n[t])return n[t];var i=new Ct;return n[t]=i,i},e._getShaderPropertyGroup=function(t){var n=e._propertyNameMap[t];return null==n?void 0:n._group},e._getNamesByMacros=function(t,n){var i=e._macroMaskMap,r=t._mask;n.length=0;for(var a=0,o=t._length;a<o;a++)for(var s=i[a],c=r[a],l=c<0?32:Math.floor(Math.log2(c))+1,u=0;u<l;u++)c&1<<u&&n.push(s[u])};var t=e.prototype;return t.compileVariant=function(t,n){var i=e._compileMacros;i.clear();for(var r=0,a=n.length;r<a;r++)i.enable(e.getMacroByName(n[r]));this._getShaderProgram(t,i)},t._getShaderProgram=function(t,n){var i=t._getShaderProgramPool(this),r=i.get(n);if(r)return r;var a=t._hardwareRenderer.isWebGL2,o=[];e._getNamesByMacros(n,o);var s=wt.parseCustomMacros(o),c=wt.parseShaderName(this.name||"VOID"),l=a?"#version 300 es":"#version 100",u="\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n      precision highp float;\n      precision highp int;\n      #define O3_VERTEX_PRECISION highp\n      #define O3_FRAGMENT_PRECISION highp\n    #else\n      precision mediump float;\n      precision mediump int;\n      #define O3_VERTEX_PRECISION mediump\n      #define O3_FRAGMENT_PRECISION mediump\n    #endif\n    ",h=wt.parseIncludes(" "+l+"\n        "+c+"\n        "+u+"\n        "+s+"\n        "+this._vertexSource),d=wt.parseIncludes(" "+l+"\n        "+c+"\n        "+(a?"":wt.parseExtension(e._shaderExtension))+"\n        "+u+"\n        "+s+"\n      "+this._fragmentSource);return a&&(h=wt.convertTo300(h),d=wt.convertTo300(d,!0)),r=new Mt(t,h,d),i.cache(r),r},e}();Pt._compileMacros=new we,Pt._shaderCounter=0,Pt._shaderMap=Object.create(null),Pt._propertyNameMap=Object.create(null),Pt._macroMaskMap=[],Pt._macroCounter=0,Pt._macroMap=Object.create(null),Pt._shaderExtension=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives","GL_EXT_draw_buffers"];var St=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._viewMat=void 0,t._inverseViewMat=void 0,t}R(t,e);var n=t.prototype;return n._onEnable=function(){this.scene.findFeature(It).attachRenderLight(this)},n._onDisable=function(){this.scene.findFeature(It).detachRenderLight(this)},T(t,[{key:"viewMatrix",get:function(){return this._viewMat||(this._viewMat=new p),p.invert(this.entity.transform.worldMatrix,this._viewMat),this._viewMat}},{key:"inverseViewMatrix",get:function(){return this._inverseViewMat||(this._inverseViewMat=new p),p.invert(this.viewMatrix,this._inverseViewMat),this._inverseViewMat}}]),t}(Qe);St._maxLight=10;var Rt=function(e){function t(t){var n;return(n=e.call(this,t)||this)._color=new w(1,1,1,1),n._intensity=1,n._lightColor=new w(1,1,1,1),n.color=n._color,n}return R(t,e),T(t,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this.scene.shaderData.setColor(t._colorProperty,this.lightColor)}},{key:"intensity",get:function(){return this._intensity},set:function(e){this._intensity=e,this.scene.shaderData.setColor(t._colorProperty,this.lightColor)}},{key:"lightColor",get:function(){return this._lightColor.r=this._color.r*this._intensity,this._lightColor.g=this._color.g*this._intensity,this._lightColor.b=this._color.b*this._intensity,this._lightColor.a=this._color.a*this._intensity,this._lightColor}}]),t}(St);Rt._colorProperty=Pt.getPropertyByName("u_ambientLightColor");var Et=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).color=new w(1,1,1,1),t.intensity=1,t._forward=new s,t._lightColor=new w(1,1,1,1),t._reverseDirection=new s,t}return R(t,e),t._updateShaderData=function(e){var n=t._combinedData;e.setFloatArray(t._colorProperty,n.color),e.setFloatArray(t._directionProperty,n.direction)},t.prototype._appendData=function(e){var n=3*e,i=3*e,r=this.lightColor,a=this.direction,o=t._combinedData;o.color[n]=r.r,o.color[n+1]=r.g,o.color[n+2]=r.b,o.direction[i]=a.x,o.direction[i+1]=a.y,o.direction[i+2]=a.z},T(t,[{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}},{key:"reverseDirection",get:function(){return s.scale(this.direction,-1,this._reverseDirection),this._reverseDirection}}]),t}(St);Et._colorProperty=Pt.getPropertyByName("u_directLightColor"),Et._directionProperty=Pt.getPropertyByName("u_directLightDirection"),Et._combinedData={color:new Float32Array(3*St._maxLight),direction:new Float32Array(3*St._maxLight)};var Lt=function(e){function t(t){var n;return(n=e.call(this,t)||this)._diffuseTexture=void 0,n._specularTexture=void 0,n._diffuseColor=new w(.3,.3,.3,1),n._specularColor=new w(.5,.5,.5,1),n._diffuseIntensity=1,n._specularIntensity=1,n.diffuseColor=n._diffuseColor,n.specularColor=n._specularColor,n.diffuseIntensity=n._diffuseIntensity,n.specularIntensity=n._specularIntensity,n}return R(t,e),t._updateShaderData=function(e,n){var i=n.entity.transform.worldMatrix;e.setMatrix(t._transformMatrixProperty,i)},T(t,[{key:"diffuseTexture",get:function(){return this._diffuseTexture},set:function(e){this._diffuseTexture=e;var n=this.scene.shaderData;e?(n.setTexture(t._diffuseTextureProperty,e),n.enableMacro(t._diffuseMacro)):n.disableMacro(t._diffuseMacro)}},{key:"specularTexture",get:function(){return this._specularTexture},set:function(e){this._specularTexture=e;var n=this.scene.shaderData;e?(n.setTexture(t._specularTextureProperty,e),n.setFloat(t._mipLevelProperty,this.specularTexture.mipmapCount),n.enableMacro(t._specularMacro)):n.disableMacro(t._specularMacro)}},{key:"diffuseColor",get:function(){return this._diffuseColor},set:function(e){this._diffuseColor=e,this.scene.shaderData.setColor(t._diffuseColorProperty,e)}},{key:"specularColor",get:function(){return this._specularColor},set:function(e){this._specularColor=e,this.scene.shaderData.setColor(t._specularColorProperty,e)}},{key:"diffuseIntensity",get:function(){return this._diffuseIntensity},set:function(e){this._diffuseIntensity=e,this.scene.shaderData.setFloat(t._diffuseIntensityProperty,e)}},{key:"specularIntensity",get:function(){return this._specularIntensity},set:function(e){this._specularIntensity=e,this.scene.shaderData.setFloat(t._specularIntensityProperty,e)}}]),t}(St);Lt._diffuseMacro=Pt.getMacroByName("O3_USE_DIFFUSE_ENV"),Lt._specularMacro=Pt.getMacroByName("O3_USE_SPECULAR_ENV"),Lt._diffuseTextureProperty=Pt.getPropertyByName("u_env_diffuseSampler"),Lt._specularTextureProperty=Pt.getPropertyByName("u_env_specularSampler"),Lt._mipLevelProperty=Pt.getPropertyByName("u_envMapLight.mipMapLevel"),Lt._diffuseColorProperty=Pt.getPropertyByName("u_envMapLight.diffuse"),Lt._specularColorProperty=Pt.getPropertyByName("u_envMapLight.specular"),Lt._diffuseIntensityProperty=Pt.getPropertyByName("u_envMapLight.diffuseIntensity"),Lt._specularIntensityProperty=Pt.getPropertyByName("u_envMapLight.specularIntensity"),Lt._transformMatrixProperty=Pt.getPropertyByName("u_envMapLight.transformMatrix");var Ft=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).color=new w(1,1,1,1),t.intensity=1,t.distance=100,t.decay=0,t._lightColor=new w(1,1,1,1),t}return R(t,e),t._updateShaderData=function(e){var n=t._combinedData;e.setFloatArray(t._colorProperty,n.color),e.setFloatArray(t._positionProperty,n.position),e.setFloatArray(t._distanceProperty,n.distance),e.setFloatArray(t._decayProperty,n.decay)},t.prototype._appendData=function(e){var n=3*e,i=3*e,r=e,a=e,o=this.lightColor,s=this.position,c=t._combinedData;c.color[n]=o.r,c.color[n+1]=o.g,c.color[n+2]=o.b,c.position[i]=s.x,c.position[i+1]=s.y,c.position[i+2]=s.z,c.distance[r]=this.distance,c.decay[a]=this.decay},T(t,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}}]),t}(St);Ft._colorProperty=Pt.getPropertyByName("u_pointLightColor"),Ft._positionProperty=Pt.getPropertyByName("u_pointLightPosition"),Ft._distanceProperty=Pt.getPropertyByName("u_pointLightDistance"),Ft._decayProperty=Pt.getPropertyByName("u_pointLightDecay"),Ft._combinedData={color:new Float32Array(3*St._maxLight),position:new Float32Array(3*St._maxLight),distance:new Float32Array(St._maxLight),decay:new Float32Array(St._maxLight)};var Ot=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).color=new w(1,1,1,1),t.penumbra=.2,t.distance=100,t.intensity=1,t.decay=0,t.angle=Math.PI/6,t._forward=new s,t._lightColor=new w(1,1,1,1),t._inverseDirection=new s,t}return R(t,e),t._updateShaderData=function(e){var n=t._combinedData;e.setFloatArray(t._colorProperty,n.color),e.setFloatArray(t._positionProperty,n.position),e.setFloatArray(t._directionProperty,n.direction),e.setFloatArray(t._distanceProperty,n.distance),e.setFloatArray(t._decayProperty,n.decay),e.setFloatArray(t._angleProperty,n.angle),e.setFloatArray(t._penumbraProperty,n.penumbra),e.setFloatArray(t._penumbraCosProperty,n.penumbraCos),e.setFloatArray(t._coneCosProperty,n.coneCos)},t.prototype._appendData=function(e){var n=3*e,i=3*e,r=3*e,a=e,o=e,s=e,c=e,l=e,u=e,h=this.lightColor,d=this.position,f=this.direction,_=t._combinedData;_.color[n]=h.r,_.color[n+1]=h.g,_.color[n+2]=h.b,_.position[i]=d.x,_.position[i+1]=d.y,_.position[i+2]=d.z,_.direction[r]=f.x,_.direction[r+1]=f.y,_.direction[r+2]=f.z,_.distance[a]=this.distance,_.decay[o]=this.decay,_.angle[s]=this.angle,_.penumbra[c]=this.penumbra,_.penumbraCos[l]=Math.cos(this.angle*(1-this.penumbra)),_.coneCos[u]=Math.cos(this.angle)},T(t,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"reverseDirection",get:function(){return s.scale(this.direction,-1,this._inverseDirection),this._inverseDirection}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}}]),t}(St);Ot._colorProperty=Pt.getPropertyByName("u_spotLightColor"),Ot._positionProperty=Pt.getPropertyByName("u_spotLightPosition"),Ot._directionProperty=Pt.getPropertyByName("u_spotLightDirection"),Ot._distanceProperty=Pt.getPropertyByName("u_spotLightDistance"),Ot._decayProperty=Pt.getPropertyByName("u_spotLightDecay"),Ot._angleProperty=Pt.getPropertyByName("u_spotLightAngle"),Ot._penumbraProperty=Pt.getPropertyByName("u_spotLightPenumbra"),Ot._penumbraCosProperty=Pt.getPropertyByName("u_spotLightPenumbraCos"),Ot._coneCosProperty=Pt.getPropertyByName("u_spotLightConeCos"),Ot._combinedData={color:new Float32Array(3*St._maxLight),position:new Float32Array(3*St._maxLight),direction:new Float32Array(3*St._maxLight),distance:new Float32Array(St._maxLight),decay:new Float32Array(St._maxLight),angle:new Float32Array(St._maxLight),penumbra:new Float32Array(St._maxLight),penumbraCos:new Float32Array(St._maxLight),coneCos:new Float32Array(St._maxLight)};var It=function(e){function t(){var t;return(t=e.call(this)||this).visibleLights=void 0,t.visibleLights=[],t}R(t,e);var n=t.prototype;return n.attachRenderLight=function(e){-1==this.visibleLights.indexOf(e)?this.visibleLights.push(e):me.warn("Light already attached.")},n.detachRenderLight=function(e){var t=this.visibleLights.indexOf(e);-1!=t&&this.visibleLights.splice(t,1)},n._updateShaderData=function(e){for(var n=0,i=0,r=0,a=0,o=0,s=this.visibleLights,c=0,l=s.length;c<l;c++){var u=s[c];u instanceof Rt?n++:u instanceof Lt?(Lt._updateShaderData(e,u),i++):u instanceof Et?u._appendData(r++):u instanceof Ft?u._appendData(a++):u instanceof Ot&&u._appendData(o++)}n?e.enableMacro(t._ambientMacro):e.disableMacro(t._ambientMacro),i?e.enableMacro(t._envMacro):e.disableMacro(t._envMacro),r?(Et._updateShaderData(e),e.enableMacro("O3_DIRECT_LIGHT_COUNT",r.toString())):e.disableMacro("O3_DIRECT_LIGHT_COUNT"),a?(Ft._updateShaderData(e),e.enableMacro("O3_POINT_LIGHT_COUNT",a.toString())):e.disableMacro("O3_POINT_LIGHT_COUNT"),o?(Ot._updateShaderData(e),e.enableMacro("O3_SPOT_LIGHT_COUNT",o.toString())):e.disableMacro("O3_SPOT_LIGHT_COUNT")},t}(vt);It._ambientMacro=Pt.getMacroByName("O3_HAS_AMBIENT_LIGHT"),It._envMacro=Pt.getMacroByName("O3_HAS_ENVMAP_LIGHT");var zt=function(e){function t(t){var n;return(n=e.call(this,t)||this).isGCIgnored=!1,n._refCount=0,n._destroyed=!1,t.resourceManager._addRefObject(n.instanceId,z(n)),n}R(t,e);var n=t.prototype;return n.destroy=function(e){if(void 0===e&&(e=!1),this._destroyed)return!0;if(!e&&0!==this._refCount)return!1;var t=this._engine.resourceManager;t&&(t._deleteAsset(this),t._deleteRefObject(this.instanceId));var n=this._getRefCount();return n>0&&this._addRefCount(-n),this._engine=null,this._onDestroy(),this._destroyed=!0,!0},n._getRefCount=function(){return this._refCount},n._addRefCount=function(e){this._refCount+=e},n._addToResourceManager=function(e){this._engine.resourceManager._addAsset(e,this)},T(t,[{key:"refCount",get:function(){return this._refCount}},{key:"destroyed",get:function(){return this._destroyed}}]),t}(he),Dt=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name=void 0,t._platformTexture=void 0,t._mipmap=void 0,t._width=void 0,t._height=void 0,t._mipmapCount=void 0,t._wrapModeU=void 0,t._wrapModeV=void 0,t._filterMode=void 0,t._anisoLevel=1,t}R(t,e);var n=t.prototype;return n.generateMipmaps=function(){this._mipmap&&this._platformTexture.generateMipmaps()},n._onDestroy=function(){this._platformTexture.destroy(),this._platformTexture=null},n._getMaxMiplevel=function(e){return Math.floor(Math.log2(e))},n._getMipmapCount=function(){return this._mipmap?Math.floor(Math.log2(Math.max(this._width,this._height)))+1:1},T(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"wrapModeU",get:function(){return this._wrapModeU},set:function(e){e!==this._wrapModeU&&(this._wrapModeU=e,this._platformTexture.wrapModeU=e)}},{key:"wrapModeV",get:function(){return this._wrapModeV},set:function(e){e!==this._wrapModeV&&(this._wrapModeV=e,this._platformTexture.wrapModeV=e)}},{key:"mipmapCount",get:function(){return this._mipmapCount}},{key:"filterMode",get:function(){return this._filterMode},set:function(e){e!==this._filterMode&&(this._filterMode=e,this._platformTexture.filterMode=e)}},{key:"anisoLevel",get:function(){return this._anisoLevel},set:function(e){var t=this._engine._hardwareRenderer.capability.maxAnisoLevel;e>t&&(me.warn("anisoLevel:"+e+", exceeds the limit and is automatically downgraded to:"+t),e=t),e<1&&(me.warn("anisoLevel:"+e+", must be greater than 0, and is automatically downgraded to 1"),e=1),e!==this._anisoLevel&&(this._anisoLevel=e,this._platformTexture.anisoLevel=e)}}]),t}(zt),Bt=function(){function e(e){this._group=void 0,this._properties=Object.create(null),this._macroCollection=new we,this._variableMacros=Object.create(null),this._refCount=0,this._group=e}var t=e.prototype;return t.getFloat=function(e){return this._getData(e)},t.setFloat=function(e,t){this._setData(e,t)},t.getInt=function(e){return this._getData(e)},t.setInt=function(e,t){this._setData(e,t)},t.getFloatArray=function(e){return this._getData(e)},t.setFloatArray=function(e,t){this._setData(e,t)},t.getIntArray=function(e){return this._getData(e)},t.setIntArray=function(e,t){this._setData(e,t)},t.getVector2=function(e){return this._getData(e)},t.setVector2=function(e,t){this._setData(e,t)},t.getVector3=function(e){return this._getData(e)},t.setVector3=function(e,t){this._setData(e,t)},t.getVector4=function(e){return this._getData(e)},t.setVector4=function(e,t){this._setData(e,t)},t.getMatrix=function(e){return this._getData(e)},t.setMatrix=function(e,t){this._setData(e,t)},t.getColor=function(e){return this._getData(e)},t.setColor=function(e,t){this._setData(e,t)},t.getTexture=function(e){return this._getData(e)},t.setTexture=function(e,t){if(this._getRefCount()>0){var n=this._getData(e);n&&n._addRefCount(-1),t&&t._addRefCount(1)}this._setData(e,t)},t.getTextureArray=function(e){return this._getData(e)},t.setTextureArray=function(e,t){if(this._getRefCount()>0){var n=this._getData(e);if(n)for(var i=0,r=n.length;i<r;i++)n[i]._addRefCount(-1);if(t)for(var a=0,o=t.length;a<o;a++)t[a]._addRefCount(1)}this._setData(e,t)},t.enableMacro=function(e,t){void 0===t&&(t=null),t?this._enableVariableMacro(e,t):("string"==typeof e&&(e=Pt.getMacroByName(e)),this._macroCollection.enable(e))},t.disableMacro=function(e){if("string"==typeof e){var t=this._variableMacros[e];t?this._disableVariableMacro(e,t):(e=Pt.getMacroByName(e),this._macroCollection.disable(e))}else this._macroCollection.disable(e)},t.clone=function(){var t=new e(this._group);return this.cloneTo(t),t},t.cloneTo=function(e){ne.deepCloneObject(this._macroCollection,e._macroCollection),C(e._variableMacros,this._variableMacros);for(var t=this._properties,n=e._properties,i=Object.keys(t),r=0,a=i.length;r<a;r++){var o=i[r],s=t[o];null!=s?"number"==typeof s||s instanceof Dt?n[o]=s:s instanceof Array||s instanceof Float32Array||s instanceof Int32Array?n[o]=s.slice():n[o]=s.clone():n[o]=s}},t._getData=function(e){return"string"==typeof e&&(e=Pt.getPropertyByName(e)),this._properties[e._uniqueId]},t._setData=function(e,t){if("string"==typeof e&&(e=Pt.getPropertyByName(e)),e._group!==this._group){if(void 0!==e._group)throw"This property has been used as "+mt[e._group]+" property.";e._group=this._group}this._properties[e._uniqueId]=t},t._getRefCount=function(){return this._refCount},t._addRefCount=function(e){this._refCount+=e;var t=this._properties;for(var n in t){var i=t[n];i&&i instanceof Dt&&i._addRefCount(e)}},t._enableVariableMacro=function(e,t){var n=this._variableMacros,i=n[e];if(i!==t){i&&this._disableVariableMacro(e,i);var r=Pt.getMacroByName(e+" "+t);this._macroCollection.enable(r),n[e]=t}},t._disableVariableMacro=function(e,t){var n=Pt.getMacroByName(e+" "+t);this._macroCollection.disable(n),delete this._variableMacros[e]},e}(),Nt=function(e){function t(n,i){var r;(r=e.call(this,n)||this).shaderData=new Bt(mt.Scene),r.name=void 0,r._activeCameras=[],r._isActiveInEngine=!1,r._destroyed=!1,r._rootEntities=[],r._resolution=new v,r.features=[],r.name=i||"";var a=r.shaderData;return t.sceneFeatureManager.addObject(z(r)),a._addRefCount(1),r._engine._hardwareRenderer.canIUse(le.shaderTextureLod)&&a.enableMacro("HAS_TEX_LOD"),r._engine._hardwareRenderer.canIUse(le.standardDerivatives)&&a.enableMacro("HAS_DERIVATIVES"),r}R(t,e);var n=t.prototype;return n.createRootEntity=function(e){var t=new $e(this._engine,e);return this.addRootEntity(t),t},n.addRootEntity=function(e){var t=e._isRoot;t||(e._isRoot=!0,e._removeFromParent());var n=e._scene;n!==this?(n&&t&&n._removeEntity(e),this._rootEntities.push(e),$e._traverseSetOwnerScene(e,this)):t||this._rootEntities.push(e),this._isActiveInEngine?!e._isActiveInHierarchy&&e._isActive&&e._processActive():e._isActiveInHierarchy&&e._processInActive()},n.removeRootEntity=function(e){e._isRoot&&e._scene==this&&(this._removeEntity(e),this._isActiveInEngine&&e._processInActive(),$e._traverseSetOwnerScene(e,null))},n.getRootEntity=function(e){return void 0===e&&(e=0),this._rootEntities[e]},n.findEntityByName=function(e){for(var t=this._rootEntities,n=t.length-1;n>=0;n--){var i=t[n];if(i.name===e)return i}for(var r=t.length-1;r>=0;r--){var a=t[r].findByName(e);if(a)return a}return null},n.findEntityByPath=function(e){for(var t=e.split("/").filter(Boolean),n=0,i=this.rootEntitiesCount;n<i;n++){var r=this.getRootEntity(n);if(r.name==t[0]){for(var a=1,o=t.length;a<o&&(r=$e._findChildByName(r,t[a]));++a);return r}}return null},n.destroy=function(){if(!this._destroyed){this._isActiveInEngine&&(this._engine.sceneManager.activeScene=null),t.sceneFeatureManager.callFeatureMethod(this,"destroy",[this]);for(var e=0,n=this.rootEntitiesCount;e<n;e++)this._rootEntities[e].destroy();this._rootEntities.length=0,this._activeCameras.length=0,t.sceneFeatureManager._objects=[],this.shaderData._addRefCount(-1),this._destroyed=!0}},n._attachRenderCamera=function(e){-1===this._activeCameras.indexOf(e)?this._activeCameras.push(e):me.warn("Camera already attached.")},n._detachRenderCamera=function(e){var t=this._activeCameras.indexOf(e);-1!==t&&this._activeCameras.splice(t,1)},n._processActive=function(e){this._isActiveInEngine=e;for(var t=this._rootEntities,n=t.length-1;n>=0;n--){var i=t[n];i._isActive&&(e?i._processActive():i._processInActive())}},n._updateShaderData=function(){var e=this.findFeature(It),n=this.shaderData,i=this.engine.canvas,r=this._resolution;e._updateShaderData(n),r.setValue(i.width,i.height),n.setVector2(t._resolutionProperty,r)},n._removeEntity=function(e){var t=this._rootEntities;t.splice(t.indexOf(e),1)},t.registerFeature=function(e){t.sceneFeatureManager.registerFeature(e)},n.findFeature=function(e){return t.sceneFeatureManager.findFeature(this,e)},n.raycast=function(e,t,n){},T(t,[{key:"engine",get:function(){return this._engine}},{key:"rootEntitiesCount",get:function(){return this._rootEntities.length}},{key:"rootEntities",get:function(){return this._rootEntities}},{key:"destroyed",get:function(){return this._destroyed}}]),t}(he);Nt._resolutionProperty=Pt.getPropertyByName("u_resolution"),Nt.sceneFeatureManager=new et;var Ut=function(){function e(e){this.engine=e,this._activeScene=void 0}var t=e.prototype;return t.loadScene=function(e,t){var n=this;void 0===t&&(t=!0);var i=this.engine.resourceManager.load(e);return i.then((function(e){var i=n._activeScene;n.activeScene=e,i&&t&&i.destroy()})),i},t.mergeScenes=function(e,t){for(var n=e.rootEntities,i=0,r=n.length;i<r;i++)t.addRootEntity(n[i])},T(e,[{key:"activeScene",get:function(){return this._activeScene},set:function(e){var t=this._activeScene;t!==e&&(t&&t._processActive(!1),e&&e._processActive(!0),this._activeScene=e)}}]),e}(),Gt="#define GLSLIFY 1\n#include <common_vert>\n#include <normal_share>\n#include <shadow_share>\nvoid main(){\n#include <begin_position_vert>\n#include <begin_normal_vert>\n#include <skinning_vert>\n#include <shadow_vert>\n#include <position_vert>\n}",kt=function(){function e(){}return e.init=function(){Pt.create("blinn-phong","#define GLSLIFY 1\n#include <common>\n#include <common_vert>\n#include <uv_share>\n#include <normal_share>\n#include <worldpos_share>\n#include <shadow_share>\n#include <fog_share>\nvoid main(){\n#include <begin_position_vert>\n#include <begin_normal_vert>\n#include <skinning_vert>\n#include <uv_vert>\n#include <normal_vert>\n#include <worldpos_vert>\n#include <shadow_vert>\n#include <position_vert>\n#include <fog_vert>\n}","#define GLSLIFY 1\n#include <common>\n#include <common_frag>\n#include <uv_share>\n#include <normal_share>\n#include <worldpos_share>\n#include <ambient_light_frag>\n#include <direct_light_frag>\n#include <point_light_frag>\n#include <spot_light_frag>\n#include <mobile_material_frag>\n#include <fog_share>\n#include <normal_get>\nvoid main(){\n#include <begin_mobile_frag>\n#include <begin_viewdir_frag>\n#include <mobile_blinnphong_frag>\ngl_FragColor=emission+ambient+diffuse+specular;gl_FragColor.a=diffuse.a;\n#include <fog_frag>\n}"),Pt.create("pbr","#define GLSLIFY 1\n#include <common>\n#include <common_vert>\n#include <uv_share>\n#include <color_share>\n#include <normal_share>\n#include <worldpos_share>\n#include <shadow_share>\n#include <fog_share>\nvoid main(){\n#include <begin_position_vert>\n#include <begin_normal_vert>\n#include <skinning_vert>\n#include <uv_vert>\n#include <color_vert>\n#include <normal_vert>\n#include <worldpos_vert>\n#include <shadow_vert>\n#include <position_vert>\n#include <fog_vert>\n}","#define GLSLIFY 1\n#include <common>\n#include <common_frag>\n#include <pbr_common_frag_define>\n#include <pbr_util_frag_define>\n#include <fog_share>\n#include <uv_share>\n#include <normal_share>\n#include <color_share>\n#include <worldpos_share>\n#include <refraction_share>\n#include <perturbation_share>\n#include <ambient_light_frag>\n#include <direct_light_frag>\n#include <point_light_frag>\n#include <spot_light_frag>\n#include <pbr_envmap_light_frag_define>\n#include <pbr_base_frag_define>\n#include <pbr_texture_frag_define>\n#include <pbr_runtime_frag_define>\n#include <normal_get>\n#include <pbr_brdf_cook_torrance_frag_define>\n#include <pbr_direct_irradiance_frag_define>\n#include <pbr_ibl_diffuse_frag_define>\n#include <pbr_ibl_specular_frag_define>\nvoid main(){\n#include <pbr_begin_frag>\n#include <pbr_direct_irradiance_frag>\n#include <pbr_ibl_diffuse_frag>\n#include <pbr_ibl_specular_frag>\n#include <pbr_end_frag>\n#include <gamma_frag>\n#include <refraction_frag>\n#include <perturbation_frag>\n#include <fog_frag>\n}"),Pt.create("unlit","#define GLSLIFY 1\n#include <common_vert>\n#include <uv_share>\n#include <fog_share>\nvoid main(){\n#include <begin_position_vert>\n#include <skinning_vert>\n#include <uv_vert>\n#include <position_vert>\n#include <fog_vert>\n}","#define GLSLIFY 1\n#include <uv_share>\n#include <fog_share>\nuniform vec4 u_baseColor;uniform float u_alphaCutoff;\n#ifdef O3_BASE_TEXTURE\nuniform sampler2D u_baseTexture;\n#endif\nvoid main(){vec4 baseColor=u_baseColor;\n#ifdef O3_BASE_TEXTURE\nbaseColor*=texture2D(u_baseTexture,v_uv);\n#endif\n#ifdef ALPHA_CUTOFF\nif(baseColor.a<u_alphaCutoff){discard;}\n#endif\ngl_FragColor=baseColor;\n#include <fog_frag>\n}"),Pt.create("shadow-map",Gt,"#define GLSLIFY 1\n/***Decompose and save depth value.*/vec4 pack(float depth){const vec4 bitShift=vec4(1.0,256.0,256.0*256.0,256.0*256.0*256.0);const vec4 bitMask=vec4(1.0/256.0,1.0/256.0,1.0/256.0,0.0);vec4 rgbaDepth=fract(depth*bitShift);rgbaDepth-=rgbaDepth.gbaa*bitMask;return rgbaDepth;}void main(){gl_FragColor=pack(gl_FragCoord.z);}"),Pt.create("shadow",Gt,"#define GLSLIFY 1\n#ifdef O3_SHADOW_MAP_COUNT\nuniform float u_shadowBias[O3_SHADOW_MAP_COUNT];uniform float u_shadowIntensity[O3_SHADOW_MAP_COUNT];uniform float u_shadowRadius[O3_SHADOW_MAP_COUNT];uniform vec2 u_shadowMapSize[O3_SHADOW_MAP_COUNT];uniform sampler2D u_shadowMaps[O3_SHADOW_MAP_COUNT];varying vec4 v_PositionFromLight[O3_SHADOW_MAP_COUNT];const vec4 bitShift=vec4(1.0,1.0/256.0,1.0/(256.0*256.0),1.0/(256.0*256.0*256.0));/***Unpack depth value.*/float unpack(const in vec4 rgbaDepth){return dot(rgbaDepth,bitShift);}/***Degree of shadow.*/float getVisibility(vec4 positionFromLight,const in sampler2D shadowMap,vec2 mapSize,float intensity,float bias,float radius){vec3 shadowCoord=(positionFromLight.xyz/positionFromLight.w)/2.0+0.5;float filterX=step(0.0,shadowCoord.x)*(1.0-step(1.0,shadowCoord.x));float filterY=step(0.0,shadowCoord.y)*(1.0-step(1.0,shadowCoord.y));shadowCoord.z-=bias;vec2 texelSize=vec2(1.0)/mapSize;float visibility=0.0;for(float y=-1.0;y<=1.0;y+=1.0){for(float x=-1.0;x<=1.0;x+=1.0){vec2 uv=shadowCoord.xy+texelSize*vec2(x,y)*radius;vec4 rgbaDepth=texture2D(shadowMap,uv);float depth=unpack(rgbaDepth);visibility+=step(depth,shadowCoord.z)*intensity;}}visibility*=(1.0/9.0);return visibility*filterX*filterY;}\n#endif\nvoid main(){vec4 shadowColor=vec4(1.0,1.0,1.0,1.0);\n#ifdef O3_SHADOW_MAP_COUNT\nfloat visibility=1.0;\n#if (O3_SHADOW_MAP_COUNT == 1)\nvisibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);\n#elif (O3_SHADOW_MAP_COUNT == 2)\nvisibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);visibility-=getVisibility(v_PositionFromLight[1],u_shadowMaps[1],u_shadowMapSize[1],u_shadowIntensity[1],u_shadowBias[1],u_shadowRadius[1]);\n#elif (O3_SHADOW_MAP_COUNT == 3)\nvisibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);visibility-=getVisibility(v_PositionFromLight[1],u_shadowMaps[1],u_shadowMapSize[1],u_shadowIntensity[1],u_shadowBias[1],u_shadowRadius[1]);visibility-=getVisibility(v_PositionFromLight[2],u_shadowMaps[2],u_shadowMapSize[2],u_shadowIntensity[2],u_shadowBias[2],u_shadowRadius[2]);\n#endif\nvisibility=clamp(visibility,0.0,1.0);shadowColor=vec4(visibility,visibility,visibility,1.0);\n#endif\ngl_FragColor=shadowColor;}"),Pt.create("skybox","#define GLSLIFY 1\n#include <common_vert>\nuniform mat4 u_mvpNoscale;varying vec3 v_cubeUV;void main(){v_cubeUV=POSITION.xyz;gl_Position=u_mvpNoscale*vec4(POSITION,1.0);gl_Position.z=gl_Position.w;}","#define GLSLIFY 1\nuniform samplerCube u_cube;varying vec3 v_cubeUV;void main(){gl_FragColor=textureCube(u_cube,v_cubeUV);}"),Pt.create("particle-shader","#define GLSLIFY 1\nattribute vec3 a_position;attribute vec3 a_velocity;attribute vec3 a_acceleration;attribute vec4 a_color;attribute vec4 a_lifeAndSize;attribute vec2 a_rotation;attribute vec3 a_uv;attribute vec2 a_normalizedUv;uniform float u_time;uniform bool u_once;uniform bool u_active;uniform mat4 u_MVPMat;varying vec4 v_color;varying float v_lifeLeft;varying vec2 v_uv;\n#ifdef is2d\nuniform mat4 u_viewInvMat;uniform mat4 u_projMat;uniform mat4 u_viewMat;uniform mat4 u_modelMat;\n#endif\nmat2 rotation2d(float angle){float s=sin(angle);float c=cos(angle);return mat2(c,-s,s,c);}void main(){v_color=a_color;v_uv=a_uv.xy;float life=a_lifeAndSize.y+a_lifeAndSize.x;float deltaTime=max(mod(u_time,life)-a_lifeAndSize.x,0.0);bool isDying=false;if(u_once||!u_active){isDying=true;}if((isDying&&u_time>life)){deltaTime=life;}if(deltaTime==0.0){deltaTime=life;}v_lifeLeft=1.0-deltaTime/a_lifeAndSize.y;float scale=a_lifeAndSize.z;vec3 position=a_position+(a_velocity+a_acceleration*deltaTime*0.5)*deltaTime;\n#ifdef isScaleByLifetime\nscale*=v_lifeLeft;\n#else\nscale*=pow(a_lifeAndSize.w,deltaTime);\n#endif\n#ifdef rotateToVelocity\nvec3 v=a_velocity+a_acceleration*deltaTime;float angle=atan(v.z,v.x)*2.0;\n#else\nfloat deltaAngle=deltaTime*a_rotation.y;float angle=a_rotation.x+deltaAngle;\n#endif\n#ifdef is2d\nvec2 rotatedPoint=rotation2d(angle)*vec2(a_normalizedUv.x,a_normalizedUv.y*a_uv.z);vec3 basisX=u_viewInvMat[0].xyz;vec3 basisZ=u_viewInvMat[1].xyz;vec3 localPosition=vec3(basisX*rotatedPoint.x+basisZ*rotatedPoint.y)*scale+position;gl_Position=u_projMat*u_viewMat*vec4(localPosition+u_modelMat[3].xyz,1.);\n#else\n#ifdef rotateToVelocity\nfloat s=sin(angle);float c=cos(angle);\n#else\nfloat s=sin(angle);float c=cos(angle);\n#endif\nvec4 rotatedPoint=vec4((a_normalizedUv.x*c+a_normalizedUv.y*a_uv.z*s)*scale,0.,(a_normalizedUv.x*s-a_normalizedUv.y*a_uv.z*c)*scale,1.);vec4 orientation=vec4(0,0,0,1);vec4 q2=orientation+orientation;vec4 qx=orientation.xxxw*q2.xyzx;vec4 qy=orientation.xyyw*q2.xyzy;vec4 qz=orientation.xxzw*q2.xxzz;mat4 localMatrix=mat4((1.0-qy.y)-qz.z,qx.y+qz.w,qx.z-qy.w,0,qx.y-qz.w,(1.0-qx.x)-qz.z,qy.z+qx.w,0,qx.z+qy.w,qy.z-qx.w,(1.0-qx.x)-qy.y,0,position.x,position.y,position.z,1);rotatedPoint=localMatrix*rotatedPoint;gl_Position=u_MVPMat*rotatedPoint;\n#endif\n}","#define GLSLIFY 1\nvarying vec4 v_color;varying float v_lifeLeft;varying vec2 v_uv;uniform sampler2D u_texture;void main(){float alphaFactor=1.0;\n#ifdef fadeIn\nfloat fadeInFactor=step(0.5,v_lifeLeft);alphaFactor=2.0*fadeInFactor*(1.0-v_lifeLeft)+(1.0-fadeInFactor);\n#endif\n#ifdef fadeOut\nfloat fadeOutFactor=step(0.5,v_lifeLeft);alphaFactor=alphaFactor*2.0*(1.0-fadeOutFactor)*v_lifeLeft+alphaFactor*fadeOutFactor;\n#endif\n#ifdef particleTexture\nvec4 tex=texture2D(u_texture,v_uv);\n#ifdef useOriginColor\ngl_FragColor=vec4(tex.rgb,alphaFactor*tex.a*v_color.w);\n#else\ngl_FragColor=vec4(v_color.xyz*tex.rgb,alphaFactor*tex.a*v_color.w);\n#endif\n#else\ngl_FragColor=vec4(v_color.xyz,alphaFactor*v_color.w);\n#endif\n}")},e}(),Vt=function(){function e(){this._cacheHierarchy=1,this._cacheMap=Object.create(null),this._lastQueryMap=void 0,this._lastQueryKey=void 0}var t=e.prototype;return t.get=function(e){var t=this._cacheMap,n=e._length;n>this._cacheHierarchy&&this._resizeCacheMapHierarchy(t,0,n);for(var i=e._mask,r=e._length-1,a=this._cacheHierarchy-1,o=0;o<a;o++){var s=r<o?0:i[o],c=t[s];c||(t[s]=c=Object.create(null)),t=c}var l=r<a?0:i[a],u=t[l];return u||(this._lastQueryKey=l,this._lastQueryMap=t),u},t.cache=function(e){this._lastQueryMap[this._lastQueryKey]=e},t._resizeCacheMapHierarchy=function(e,t,n){var i=this._cacheHierarchy-1;if(t==i){for(var r in e)for(var a=e[r],o=0,s=n-i;o<s;o++)o==s-1?e[0]=a:e=e[0==o?r:0]=Object.create(null);this._cacheHierarchy=n}else for(var c in e)this._resizeCacheMapHierarchy(e[c],++t,n)},e}(),Ht=function(){this.enabled=!1,this.colorBlendOperation=st.Add,this.alphaBlendOperation=st.Add,this.sourceColorBlendFactor=at.One,this.sourceAlphaBlendFactor=at.One,this.destinationColorBlendFactor=at.Zero,this.destinationAlphaBlendFactor=at.Zero,this.colorWriteMask=lt.All},jt=function(){function e(){this.targetBlendState=new Ht,this.blendColor=new w(0,0,0,0),this.alphaToCoverage=!1}e._getGLBlendFactor=function(e){switch(e){case at.Zero:return WebGLRenderingContext.ZERO;case at.One:return WebGLRenderingContext.ONE;case at.SourceColor:return WebGLRenderingContext.SRC_COLOR;case at.OneMinusSourceColor:return WebGLRenderingContext.ONE_MINUS_SRC_COLOR;case at.DestinationColor:return WebGLRenderingContext.DST_COLOR;case at.OneMinusDestinationColor:return WebGLRenderingContext.ONE_MINUS_DST_COLOR;case at.SourceAlpha:return WebGLRenderingContext.SRC_ALPHA;case at.OneMinusSourceAlpha:return WebGLRenderingContext.ONE_MINUS_SRC_ALPHA;case at.DestinationAlpha:return WebGLRenderingContext.DST_ALPHA;case at.OneMinusDestinationAlpha:return WebGLRenderingContext.ONE_MINUS_DST_ALPHA;case at.SourceAlphaSaturate:return WebGLRenderingContext.SRC_ALPHA_SATURATE;case at.BlendColor:return WebGLRenderingContext.CONSTANT_COLOR;case at.OneMinusBlendColor:return WebGLRenderingContext.ONE_MINUS_CONSTANT_COLOR}},e._getGLBlendOperation=function(e,t){var n=t.gl;switch(e){case st.Add:return n.FUNC_ADD;case st.Subtract:return n.FUNC_SUBTRACT;case st.ReverseSubtract:return n.FUNC_REVERSE_SUBTRACT;case st.Min:if(!t.canIUse(le.blendMinMax))throw new Error("BlendOperation.Min is not supported in this context");return n.MIN;case st.Max:if(!t.canIUse(le.blendMinMax))throw new Error("BlendOperation.Max is not supported in this context");return n.MAX}};var t=e.prototype;return t._apply=function(e,t){this._platformApply(e,t.blendState)},t._platformApply=function(t,n){var i=t.gl,r=n.targetBlendState,a=this.targetBlendState,o=a.enabled,s=a.colorBlendOperation,c=a.alphaBlendOperation,l=a.sourceColorBlendFactor,u=a.destinationColorBlendFactor,h=a.sourceAlphaBlendFactor,d=a.destinationAlphaBlendFactor,f=a.colorWriteMask;if(o!==r.enabled&&(o?i.enable(i.BLEND):i.disable(i.BLEND),r.enabled=o),o){l===r.sourceColorBlendFactor&&u===r.destinationColorBlendFactor&&h===r.sourceAlphaBlendFactor&&d===r.destinationAlphaBlendFactor||(i.blendFuncSeparate(e._getGLBlendFactor(l),e._getGLBlendFactor(u),e._getGLBlendFactor(h),e._getGLBlendFactor(d)),r.sourceColorBlendFactor=l,r.destinationColorBlendFactor=u,r.sourceAlphaBlendFactor=h,r.destinationAlphaBlendFactor=d),s===r.colorBlendOperation&&c===r.alphaBlendOperation||(i.blendEquationSeparate(e._getGLBlendOperation(s,t),e._getGLBlendOperation(c,t)),r.colorBlendOperation=s,r.alphaBlendOperation=c);var _=this.blendColor;w.equals(n.blendColor,_)||(i.blendColor(_.r,_.g,_.b,_.a),_.cloneTo(n.blendColor))}f!==r.colorWriteMask&&(i.colorMask(0!=(f&lt.Red),0!=(f&lt.Green),0!=(f&lt.Blue),0!=(f&lt.Alpha)),r.colorWriteMask=f);var p=this.alphaToCoverage;p!==n.alphaToCoverage&&(p?i.enable(i.SAMPLE_ALPHA_TO_COVERAGE):i.disable(i.SAMPLE_ALPHA_TO_COVERAGE),n.alphaToCoverage=p)},e}(),Wt=function(){function e(){this.enabled=!0,this.writeEnabled=!0,this.compareFunction=ht.Less}e._getGLCompareFunction=function(e){switch(e){case ht.Never:return WebGLRenderingContext.NEVER;case ht.Less:return WebGLRenderingContext.LESS;case ht.Equal:return WebGLRenderingContext.EQUAL;case ht.LessEqual:return WebGLRenderingContext.LEQUAL;case ht.Greater:return WebGLRenderingContext.GREATER;case ht.NotEqual:return WebGLRenderingContext.NOTEQUAL;case ht.GreaterEqual:return WebGLRenderingContext.GEQUAL;case ht.Always:return WebGLRenderingContext.ALWAYS}};var t=e.prototype;return t._apply=function(e,t){this._platformApply(e,t.depthState)},t._platformApply=function(t,n){var i=t.gl,r=this.enabled,a=this.compareFunction,o=this.writeEnabled;r!=n.enabled&&(r?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST),n.enabled=r),r&&(a!=n.compareFunction&&(i.depthFunc(e._getGLCompareFunction(a)),n.compareFunction=a),o!=n.writeEnabled&&(i.depthMask(o),n.writeEnabled=o))},e}(),Xt=function(){function e(){this.cullMode=ft.Back,this.depthBias=0,this.slopeScaledDepthBias=0,this._cullFaceEnable=!0}var t=e.prototype;return t._apply=function(e,t){this._platformApply(e,t.rasterState)},t._platformApply=function(e,t){var n=e.gl,i=this.cullMode,r=this.depthBias,a=this.slopeScaledDepthBias,o=i!==ft.Off;o!==t._cullFaceEnable&&(o?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),t._cullFaceEnable=o),o&&i!==t.cullMode&&(i==ft.Back?n.cullFace(n.BACK):n.cullFace(n.FRONT),t.cullMode=i),r===t.depthBias&&a===t.slopeScaledDepthBias||(0!==r||0!==a?(n.enable(n.POLYGON_OFFSET_FILL),n.polygonOffset(a,r)):n.disable(n.POLYGON_OFFSET_FILL),t.depthBias=r,t.slopeScaledDepthBias=a)},e}(),Kt=function(){function e(){this.enabled=!1,this.referenceValue=0,this.mask=255,this.writeMask=255,this.compareFunctionFront=ht.Always,this.compareFunctionBack=ht.Always,this.passOperationFront=pt.Keep,this.passOperationBack=pt.Keep,this.failOperationFront=pt.Keep,this.failOperationBack=pt.Keep,this.zFailOperationFront=pt.Keep,this.zFailOperationBack=pt.Keep}e._getGLCompareFunction=function(e){switch(e){case ht.Never:return WebGLRenderingContext.NEVER;case ht.Less:return WebGLRenderingContext.LESS;case ht.Equal:return WebGLRenderingContext.EQUAL;case ht.LessEqual:return WebGLRenderingContext.LEQUAL;case ht.Greater:return WebGLRenderingContext.GREATER;case ht.NotEqual:return WebGLRenderingContext.NOTEQUAL;case ht.GreaterEqual:return WebGLRenderingContext.GEQUAL;case ht.Always:return WebGLRenderingContext.ALWAYS}},e._getGLStencilOperation=function(e){switch(e){case pt.Keep:return WebGLRenderingContext.KEEP;case pt.Zero:return WebGLRenderingContext.ZERO;case pt.Replace:return WebGLRenderingContext.REPLACE;case pt.IncrementSaturate:return WebGLRenderingContext.INCR;case pt.DecrementSaturate:return WebGLRenderingContext.DECR;case pt.Invert:return WebGLRenderingContext.INVERT;case pt.IncrementWrap:return WebGLRenderingContext.INCR_WRAP;case pt.DecrementWrap:return WebGLRenderingContext.DECR_WRAP}};var t=e.prototype;return t._apply=function(e,t){this._platformApply(e,t.stencilState)},t._platformApply=function(t,n){var i=t.gl,r=this.enabled,a=this.referenceValue,o=this.mask,s=this.compareFunctionFront,c=this.compareFunctionBack,l=this.failOperationFront,u=this.zFailOperationFront,h=this.passOperationFront,d=this.failOperationBack,f=this.zFailOperationBack,_=this.passOperationBack,p=this.writeMask;if(r!=n.enabled&&(r?i.enable(i.STENCIL_TEST):i.disable(WebGLRenderingContext.STENCIL_TEST),n.enabled=r),r){var g=a!==n.referenceValue||o!==n.mask;(g||s!==n.compareFunctionFront)&&(i.stencilFuncSeparate(i.FRONT,e._getGLCompareFunction(s),a,o),n.compareFunctionFront=s),(g||c!==n.compareFunctionBack)&&(i.stencilFuncSeparate(i.BACK,e._getGLCompareFunction(c),a,o),n.compareFunctionBack=this.compareFunctionBack),g&&(n.referenceValue=this.referenceValue,n.mask=this.mask),l===n.failOperationFront&&u===n.zFailOperationFront&&h===n.passOperationFront||(i.stencilOpSeparate(i.FRONT,e._getGLStencilOperation(l),e._getGLStencilOperation(u),e._getGLStencilOperation(h)),n.failOperationFront=l,n.zFailOperationFront=u,n.passOperationFront=h),d===n.failOperationBack&&f===n.zFailOperationBack&&_===n.passOperationBack||(i.stencilOpSeparate(i.BACK,e._getGLStencilOperation(d),e._getGLStencilOperation(f),e._getGLStencilOperation(_)),n.failOperationBack=d,n.zFailOperationBack=f,n.passOperationBack=_),p!==n.writeMask&&(i.stencilMask(p),n.writeMask=p)}},e}(),qt=function(){function e(){this.blendState=new jt,this.depthState=new Wt,this.stencilState=new Kt,this.rasterState=new Xt}return e.prototype._apply=function(e){var t=e._hardwareRenderer,n=e._lastRenderState;this.blendState._apply(t,n),this.depthState._apply(t,n),this.stencilState._apply(t,n),this.rasterState._apply(t,n)},e}(),Yt=new et;kt.init();var Qt,Zt,Jt,$t,en,tn,nn,rn,an,on,sn,cn,ln,un,hn,dn,fn,_n,pn,gn,vn,mn,yn,xn,wn,bn,An,Tn,Mn,Cn,Pn,Sn=function(e){function t(t,n){var i;return(i=e.call(this,null)||this)._componentsManager=new be,i._hardwareRenderer=void 0,i._lastRenderState=new qt,i._renderElementPool=new tt(it),i._renderContext=new nt,i._renderCount=0,i._shaderProgramPools=[],i._canvas=void 0,i._resourceManager=new V(z(i)),i._sceneManager=new Ut(z(i)),i._vSyncCount=1,i._targetFrameRate=60,i._time=new ye,i._isPaused=!0,i._requestId=void 0,i._timeoutId=void 0,i._vSyncCounter=1,i._targetFrameInterval=1e3/60,i._animate=function(){i._vSyncCount?(i._requestId=requestAnimationFrame(i._animate),i._vSyncCounter++%i._vSyncCount==0&&(i.update(),i._vSyncCounter=1)):(i._timeoutId=window.setTimeout(i._animate,i._targetFrameInterval),i.update())},i.features=[],i._hardwareRenderer=n,i._hardwareRenderer.init(t),i._canvas=t,Yt.addObject(z(i)),i._sceneManager.activeScene=new Nt(z(i),"DefaultScene"),i}R(t,e);var n=t.prototype;return n.createEntity=function(e){return new $e(this,e)},n.pause=function(){this._isPaused=!0,cancelAnimationFrame(this._requestId),clearTimeout(this._timeoutId)},n.resume=function(){this._isPaused&&(this._isPaused=!1,this.time.reset(),requestAnimationFrame(this._animate))},n.update=function(){var e=this._time,t=e.deltaTime;e.tick(),it._restPool(),rt._restPool(),Yt.callFeatureMethod(this,"preTick",[this,this._sceneManager._activeScene]);var n=this._sceneManager._activeScene,i=this._componentsManager;n&&(i.callScriptOnStart(),i.callScriptOnUpdate(t),i.callAnimationUpdate(t),i.callScriptOnLateUpdate(t),this._render(n)),this._componentsManager.callComponentDestory(),Yt.callFeatureMethod(this,"postTick",[this,this._sceneManager._activeScene])},n.run=function(){Yt.callFeatureMethod(this,"preLoad",[this]),this.resume(),this.trigger(new X("run",this))},n.destroy=function(){this._sceneManager&&(this.trigger(new X("shutdown",this)),Yt.callFeatureMethod(this,"shutdown",[this]),this.pause(),this._animate=null,this._sceneManager._activeScene.destroy(),this._resourceManager.gc(),this._componentsManager.callComponentDestory(),this._sceneManager=null,this._resourceManager=null,this._canvas=null,this.features=[],this._time=null,Yt._objects=[],this.removeAllEventListeners())},n._getShaderProgramPool=function(e){var t=e._shaderId,n=this._shaderProgramPools,i=n[t];if(!i){var r=t+1;r<n.length&&(n.length=r),n[t]=i=new Vt}return i},n._render=function(e){var t=e._activeCameras,n=this._componentsManager,i=this.time.deltaTime;if(n.callRendererOnUpdate(i),e._updateShaderData(),t.length>0){t.sort((function(e,t){return e.priority-t.priority}));for(var r=0,a=t.length;r<a;r++){var o=t[r],s=o.entity;o.enabled&&s.isActiveInHierarchy&&(n.callCameraOnBeginRender(o),Nt.sceneFeatureManager.callFeatureMethod(e,"preRender",[e,o]),o.render(),Nt.sceneFeatureManager.callFeatureMethod(e,"postRender",[e,o]),n.callCameraOnEndRender(o))}}else me.debug("NO active camera.")},n.findFeature=function(e){return Yt.findFeature(this,e)},t.registerFeature=function(e){Yt.registerFeature(e)},T(t,[{key:"canvas",get:function(){return this._canvas}},{key:"resourceManager",get:function(){return this._resourceManager}},{key:"sceneManager",get:function(){return this._sceneManager}},{key:"time",get:function(){return this._time}},{key:"isPaused",get:function(){return this._isPaused}},{key:"vSyncCount",get:function(){return this._vSyncCount},set:function(e){this._vSyncCount=Math.max(0,Math.floor(e))}},{key:"targetFrameRate",get:function(){return this._targetFrameRate},set:function(e){e=Math.max(1e-6,e),this._targetFrameRate=e,this._targetFrameInterval=1e3/e}}]),t}(de),Rn=function(){function e(){}return e._isIos=function(){var e=window.navigator.userAgent.toLocaleLowerCase();return/iphone|ipad|ipod/.test(e)},T(e,null,[{key:"devicePixelRatio",get:function(){return window.devicePixelRatio}}]),e}(),En=function(){function e(){}var t=e.prototype;return t.preLoad=function(e){},t.preTick=function(e,t){},t.postTick=function(e,t){},t.shutdown=function(e){},e}(),Ln=(Zt=U((Qt=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return N(t=e.call.apply(e,[this].concat(i))||this,"_started",Zt,z(t)),N(t,"_onStartIndex",Jt,z(t)),N(t,"_onUpdateIndex",$t,z(t)),N(t,"_onLateUpdateIndex",en,z(t)),N(t,"_onPreRenderIndex",tn,z(t)),N(t,"_onPostRenderIndex",nn,z(t)),t}R(t,e);var n=t.prototype;return n.onAwake=function(){},n.onEnable=function(){},n.onStart=function(){},n.onUpdate=function(e){},n.onLateUpdate=function(e){},n.onBeginRender=function(e){},n.onEndRender=function(e){},n.onDisable=function(){},n.onDestroy=function(){},n._onAwake=function(){this.onAwake()},n._onEnable=function(){var e=this.engine._componentsManager,n=t.prototype;this._started||e.addOnStartScript(this),this.onUpdate!==n.onUpdate&&e.addOnUpdateScript(this),this.onLateUpdate!==n.onLateUpdate&&e.addOnLateUpdateScript(this),this.onEnable()},n._onDisable=function(){var e=this.engine._componentsManager;-1!==this._onStartIndex&&e.removeOnStartScript(this),-1!==this._onUpdateIndex&&e.removeOnUpdateScript(this),-1!==this._onLateUpdateIndex&&e.removeOnLateUpdateScript(this),this.onDisable()},n._onDestroy=function(){this.engine._componentsManager.addDestoryComponent(this)},t}(Qe)).prototype,"_started",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Jt=U(Qt.prototype,"_onStartIndex",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),$t=U(Qt.prototype,"_onUpdateIndex",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),en=U(Qt.prototype,"_onLateUpdateIndex",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),tn=U(Qt.prototype,"_onPreRenderIndex",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),nn=U(Qt.prototype,"_onPostRenderIndex",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Qt),Fn=(wn=xn=function(e){function t(n){var i;N(i=e.call(this,n)||this,"shaderData",an,z(i)),N(i,"isCulled",on,z(i)),N(i,"_distanceForSort",sn,z(i)),N(i,"_onUpdateIndex",cn,z(i)),N(i,"_rendererIndex",ln,z(i)),N(i,"_globalShaderMacro",un,z(i)),N(i,"_overrideUpdate",hn,z(i)),N(i,"_materials",dn,z(i)),N(i,"_transformChangeFlag",fn,z(i)),N(i,"_bounds",_n,z(i)),N(i,"_mvMatrix",pn,z(i)),N(i,"_mvpMatrix",gn,z(i)),N(i,"_mvInvMatrix",vn,z(i)),N(i,"_normalMatrix",mn,z(i)),N(i,"_materialsInstanced",yn,z(i));var r=t.prototype;return i._overrideUpdate=i.update!==r.update,i._transformChangeFlag=i.entity.transform.registerWorldChangeFlag(),i.shaderData._addRefCount(1),i}R(t,e);var n=t.prototype;return n.getInstanceMaterial=function(e){void 0===e&&(e=0);var t=this._materials;if(t.length>e){var n=t[e];if(n)return this._materialsInstanced[e]?n:this._createInstanceMaterial(n,e)}return null},n.getMaterial=function(e){return void 0===e&&(e=0),this._materials[e]||null},n.setMaterial=function(e,t){var n;void 0===t&&(t=null),"number"==typeof e?n=e:(n=0,t=e);var i=this._materials;n>=i.length&&(i.length=n+1);var r=this._materialsInstanced,a=i[n];a!==t&&(i[n]=t,n<r.length&&(r[n]=!1),a&&a._addRefCount(-1),t&&t._addRefCount(1))},n.getInstanceMaterials=function(){for(var e=this._materials,t=this._materialsInstanced,n=0,i=e.length;n<i;n++)t[n]||this._createInstanceMaterial(this._materials[n],n);return e},n.getMaterials=function(){return this._materials},n.setMaterials=function(e){for(var t=e.length,n=this._materials,i=this._materialsInstanced,r=t,a=n.length;r<a;r++){var o=n[r];o&&o._addRefCount(-1)}n.length!==t&&(n.length=t),0!==i.length&&(i.length=0);for(var s=0;s<t;s++){var c=n[s],l=e[s];c!==l&&(n[s]=l,c&&c._addRefCount(-1),l&&l._addRefCount(1))}},n.update=function(e){},n._updateShaderData=function(e){var n=this.shaderData,i=this.entity.transform.worldMatrix,r=this._mvMatrix,a=this._mvpMatrix,o=this._mvInvMatrix,s=this._normalMatrix;p.multiply(e._camera.viewMatrix,i,r),p.multiply(e._viewProjectMatrix,i,a),p.invert(r,o),p.invert(i,s),s.transpose(),n.setMatrix(t._localMatrixProperty,this.entity.transform.localMatrix),n.setMatrix(t._worldMatrixProperty,i),n.setMatrix(t._mvMatrixProperty,r),n.setMatrix(t._mvpMatrixProperty,a),n.setMatrix(t._mvInvMatrixProperty,o),n.setMatrix(t._normalMatrixProperty,s)},n._onEnable=function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.addOnUpdateRenderers(this),e.addRenderer(this)},n._onDisable=function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.removeOnUpdateRenderers(this),e.removeRenderer(this)},n._onDestroy=function(){var e=this._transformChangeFlag;e&&(e.destroy(),this._transformChangeFlag=null),this.shaderData._addRefCount(-1);for(var t=0,n=this._materials.length;t<n;t++)this._materials[t]._addRefCount(-1)},n._updateBounds=function(e){},n._createInstanceMaterial=function(e,t){var n=e.clone();return n.name=n.name+"(Instance)",e._addRefCount(-1),n._addRefCount(1),this._materialsInstanced[t]=!0,this._materials[t]=n,n},T(t,[{key:"materialCount",get:function(){return this._materials.length},set:function(e){var t=this._materials,n=this._materialsInstanced;t.length!==e&&(t.length=e),n.length>e&&(n.length=e)}},{key:"bounds",get:function(){var e=this._transformChangeFlag;return e.flag&&(this._updateBounds(this._bounds),e.flag=!1),this._bounds}}]),t}(Qe),xn._localMatrixProperty=Pt.getPropertyByName("u_localMat"),xn._worldMatrixProperty=Pt.getPropertyByName("u_modelMat"),xn._mvMatrixProperty=Pt.getPropertyByName("u_MVMat"),xn._mvpMatrixProperty=Pt.getPropertyByName("u_MVPMat"),xn._mvInvMatrixProperty=Pt.getPropertyByName("u_MVInvMat"),xn._normalMatrixProperty=Pt.getPropertyByName("u_normalMat"),an=U((rn=wn).prototype,"shaderData",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bt(mt.Renderer)}}),on=U(rn.prototype,"isCulled",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sn=U(rn.prototype,"_distanceForSort",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),cn=U(rn.prototype,"_onUpdateIndex",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),ln=U(rn.prototype,"_rendererIndex",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),un=U(rn.prototype,"_globalShaderMacro",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new we}}),hn=U(rn.prototype,"_overrideUpdate",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),dn=U(rn.prototype,"_materials",[Y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fn=U(rn.prototype,"_transformChangeFlag",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_n=U(rn.prototype,"_bounds",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new l(new s,new s)}}),pn=U(rn.prototype,"_mvMatrix",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new p}}),gn=U(rn.prototype,"_mvpMatrix",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new p}}),vn=U(rn.prototype,"_mvInvMatrix",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new p}}),mn=U(rn.prototype,"_normalMatrix",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new p}}),yn=U(rn.prototype,"_materialsInstanced",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rn);(An=bn||(bn={}))[An.Opaque=1e3]="Opaque",An[An.AlphaTest=2e3]="AlphaTest",An[An.Transparent=3e3]="Transparent",(Mn=Tn||(Tn={}))[Mn.Front=0]="Front",Mn[Mn.Back=1]="Back",Mn[Mn.Double=2]="Double",(Pn=Cn||(Cn={}))[Pn.Normal=0]="Normal",Pn[Pn.Additive=1]="Additive";var On=function(e){function t(t,n){var i;return(i=e.call(this,t)||this).name=void 0,i.shader=void 0,i.renderQueueType=bn.Opaque,i.shaderData=new Bt(mt.Material),i.renderState=new qt,i.shader=n,i}R(t,e);var n=t.prototype;return n.clone=function(){var e=new t(this._engine,this.shader);return this.cloneTo(e),e},n.cloneTo=function(e){e.shader=this.shader,e.renderQueueType=this.renderQueueType,this.shaderData.cloneTo(e.shaderData),ne.deepCloneObject(this.renderState,e.renderState)},n._addRefCount=function(t){e.prototype._addRefCount.call(this,t),this.shaderData._addRefCount(t)},n._preRender=function(e){},n._onDestroy=function(){},t}(zt),In=function(e){function t(t,n){var i;return(i=e.call(this,t,n)||this)._alphaCutoff=0,i._renderFace=Tn.Front,i._isTransparent=!1,i._blendMode=void 0,i.blendMode=Cn.Normal,i}return R(t,e),T(t,[{key:"isTransparent",get:function(){return this._isTransparent},set:function(e){if(e!==this._isTransparent){this._isTransparent=e;var n=this.renderState,i=n.depthState,r=n.blendState.targetBlendState;e?(this.shaderData.enableMacro(t._blendMacro),r.enabled=!0,i.writeEnabled=!1,this.renderQueueType=bn.Transparent):(this.shaderData.disableMacro(t._blendMacro),r.enabled=!1,i.writeEnabled=!0,this.renderQueueType=this._alphaCutoff?bn.AlphaTest:bn.Opaque)}}},{key:"alphaCutoff",get:function(){return this._alphaCutoff},set:function(e){e!==this._alphaCutoff&&(this._alphaCutoff=e,e>0?(this.shaderData.enableMacro(t._alphaCutoffMacro),this.renderQueueType=this._isTransparent?bn.Transparent:bn.AlphaTest):(this.shaderData.disableMacro(t._alphaCutoffMacro),this.renderQueueType=this._isTransparent?bn.Transparent:bn.Opaque),this.shaderData.setFloat("u_alphaCutoff",e))}},{key:"renderFace",get:function(){return this._renderFace},set:function(e){if(e!==this._renderFace)switch(this._renderFace=e,e){case Tn.Front:this.renderState.rasterState.cullMode=ft.Back;break;case Tn.Back:this.renderState.rasterState.cullMode=ft.Front;break;case Tn.Double:this.renderState.rasterState.cullMode=ft.Off}}},{key:"blendMode",get:function(){return this._blendMode},set:function(e){if(e!==this._blendMode){this._blendMode=e;var t=this.renderState.blendState.targetBlendState;switch(e){case Cn.Normal:t.sourceColorBlendFactor=at.SourceAlpha,t.destinationColorBlendFactor=at.OneMinusSourceAlpha,t.sourceAlphaBlendFactor=at.One,t.destinationAlphaBlendFactor=at.OneMinusSourceAlpha,t.colorBlendOperation=t.alphaBlendOperation=st.Add;break;case Cn.Additive:t.sourceColorBlendFactor=at.SourceAlpha,t.destinationColorBlendFactor=at.One,t.sourceAlphaBlendFactor=at.One,t.destinationAlphaBlendFactor=at.OneMinusSourceAlpha,t.colorBlendOperation=t.alphaBlendOperation=st.Add}}}}]),t}(On);In._alphaCutoffMacro=Pt.getMacroByName("ALPHA_CUTOFF"),In._blendMacro=Pt.getMacroByName("ALPHA_BLEND");var zn,Dn,Bn,Nn,Un,Gn,kn=function(e){function t(t){var n;(n=e.call(this,t,Pt.find("blinn-phong"))||this)._baseColor=new w(1,1,1,1),n._specularColor=new w(1,1,1,1),n._emissiveColor=new w(0,0,0,1),n._baseTexture=void 0,n._specularTexture=void 0,n._emissiveTexture=void 0,n._normalTexture=void 0,n._normalIntensity=1,n._shininess=16,n._tilingOffset=new m(1,1,0,0);var i=n.shaderData;return i.enableMacro("O3_NEED_WORLDPOS"),i.enableMacro("O3_NEED_TILINGOFFSET"),i.setColor("u_diffuseColor",n._baseColor),i.setColor("u_specularColor",n._specularColor),i.setColor("u_emissiveColor",n._emissiveColor),i.setVector4("u_tilingOffset",n._tilingOffset),n.shininess=n._shininess,n.normalIntensity=n._normalIntensity,n}return R(t,e),t.prototype.clone=function(){var e=new t(this._engine);return this.cloneTo(e),e},T(t,[{key:"baseColor",get:function(){return this._baseColor},set:function(e){e!==this._baseColor&&e.cloneTo(this._baseColor)}},{key:"baseTexture",get:function(){return this._baseTexture},set:function(e){this._baseTexture=e,e?(this.shaderData.enableMacro("O3_DIFFUSE_TEXTURE"),this.shaderData.setTexture("u_diffuseTexture",e)):this.shaderData.disableMacro("O3_DIFFUSE_TEXTURE")}},{key:"specularColor",get:function(){return this._specularColor},set:function(e){e!==this._specularColor&&e.cloneTo(this._specularColor)}},{key:"specularTexture",get:function(){return this._specularTexture},set:function(e){this._specularTexture=e,e?(this.shaderData.enableMacro("O3_SPECULAR_TEXTURE"),this.shaderData.setTexture("u_specularTexture",e)):this.shaderData.disableMacro("O3_SPECULAR_TEXTURE")}},{key:"emissiveColor",get:function(){return this._emissiveColor},set:function(e){e!==this._emissiveColor&&e.cloneTo(this._emissiveColor)}},{key:"emissiveTexture",get:function(){return this._emissiveTexture},set:function(e){this._emissiveTexture=e,e?(this.shaderData.enableMacro("O3_EMISSIVE_TEXTURE"),this.shaderData.setTexture("u_emissiveTexture",e)):this.shaderData.disableMacro("O3_EMISSIVE_TEXTURE")}},{key:"normalTexture",get:function(){return this._normalTexture},set:function(e){this._normalTexture=e,e?(this.shaderData.enableMacro("O3_NORMAL_TEXTURE"),this.shaderData.setTexture("u_normalTexture",e)):this.shaderData.disableMacro("O3_NORMAL_TEXTURE")}},{key:"normalIntensity",get:function(){return this._normalIntensity},set:function(e){this._normalIntensity=e,this.shaderData.setFloat("u_normalIntensity",e)}},{key:"shininess",get:function(){return this._shininess},set:function(e){this._shininess=e,this.shaderData.setFloat("u_shininess",e)}},{key:"tilingOffset",get:function(){return this._tilingOffset},set:function(e){e!==this._tilingOffset&&e.cloneTo(this._tilingOffset)}}]),t}(In),Vn=function(e){function t(t){var n;return(n=e.call(this,t,Pt.find("pbr"))||this)._baseColor=new w(1,1,1,1),n._normalIntensity=1,n._emissiveColor=new w(0,0,0,1),n._occlusionStrength=1,n._envMapIntensity=1,n._refractionRatio=1/1.33,n._refractionDepth=1,n._perturbationUOffset=0,n._perturbationVOffset=0,n._PTMMatrix=new p(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),n._baseTexture=void 0,n._opacityTexture=void 0,n._normalTexture=void 0,n._emissiveTexture=void 0,n._occlusionTexture=void 0,n._reflectionTexture=void 0,n._refractionTexture=void 0,n._perturbationTexture=void 0,n._tilingOffset=new m(1,1,0,0),n._srgb=!1,n._srgbFast=!1,n._gamma=!1,n._getOpacityFromRGB=!1,n._envMapModeRefract=!1,n.shaderData.enableMacro("O3_NEED_WORLDPOS"),n.shaderData.enableMacro("O3_NEED_TILINGOFFSET"),n.baseColor=n._baseColor,n.normalIntensity=n._normalIntensity,n.emissiveColor=n._emissiveColor,n.occlusionStrength=n._occlusionStrength,n.envMapIntensity=n._envMapIntensity,n.refractionRatio=n._refractionRatio,n.refractionDepth=n._refractionDepth,n.perturbationUOffset=n._perturbationUOffset,n.perturbationVOffset=n._perturbationVOffset,n.tilingOffset=n._tilingOffset,n.srgb=n._srgb,n.srgbFast=n._srgbFast,n.gamma=n._gamma,n.getOpacityFromRGB=n._getOpacityFromRGB,n.envMapModeRefract=n._envMapModeRefract,n}return R(t,e),T(t,[{key:"tilingOffset",get:function(){return this._tilingOffset},set:function(e){this._tilingOffset=e,this.shaderData.setVector4("u_tilingOffset",e)}},{key:"baseColor",get:function(){return this._baseColor},set:function(e){this._baseColor=e,this.shaderData.setColor("u_baseColorFactor",e)}},{key:"baseTexture",get:function(){return this._baseTexture},set:function(e){this._baseTexture=e,e?(this.shaderData.enableMacro("HAS_BASECOLORMAP"),this.shaderData.setTexture("u_baseColorSampler",e)):this.shaderData.disableMacro("HAS_BASECOLORMAP")}},{key:"opacity",get:function(){return this.baseColor.a},set:function(e){this.baseColor.a=e}},{key:"opacityTexture",get:function(){return this._opacityTexture},set:function(e){this._opacityTexture=e,e?(this.shaderData.enableMacro("HAS_OPACITYMAP"),this.shaderData.setTexture("u_opacitySampler",e)):this.shaderData.disableMacro("HAS_OPACITYMAP")}},{key:"normalTexture",get:function(){return this._normalTexture},set:function(e){this._normalTexture=e,e?(this.shaderData.enableMacro("O3_NORMAL_TEXTURE"),this.shaderData.setTexture("u_normalTexture",e)):this.shaderData.disableMacro("O3_NORMAL_TEXTURE")}},{key:"normalIntensity",get:function(){return this._normalIntensity},set:function(e){this._normalIntensity=e,this.shaderData.setFloat("u_normalIntensity",e)}},{key:"emissiveTexture",get:function(){return this._emissiveTexture},set:function(e){this._emissiveTexture=e,e?(this.shaderData.enableMacro("HAS_EMISSIVEMAP"),this.shaderData.setTexture("u_emissiveSampler",e)):this.shaderData.disableMacro("HAS_EMISSIVEMAP")}},{key:"emissiveColor",get:function(){return this._emissiveColor},set:function(e){this._emissiveColor=e,this.shaderData.setColor("u_emissiveFactor",e)}},{key:"occlusionTexture",get:function(){return this._occlusionTexture},set:function(e){this._occlusionTexture=e,e?(this.shaderData.enableMacro("HAS_OCCLUSIONMAP"),this.shaderData.setTexture("u_occlusionSampler",e)):this.shaderData.disableMacro("HAS_OCCLUSIONMAP")}},{key:"occlusionStrength",get:function(){return this._occlusionStrength},set:function(e){this._occlusionStrength=e,this.shaderData.setFloat("u_occlusionStrength",e)}},{key:"reflectionTexture",get:function(){return this._reflectionTexture},set:function(e){this._reflectionTexture=e,e?(this.shaderData.enableMacro("HAS_REFLECTIONMAP"),this.shaderData.setTexture("u_reflectionSampler",e)):this.shaderData.disableMacro("HAS_REFLECTIONMAP")}},{key:"envMapIntensity",get:function(){return this._envMapIntensity},set:function(e){this._envMapIntensity=e,this.shaderData.setFloat("u_envMapIntensity",e)}},{key:"refractionRatio",get:function(){return this._refractionRatio},set:function(e){this._refractionRatio=e,this.shaderData.setFloat("u_refractionRatio",e)}},{key:"refractionDepth",get:function(){return this._refractionDepth},set:function(e){this._refractionDepth=e,this.shaderData.setFloat("u_refractionDepth",e)}},{key:"refractionTexture",get:function(){return this._refractionTexture},set:function(e){this._refractionTexture=e,e?(this.shaderData.enableMacro("HAS_REFRACTIONMAP"),this.shaderData.setTexture("u_refractionSampler",e),this.shaderData.setMatrix("u_PTMMatrix",this._PTMMatrix)):this.shaderData.disableMacro("HAS_REFRACTIONMAP")}},{key:"perturbationTexture",get:function(){return this._perturbationTexture},set:function(e){this._perturbationTexture=e,e?(this.shaderData.enableMacro("HAS_PERTURBATIONMAP"),this.shaderData.setTexture("u_perturbationSampler",e)):this.shaderData.disableMacro("HAS_PERTURBATIONMAP")}},{key:"perturbationUOffset",get:function(){return this._perturbationUOffset},set:function(e){this._perturbationUOffset=e,this.shaderData.setFloat("u_perturbationUOffset",e)}},{key:"perturbationVOffset",get:function(){return this._perturbationVOffset},set:function(e){this._perturbationVOffset=e,this.shaderData.setFloat("u_perturbationVOffset",e)}},{key:"srgb",get:function(){return this._srgb},set:function(e){this._srgb=e,e?this.shaderData.enableMacro("MANUAL_SRGB"):this.shaderData.disableMacro("MANUAL_SRGB")}},{key:"srgbFast",get:function(){return this._srgbFast},set:function(e){this._srgbFast=e,e?this.shaderData.enableMacro("SRGB_FAST_APPROXIMATION"):this.shaderData.disableMacro("SRGB_FAST_APPROXIMATION")}},{key:"gamma",get:function(){return this._gamma},set:function(e){this._gamma=e,e?this.shaderData.enableMacro("GAMMA"):this.shaderData.disableMacro("GAMMA")}},{key:"getOpacityFromRGB",get:function(){return this._getOpacityFromRGB},set:function(e){this._getOpacityFromRGB=e,e?this.shaderData.enableMacro("GETOPACITYFROMRGB"):this.shaderData.disableMacro("GETOPACITYFROMRGB")}},{key:"envMapModeRefract",get:function(){return this._envMapModeRefract},set:function(e){this._envMapModeRefract=e,e?this.shaderData.enableMacro("ENVMAPMODE_REFRACT"):this.shaderData.disableMacro("ENVMAPMODE_REFRACT")}}]),t}(In),Hn=function(e){function t(t){var n;return(n=e.call(this,t)||this)._metallicFactor=1,n._roughnessFactor=1,n._metallicTexture=void 0,n._roughnessTexture=void 0,n._metallicRoughnessTexture=void 0,n.shaderData.enableMacro("IS_METALLIC_WORKFLOW"),n.metallicFactor=n._metallicFactor,n.roughnessFactor=n._roughnessFactor,n}return R(t,e),t.prototype.clone=function(){var e=new t(this._engine);return this.cloneTo(e),e},T(t,[{key:"metallicFactor",get:function(){return this._metallicFactor},set:function(e){this._metallicFactor=e,this.shaderData.setFloat("u_metal",e)}},{key:"roughnessFactor",get:function(){return this._roughnessFactor},set:function(e){this._roughnessFactor=e,this.shaderData.setFloat("u_roughness",e)}},{key:"metallicTexture",get:function(){return this._metallicTexture},set:function(e){this._metallicTexture=e,e?(this.shaderData.enableMacro("HAS_METALMAP"),this.shaderData.setTexture("u_metallicSampler",e)):this.shaderData.disableMacro("HAS_METALMAP")}},{key:"roughnessTexture",get:function(){return this._roughnessTexture},set:function(e){this._roughnessTexture=e,e?(this.shaderData.enableMacro("HAS_ROUGHNESSMAP"),this.shaderData.setTexture("u_roughnessSampler",e)):this.shaderData.disableMacro("HAS_ROUGHNESSMAP")}},{key:"metallicRoughnessTexture",get:function(){return this._metallicRoughnessTexture},set:function(e){this._metallicRoughnessTexture=e,e?(this.shaderData.enableMacro("HAS_METALROUGHNESSMAP"),this.shaderData.setTexture("u_metallicRoughnessSampler",e)):this.shaderData.disableMacro("HAS_METALROUGHNESSMAP")}}]),t}(Vn),jn=function(e){function t(t){var n;return(n=e.call(this,t)||this)._specularColor=new w(1,1,1,1),n._glossinessFactor=1,n._specularGlossinessTexture=void 0,n.specularColor=n._specularColor,n.glossinessFactor=n._glossinessFactor,n}return R(t,e),t.prototype.clone=function(){var e=new t(this._engine);return this.cloneTo(e),e},T(t,[{key:"specularColor",get:function(){return this._specularColor},set:function(e){this._specularColor=e,this.shaderData.setColor("u_specularFactor",e)}},{key:"glossinessFactor",get:function(){return this._glossinessFactor},set:function(e){this._glossinessFactor=e,this.shaderData.setFloat("u_glossinessFactor",e)}},{key:"specularGlossinessTexture",get:function(){return this._specularGlossinessTexture},set:function(e){this._specularGlossinessTexture=e,e?(this.shaderData.enableMacro("HAS_SPECULARGLOSSINESSMAP"),this.shaderData.setTexture("u_specularGlossinessSampler",e)):this.shaderData.disableMacro("HAS_SPECULARGLOSSINESSMAP")}}]),t}(Vn),Wn=function(e){function t(t){var n;(n=e.call(this,t,Pt.find("unlit"))||this)._baseColor=new w(1,1,1,1),n._baseTexture=void 0,n._tilingOffset=new m(1,1,0,0);var i=n.shaderData;return i.enableMacro("OMIT_NORMAL"),i.enableMacro("O3_NEED_TILINGOFFSET"),i.setColor("u_baseColor",n._baseColor),i.setVector4("u_tilingOffset",n._tilingOffset),n}return R(t,e),t.prototype.clone=function(){var e=new t(this._engine);return this.cloneTo(e),e},T(t,[{key:"baseColor",get:function(){return this._baseColor},set:function(e){e!==this._baseColor&&e.cloneTo(this._baseColor)}},{key:"baseTexture",get:function(){return this._baseTexture},set:function(e){this._baseTexture=e,e?(this.shaderData.enableMacro("O3_BASE_TEXTURE"),this.shaderData.setTexture("u_baseTexture",e)):this.shaderData.disableMacro("O3_BASE_TEXTURE")}},{key:"tilingOffset",get:function(){return this._tilingOffset},set:function(e){e!==this._tilingOffset&&e.cloneTo(this._tilingOffset)}}]),t}(In),Xn=0,Kn=function(){function e(e,t,n,i,r,a){void 0===e&&(e="RENDER_PASS"+Xn++),void 0===t&&(t=0),void 0===n&&(n=null),void 0===i&&(i=null),void 0===r&&(r=null),void 0===a&&(a=new m(0,0,0,0)),this.name=void 0,this.enabled=void 0,this.priority=void 0,this.renderTarget=void 0,this.replaceMaterial=void 0,this.mask=void 0,this.renderOverride=void 0,this.clearMode=void 0,this._clearParam=void 0,this.name=e,this.enabled=!0,this.priority=t,this.renderTarget=n,this.replaceMaterial=i,this.mask=r||Ae.Everything,this.renderOverride=!1,this.clearMode=ae.SOLID_COLOR,this._clearParam=a}var t=e.prototype;return t.render=function(e,t,n,i){},t.preRender=function(e,t,n,i){},t.postRender=function(e,t,n,i){},T(e,[{key:"clearParam",get:function(){return this._clearParam},set:function(e){this._clearParam=e}}]),e}();(Dn=zn||(zn={}))[Dn.Static=0]="Static",Dn[Dn.Dynamic=1]="Dynamic",Dn[Dn.Stream=2]="Stream",(Nn=Bn||(Bn={}))[Nn.Float=0]="Float",Nn[Nn.Vector2=1]="Vector2",Nn[Nn.Vector3=2]="Vector3",Nn[Nn.Vector4=3]="Vector4",Nn[Nn.Byte4=4]="Byte4",Nn[Nn.UByte4=5]="UByte4",Nn[Nn.NormalizedByte4=6]="NormalizedByte4",Nn[Nn.NormalizedUByte4=7]="NormalizedUByte4",Nn[Nn.Short2=8]="Short2",Nn[Nn.UShort2=9]="UShort2",Nn[Nn.NormalizedShort2=10]="NormalizedShort2",Nn[Nn.NormalizedUShort2=11]="NormalizedUShort2",Nn[Nn.Short4=12]="Short4",Nn[Nn.UShort4=13]="UShort4",Nn[Nn.NormalizedShort4=14]="NormalizedShort4",Nn[Nn.NormalizedUShort4=15]="NormalizedUShort4",(Gn=Un||(Un={}))[Gn.UInt8=0]="UInt8",Gn[Gn.UInt16=1]="UInt16",Gn[Gn.UInt32=2]="UInt32";var qn,Yn,Qn,Zn,Jn=function(){function e(){}return e._getGLBufferUsage=function(e,t){switch(t){case zn.Static:return e.STATIC_DRAW;case zn.Dynamic:return e.DYNAMIC_DRAW;case zn.Stream:return e.STREAM_DRAW}},e._getGLIndexType=function(e){switch(e){case Un.UInt8:return se.UNSIGNED_BYTE;case Un.UInt16:return se.UNSIGNED_SHORT;case Un.UInt32:return se.UNSIGNED_INT}},e._getGLIndexByteCount=function(e){switch(e){case Un.UInt8:return 1;case Un.UInt16:return 2;case Un.UInt32:return 4}},e._getElementInfo=function(e){var t,n;switch(e){case Bn.Float:t=1,n=se.FLOAT;break;case Bn.Vector2:t=2,n=se.FLOAT;break;case Bn.Vector3:t=3,n=se.FLOAT;break;case Bn.Vector4:t=4,n=se.FLOAT;break;case Bn.Byte4:t=4,n=se.UNSIGNED_BYTE;break;case Bn.Short2:t=2,n=se.SHORT;break;case Bn.Short4:t=4,n=se.SHORT;break;case Bn.UShort2:t=2,n=se.UNSIGNED_SHORT;break;case Bn.UShort4:t=4,n=se.UNSIGNED_SHORT}return{size:t,type:n}},e}();(Yn=qn||(qn={}))[Yn.VertexBuffer=0]="VertexBuffer",Yn[Yn.IndexBuffer=1]="IndexBuffer",(Zn=Qn||(Qn={}))[Zn.None=0]="None",Zn[Zn.Discard=1]="Discard";var $n,ei,ti=function(e){function t(t,n,i,r){var a;void 0===r&&(r=zn.Static),(a=e.call(this,t)||this)._glBindTarget=void 0,a._glBufferUsage=void 0,a._nativeBuffer=void 0,a._hardwareRenderer=void 0,a._type=void 0,a._byteLength=void 0,a._bufferUsage=void 0,a._engine=t,a._type=n,a._bufferUsage=r;var o=t._hardwareRenderer,s=o.gl,c=Jn._getGLBufferUsage(s,r),l=n===qn.VertexBuffer?s.ARRAY_BUFFER:s.ELEMENT_ARRAY_BUFFER;return a._nativeBuffer=s.createBuffer(),a._hardwareRenderer=o,a._glBufferUsage=c,a._glBindTarget=l,a.bind(),"number"==typeof i?(a._byteLength=i,s.bufferData(l,i,c)):(a._byteLength=i.byteLength,s.bufferData(l,i,c)),s.bindBuffer(l,null),a}R(t,e);var n=t.prototype;return n.bind=function(){this._hardwareRenderer.gl.bindBuffer(this._glBindTarget,this._nativeBuffer)},n.setData=function(e,t,n,i,r){void 0===t&&(t=0),void 0===n&&(n=0),void 0===r&&(r=Qn.None);var a=this._hardwareRenderer.gl,o=this._hardwareRenderer.isWebGL2,s=this._glBindTarget;this.bind(),r===Qn.Discard&&a.bufferData(s,this._byteLength,this._glBufferUsage);var c=e.BYTES_PER_ELEMENT||1,l=i?c*i:e.byteLength;if(0!==n||l<e.byteLength){var u=void 0!==e.byteOffset;if(o&&u)a.bufferSubData(s,t,e,n,l/c);else{var h=new Uint8Array(u?e.buffer:e,n*c,l);a.bufferSubData(s,t,h)}}else a.bufferSubData(s,t,e);a.bindBuffer(s,null)},n.getData=function(e,t,n,i){if(void 0===t&&(t=0),void 0===n&&(n=0),!this._hardwareRenderer.isWebGL2)throw"Buffer is write-only on WebGL1.0 platforms.";var r=this._hardwareRenderer.gl;this.bind(),r.getBufferSubData(this._glBindTarget,t,e,n,i)},n._onDestroy=function(){this._hardwareRenderer.gl.deleteBuffer(this._nativeBuffer),this._nativeBuffer=null,this._hardwareRenderer=null},n.resize=function(e){this.bind(),this._hardwareRenderer.gl.bufferData(this._glBindTarget,e,this._glBufferUsage),this._byteLength=e},T(t,[{key:"engine",get:function(){return this._engine}},{key:"type",get:function(){return this._type}},{key:"byteLength",get:function(){return this._byteLength}},{key:"bufferUsage",get:function(){return this._bufferUsage}}]),t}(zt);(ei=$n||($n={}))[ei.Points=0]="Points",ei[ei.Lines=1]="Lines",ei[ei.LineLoop=2]="LineLoop",ei[ei.LineStrip=3]="LineStrip",ei[ei.Triangles=4]="Triangles",ei[ei.TriangleStrip=5]="TriangleStrip",ei[ei.TriangleFan=6]="TriangleFan";var ni=function(){function e(e,t){this._buffer=void 0,this._format=void 0,this._buffer=e,this._format=t}return T(e,[{key:"buffer",get:function(){return this._buffer}},{key:"format",get:function(){return this._format}}]),e}(),ii=function(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=$n.Triangles),this.start=void 0,this.count=void 0,this.topology=void 0,this.start=e,this.count=t,this.topology=n},ri=function(e){function t(t,n){var i;return(i=e.call(this,t)||this).name=void 0,i.bounds=new l,i._vertexElementMap={},i._glIndexType=void 0,i._glIndexByteCount=void 0,i._platformPrimitive=void 0,i._instanceCount=0,i._vertexBufferBindings=[],i._indexBufferBinding=null,i._vertexElements=[],i._subMeshes=[],i._updateFlags=[],i.name=n,i._platformPrimitive=i._engine._hardwareRenderer.createPlatformPrimitive(z(i)),i}R(t,e);var n=t.prototype;return n.addSubMesh=function(e,t,n){return void 0===n&&(n=$n.Triangles),"number"==typeof e&&(e=new ii(e,t,n)),this._subMeshes.push(e),e},n.removeSubMesh=function(e){var t=this._subMeshes,n=t.indexOf(e);-1!==n&&t.splice(n,1)},n.clearSubMesh=function(){this._subMeshes.length=0},n.registerUpdateFlag=function(){return new Ze(this._updateFlags)},n._draw=function(e,t){this._platformPrimitive.draw(e,t)},n._addRefCount=function(t){e.prototype._addRefCount.call(this,t);for(var n=this._vertexBufferBindings,i=0,r=n.length;i<r;i++)n[i]._buffer._addRefCount(t)},n._onDestroy=function(){this._vertexBufferBindings=null,this._indexBufferBinding=null,this._vertexElements=null,this._vertexElementMap=null,this._platformPrimitive.destroy()},n._setVertexElements=function(e){this._clearVertexElements();for(var t=0,n=e.length;t<n;t++)this._addVertexElement(e[t])},n._setVertexBufferBinding=function(e,t){if(this._getRefCount()>0){var n=this._vertexBufferBindings[e];n&&n._buffer._addRefCount(-1),t._buffer._addRefCount(1)}this._vertexBufferBindings[e]=t},n._setIndexBufferBinding=function(e){e?(this._indexBufferBinding=e,this._glIndexType=Jn._getGLIndexType(e.format),this._glIndexByteCount=Jn._getGLIndexByteCount(e.format)):(this._indexBufferBinding=null,this._glIndexType=void 0)},n._clearVertexElements=function(){this._vertexElements.length=0;var e=this._vertexElementMap;for(var t in e)delete e[t]},n._addVertexElement=function(e){var t=e.semantic;this._vertexElementMap[t]=e,this._vertexElements.push(e),this._makeModified()},n._makeModified=function(){for(var e=this._updateFlags.length-1;e>=0;e--)this._updateFlags[e].flag=!0},T(t,[{key:"subMesh",get:function(){return this._subMeshes[0]||null}},{key:"subMeshes",get:function(){return this._subMeshes}}]),t}(zt),ai=function(){function e(e,t){this._buffer=void 0,this._stride=void 0,this._buffer=e,this._stride=t}return T(e,[{key:"buffer",get:function(){return this._buffer}},{key:"stride",get:function(){return this._stride}}]),e}(),oi=function(){function e(e,t,n,i,r){void 0===r&&(r=0),this.normalized=!1,this._glElementInfo=void 0,this._semantic=void 0,this._offset=void 0,this._format=void 0,this._bindingIndex=void 0,this._instanceStepRate=void 0,this._semantic=e,this._offset=t,this._format=n,this._bindingIndex=i,this._glElementInfo=Jn._getElementInfo(this.format),this._instanceStepRate=Math.floor(r)}return T(e,[{key:"semantic",get:function(){return this._semantic}},{key:"offset",get:function(){return this._offset}},{key:"format",get:function(){return this._format}},{key:"bindingIndex",get:function(){return this._bindingIndex}},{key:"instanceStepRate",get:function(){return this._instanceStepRate}},{key:"elementInfo",get:function(){return this._glElementInfo}}]),e}(),si=function(e){function t(){return e.apply(this,arguments)||this}R(t,e);var n=t.prototype;return n.setVertexElements=function(e){this._setVertexElements(e)},n.setVertexBufferBinding=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=0);var i=e,r=void 0!==i.buffer;r||(i=new ai(e,t));var a=this._vertexBufferBindings;a.length<=n&&(a.length=n+1),this._setVertexBufferBinding(r?t:n,i)},n.setVertexBufferBindings=function(e,t){void 0===t&&(t=0);var n=this._vertexBufferBindings,i=e.length,r=t+i;n.length<r&&(n.length=r);for(var a=0;a<i;a++)this._setVertexBufferBinding(t+a,e[a])},n.setIndexBufferBinding=function(e,t){var n=e;n&&(void 0!==n.buffer||(n=new ni(e,t)));this._setIndexBufferBinding(n)},T(t,[{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"vertexBufferBindings",get:function(){return this._vertexBufferBindings}},{key:"indexBufferBinding",get:function(){return this._indexBufferBinding}},{key:"vertexElements",get:function(){return this._vertexElements}}]),t}(ri),ci=function(){function e(t){this._batchedQueue=[],this._meshes=[],this._meshCount=1,this._vertexBuffers=[],this._indiceBuffers=[],this._vertices=void 0,this._indices=void 0,this._vertexCount=0,this._spriteCount=0,this._flushId=0;var n=e.MAX_VERTEX_COUNT;this._vertices=new Float32Array(9*n),this._indices=new Uint16Array(3*n);for(var i=this._meshes,r=this._meshCount,a=0;a<r;a++)i[a]=this._createMesh(t,a)}e._getSubMeshFromPool=function(t,n,i){void 0===i&&(i=$n.Triangles);var r=e._subMeshPoolIndex,a=e._subMeshPool;e._subMeshPoolIndex++;var o=null;return a.length===r?(o=new ii(t,n,i),a.push(o)):((o=a[r]).start=t,o.count=n,o.topology=i),o},e._restPool=function(){e._subMeshPoolIndex=0};var t=e.prototype;return t._createMesh=function(t,n){var i=e.MAX_VERTEX_COUNT,r=new si(t,"SpriteBatchBufferMesh"+n),a=[new oi("POSITION",0,Bn.Vector3,0),new oi("TEXCOORD_0",12,Bn.Vector2,0),new oi("COLOR_0",20,Bn.Vector4,0)];return this._vertexBuffers[n]=new ti(t,qn.VertexBuffer,4*i*36,zn.Dynamic),this._indiceBuffers[n]=new ti(t,qn.IndexBuffer,3*i,zn.Dynamic),r.setVertexBufferBinding(this._vertexBuffers[n],36),r.setIndexBufferBinding(this._indiceBuffers[n],Un.UInt16),r.setVertexElements(a),r},t._updateData=function(t){var n=this._meshes,i=this._flushId;!e._canUploadSameBuffer&&this._meshCount<=i&&(this._meshCount++,n[i]=this._createMesh(t,i));var r=e._getSubMeshFromPool,a=this._batchedQueue,o=this._vertices,s=this._indices,c=n[i];c.clearSubMesh();for(var l=0,u=0,h=0,d=0,f=0,_=0,p=null,g=0,v=a.length;g<v;g++){for(var m=a[g],y=m.positions,x=m.uv,w=m.triangles,b=m.color,A=y.length,T=0;T<A;T++){var M=y[T],C=x[T];o[l++]=M.x,o[l++]=M.y,o[l++]=M.z,o[l++]=C.x,o[l++]=C.y,o[l++]=b.r,o[l++]=b.g,o[l++]=b.b,o[l++]=b.a}for(var P=w.length,S=0;S<P;S++)s[u++]=w[S]+f;f+=A,null===p||this._canBatch(p,m)?d+=P:(c.addSubMesh(r(h,d)),h+=d,d=P,a[_++]=p),p=m}c.addSubMesh(r(h,d)),a[_]=p,this._vertexBuffers[i].setData(o,0,0,l),this._indiceBuffers[i].setData(s,0,0,u)},t._drawBatches=function(e){for(var t=this._meshes[this._flushId],n=t.subMeshes,i=this._batchedQueue,r=0,a=n.length;r<a;r++){var o=n[r],s=i[r];if(!o||!s)return;var c=Pt._compileMacros;c.clear();var l=s.material,u=l.shader._getShaderProgram(e,c);if(!u.isValid)return;u.bind(),u.groupingOtherUniformBlock();var h=s.camera;u.uploadAll(u.sceneUniformBlock,h.scene.shaderData),u.uploadAll(u.cameraUniformBlock,h.shaderData),u.uploadAll(u.rendererUniformBlock,s.component.shaderData),u.uploadAll(u.materialUniformBlock,l.shaderData),l.renderState._apply(e),e._hardwareRenderer.drawPrimitive(t,o,u)}},t._canBatch=function(t,n){var i=e._textureProperty;return t.component.shaderData.getTexture(i)===n.component.shaderData.getTexture(i)&&(t.material===n.material&&t.camera===n.camera)},t.flush=function(t){0!==this._batchedQueue.length&&(this._updateData(t),this._drawBatches(t),e._canUploadSameBuffer||this._flushId++,e._restPool(),this._batchedQueue.length=0,this._vertexCount=0,this._spriteCount=0)},t.drawSprite=function(t){var n=t.positions.length;this._vertexCount+n>e.MAX_VERTEX_COUNT&&this.flush(t.camera.engine),this._vertexCount+=n,this._batchedQueue[this._spriteCount++]=t},t.clear=function(){this._flushId=0,this._vertexCount=0,this._spriteCount=0,this._batchedQueue.length=0},e}();ci._textureProperty=Pt.getPropertyByName("u_texture"),ci.MAX_VERTEX_COUNT=4096,ci._canUploadSameBuffer=!Rn._isIos(),ci._subMeshPool=[],ci._subMeshPoolIndex=0;var li,ui,hi,di,fi,_i,pi,gi,vi,mi,yi,xi,wi,bi,Ai,Ti,Mi,Ci,Pi,Si,Ri=function(){function e(e){this.items=[],this._spriteBatcher=void 0,this._spriteBatcher=new ci(e)}e._compareFromNearToFar=function(e,t){var n=e.material.renderQueueType-t.material.renderQueueType;return n||e.component._distanceForSort-t.component._distanceForSort},e._compareFromFarToNear=function(e,t){var n=e.material.renderQueueType-t.material.renderQueueType;return n||t.component._distanceForSort-e.component._distanceForSort};var t=e.prototype;return t.pushPrimitive=function(e){this.items.push(e)},t.render=function(e,t,n){var i=this.items;if(0!==i.length){for(var r=e.engine,a=e.scene,o=r._renderCount,s=r._hardwareRenderer,c=a.shaderData,l=e.shaderData,u=0,h=i.length;u<h;u++){var d=i[u];if(d.component.entity.layer&n)if(d.mesh){this._spriteBatcher.flush(r);var f=Pt._compileMacros,_=d,p=_.component,g=t||_.material,v=p.shaderData,m=g.shaderData;g._preRender(_),we.unionCollection(p._globalShaderMacro,m._macroCollection,f);var y=g.shader._getShaderProgram(r,f);if(!y.isValid)continue;var x=y.bind();o!==y._uploadRenderCount?(y.groupingOtherUniformBlock(),y.uploadAll(y.sceneUniformBlock,c),y.uploadAll(y.cameraUniformBlock,l),y.uploadAll(y.rendererUniformBlock,v),y.uploadAll(y.materialUniformBlock,m),y._uploadCamera=e,y._uploadRenderer=p,y._uploadMaterial=g,y._uploadRenderCount=o):(y._uploadCamera!==e?(y.uploadAll(y.cameraUniformBlock,l),y._uploadCamera=e):x&&y.uploadTextures(y.cameraUniformBlock,l),y._uploadRenderer!==p?(y.uploadAll(y.rendererUniformBlock,v),y._uploadRenderer=p):x&&y.uploadTextures(y.rendererUniformBlock,v),y._uploadMaterial!==g?(y.uploadAll(y.materialUniformBlock,m),y._uploadMaterial=g):x&&y.uploadTextures(y.materialUniformBlock,m)),g.renderState._apply(e.engine),s.drawPrimitive(_.mesh,_.subMesh,y)}else{var w=d;this._spriteBatcher.drawSprite(w)}}this._spriteBatcher.flush(r)}},t.clear=function(){this.items.length=0,this._spriteBatcher.clear()},t.sort=function(e){this._quickSort(this.items,0,this.items.length,e)},t._quickSort=function(e,t,n,i){for(;;){if(n-t<=10)return void this._insertionSort(e,t,n,i);var r=t+n>>1,a=e[t],o=e[n-1],s=e[r];if(i(a,o)>0){var c=a;a=o,o=c}if(i(a,s)>=0){var l=a;a=s,s=o,o=l}else{if(i(o,s)>0){var u=o;o=s,s=u}}e[t]=a,e[n-1]=s;var h=o,d=t+1,f=n-1;e[r]=e[d],e[d]=h;e:for(var _=d+1;_<f;_++){var p=e[_],g=i(p,h);if(g<0)e[_]=e[d],e[d]=p,d++;else if(g>0){do{if(--f==_)break e;g=i(e[f],h)}while(g>0);e[_]=e[f],e[f]=p,g<0&&(p=e[_],e[_]=e[d],e[d]=p,d++)}}n-f<d-t?(this._quickSort(e,f,n,i),n=d):(this._quickSort(e,t,d,i),t=f)}},t._insertionSort=function(e,t,n,i){for(var r=t+1;r<n;r++){for(var a=e[r],o=r-1;o>=t;o--){var s=e[o];if(!(i(s,a)>0))break;e[o+1]=s}e[o+1]=a}},e}(),Ei=function(){function e(e){this._opaqueQueue=void 0,this._transparentQueue=void 0,this._alphaTestQueue=void 0,this._camera=void 0,this._defaultPass=void 0,this._renderPassArray=void 0,this._canvasDepthPass=void 0,this._camera=e,this._opaqueQueue=new Ri(e.engine),this._alphaTestQueue=new Ri(e.engine),this._transparentQueue=new Ri(e.engine),this._renderPassArray=[],this._defaultPass=new Kn("default",0,null,null,0),this.addRenderPass(this._defaultPass)}var t=e.prototype;return t.addRenderPass=function(e,t,n,i,r,a){if(void 0===t&&(t=null),void 0===n&&(n=null),void 0===i&&(i=null),void 0===r&&(r=null),void 0===a&&(a=new m(0,0,0,0)),"string"==typeof e){var o=new Kn(e,t,n,i,r,a);this._renderPassArray.push(o)}else e instanceof Kn&&this._renderPassArray.push(e);this._renderPassArray.sort((function(e,t){return e.priority-t.priority}))},t.removeRenderPass=function(e){var t;if("string"==typeof e?t=this.getRenderPass(e):e instanceof Kn&&(t=e),t){var n=this._renderPassArray.indexOf(t);this._renderPassArray.splice(n,1)}},t.getRenderPass=function(e){for(var t=0,n=this._renderPassArray.length;t<n;t++){var i=this._renderPassArray[t];if(i.name===e)return i}return null},t.destroy=function(){},t.render=function(e,t){var n=this._camera,i=this._opaqueQueue,r=this._alphaTestQueue,a=this._transparentQueue;i.clear(),r.clear(),a.clear(),n.engine._componentsManager.callRender(e),i.sort(Ri._compareFromNearToFar),r.sort(Ri._compareFromNearToFar),a.sort(Ri._compareFromFarToNear),this._canvasDepthPass&&(this._canvasDepthPass.enabled=!1);for(var o=0,s=this._renderPassArray.length;o<s;o++)this._drawRenderPass(this._renderPassArray[o],n,t)},t._drawRenderPass=function(e,t,n){if(e.preRender(t,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue),e.enabled){var i=t.scene.engine._hardwareRenderer,r=t.renderTarget||e.renderTarget;i.activeRenderTarget(r,t),null==r||r._setRenderTargetFace(n),i.clearRenderTarget(t.engine,e.clearMode,e.clearParam),e.renderOverride?e.render(t,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue):(this._opaqueQueue.render(t,e.replaceMaterial,e.mask),this._alphaTestQueue.render(t,e.replaceMaterial,e.mask),this._transparentQueue.render(t,e.replaceMaterial,e.mask)),null==r||r._blitRenderTarget(),null==r||r.generateMipmaps()}e.postRender(t,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue)},t.pushPrimitive=function(e){var t=e.material.renderQueueType;t>bn.Transparent+bn.AlphaTest>>1?this._transparentQueue.pushPrimitive(e):t>bn.AlphaTest+bn.Opaque>>1?this._alphaTestQueue.pushPrimitive(e):this._opaqueQueue.pushPrimitive(e)},T(e,[{key:"defaultRenderPass",get:function(){return this._defaultPass}}]),e}(),Li=function(){};Li.tempMat4=new p,Li.tempVec4=new m,Li.tempVec3=new s,Li.tempVec2=new v,(Si=Pi||(Pi={}))[Si.DepthSky=0]="DepthSky",Si[Si.DepthColor=1]="DepthColor",Si[Si.Depth=2]="Depth",Si[Si.None=3]="None";var Fi=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(e){t.forEach((function(t){return Le.register(e,t)}))}}(Je)((Ci=Mi=function(e){function t(t){var n;(n=e.call(this,t)||this).priority=0,n.enableFrustumCulling=!0,n.cullingMask=Ae.Everything,n.shaderData=new Bt(mt.Camera),n._globalShaderMacro=new we,N(n,"_frustum",hi,z(n)),N(n,"_renderPipeline",di,z(n)),n._isOrthographic=!1,n._isProjMatSetting=!1,n._clearMode=ae.SOLID_COLOR,n._nearClipPlane=.1,n._farClipPlane=100,n._fieldOfView=45,n._orthographicSize=10,n._isProjectionDirty=!0,n._isInvProjMatDirty=!0,n._isFrustumProjectDirty=!0,n._customAspectRatio=void 0,n._renderTarget=null,N(n,"_frustumViewChangeFlag",fi,z(n)),N(n,"_transform",_i,z(n)),N(n,"_isViewMatrixDirty",pi,z(n)),N(n,"_isInvViewProjDirty",gi,z(n)),N(n,"_projectionMatrix",vi,z(n)),N(n,"_viewMatrix",mi,z(n)),N(n,"_backgroundColor",yi,z(n)),N(n,"_viewport",xi,z(n)),N(n,"_inverseProjectionMatrix",wi,z(n)),N(n,"_inverseViewMatrix",bi,z(n)),N(n,"_lastAspectSize",Ai,z(n)),N(n,"_invViewProjMat",Ti,z(n));var i=n.entity.transform;return n._transform=i,n._isViewMatrixDirty=i.registerWorldChangeFlag(),n._isInvViewProjDirty=i.registerWorldChangeFlag(),n._frustumViewChangeFlag=i.registerWorldChangeFlag(),n._renderPipeline=new Ei(z(n)),n.shaderData._addRefCount(1),n.setClearMode(),n}R(t,e);var n=t.prototype;return n.resetProjectionMatrix=function(){this._isProjMatSetting=!1,this._projMatChange()},n.resetAspectRatio=function(){this._customAspectRatio=void 0,this._projMatChange()},n.worldToViewportPoint=function(e,t){p.multiply(this.projectionMatrix,this.viewMatrix,Li.tempMat4),Li.tempVec4.setValue(e.x,e.y,e.z,1),m.transform(Li.tempVec4,Li.tempMat4,Li.tempVec4);var n=Li.tempVec4.w,i=Li.tempVec4.x/n,r=Li.tempVec4.y/n,a=Li.tempVec4.z/n;return t.x=.5*(i+1),t.y=.5*(1-r),t.z=a,t.w=n,t},n.viewportToWorldPoint=function(e,t){var n=this.invViewProjMat;return this._innerViewportToWorldPoint(e,n,t)},n.viewportPointToRay=function(e,t){var n=Li.tempVec3;n.setValue(e.x,e.y,0);var i=this.viewportToWorldPoint(n,t.origin);n.z=1;var r=this._innerViewportToWorldPoint(n,this._invViewProjMat,n);return s.subtract(r,i,t.direction),t.direction.normalize(),t},n.screenToViewportPoint=function(e,t){var n=this.engine.canvas,i=this.viewport;return t.x=(e.x/n.width-i.x)/i.z,t.y=(e.y/n.height-i.y)/i.w,t},n.viewportToScreenPoint=function(e,t){var n=this.engine.canvas,i=this.viewport;return t.x=(i.x+e.x*i.z)*n.width,t.y=(i.y+e.y*i.w)*n.height,t},n.worldToScreenPoint=function(e,t){return this.worldToViewportPoint(e,t),this.viewportToScreenPoint(t,t)},n.screenToWorldPoint=function(e,t){return this.screenToViewportPoint(e,t),this.viewportToWorldPoint(t,t)},n.screenPointToRay=function(e,t){var n=Li.tempVec2;return this.screenToViewportPoint(e,n),this.viewportPointToRay(n,t)},n.render=function(e){var t=this.engine._renderContext;t._setContext(this),this.enableFrustumCulling&&(this._frustumViewChangeFlag.flag||this._isFrustumProjectDirty)&&(this._frustum.calculateFromMatrix(t._viewProjectMatrix),this._frustumViewChangeFlag.flag=!1,this._isFrustumProjectDirty=!1),this._updateShaderData(t),we.unionCollection(this.scene.shaderData._macroCollection,this.shaderData._macroCollection,this._globalShaderMacro),this._renderPipeline.render(t,e),this._engine._renderCount++},n._onActive=function(){this.entity.scene._attachRenderCamera(this)},n._onInActive=function(){this.entity.scene._detachRenderCamera(this)},n._onDestroy=function(){var e;null===(e=this._renderPipeline)||void 0===e||e.destroy(),this._isInvViewProjDirty.destroy(),this._isViewMatrixDirty.destroy(),this.shaderData._addRefCount(-1)},n._projMatChange=function(){this._isFrustumProjectDirty=!0,this._isProjectionDirty=!0,this._isInvProjMatDirty=!0,this._isInvViewProjDirty.flag=!0},n._innerViewportToWorldPoint=function(e,t,n){var i=2*e.z-1,r=Li.tempVec4;r.setValue(2*e.x-1,1-2*e.y,i,1),m.transform(r,t,r);var a=1/r.w;return n.x=r.x*a,n.y=r.y*a,n.z=r.z*a,n},n._updateShaderData=function(e){var n=this.shaderData;n.setMatrix(t._viewMatrixProperty,this.viewMatrix),n.setMatrix(t._projectionMatrixProperty,this.projectionMatrix),n.setMatrix(t._vpMatrixProperty,e._viewProjectMatrix),n.setMatrix(t._inverseViewMatrixProperty,this.inverseViewMatrix),n.setMatrix(t._inverseProjectionMatrixProperty,this.inverseProjectionMatrix),n.setVector3(t._cameraPositionProperty,this._transform.worldPosition)},n.setClearMode=function(e,t){void 0===e&&(e=ae.SOLID_COLOR),void 0===t&&(t=new m(.25,.25,.25,1)),this._clearMode=e,this._backgroundColor=t,this._renderPipeline.defaultRenderPass.clearParam=t,this._renderPipeline.defaultRenderPass.clearMode=e},T(t,[{key:"nearClipPlane",get:function(){return this._nearClipPlane},set:function(e){this._nearClipPlane=e,this._projMatChange()}},{key:"farClipPlane",get:function(){return this._farClipPlane},set:function(e){this._farClipPlane=e,this._projMatChange()}},{key:"fieldOfView",get:function(){return this._fieldOfView},set:function(e){this._fieldOfView=e,this._projMatChange()}},{key:"aspectRatio",get:function(){var e,t=this._entity.engine.canvas;return null!=(e=this._customAspectRatio)?e:t.width*this._viewport.z/(t.height*this._viewport.w)},set:function(e){this._customAspectRatio=e,this._projMatChange()}},{key:"viewport",get:function(){return this._viewport},set:function(e){e!==this._viewport&&e.cloneTo(this._viewport),this._projMatChange()}},{key:"isOrthographic",get:function(){return this._isOrthographic},set:function(e){this._isOrthographic=e,this._projMatChange()}},{key:"orthographicSize",get:function(){return this._orthographicSize},set:function(e){this._orthographicSize=e,this._projMatChange()}},{key:"clearFlags",get:function(){throw"not implemented"},set:function(e){throw"not implemented"}},{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(e){this.setClearMode(this._clearMode,e)}},{key:"backgroundSky",get:function(){throw new Error("not implemented")}},{key:"viewMatrix",get:function(){return this._isViewMatrixDirty.flag&&(this._isViewMatrixDirty.flag=!1,p.invert(this._transform.worldMatrix,this._viewMatrix)),this._viewMatrix}},{key:"projectionMatrix",get:function(){var e=this._entity.engine.canvas;if((!this._isProjectionDirty||this._isProjMatSetting)&&this._lastAspectSize.x===e.width&&this._lastAspectSize.y===e.height)return this._projectionMatrix;this._isProjectionDirty=!1,this._lastAspectSize.x=e.width,this._lastAspectSize.y=e.height;var t=this.aspectRatio;if(this._isOrthographic){var n=this._orthographicSize*t,i=this._orthographicSize;p.ortho(-n,n,-i,i,this._nearClipPlane,this._farClipPlane,this._projectionMatrix)}else p.perspective(o.degreeToRadian(this._fieldOfView),t,this._nearClipPlane,this._farClipPlane,this._projectionMatrix);return this._projectionMatrix},set:function(e){this._projectionMatrix=e,this._isProjMatSetting=!0,this._projMatChange()}},{key:"enableHDR",get:function(){return console.log("not implemention"),!1},set:function(e){console.log("not implemention")}},{key:"renderTarget",get:function(){return this._renderTarget},set:function(e){this._renderTarget=e}},{key:"invViewProjMat",get:function(){return this._isInvViewProjDirty.flag&&(this._isInvViewProjDirty.flag=!1,p.multiply(this.inverseViewMatrix,this.inverseProjectionMatrix,this._invViewProjMat)),this._invViewProjMat}},{key:"inverseProjectionMatrix",get:function(){return this._isInvProjMatDirty&&(this._isInvProjMatDirty=!1,p.invert(this.projectionMatrix,this._inverseProjectionMatrix)),this._inverseProjectionMatrix}},{key:"inverseViewMatrix",get:function(){return this._transform.worldMatrix.cloneTo(this._inverseViewMatrix),this._inverseViewMatrix}}]),t}(Qe),Mi._viewMatrixProperty=Pt.getPropertyByName("u_viewMat"),Mi._projectionMatrixProperty=Pt.getPropertyByName("u_projMat"),Mi._vpMatrixProperty=Pt.getPropertyByName("u_VPMat"),Mi._inverseViewMatrixProperty=Pt.getPropertyByName("u_viewInvMat"),Mi._inverseProjectionMatrixProperty=Pt.getPropertyByName("u_projInvMat"),Mi._cameraPositionProperty=Pt.getPropertyByName("u_cameraPos"),hi=U((ui=Ci).prototype,"_frustum",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new d}}),di=U(ui.prototype,"_renderPipeline",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),fi=U(ui.prototype,"_frustumViewChangeFlag",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_i=U(ui.prototype,"_transform",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),pi=U(ui.prototype,"_isViewMatrixDirty",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),gi=U(ui.prototype,"_isInvViewProjDirty",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),vi=U(ui.prototype,"_projectionMatrix",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new p}}),mi=U(ui.prototype,"_viewMatrix",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new p}}),yi=U(ui.prototype,"_backgroundColor",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new m}}),xi=U(ui.prototype,"_viewport",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new m(0,0,1,1)}}),wi=U(ui.prototype,"_inverseProjectionMatrix",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new p}}),bi=U(ui.prototype,"_inverseViewMatrix",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new p}}),Ai=U(ui.prototype,"_lastAspectSize",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new v(0,0)}}),Ti=U(ui.prototype,"_invViewProjMat",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new p}}),li=ui))||li,Oi={json:"json",gltf:"json",mtl:"json",prefab:"json",txt:"text",bin:"arraybuffer",png:"image",webp:"image",jpg:"image"};function Ii(e,t){return void 0===t&&(t={}),new G((function(n,i,r){var a,o,s,c,l=null!=(a=t.retryCount)?a:4,u=null!=(o=t.retryInterval)?o:500;t.timeout=null!=(s=t.timeout)?s:15e3,t.type=null!=(c=t.type)?c:function(e){var t=e.substring(e.lastIndexOf(".")+1);return Oi[t]}(e);var h,d="image"===t.type?zi:Di,f=new Ui((function(){return d(e,t).onProgress(r).then((function(e){n(e),f.stop()})).catch((function(e){return h=e}))}),l,u);f.start((function(){i(h)}))}))}function zi(e,t){return new G((function(n,i){var r=t.timeout,a=new Image,o=function(){i(new Error("request "+e+" fail"))};a.onerror=o,a.onabort=o;var s,c=setTimeout((function(){i(new Error("request "+e+" timeout"))}),r);a.onload=(s=c,function(){requestAnimationFrame((function(){n(a)})),clearTimeout(s)}),a.crossOrigin="anonymous",a.src=e}))}function Di(e,t){return new G((function(n,i,r){var a,o=new XMLHttpRequest;o.timeout=t.timeout,t.method=null!=(a=t.method)?a:"get",o.onload=function(){var t;if(o.status<200||o.status>=300)i(new Error("request failed from: "+e));else{var r=null!=(t=o.response)?t:o.responseText;n(r)}},o.onerror=function(){i(new Error("request failed from: "+e))},o.ontimeout=function(){i(new Error("request timeout from: "+e))},o.onprogress=function(e){r(e.loaded/e.total)},o.open(t.method,e,!0),o.withCredentials="include"===t.credentials,o.responseType=t.type;var s=t.headers;s&&Object.keys(s).forEach((function(e){o.setRequestHeader(e,s[e])})),o.send(t.body)}))}var Bi,Ni,Ui=function(){function e(e,t,n){this.execFunc=e,this.totalCount=t,this.interval=n,this._timeoutId=-100,this._currentCount=0,this.done=void 0,this.exec=this.exec.bind(this)}var t=e.prototype;return t.start=function(e){this.done=e,this.exec()},t.stop=function(){clearTimeout(this._timeoutId)},t.exec=function(){var e=this;this._currentCount>=this.totalCount?this.done&&this.done():(this._currentCount++,this.execFunc(this._currentCount).then((function(){e._timeoutId=setTimeout(e.exec,e.interval)})))},e}(),Gi=function(e){this.useCache=e,this.request=Ii};(Ni=Bi||(Bi={})).Text="text",Ni.JSON="json",Ni.Buffer="buffer",Ni.Texture2D="texture2d",Ni.TextureCube="texture-cube",Ni.Material="material",Ni.Mesh="mesh",Ni.AnimationClip="animation-clip",Ni.Perfab="prefab",Ni.KTX="ktx",Ni.KTXCube="ktx-cube";var ki=function(e){function t(){var t;return(t=e.call(this)||this).colliders=void 0,t.colliders=[],t}R(t,e);var n=t.prototype;return n.attachCollider=function(e){this.colliders.push(e)},n.detachCollider=function(e){var t=this.colliders.indexOf(e);-1!=t&&this.colliders.splice(t,1)},t}(vt),Vi=function(e){function t(t){return e.call(this,t)||this}R(t,e);var n=t.prototype;return n._onEnable=function(){this.scene.findFeature(ki).attachCollider(this)},n._onDisable=function(){this.scene.findFeature(ki).detachCollider(this)},t}(Qe),Hi=function(e){function t(t){var n;return(n=e.call(this,t)||this).boxMin=void 0,n.boxMax=void 0,n._corners=[],n._cornerFlag=!1,n.boxMin=new s(-.5,-.5,-.5),n.boxMax=new s(.5,.5,.5),n}R(t,e);var n=t.prototype;return n.setBoxMinMax=function(e,t){this.boxMin=e,this.boxMax=t,this._cornerFlag=!0},n.setBoxCenterSize=function(e,n){var i=t._tempVec3;s.scale(n,.5,i),s.add(e,i,this.boxMax),s.subtract(e,i,this.boxMin),this._cornerFlag=!0},n.getCorners=function(){if(this._cornerFlag){var e=this.boxMin.x,t=this.boxMin.y,n=this.boxMin.z,i=this.boxMax.x-e,r=this.boxMax.y-t,a=this.boxMax.z-n;if(0===this._corners.length)for(var o=0;o<8;++o)this._corners.push(new s);this._corners[0].setValue(e+i,t+r,n+a),this._corners[1].setValue(e,t+r,n+a),this._corners[2].setValue(e,t,n+a),this._corners[3].setValue(e+i,t,n+a),this._corners[4].setValue(e+i,t+r,n),this._corners[5].setValue(e,t+r,n),this._corners[6].setValue(e,t,n),this._corners[7].setValue(e+i,t,n),this._cornerFlag=!1}return this._corners},t}(Vi);Hi._tempVec3=new s;var ji,Wi,Xi,Ki,qi,Yi,Qi,Zi,Ji,$i,er,tr,nr=function(e){function t(t){var n;return(n=e.call(this,t)||this).center=void 0,n.radius=void 0,n.center=new s,n.radius=1,n}return R(t,e),t.prototype.setSphere=function(e,t){this.center=e,this.radius=t},t}(Vi),ir=function(e){function t(t){var n;return(n=e.call(this,t)||this).planePoint=void 0,n.normal=void 0,n.planePoint=new s,n.normal=new s(0,1,0),n}return R(t,e),t.prototype.setPlane=function(e,t){this.planePoint=e,this.normal=t},t}(Vi),rr=function(){this.distance=void 0,this.collider=void 0,this.point=void 0,this.distance=Number.MAX_VALUE,this.collider=null,this.point=null},ar=new s,or=new h,sr=new l,cr=new c;function lr(e,t,n,i,r){var a=ar;t.getPoint(n,a),s.transformCoordinate(a,e.entity.transform.worldMatrix,a),i.distance=s.distance(r,a),i.collider=e,i.point=a}function ur(e,t){var n=e.entity.getInvModelMatrix(),i=new s;s.transformCoordinate(t.origin,n,i);var r,a,o,c,l,u,h,d=new s;return r=d,a=t.direction,o=n,c=a.x,l=a.y,u=a.z,h=o.elements,r.x=c*h[0]+l*h[4]+u*h[8],r.y=c*h[1]+l*h[5]+u*h[9],r.z=c*h[2]+l*h[6]+u*h[10],new g(i,d)}Nt.prototype.raycast=function(e,t,n){void 0===n&&(n=Ae.Everything);for(var i=this.findFeature(ki).colliders,r=new rr,a=0,o=i.length;a<o;a++){var s=i[a];if(s.entity.isActiveInHierarchy&&s.entity.layer&n){var c=new rr;s.raycast(e,c)&&c.distance<r.distance&&(r=c)}}return t&&r.collider&&r.point.cloneTo(t),r.collider},Hi.prototype.raycast=function(e,t){var n=ur(this,e);this.boxMin.cloneTo(sr.min),this.boxMax.cloneTo(sr.max);var i=n.intersectBox(sr);return-1!==i&&(lr(this,n,i,t,e.origin),!0)},nr.prototype.raycast=function(e,t){var n=ur(this,e);this.center.cloneTo(cr.center),cr.radius=this.radio;var i=n.intersectSphere(cr);return-1!==i&&(lr(this,n,i,t,e.origin),!0)},ir.prototype.raycast=function(e,t){var n=ur(this,e);this.normal.cloneTo(or.normal),or.distance=-s.dot(this.planePoint,or.normal);var i=n.intersectPlane(or);return-1!==i&&(lr(this,n,i,t,e.origin),!0)},(Wi=ji||(ji={}))[Wi.R8G8B8=0]="R8G8B8",Wi[Wi.R8G8B8A8=1]="R8G8B8A8",Wi[Wi.R4G4B4A4=2]="R4G4B4A4",Wi[Wi.R5G5B5A1=3]="R5G5B5A1",Wi[Wi.R5G6B5=4]="R5G6B5",Wi[Wi.Alpha8=5]="Alpha8",Wi[Wi.R16G16B16A16=6]="R16G16B16A16",Wi[Wi.R32G32B32A32=7]="R32G32B32A32",(Ki=Xi||(Xi={}))[Ki.Depth=0]="Depth",Ki[Ki.DepthStencil=1]="DepthStencil",Ki[Ki.Stencil=2]="Stencil",Ki[Ki.Depth16=3]="Depth16",Ki[Ki.Depth24=4]="Depth24",Ki[Ki.Depth32=5]="Depth32",Ki[Ki.Depth24Stencil8=6]="Depth24Stencil8",Ki[Ki.Depth32Stencil8=7]="Depth32Stencil8",(Yi=qi||(qi={}))[Yi.PositiveX=0]="PositiveX",Yi[Yi.NegativeX=1]="NegativeX",Yi[Yi.PositiveY=2]="PositiveY",Yi[Yi.NegativeY=3]="NegativeY",Yi[Yi.PositiveZ=4]="PositiveZ",Yi[Yi.NegativeZ=5]="NegativeZ",(Zi=Qi||(Qi={}))[Zi.Point=0]="Point",Zi[Zi.Bilinear=1]="Bilinear",Zi[Zi.Trilinear=2]="Trilinear",($i=Ji||(Ji={}))[$i.R8G8B8=0]="R8G8B8",$i[$i.R8G8B8A8=1]="R8G8B8A8",$i[$i.R4G4B4A4=2]="R4G4B4A4",$i[$i.R5G5B5A1=3]="R5G5B5A1",$i[$i.R5G6B5=4]="R5G6B5",$i[$i.Alpha8=5]="Alpha8",$i[$i.R32G32B32A32=6]="R32G32B32A32",$i[$i.DXT1=7]="DXT1",$i[$i.DXT5=8]="DXT5",$i[$i.ETC1_RGB=9]="ETC1_RGB",$i[$i.ETC2_RGB=10]="ETC2_RGB",$i[$i.ETC2_RGBA5=11]="ETC2_RGBA5",$i[$i.ETC2_RGBA8=12]="ETC2_RGBA8",$i[$i.PVRTC_RGB2=13]="PVRTC_RGB2",$i[$i.PVRTC_RGBA2=14]="PVRTC_RGBA2",$i[$i.PVRTC_RGB4=15]="PVRTC_RGB4",$i[$i.PVRTC_RGBA4=16]="PVRTC_RGBA4",$i[$i.ASTC_4x4=17]="ASTC_4x4",$i[$i.ASTC_5x5=18]="ASTC_5x5",$i[$i.ASTC_6x6=19]="ASTC_6x6",$i[$i.ASTC_8x8=20]="ASTC_8x8",$i[$i.ASTC_10x10=21]="ASTC_10x10",$i[$i.ASTC_12x12=22]="ASTC_12x12",(tr=er||(er={}))[tr.Clamp=0]="Clamp",tr[tr.Repeat=1]="Repeat",tr[tr.Mirror=2]="Mirror";var hr,dr,fr=function(e){function t(t,n,i,r,a){var o;return void 0===r&&(r=Ji.R8G8B8A8),void 0===a&&(a=!0),(o=e.call(this,t)||this)._format=void 0,o._mipmap=a,o._width=n,o._height=i,o._format=r,o._mipmapCount=o._getMipmapCount(),o._platformTexture=t._hardwareRenderer.createPlatformTexture2D(z(o)),o.filterMode=Qi.Bilinear,o.wrapModeU=o.wrapModeV=er.Repeat,o}R(t,e);var n=t.prototype;return n.setPixelBuffer=function(e,t,n,i,r,a){void 0===t&&(t=0),this._platformTexture.setPixelBuffer(e,t,n,i,r,a)},n.setImageSource=function(e,t,n,i,r,a){void 0===t&&(t=0),void 0===n&&(n=!1),void 0===i&&(i=!1),this._platformTexture.setImageSource(e,t,n,i,r,a)},n.getPixelBuffer=function(e,t,n,i,r){this._platformTexture.getPixelBuffer(e,t,n,i,r)},T(t,[{key:"format",get:function(){return this._format}}]),t}(Dt),_r=function(e){function t(t,n,i,r){var a;return void 0===i&&(i=Ji.R8G8B8A8),void 0===r&&(r=!0),(a=e.call(this,t)||this)._format=void 0,a._mipmap=r,a._width=n,a._height=n,a._format=i,a._mipmapCount=a._getMipmapCount(),a._platformTexture=t._hardwareRenderer.createPlatformTextureCubeMap(z(a)),a.filterMode=Qi.Bilinear,a.wrapModeU=a.wrapModeV=er.Clamp,a}R(t,e);var n=t.prototype;return n.setPixelBuffer=function(e,t,n,i,r,a,o){void 0===n&&(n=0),this._platformTexture.setPixelBuffer(e,t,n,i,r,a,o)},n.setImageSource=function(e,t,n,i,r,a,o){void 0===n&&(n=0),void 0===i&&(i=!1),void 0===r&&(r=!1),this._platformTexture.setImageSource(e,t,n,i,r,a,o)},n.getPixelBuffer=function(e,t,n,i,r,a){this._platformTexture.getPixelBuffer(e,t,n,i,r,a)},T(t,[{key:"format",get:function(){return this._format}}]),t}(Dt),pr=function(e){function t(t,n,i,r,a,o){var s;return void 0===r&&(r=Xi.Depth),void 0===a&&(a=!1),void 0===o&&(o=!1),(s=e.call(this,t)||this)._autoMipmap=!1,s._format=void 0,s._isCube=!1,s._isCube=o,s._mipmap=a,s._width=n,s._height=i,s._format=r,s._mipmapCount=s._getMipmapCount(),s._platformTexture=t._hardwareRenderer.createPlatformRenderDepthTexture(z(s)),s.filterMode=Qi.Bilinear,s.wrapModeU=s.wrapModeV=er.Clamp,s}return R(t,e),T(t,[{key:"format",get:function(){return this._format}},{key:"isCube",get:function(){return this._isCube}},{key:"autoGenerateMipmaps",get:function(){return this._autoMipmap},set:function(e){this._autoMipmap=e}}]),t}(Dt),gr=function(e){function t(t,n,i,r,a,o){var s;return void 0===a&&(a=Xi.Depth),void 0===o&&(o=1),(s=e.call(this,t)||this)._platformRenderTarget=void 0,s._colorTextures=void 0,s._depth=void 0,s._antiAliasing=void 0,s._width=void 0,s._height=void 0,s._depthTexture=void 0,s._width=n,s._height=i,s._antiAliasing=o,s._depth=a,s._colorTextures=r?r instanceof Array?r.slice():[r]:[],a instanceof pr&&(s._depthTexture=a),s._platformRenderTarget=t._hardwareRenderer.createPlatformRenderTarget(z(s)),s}R(t,e);var n=t.prototype;return n.getColorTexture=function(e){return void 0===e&&(e=0),this._colorTextures[e]},n.generateMipmaps=function(){var e,t=this.colorTextureCount;null!==(e=this._depthTexture)&&void 0!==e&&e.autoGenerateMipmaps&&this._depthTexture.generateMipmaps();for(var n=0;n<t;n++){var i=this._colorTextures[n];i.autoGenerateMipmaps&&i.generateMipmaps()}},n.destroy=function(){this._platformRenderTarget.destroy(),this._colorTextures.length=0,this._depthTexture=null,this._depth=null},n._setRenderTargetFace=function(e){this._platformRenderTarget.setRenderTargetFace(e)},n._blitRenderTarget=function(){this._platformRenderTarget.blitRenderTarget()},T(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorTextureCount",get:function(){return this._colorTextures.length}},{key:"depthTexture",get:function(){return this._depthTexture}},{key:"antiAliasing",get:function(){return this._antiAliasing}}]),t}(he),vr=function(e){function t(t,n,i,r,a,o){var s;return void 0===r&&(r=ji.R8G8B8A8),void 0===a&&(a=!1),void 0===o&&(o=!1),(s=e.call(this,t)||this)._autoMipmap=!1,s._format=void 0,s._isCube=!1,s._isCube=o,s._mipmap=a,s._width=n,s._height=i,s._format=r,s._mipmapCount=s._getMipmapCount(),s._platformTexture=t._hardwareRenderer.createPlatformRenderColorTexture(z(s)),s.filterMode=Qi.Bilinear,s.wrapModeU=s.wrapModeV=er.Clamp,s}return R(t,e),t.prototype.getPixelBuffer=function(e,t,n,i,r,a){this._platformTexture.getPixelBuffer(e,t,n,i,r,a)},T(t,[{key:"format",get:function(){return this._format}},{key:"isCube",get:function(){return this._isCube}},{key:"autoGenerateMipmaps",get:function(){return this._autoMipmap},set:function(e){this._autoMipmap=e}}]),t}(Dt),mr=function(e){function t(t,n,i,r,a){var o;return void 0===n&&(n=null),void 0===i&&(i=null),void 0===r&&(r=null),void 0===a&&(a=128),(o=e.call(this,t)||this)._triangles=[],o._uv=[new v,new v,new v,new v],o._positions=[new v,new v,new v,new v],o._texture=null,o._atlasRegion=new b(0,0,1,1),o._region=new b(0,0,1,1),o._pivot=new v(.5,.5),o._pixelsPerUnit=void 0,o._dirtyFlag=hr.all,n&&(o.texture=n),i&&(o.region=i,o.atlasRegion=i),r&&(o.pivot=r),o.pixelsPerUnit=a,o}R(t,e);var n=t.prototype;return n._onDestroy=function(){this._texture&&(this._texture=null)},n._updateMesh=function(){if(this._isContainDirtyFlag(hr.positions)){var e=this._pixelsPerUnit,n=this._positions,i=this.texture,r=i.width,a=i.height,o=this.region,s=o.width,c=o.height,l=this.pivot,u=l.x,h=l.y,d=t._tempVec2,f=1/e,_=s*r*f,p=c*a*f;d.x=u*_,d.y=h*p,n[0].setValue(-d.x,p-d.y),n[1].setValue(_-d.x,p-d.y),n[2].setValue(_-d.x,-d.y),n[3].setValue(-d.x,-d.y)}if(this._isContainDirtyFlag(hr.uv)){var g=this._uv,v=this.region,m=v.x,y=v.y,x=m+v.width,w=y+v.height;g[0].setValue(m,y),g[1].setValue(x,y),g[2].setValue(x,w),g[3].setValue(m,w)}if(this._isContainDirtyFlag(hr.triangles)){var b=this._triangles;b[0]=0,b[1]=2,b[2]=1,b[3]=2,b[4]=0,b[5]=3}},n._updateMeshData=function(){return!!this._isContainDirtyFlag(hr.all)&&(this._updateMesh(),this._setDirtyFlagFalse(hr.all),!0)},n._isContainDirtyFlag=function(e){return 0!=(this._dirtyFlag&e)},n._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},n._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},T(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture!==e&&(this._texture=e)}},{key:"atlasRegion",get:function(){return this._atlasRegion},set:function(e){var t=this._atlasRegion;e&&t!==e&&(t.x=o.clamp(e.x,0,1),t.y=o.clamp(e.y,0,1),t.width=o.clamp(e.width,0,1-t.x),t.height=o.clamp(e.height,0,1-t.y))}},{key:"pivot",get:function(){return this._pivot},set:function(e){var t=this._pivot;e&&t!==e&&(t.x=o.clamp(e.x,0,1),t.y=o.clamp(e.y,0,1),this._setDirtyFlagTrue(hr.positions))}},{key:"region",get:function(){return this._region},set:function(e){var t=this._region;e&&t!==e&&(t.x=o.clamp(e.x,0,1),t.y=o.clamp(e.y,0,1),t.width=o.clamp(e.width,0,1-t.x),t.height=o.clamp(e.height,0,1-t.y),this._setDirtyFlagTrue(hr.positions|hr.uv))}},{key:"pixelsPerUnit",get:function(){return this._pixelsPerUnit},set:function(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this._setDirtyFlagTrue(hr.positions))}}]),t}(zt);mr._tempVec2=new v,(dr=hr||(hr={}))[dr.positions=1]="positions",dr[dr.uv=2]="uv",dr[dr.triangles=4]="triangles",dr[dr.all=7]="all";var yr,xr,wr,br,Ar,Tr,Mr,Cr,Pr,Sr,Rr,Er;Pt.create("Sprite","\nprecision highp float;\n\nuniform mat4 u_VPMat;\n\nattribute vec3 POSITION;\nattribute vec2 TEXCOORD_0;\nattribute vec4 COLOR_0;\n\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nvoid main()\n{\n  gl_Position = u_VPMat * vec4(POSITION, 1.0);\n  v_uv = TEXCOORD_0;\n  v_color = COLOR_0;\n}\n","\nprecision mediump float;\nprecision mediump int;\n\nuniform sampler2D u_texture;\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nvoid main()\n{\n  // Only use the Alpha of the texture as a mask, so that the tint color can still be controlled to fade out.\n  vec4 baseColor = texture2D(u_texture, v_uv);\n  gl_FragColor = baseColor * v_color;\n}\n");var Lr,Fr,Or,Ir,zr,Dr,Br,Nr,Ur,Gr=(Er=Rr=function(e){function t(t){var n;return N(n=e.call(this,t)||this,"_positions",xr,z(n)),N(n,"_sprite",wr,z(n)),N(n,"_color",br,z(n)),N(n,"_flipX",Ar,z(n)),N(n,"_flipY",Tr,z(n)),N(n,"_cacheFlipX",Mr,z(n)),N(n,"_cacheFlipY",Cr,z(n)),N(n,"_dirtyFlag",Pr,z(n)),N(n,"_isWorldMatrixDirty",Sr,z(n)),n._isWorldMatrixDirty=t.transform.registerWorldChangeFlag(),n}R(t,e);var n=t.prototype;return n._render=function(e){var n=this.sprite;if(n){var i=n.texture;if(i){var r=this._positions,a=this.entity.transform,o=n._updateMeshData();if(this._isWorldMatrixDirty.flag||o||this._isContainDirtyFlag(Lr.Sprite)){for(var c=n._positions,l=t._tempVec3,u=a.worldMatrix,h=this.flipX,d=this.flipY,f=0,_=r.length;f<_;f++){var p=c[f];l.setValue(h?-p.x:p.x,d?-p.y:p.y,0),s.transformToVec3(l,u,r[f])}this._setDirtyFlagFalse(Lr.Flip),this._setDirtyFlagFalse(Lr.Sprite),this._isWorldMatrixDirty.flag=!1,this._cacheFlipX=h,this._cacheFlipY=d}else if(this._isContainDirtyFlag(Lr.Flip)){var g=this.flipX,v=this.flipY,m=this._cacheFlipX!==g,y=this._cacheFlipY!==v;if(m||y)for(var x=a.worldPosition,w=x.x,b=x.y,A=0,T=r.length;A<T;A++){var M=r[A];m&&(M.x=2*w-M.x),y&&(M.y=2*b-M.y)}this._setDirtyFlagFalse(Lr.Flip),this._cacheFlipX=g,this._cacheFlipY=v}this.shaderData.setTexture(t._textureProperty,i);var C=this.getMaterial()||this._getDefaultMaterial(),P=rt.getFromPool();P.setValue(this,r,n._uv,n._triangles,this.color,C,e),e._renderPipeline.pushPrimitive(P)}}},n._onDestroy=function(){this._isWorldMatrixDirty.destroy(),e.prototype._onDestroy.call(this)},n._isContainDirtyFlag=function(e){return 0!=(this._dirtyFlag&e)},n._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},n._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},n._getDefaultMaterial=function(){if(!t._defaultMaterial){var e=t._defaultMaterial=new On(this.scene.engine,Pt.find("Sprite")),n=e.renderState.blendState.targetBlendState;n.enabled=!0,n.sourceColorBlendFactor=at.SourceAlpha,n.destinationColorBlendFactor=at.OneMinusSourceAlpha,n.sourceAlphaBlendFactor=at.One,n.destinationAlphaBlendFactor=at.OneMinusSourceAlpha,n.colorBlendOperation=n.alphaBlendOperation=st.Add,e.renderState.depthState.writeEnabled=!1,e.renderQueueType=bn.Transparent,e.renderState.rasterState.cullMode=ft.Off}return t._defaultMaterial},T(t,[{key:"sprite",get:function(){return this._sprite},set:function(e){this._sprite!==e&&(this._sprite=e,this._setDirtyFlagTrue(Lr.Sprite))}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&e.cloneTo(this._color)}},{key:"flipX",get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this._setDirtyFlagTrue(Lr.Flip))}},{key:"flipY",get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._setDirtyFlagTrue(Lr.Flip))}}]),t}(Fn),Rr._textureProperty=Pt.getPropertyByName("u_texture"),Rr._tempVec3=new s,Rr._defaultMaterial=null,xr=U((yr=Er).prototype,"_positions",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new s,new s,new s,new s]}}),wr=U(yr.prototype,"_sprite",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),br=U(yr.prototype,"_color",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new w(1,1,1,1)}}),Ar=U(yr.prototype,"_flipX",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Tr=U(yr.prototype,"_flipY",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Mr=U(yr.prototype,"_cacheFlipX",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Cr=U(yr.prototype,"_cacheFlipY",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Pr=U(yr.prototype,"_dirtyFlag",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lr.All}}),Sr=U(yr.prototype,"_isWorldMatrixDirty",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),yr);!function(e){e[e.Flip=1]="Flip",e[e.Sprite=2]="Sprite",e[e.All=3]="All"}(Lr||(Lr={})),(Or=Fr||(Fr={}))[Or.ONCE=0]="ONCE",Or[Or.LOOP=1]="LOOP",(zr=Ir||(Ir={}))[zr.FINISHED=0]="FINISHED",zr[zr.LOOP_END=1]="LOOP_END",zr[zr.FRAME_EVENT=2]="FRAME_EVENT",(Br=Dr||(Dr={}))[Br.LINEAR=0]="LINEAR",Br[Br.CUBICSPLINE=1]="CUBICSPLINE",Br[Br.STEP=2]="STEP",(Ur=Nr||(Nr={}))[Ur.position=0]="position",Ur[Ur.rotation=1]="rotation",Ur[Ur.scale=2]="scale",Ur[Ur.other=3]="other";var kr,Vr,Hr,jr,Wr,Xr=function(e){function t(t){var n;return(n=e.call(this,null)||this).name=t,n.duration=void 0,n.durationIndex=void 0,n.samplers=void 0,n.channels=void 0,n.samplers=[],n.channels=[],n}R(t,e);var n=t.prototype;return n.addSampler=function(e,t,n,i){void 0===i&&(i=Dr.LINEAR),i===Dr.CUBICSPLINE&&(n<=4?i=Dr.LINEAR:n/=3);var r={input:e,output:t,outputSize:n,interpolation:i};this.samplers.push(r)},n.addChannel=function(e,n,i){var r=this.samplers[e],a=t._tagetTypeMap[i],o={sampler:r,target:{id:n,path:i,pathType:null!=a?a:Nr.other}};this.channels.push(o)},n.getChannelCount=function(){return this.channels.length},n.getChannelObject=function(e){return this.channels[e]},n.getFrameCount=function(e){return this.channels[e].sampler.input.length},n.getFrameTime=function(e,t){return this.channels[e].sampler.input[t]},n.getChannelTimeLength=function(e){var t=this.channels[e].sampler,n=t.input.length;return t.input[n-1]},n.createChannelValue=function(e){var t=this.channels[e].sampler;return new Float32Array(t.outputSize)},n.evaluate=function(e,t,n,i,r){var a=this.channels[t],o=a.sampler.output,s=a.sampler.outputSize;switch(a.sampler.interpolation){case Dr.CUBICSPLINE:this.evaluateCubicSpline(e,o,s,n,i,r);break;case Dr.LINEAR:this.evaluateLinear(e,o,s,n,i,r)}return e},n.evaluateCubicSpline=function(e,t,n,i,r,a){for(var o=a*a,s=a*o,c=2*s-3*o+1,l=-2*s+3*o,u=s-2*o+a,h=s-o,d=n;d>=0;d--){var f=t[i*n*3+d],_=t[i*n*3+n+d],p=t[i*n*3+2*n+d],g=t[r*n*3+n+d];e[d]=_*c+g*l+f*u+p*h}},n.evaluateLinear=function(e,t,n,i,r,a){switch(n){case 1:e[0]=t[i]*(1-a)+t[r]*a;break;case 4:this._quaSlerp(e,t,i*n,t,r*n,a);break;default:for(var o=n;o>=0;o--)e[o]=t[i*n+o]*(1-a)+t[r*n+o]*a}},n._quaSlerp=function(e,t,n,i,r,a){var o,s,c,l,u,h=t[0+n],d=t[1+n],f=t[2+n],_=t[3+n],p=i[0+r],g=i[1+r],v=i[2+r],m=i[3+r];return(s=h*p+d*g+f*v+_*m)<0&&(s=-s,p=-p,g=-g,v=-v,m=-m),1-s>1e-6?(o=Math.acos(s),c=Math.sin(o),l=Math.sin((1-a)*o)/c,u=Math.sin(a*o)/c):(l=1-a,u=a),e[0]=l*h+u*p,e[1]=l*d+u*g,e[2]=l*f+u*v,e[3]=l*_+u*m,e},t}(he);Xr._tagetTypeMap={position:Nr.position,rotation:Nr.rotation,scale:Nr.scale};var Kr,qr,Yr,Qr,Zr,Jr,$r,ea,ta,na,ia,ra,aa,oa,sa,ca,la,ua=(Wr=jr=function(e){function t(t){var n;return N(n=e.call(this,t)||this,"_mesh",Vr,z(n)),N(n,"_meshUpdateFlag",Hr,z(n)),n}R(t,e);var n=t.prototype;return n._render=function(e){var n=this._mesh;if(n){if(this._meshUpdateFlag.flag){var i=this.shaderData,r=n._vertexElements;i.disableMacro(t._uvMacro),i.disableMacro(t._normalMacro),i.disableMacro(t._tangentMacro),i.disableMacro(t._vertexColorMacro),i.disableMacro(t._vertexAlphaMacro);for(var a=0,o=r.length;a<o;a++){var s=r[a],c=s.semantic,l=s.format;switch(c){case"TEXCOORD_0":i.enableMacro(t._uvMacro);break;case"NORMAL":i.enableMacro(t._normalMacro);break;case"TANGENT":i.enableMacro(t._tangentMacro);break;case"COLOR_0":i.enableMacro(t._vertexColorMacro),l===Bn.Vector4&&i.enableMacro(t._vertexAlphaMacro)}}this._meshUpdateFlag.flag=!1}for(var u=n.subMeshes,h=e._renderPipeline,d=this._engine._renderElementPool,f=0,_=u.length;f<_;f++){var p=this._materials[f];if(p){var g=d.getFromPool();g.setValue(this,n,u[f],p),h.pushPrimitive(g)}}}else me.error("mesh is null.")},n._onDestroy=function(){e.prototype._onDestroy.call(this),this._mesh&&(this._mesh._addRefCount(-1),this._mesh=null)},n._cloneTo=function(e){e.mesh=this._mesh},n._updateBounds=function(e){var t=this._mesh;if(t){var n=t.bounds,i=this._entity.transform.worldMatrix;l.transform(n,i,e)}else e.min.setValue(0,0,0),e.max.setValue(0,0,0)},T(t,[{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh;t!==e&&(t&&(t._addRefCount(-1),this._meshUpdateFlag.destroy()),e&&(e._addRefCount(1),this._meshUpdateFlag=e.registerUpdateFlag()),this._mesh=e)}}]),t}(Fn),jr._uvMacro=Pt.getMacroByName("O3_HAS_UV"),jr._normalMacro=Pt.getMacroByName("O3_HAS_NORMAL"),jr._tangentMacro=Pt.getMacroByName("O3_HAS_TANGENT"),jr._vertexColorMacro=Pt.getMacroByName("O3_HAS_VERTEXCOLOR"),jr._vertexAlphaMacro=Pt.getMacroByName("O3_HAS_VERTEXALPHA"),Vr=U((kr=Wr).prototype,"_mesh",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Hr=U(kr.prototype,"_meshUpdateFlag",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),kr),ha=(ta=ea=function(e){function t(t){var n;return N(n=e.call(this,t)||this,"matrixPalette",qr,z(n)),N(n,"jointNodes",Yr,z(n)),N(n,"jointTexture",Qr,z(n)),N(n,"_hasInitJoints",Zr,z(n)),N(n,"_mat",Jr,z(n)),N(n,"_useJointTexture",$r,z(n)),n._skin=void 0,n._mat=new p,n._skin=null,n}R(t,e);var n=t.prototype;return n._updateShaderData=function(n){e.prototype._updateShaderData.call(this,n),!this._useJointTexture&&this.matrixPalette&&this.shaderData.setFloatArray(t._jointMatrixProperty,this.matrixPalette)},n._initJoints=function(){var e;if(this._skin){for(var n=this._skin.joints,i=[],r=n.length-1;r>=0;r--)i[r]=this.findByNodeName(this.entity,n[r]);this.matrixPalette=new Float32Array(16*i.length),this.jointNodes=i;var a=this.entity.engine._hardwareRenderer;if(a){var o=a.renderStates.getParameter(a.gl.MAX_VERTEX_UNIFORM_VECTORS),s=Math.floor((o-20)/4),c=this.shaderData,l=null===(e=this.jointNodes)||void 0===e?void 0:e.length;if(l)if(c.enableMacro("O3_HAS_SKIN"),c.setInt(t._jointCountProperty,l),n.length>s)a.canIUseMoreJoints?this._useJointTexture=!0:me.error("component's joints count("+n+") greater than device's MAX_VERTEX_UNIFORM_VECTORS number "+o+", and don't support jointTexture in this device. suggest joint count less than "+s+".",this);else{var u=Math.max(t._maxJoints,n.length);t._maxJoints=u,c.disableMacro("O3_USE_JOINT_TEXTURE"),c.enableMacro("O3_JOINTS_NUM",u.toString())}else c.disableMacro("O3_HAS_SKIN")}}},n.findByNodeName=function(e,t){if(!e)return null;var n=e.findByName(t);return n||this.findByNodeName(e.parent,t)},n._findParent=function(e,t){if(e){var n=e.parent;if(!n)return null;if(n.name===t)return n;var i=n.findByName(t);return i||this._findParent(n,t)}return null},n.update=function(){if(this._hasInitJoints||(this._initJoints(),this._hasInitJoints=!0),this._skin){for(var e=this.jointNodes,t=this._skin.inverseBindMatrices,n=this.matrixPalette,i=this.entity.getInvModelMatrix(),r=this._mat,a=e.length-1;a>=0;a--)r.identity(),e[a]?p.multiply(e[a].transform.worldMatrix,t[a],r):t[a].cloneTo(r),p.multiply(i,r,r),n.set(r.elements,16*a);this._useJointTexture&&this.createJointTexture()}},n.createJointTexture=function(){if(!this.jointTexture){var e=this.engine;if(!e._hardwareRenderer)return;this.jointTexture=new fr(e,4,this.jointNodes.length,Ji.R32G32B32A32,!1),this.jointTexture.filterMode=Qi.Point,this.shaderData.enableMacro("O3_USE_JOINT_TEXTURE"),this.shaderData.setTexture(t._jointSamplerProperty,this.jointTexture)}this.jointTexture.setPixelBuffer(this.matrixPalette)},T(t,[{key:"skin",get:function(){return this._skin},set:function(e){this._skin=e}}]),t}(ua),ea._jointCountProperty=Pt.getPropertyByName("u_jointCount"),ea._jointSamplerProperty=Pt.getPropertyByName("u_jointSampler"),ea._jointMatrixProperty=Pt.getPropertyByName("u_jointMatrix"),ea._maxJoints=0,qr=U((Kr=ta).prototype,"matrixPalette",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Yr=U(Kr.prototype,"jointNodes",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Qr=U(Kr.prototype,"jointTexture",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Zr=U(Kr.prototype,"_hasInitJoints",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Jr=U(Kr.prototype,"_mat",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),$r=U(Kr.prototype,"_useJointTexture",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Kr),da=function(e){function t(){var t;return(t=e.call(this,null)||this).layerWeight=void 0,t.mixTagetLayer=void 0,t.isFading=void 0,t.fadeDeltaTime=void 0,t.crossFadeDuration=void 0,t.fadeDuration=void 0,t.crossFadeDeltaTime=void 0,t.isMixLayer=void 0,t.hasMixLayer=void 0,t.mixEntity=void 0,t._activedEvents=void 0,t._animClip=void 0,t._isPlaying=void 0,t._wrapMode=void 0,t._channelStates=void 0,t._animClipLength=void 0,t._frameEvents=void 0,t.layerWeight=1,t._activedEvents=[],t}R(t,e);var n=t.prototype;return n.canMix=function(e,t){if(!this._animClip||!this._isPlaying||this.isMixLayer||this.isFading)return!1;if(this._animClip.getChannelCount()!==e.getChannelCount())return!1;for(var n=this._animClip.getChannelCount()-1;n>=0;n--){var i=this._animClip.getChannelObject(n),r=this._findChannelTarget(t,i.target),a=e.getChannelObject(n);if(r!==this._findChannelTarget(t,a.target))return!1}return!0},n.mix=function(e,t,n,i,r){if(void 0===r&&(r={}),this._isPlaying=t.isPlaying,this._animClip=e,this._wrapMode=void 0!==r.wrapMode?r.wrapMode:t._wrapMode,this._addEvents(r),this._channelStates=[],this._animClipLength=0,this._isPlaying){for(var a=t._channelStates,o=this._animClip.getChannelCount()-1;o>=0;o--){var s=this._animClip.getChannelObject(o),c=this._findChannelTarget(i,s.target);this._channelStates[o]={frameTime:0,currentFrame:0,currentValue:this._animClip.createChannelValue(o),mixWeight:c?1:0},a[o].mixWeight=void 0===a[o].mixWeight?1:a[o].mixWeight,1===a[o].mixWeight&&(a[o].mixWeight=c?0:1);var l=this._animClip.getChannelTimeLength(o);this._animClipLength=this._animClipLength>l?this._animClipLength:l}return!0}return!1},n.removeMixWeight=function(){for(var e=this._channelStates.length-1;e>=0;e--)1===this._channelStates[e].mixWeight&&(this.mixTagetLayer._channelStates[e].mixWeight=1)},n.play=function(e,t,n){if(void 0===n&&(n={wrapMode:Fr.LOOP}),this._isPlaying=!!e,this._animClip=e,this._wrapMode=void 0!==n.wrapMode?n.wrapMode:Fr.LOOP,this._addEvents(n),this._channelStates=[],this._animClipLength=0,this._isPlaying){for(var i=[],r=this._animClip.getChannelCount()-1;r>=0;r--){var a=this._animClip.getChannelObject(r),o=this._findChannelTarget(t,a.target);o||me.warn("Can not find channel target:"+a.target.id),this._channelStates[r]={frameTime:0,currentFrame:0,currentValue:this._animClip.createChannelValue(r)},i[r]={targetObject:o,path:a.target.path,pathType:a.target.pathType,outputSize:a.sampler.outputSize};var s=this._animClip.getChannelTimeLength(r);this._animClipLength=this._animClipLength>s?this._animClipLength:s}return i}return!1},n.stop=function(e){this._animClip&&this._isPlaying&&(e?this._isPlaying=!1:this._wrapMode=Fr.ONCE)},n.updateState=function(e){if(this._animClip&&this._isPlaying){this.isFading?(this.fadeDeltaTime+=e,this.layerWeight=1-this.fadeDeltaTime/this.fadeDuration,this.layerWeight<=0&&(this._isPlaying=!1)):this.crossFadeDuration&&(this.crossFadeDeltaTime+=e,this.layerWeight=this.crossFadeDeltaTime/this.crossFadeDuration,this.layerWeight>=1&&(this.layerWeight=1,delete this.crossFadeDuration)),e/=1e3,this._activeEvents(e);for(var t=0,n=this._animClip.getChannelCount()-1;n>=0;n--)this._updateChannelState(e,n)&&t++;0===t&&(this._isPlaying=!1,this.isMixLayer&&this.removeMixWeight())}},n.getChannelLayerWeight=function(e){return(this.hasMixLayer||this.isMixLayer)&&e<this._channelStates.length?this._channelStates[e].mixWeight*(this.isMixLayer?this.mixTagetLayer.layerWeight:this.layerWeight):this.layerWeight},n.getChannelValue=function(e){return this._channelStates[e].currentValue},n.triggerEvents=function(){var e=this;this._activedEvents&&this._activedEvents.forEach((function(t){e.trigger(t)})),this._activedEvents.length=0},n.jumpToFrame=function(e){for(var t=this._animClip.getChannelCount()-1;t>=0;t--){this._channelStates[t].frameTime=0,this._updateChannelState(e,t)}},n._updateChannelState=function(e,t){var n=this._animClip,i=this._channelStates[t],r=n.getChannelTimeLength(t);if(i.frameTime+=e,i.frameTime>r)switch(this._wrapMode){case Fr.ONCE:i.frameTime=r;break;case Fr.LOOP:i.frameTime=i.frameTime%this._animClipLength;break;default:me.error("Unknown Anim wrap Mode: "+this._wrapMode)}if(i.mixWeight&&0===i.mixWeight)return!0;var a=Math.min(i.frameTime,r),o=this._getKeyAndAlpha(n.getChannelObject(t),a);return i.currentValue=n.evaluate(i.currentValue,t,o.currentKey,o.nextKey,o.alpha),!(this._wrapMode===Fr.ONCE&&i.frameTime>=r)},n._addEvents=function(e){var t=this;if(this.removeAllEventListeners(),this._frameEvents=[],e.events)for(var n=0,i=function(i){var r=e.events[i],a=r.type;r.type===Ir.FRAME_EVENT&&(a="frameEvent"+n,n++,t._frameEvents.push({eventType:a,triggerTime:r.triggerTime,triggered:!1})),t.addEventListener(a,(function(e){r.callback()}))},r=e.events.length-1;r>=0;r--)i(r)},n._activeEvents=function(e){var t=this._animClip.durationIndex;if(this._frameEvents.length>0&&this._channelStates.length>0)for(var n=this._channelStates[t].frameTime+e,i=this._frameEvents.length-1;i>=0;i--){var r=this._frameEvents[i];!r.triggered&&n>r.triggerTime&&(this._activedEvents.push(new X(r.eventType,this)),r.triggered=!0)}if(this._channelStates.length>0&&this._channelStates[t].frameTime+e>=this._animClip.duration)if(this._wrapMode===Fr.LOOP){if(this._frameEvents.length>0)for(var a=this._frameEvents.length-1;a>=0;a--)this._frameEvents[a].triggered=!1;this.hasEvent(Ir.LOOP_END)&&this._activedEvents.push(new X(Ir.LOOP_END,this))}else this.hasEvent(Ir.FINISHED)&&this._activedEvents.push(new X(Ir.FINISHED,this))},n._findChannelTarget=function(e,t){var n=t.id,i=null;return i=e.name===n?e:e.findByName(n),"weights"===t.path?i.getComponent(ha):i},n._getKeyAndAlpha=function(e,t){for(var n=0,i=0,r=0,a=e.sampler.input,o=a.length,s=o-1;s>=0;s--)if(t>a[s]){n=t-a[s],i=s;break}if((r=i+1)>=o)switch(this._wrapMode){case Fr.ONCE:r=o-1;break;case Fr.LOOP:r=0}var c=a[r]-a[i];return{currentKey:i,nextKey:r,alpha:r===i||c<1e-5?1:n/c}},T(t,[{key:"isPlaying",get:function(){return this._animClip&&this._isPlaying}}]),t}(de),fa=(ia=U((na=function(e){function t(t){var n;return N(n=e.call(this,t)||this,"_onUpdateIndex",ia,z(n)),N(n,"_animSet",ra,z(n)),N(n,"_animLayers",aa,z(n)),N(n,"_timeScale",oa,z(n)),N(n,"_channelTargets",sa,z(n)),n}R(t,e),t.lerp=function(e,t,n,i,r){switch(r){case 1:e=t*(1-i)+n*i;break;case 4:var a=O(_,t),o=O(_,n),s=new _;_.slerp(a,o,i,s),e[0]=s.x,e[1]=s.y,e[2]=s.z,e[3]=s.w;break;default:for(var c=r;c>=0;c--)e[c]=t[c]*(1-i)+n[c]*i}return e};var n=t.prototype;return n.update=function(e){if(this.isPlaying()){e*=this._timeScale;for(var t=this._animLayers.length-1;t>=0;t--){this._animLayers[t].updateState(e)}this._updateValues();for(var n=this._animLayers.length-1;n>=0;n--){var i=this._animLayers[n];i.triggerEvents(),i.isPlaying||!i.isFading&&!i.isMixLayer||(this._animLayers.splice(n,1),this._removeRefMixLayers(i))}}},n.addAnimationClip=function(e,t){this._animSet[t]=e},n.removeAnimationClip=function(e){this._animSet[e]&&delete this._animSet[e]},n.getAnimationClipLength=function(e){var t=this._animSet[e];return t?t.getChannelTimeLength(0):0},n.getAnimationClip=function(e){return this._animSet[e]||null},n.isPlaying=function(){for(var e=this._animLayers.length-1;e>=0;e--)if(this._animLayers[e].isPlaying)return!0;return!1},n.playAnimationClip=function(e,t){var n=this._animSet[e];if(n){for(var i=null,r=this._animLayers.length-1;r>=0;r--)if(!this._animLayers[r].isFading&&!this._animLayers[r].isMixLayer){i=this._animLayers[r];break}i||(i=new da,this._animLayers.push(i)),this._removeRefMixLayers(i),this._channelTargets=i.play(n,this.entity,t)}else me.error("can not find anim clip: "+e)},n.crossFade=function(e,t,n){var i=this._animSet[e];if(i)if(!t||t<0)me.error("crossFadeDuration can not less than 0!");else{for(var r=null,a=this._animLayers.length-1;a>=0;a--)if(this._animLayers[a].canMix(i,this.entity)){r=this._animLayers[a];break}if(r){for(var o=this._animLayers.length-1;o>=0;o--)this._animLayers[o].isFading&&this._animLayers.splice(o,1);r.isFading=!0,r.fadeDuration=t,r.fadeDeltaTime=0;var s=new da;s.crossFadeDuration=t,s.crossFadeDeltaTime=0,s.play(i,this.entity,n),this._animLayers.push(s)}else this.playAnimationClip(e,n)}else me.error("can not find anim clip: "+e)},n.mix=function(e,t,n){var i=this._animSet[e];if(i){var r=this.entity.findByName(t);if(r){for(var a=null,o=this._animLayers.length-1;o>=0;o--)if(this._animLayers[o].canMix(i,this.entity)){a=this._animLayers[o];break}if(a){this._removeRefMixLayers(null,r),a.hasMixLayer=!0;var s=new da;s.isMixLayer=!0,s.mixTagetLayer=a,s.mixEntity=r,s.mix(i,a,this.entity,r,n),this._animLayers.push(s)}}else me.error("can not find mix bone!")}else me.error("can not find anim clip: "+e)},n.stop=function(e){for(var t=this._animLayers.length-1;t>=0;t--)this._animLayers[t].isFading?this._animLayers.splice(t,1):this._animLayers[t].stop(e)},n.jumpToFrame=function(e){e/=1e3;for(var t=this._animLayers.length-1;t>=0;t--)this._animLayers[t].jumpToFrame(e);this._updateValues()},n._removeRefMixLayers=function(e,t){if(e&&e.hasMixLayer)for(var n=this._animLayers.length-1;n>=0;n--){var i=this._animLayers[n];i.isMixLayer&&i.mixTagetLayer===e&&(i.removeMixWeight(),this._animLayers.splice(n,1))}if(t)for(var r=this._animLayers.length-1;r>=0;r--){var a=this._animLayers[r];a.isMixLayer&&(a.mixEntity===t||a.mixEntity.findByName(t)||t.findByName(a.mixEntity))&&(a.removeMixWeight(),this._animLayers.splice(r,1))}},n._updateValues=function(){if(0!==this._animLayers.length&&this._channelTargets)for(var e=this._channelTargets.length-1;e>=0;e--){var t=this._channelTargets[e],n=this._getChannelValue(e,t.outputSize),i=t.targetObject,r=t.path;if("weights"===r);else{var a=n,o=i.transform;switch(t.pathType){case Nr.position:var s=o.position;s.setValue(a[0],a[1],a[2]),o.position=s;break;case Nr.rotation:var c=o.rotationQuaternion;c.setValue(a[0],a[1],a[2],a[3]),o.rotationQuaternion=c;break;case Nr.scale:var l=o.scale;l.setValue(a[0],a[1],a[2]),o.scale=l;break;default:i[r]=n}}}},n._getChannelValue=function(e,n){for(var i=[],r=[],a=this._animLayers.length-1;a>=0;a--){var o=this._animLayers[a].getChannelLayerWeight(e);o>0&&(i.push(o),r.push(this._animLayers[a].getChannelValue(e)))}return 1===r.length?r[0]:2===r.length?t.lerp(r[0],r[0],r[1],i[1],n):(me.error("Can not get channel value!"),!1)},n._onEnable=function(){this.engine._componentsManager.addOnUpdateAnimations(this)},n._onDisable=function(){this.engine._componentsManager.removeOnUpdateAnimations(this)},T(t,[{key:"timeScale",get:function(){return this._timeScale},set:function(e){e>0&&(this._timeScale=e)}}]),t}(Qe)).prototype,"_onUpdateIndex",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),ra=U(na.prototype,"_animSet",[Y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),aa=U(na.prototype,"_animLayers",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new da]}}),oa=U(na.prototype,"_timeScale",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sa=U(na.prototype,"_channelTargets",[K],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),na),_a=function(e){function t(t,n){var i;return(i=e.call(this,t)||this)._vertexCount=0,i._accessible=!0,i._verticesFloat32=null,i._verticesUint8=null,i._indices=null,i._indicesFormat=null,i._vertexSlotChanged=!0,i._vertexChangeFlag=0,i._indicesChangeFlag=!1,i._elementCount=0,i._vertexElementsCache=[],i._positions=[],i._normals=null,i._colors=null,i._tangents=null,i._uv=null,i._uv1=null,i._uv2=null,i._uv3=null,i._uv4=null,i._uv5=null,i._uv6=null,i._uv7=null,i._boneWeights=null,i._boneIndices=null,i.name=n,i}R(t,e);var n=t.prototype;return n.uploadData=function(e){var t,n;if(!this._accessible)throw"Not allowed to access data while accessible is false.";var i=this._indices;if(this._vertexSlotChanged){var r=this._updateVertexElements();this._setVertexElements(r),this._vertexChangeFlag=ca.All,this._vertexSlotChanged=!1}var a=null===(t=this._vertexBufferBindings[0])||void 0===t?void 0:t._buffer,o=this._elementCount,s=o*this._vertexCount;if(a&&this._verticesFloat32.length===s){if(this._vertexChangeFlag&ca.All){var c=this._verticesFloat32;this._updateVertices(c),a.setData(c)}}else{null==a||a.destroy();var l=new Float32Array(s);this._verticesFloat32=l,this._verticesUint8=new Uint8Array(l.buffer),this._vertexChangeFlag=ca.All,this._updateVertices(l);var u=new ti(this._engine,qn.VertexBuffer,l,e?zn.Static:zn.Dynamic);this._setVertexBufferBinding(0,new ai(u,4*o))}var h=null===(n=this._indexBufferBinding)||void 0===n?void 0:n._buffer;if(i)if(h&&i.byteLength==h.byteLength)this._indicesChangeFlag&&(this._indicesChangeFlag=!1,h.setData(i),this._indexBufferBinding._format!==this._indicesFormat&&this._setIndexBufferBinding(new ni(h,this._indicesFormat)));else{null==h||h.destroy();var d=new ti(this._engine,qn.IndexBuffer,i);this._setIndexBufferBinding(new ni(d,this._indicesFormat))}else h&&(h.destroy(),this._setIndexBufferBinding(null));e&&(this._accessible=!1,this._releaseCache())},n.setIndices=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._indices!==e&&(this._indices=e,e instanceof Uint8Array?this._indicesFormat=Un.UInt8:e instanceof Uint16Array?this._indicesFormat=Un.UInt16:e instanceof Uint32Array&&(this._indicesFormat=Un.UInt32)),this._indicesChangeFlag=!0},n.getIndices=function(){return this._indices},n.setPositions=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";var t=e.length;this._positions=e,this._vertexChangeFlag|=ca.Position,this._vertexCount!==t&&(this._vertexCount=t)},n.getPositions=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._positions},n.setNormals=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._normals!=!!e,this._vertexChangeFlag|=ca.Normal,this._normals=e},n.getNormals=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._normals},n.setColors=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._colors!=!!e,this._vertexChangeFlag|=ca.Color,this._colors=e},n.getColors=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._colors},n.setBoneWeights=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=null!=e,this._vertexChangeFlag|=ca.BoneWeight,this._boneWeights=e},n.getBoneWeights=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._boneWeights},n.setBoneIndices=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._boneIndices!=!!e,this._vertexChangeFlag|=ca.BoneIndex,this._boneIndices=e},n.getBoneIndices=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._boneIndices},n.setTangents=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._tangents!=!!e,this._vertexChangeFlag|=ca.Tangent,this._tangents=e},n.getTangents=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._tangents},n.setUVs=function(e,t){var n;if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";switch(t=null!=(n=t)?n:0){case 0:this._vertexSlotChanged=!!this._uv!=!!e,this._vertexChangeFlag|=ca.UV,this._uv=e;break;case 1:this._vertexSlotChanged=!!this._uv1!=!!e,this._vertexChangeFlag|=ca.UV1,this._uv1=e;break;case 2:this._vertexSlotChanged=!!this._uv2!=!!e,this._vertexChangeFlag|=ca.UV2,this._uv2=e;break;case 3:this._vertexSlotChanged=!!this._uv3!=!!e,this._vertexChangeFlag|=ca.UV3,this._uv3=e;break;case 4:this._vertexSlotChanged=!!this._uv4!=!!e,this._vertexChangeFlag|=ca.UV4,this._uv4=e;break;case 5:this._vertexSlotChanged=!!this._uv5!=!!e,this._vertexChangeFlag|=ca.UV5,this._uv5=e;break;case 6:this._vertexSlotChanged=!!this._uv6!=!!e,this._vertexChangeFlag|=ca.UV6,this._uv6=e;break;case 7:this._vertexSlotChanged=!!this._uv7!=!!e,this._vertexChangeFlag|=ca.UV7,this._uv7=e;break;default:throw"The index of channel needs to be in range [0 - 7]."}},n.getUVs=function(e){var t;if(!this._accessible)throw"Not allowed to access data while accessible is false.";switch(e=null!=(t=e)?t:0){case 0:return this._uv;case 1:return this._uv1;case 2:return this._uv2;case 3:return this._uv3;case 4:return this._uv4;case 5:return this._uv5;case 6:return this._uv6;case 7:return this._uv7}throw"The index of channel needs to be in range [0 - 7]."},n._updateVertexElements=function(){var e=this._vertexElementsCache;e.length=1,e[0]=pa;var t=12,n=3;return this._normals&&(e.push(new oi("NORMAL",t,Bn.Vector3,0)),t+=12,n+=3),this._colors&&(e.push(new oi("COLOR_0",t,Bn.Vector4,0)),t+=16,n+=4),this._boneWeights&&(e.push(new oi("WEIGHTS_0",t,Bn.Vector4,0)),t+=16,n+=4),this._boneIndices&&(e.push(new oi("JOINTS_0",t,Bn.UByte4,0)),t+=4,n+=1),this._tangents&&(e.push(new oi("TANGENT",t,Bn.Vector4,0)),t+=16,n+=4),this._uv&&(e.push(new oi("TEXCOORD_0",t,Bn.Vector2,0)),t+=8,n+=2),this._uv1&&(e.push(new oi("TEXCOORD_1",t,Bn.Vector2,0)),t+=8,n+=2),this._uv2&&(e.push(new oi("TEXCOORD_2",t,Bn.Vector2,0)),t+=8,n+=2),this._uv3&&(e.push(new oi("TEXCOORD_3",t,Bn.Vector2,0)),t+=8,n+=2),this._uv4&&(e.push(new oi("TEXCOORD_4",t,Bn.Vector2,0)),t+=8,n+=2),this._uv5&&(e.push(new oi("TEXCOORD_5",t,Bn.Vector2,0)),t+=8,n+=2),this._uv6&&(e.push(new oi("TEXCOORD_6",t,Bn.Vector2,0)),t+=8,n+=2),this._uv7&&(e.push(new oi("TEXCOORD_7",t,Bn.Vector2,0)),t+=8,n+=2),this._elementCount=n,e},n._updateVertices=function(e){var t=this._elementCount,n=this._vertexCount,i=this._positions,r=this._normals,a=this._colors,o=this._vertexChangeFlag,s=this._boneWeights,c=this._boneIndices,l=this._tangents,u=this._uv,h=this._uv1,d=this._uv2,f=this._uv3,_=this._uv4,p=this._uv5,g=this._uv6,v=this._uv7;if(o&ca.Position)for(var m=0;m<n;m++){var y=t*m,x=i[m];e[y]=x.x,e[y+1]=x.y,e[y+2]=x.z}var w=3;if(r){if(o&ca.Normal)for(var b=0;b<n;b++){var A=t*b+w,T=r[b];T&&(e[A]=T.x,e[A+1]=T.y,e[A+2]=T.z)}w+=3}if(a){if(o&ca.Color)for(var M=0;M<n;M++){var C=t*M+w,P=a[M];P&&(e[C]=P.r,e[C+1]=P.g,e[C+2]=P.b,e[C+3]=P.a)}w+=4}if(s){if(o&ca.BoneWeight)for(var S=0;S<n;S++){var R=t*S+w,E=s[S];E&&(e[R]=E.x,e[R+1]=E.y,e[R+2]=E.z,e[R+3]=E.w)}w+=4}if(c){if(o&ca.BoneIndex)for(var L=this._verticesUint8,F=0;F<n;F++){var O=t*F+w,I=c[F];if(I){var z=4*O;L[z]=I.x,L[z+1]=I.y,L[z+2]=I.z,L[z+3]=I.w}}w+=1}if(l){if(o&ca.Tangent)for(var D=0;D<n;D++){var B=t*D+w,N=l[D];N&&(e[B]=N.x,e[B+1]=N.y,e[B+2]=N.z)}w+=3}if(u){if(o&ca.UV)for(var U=0;U<n;U++){var G=t*U+w,k=u[U];k&&(e[G]=k.x,e[G+1]=k.y)}w+=2}if(h){if(o&ca.UV1)for(var V=0;V<n;V++){var H=t*V+w,j=h[V];j&&(e[H]=j.x,e[H+1]=j.y)}w+=2}if(d){if(o&ca.UV2)for(var W=0;W<n;W++){var X=t*W+w,K=d[W];K&&(e[X]=K.x,e[X+1]=K.y)}w+=2}if(f){if(o&ca.UV3)for(var q=0;q<n;q++){var Y=t*q+w,Q=f[q];Q&&(e[Y]=Q.x,e[Y+1]=Q.y)}w+=2}if(_){if(o&ca.UV4)for(var Z=0;Z<n;Z++){var J=t*Z+w,$=_[Z];$&&(e[J]=$.x,e[J+1]=$.y)}w+=2}if(p){if(o&ca.UV5)for(var ee=0;ee<n;ee++){var te=t*ee+w,ne=p[ee];ne&&(e[te]=ne.x,e[te+1]=ne.y)}w+=2}if(g){if(o&ca.UV6)for(var ie=0;ie<n;ie++){var re=t*ie+w,ae=g[ie];ae&&(e[re]=ae.x,e[re+1]=ae.y)}w+=2}if(v){if(o&ca.UV7)for(var oe=0;oe<n;oe++){var se=t*oe+w,ce=v[oe];ce&&(e[se]=ce.x,e[se+1]=ce.y)}w+=2}this._vertexChangeFlag=0},n._releaseCache=function(){this._verticesUint8=null,this._indices=null,this._verticesFloat32=null,this._positions.length=0,this._tangents=null,this._normals=null,this._colors=null,this._uv=null,this._uv1=null,this._uv2=null,this._uv3=null,this._uv4=null,this._uv5=null,this._uv6=null,this._uv7=null},T(t,[{key:"accessible",get:function(){return this._accessible}},{key:"vertexCount",get:function(){return this._vertexCount}}]),t}(ri),pa=new oi("POSITION",0,Bn.Vector3,0);(la=ca||(ca={}))[la.Position=1]="Position",la[la.Normal=2]="Normal",la[la.Color=4]="Color",la[la.Tangent=8]="Tangent",la[la.BoneWeight=16]="BoneWeight",la[la.BoneIndex=32]="BoneIndex",la[la.UV=64]="UV",la[la.UV1=128]="UV1",la[la.UV2=256]="UV2",la[la.UV3=512]="UV3",la[la.UV4=1024]="UV4",la[la.UV5=2048]="UV5",la[la.UV6=4096]="UV6",la[la.UV7=8192]="UV7",la[la.All=65535]="All";var ga,va,ma,ya,xa=function(e){function t(t){var n;return(n=e.call(this,null)||this).inverseBindMatrices=void 0,n.joints=void 0,n.skeleton=void 0,n.inverseBindMatrices=[],n.joints=[],n.skeleton="none",n}return R(t,e),t}(he),wa=function(){function e(){}return e.createSphere=function(t,n,i,r){void 0===n&&(n=.5),void 0===i&&(i=12),void 0===r&&(r=!0);for(var a=new _a(t),o=(i=Math.max(2,Math.floor(i)))+1,c=o*o,l=i*i,u=e._generateIndices(t,c,6*l),h=Math.PI,d=2*h,f=1/o,_=1/i,p=new Array(c),g=new Array(c),m=new Array(c),y=0;y<c;++y){var x=y%o*_,w=(y*f|0)*_,b=x*d,A=w*h,T=Math.sin(A),M=-n*Math.cos(b)*T,C=n*Math.cos(A),P=n*Math.sin(b)*T;p[y]=new s(M,C,P),g[y]=new s(M,C,P),m[y]=new v(x,w)}for(var S=0,R=0;R<l;++R){var E=(R*_|0)*o+R%i,L=E+1,F=E+o,O=F+1;u[S++]=L,u[S++]=E,u[S++]=O,u[S++]=E,u[S++]=F,u[S++]=O}var I=a.bounds;return I.min.setValue(-n,-n,-n),I.max.setValue(n,n,n),e._initialize(a,p,g,m,u,r),a},e.createCuboid=function(t,n,i,r,a){void 0===n&&(n=1),void 0===i&&(i=1),void 0===r&&(r=1),void 0===a&&(a=!0);var o=new _a(t),c=n/2,l=i/2,u=r/2,h=new Array(24),d=new Array(24),f=new Array(24);h[0]=new s(-c,l,-u),h[1]=new s(c,l,-u),h[2]=new s(c,l,u),h[3]=new s(-c,l,u),d[0]=new s(0,1,0),d[1]=new s(0,1,0),d[2]=new s(0,1,0),d[3]=new s(0,1,0),f[0]=new v(0,0),f[1]=new v(1,0),f[2]=new v(1,1),f[3]=new v(0,1),h[4]=new s(-c,-l,-u),h[5]=new s(c,-l,-u),h[6]=new s(c,-l,u),h[7]=new s(-c,-l,u),d[4]=new s(0,-1,0),d[5]=new s(0,-1,0),d[6]=new s(0,-1,0),d[7]=new s(0,-1,0),f[4]=new v(0,1),f[5]=new v(1,1),f[6]=new v(1,0),f[7]=new v(0,0),h[8]=new s(-c,l,-u),h[9]=new s(-c,l,u),h[10]=new s(-c,-l,u),h[11]=new s(-c,-l,-u),d[8]=new s(-1,0,0),d[9]=new s(-1,0,0),d[10]=new s(-1,0,0),d[11]=new s(-1,0,0),f[8]=new v(0,0),f[9]=new v(1,0),f[10]=new v(1,1),f[11]=new v(0,1),h[12]=new s(c,l,-u),h[13]=new s(c,l,u),h[14]=new s(c,-l,u),h[15]=new s(c,-l,-u),d[12]=new s(1,0,0),d[13]=new s(1,0,0),d[14]=new s(1,0,0),d[15]=new s(1,0,0),f[12]=new v(1,0),f[13]=new v(0,0),f[14]=new v(0,1),f[15]=new v(1,1),h[16]=new s(-c,l,u),h[17]=new s(c,l,u),h[18]=new s(c,-l,u),h[19]=new s(-c,-l,u),d[16]=new s(0,0,1),d[17]=new s(0,0,1),d[18]=new s(0,0,1),d[19]=new s(0,0,1),f[16]=new v(0,0),f[17]=new v(1,0),f[18]=new v(1,1),f[19]=new v(0,1),h[20]=new s(-c,l,-u),h[21]=new s(c,l,-u),h[22]=new s(c,-l,-u),h[23]=new s(-c,-l,-u),d[20]=new s(0,0,-1),d[21]=new s(0,0,-1),d[22]=new s(0,0,-1),d[23]=new s(0,0,-1),f[20]=new v(1,0),f[21]=new v(0,0),f[22]=new v(0,1),f[23]=new v(1,1);var _=new Uint16Array(36);_[0]=0,_[1]=2,_[2]=1,_[3]=2,_[4]=0,_[5]=3,_[6]=4,_[7]=6,_[8]=7,_[9]=6,_[10]=4,_[11]=5,_[12]=8,_[13]=10,_[14]=9,_[15]=10,_[16]=8,_[17]=11,_[18]=12,_[19]=14,_[20]=15,_[21]=14,_[22]=12,_[23]=13,_[24]=16,_[25]=18,_[26]=17,_[27]=18,_[28]=16,_[29]=19,_[30]=20,_[31]=22,_[32]=23,_[33]=22,_[34]=20,_[35]=21;var p=o.bounds;return p.min.setValue(-c,-l,-u),p.max.setValue(c,l,u),e._initialize(o,h,d,f,_,a),o},e.createPlane=function(t,n,i,r,a,o){void 0===n&&(n=1),void 0===i&&(i=1),void 0===r&&(r=1),void 0===a&&(a=1),void 0===o&&(o=!0);for(var c=new _a(t),l=(r=Math.max(1,Math.floor(r)))+1,u=n/2,h=i/2,d=n/r,f=i/(a=Math.max(1,Math.floor(a))),_=l*(a+1),p=a*r,g=e._generateIndices(t,_,6*p),m=1/l,y=1/r,x=1/a,w=new Array(_),b=new Array(_),A=new Array(_),T=0;T<_;++T){var M=T%l,C=T*m|0;w[T]=new s(M*d-u,C*f-h,0),b[T]=new s(0,0,1),A[T]=new v(M*y,1-C*x)}for(var P=0,S=0;S<p;++S){var R=(S*y|0)*l+S%r,E=R+1,L=R+l,F=L+1;g[P++]=E,g[P++]=L,g[P++]=R,g[P++]=E,g[P++]=F,g[P++]=L}var O=c.bounds;return O.min.setValue(-u,-h,0),O.max.setValue(u,h,0),e._initialize(c,w,b,A,g,o),c},e.createCylinder=function(t,n,i,r,a,o,c){void 0===n&&(n=.5),void 0===i&&(i=.5),void 0===r&&(r=2),void 0===a&&(a=20),void 0===o&&(o=1),void 0===c&&(c=!0);for(var l=new _a(t),u=(a=Math.floor(a))+1,h=.5*r,d=r/(o=Math.floor(o)),f=u*(o+1),_=a*o,p=2*a,g=f+2+p,m=e._generateIndices(t,g,6*_+3*p),y=1/u,x=1/a,w=1/o,b=new Array(g),A=new Array(g),T=new Array(g),M=0,C=Math.PI,P=2*Math.PI,S=(i-n)/r,R=0;R<f;++R){var E=R*y|0,L=R%u*x,F=E*w,O=C+L*P,I=Math.sin(O),z=Math.cos(O),D=i-E*(i-n),B=D*I,N=E*d-h,U=D*z;b[R]=new s(B,N,U),A[R]=new s(I,S,z),T[R]=new v(L,1-F)}for(var G=0;G<_;++G){var k=(G*x|0)*u+G%a,V=k+1,H=k+u,j=H+1;m[M++]=V,m[M++]=H,m[M++]=k,m[M++]=V,m[M++]=j,m[M++]=H}b[f]=new s(0,-h,0),A[f]=new s(0,-1,0),T[f]=new v(.5,.5),b[f+1]=new s(0,h,0),A[f+1]=new s(0,1,0),T[f+1]=new v(.5,.5);for(var W=f+2,X=1/(2*n),K=1/(2*i),q=u*o,Y=0;Y<a;++Y){var Q=b[Y],Z=Q.x,J=Q.z;b[W]=new s(Z,-h,J),A[W]=new s(0,-1,0),T[W++]=new v(Z*K+.5,.5-J*K);var $=b[Y+q];Z=$.x,J=$.z,b[W]=new s(Z,h,J),A[W]=new s(0,1,0),T[W++]=new v(Z*X+.5,J*X+.5)}for(var ee=f+1,te=f+2,ne=te+1,ie=0;ie<a;++ie){var re=2*ie,ae=ie===a-1?0:re+2;m[M++]=f,m[M++]=te+ae,m[M++]=te+re,m[M++]=ee,m[M++]=ne+re,m[M++]=ne+ae}var oe=l.bounds,se=Math.max(n,i);return oe.min.setValue(-se,-h,-se),oe.max.setValue(se,h,se),e._initialize(l,b,A,T,m,c),l},e.createTorus=function(t,n,i,r,a,o,c){void 0===n&&(n=.5),void 0===i&&(i=.1),void 0===r&&(r=30),void 0===a&&(a=30),void 0===o&&(o=360),void 0===c&&(c=!0);var l=new _a(t),u=((r=Math.floor(r))+1)*((a=Math.floor(a))+1),h=r*a,d=e._generateIndices(t,u,6*h),f=new Array(u),_=new Array(u),p=new Array(u);o=o/180*Math.PI;for(var g=0,m=0;m<=r;m++)for(var y=0;y<=a;y++){var x=y/a*o,w=m/r*Math.PI*2,b=Math.cos(w),A=Math.sin(w),T=Math.cos(x),M=Math.sin(x),C=new s((n+i*b)*T,(n+i*b)*M,i*A);f[g]=C;var P=n*T,S=n*M;_[g]=new s(C.x-P,C.y-S,C.z).normalize(),p[g++]=new v(y/a,m/r)}g=0;for(var R=1;R<=r;R++)for(var E=1;E<=a;E++){var L=(a+1)*R+E-1,F=(a+1)*(R-1)+E-1,O=(a+1)*(R-1)+E,I=(a+1)*R+E;d[g++]=L,d[g++]=F,d[g++]=I,d[g++]=F,d[g++]=O,d[g++]=I}var z=l.bounds,D=n+i;return z.min.setValue(-D,-D,-i),z.max.setValue(D,D,i),e._initialize(l,f,_,p,d,c),l},e.createCone=function(t,n,i,r,a,o){void 0===n&&(n=.5),void 0===i&&(i=2),void 0===r&&(r=20),void 0===a&&(a=1),void 0===o&&(o=!0);for(var c=new _a(t),l=(r=Math.floor(r))+1,u=.5*i,h=i/(a=Math.floor(a)),d=l*(a+1),f=r*a,_=d+1+r,p=e._generateIndices(t,_,6*f+3*r),g=1/l,m=1/r,y=1/a,x=new Array(_),w=new Array(_),b=new Array(_),A=0,T=Math.PI,M=2*Math.PI,C=n/i,P=0;P<d;++P){var S=P*g|0,R=P%l*m,E=S*y,L=T+R*M,F=Math.sin(L),O=Math.cos(L),I=n-S*n,z=I*F,D=S*h-u,B=I*O;x[P]=new s(z,D,B),w[P]=new s(F,C,O),b[P]=new v(R,1-E)}for(var N=0;N<f;++N){var U=(N*m|0)*l+N%r,G=U+1,k=U+l,V=k+1;p[A++]=G,p[A++]=k,p[A++]=U,p[A++]=G,p[A++]=V,p[A++]=k}x[d]=new s(0,-u,0),w[d]=new s(0,-1,0),b[d]=new v(.5,.5);for(var H=d+1,j=1/(2*n),W=0;W<r;++W){var X=x[W],K=X.x,q=X.z;x[H]=new s(K,-u,q),w[H]=new s(0,-1,0),b[H++]=new v(K*j+.5,.5-q*j)}for(var Y=d+1,Q=0;Q<r;++Q){var Z=Q,J=Q===r-1?0:Z+1;p[A++]=d,p[A++]=Y+J,p[A++]=Y+Z}var $=c.bounds;return $.min.setValue(-n,-u,-n),$.max.setValue(n,u,n),e._initialize(c,x,w,b,p,o),c},e._initialize=function(e,t,n,i,r,a){e.setPositions(t),e.setNormals(n),e.setUVs(i),e.setIndices(r),e.uploadData(a),e.addSubMesh(0,r.length)},e._generateIndices=function(e,t,n){var i=null;if(t>65535){if(!e._hardwareRenderer.canIUse(le.elementIndexUint))throw Error("The vertex count is over limit.");i=new Uint32Array(n)}else i=new Uint16Array(n);return i},e}(),ba=function(e){function t(t){var n;return(n=e.call(this,t,Pt.find("skybox"))||this).renderState.rasterState.cullMode=ft.Off,n.renderState.depthState.compareFunction=ht.LessEqual,n.renderQueueType=0,n}return R(t,e),t}(On),Aa=function(e){function t(t){var n;return(n=e.call(this,t)||this)._skyBoxMap=void 0,n._matrix=new p,n._initBounds=!1,n.mesh=wa.createCuboid(n.engine,2,2,2),n.setMaterial(new ba(n.engine)),n}R(t,e);var n=t.prototype;return n._render=function(t){if(this._skyBoxMap){var n=this.entity.transform.worldMatrix,i=t.viewMatrix,r=t.projectionMatrix,a=this._matrix;p.multiply(i,n,a);var o=a.elements;o[12]=o[13]=o[14]=0,p.multiply(r,a,a),this.shaderData.setMatrix("u_mvpNoscale",a),e.prototype._render.call(this,t)}},n._updateBounds=function(e){this._initBounds||(e.min.setValue(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),e.max.setValue(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),this._initBounds=!0)},T(t,[{key:"skyBoxMap",get:function(){return this._skyBoxMap},set:function(e){this._skyBoxMap=e,e&&this.getMaterial().shaderData.setTexture("u_cube",e)}}]),t}(ua);(va=ga||(ga={}))[va.Position=1]="Position",va[va.Velocity=2]="Velocity",va[va.Acceleration=4]="Acceleration",va[va.Color=8]="Color",va[va.Apha=16]="Apha",va[va.Size=32]="Size",va[va.StartAngle=64]="StartAngle",va[va.StartTime=128]="StartTime",va[va.LifeTime=256]="LifeTime",va[va.RotateVelocity=512]="RotateVelocity",va[va.Scale=1024]="Scale",va[va.Everything=4294967295]="Everything",(ya=ma||(ma={}))[ya.Transparent=0]="Transparent",ya[ya.Additive=1]="Additive";var Ta=function(e){function t(t){var n;return(n=e.call(this,t)||this)._vertexStride=void 0,n._vertices=void 0,n._vertexBuffer=void 0,n._maxCount=1e3,n._position=new s,n._positionRandomness=new s,n._positionArray=void 0,n._velocity=new s,n._velocityRandomness=new s,n._acceleration=new s,n._accelerationRandomness=new s,n._color=new w(1,1,1,1),n._colorRandomness=0,n._size=1,n._sizeRandomness=0,n._alpha=1,n._alphaRandomness=0,n._startAngle=0,n._startAngleRandomness=0,n._rotateVelocity=0,n._rotateVelocityRandomness=0,n._lifetime=5,n._startTimeRandomness=0,n._scale=1,n._isOnce=!1,n._time=0,n._isInit=!1,n._isStart=!1,n._updateDirtyFlag=ga.Everything,n._isRotateToVelocity=!1,n._isUseOriginColor=!1,n._isScaleByLifetime=!1,n._is2d=!0,n._isFadeIn=!1,n._isFadeOut=!1,n._playOnEnable=!0,n._blendMode=ma.Transparent,n.spriteSheet=void 0,n.setMaterial(n._createMaterial()),n}R(t,e),t._getRandom=function(){return Math.random()-.5};var n=t.prototype;return n.update=function(e){this._isInit&&this._isStart&&(this._updateDirtyFlag&&(this._updateBuffer(),this._updateDirtyFlag=0),this._time+=e/1e3,this.shaderData.setFloat("u_time",this._time))},n._onEnable=function(){e.prototype._onEnable.call(this),this._playOnEnable&&this.start()},n.start=function(){this._isStart=!0,this._time=0,this.shaderData.setInt("u_active",1)},n.stop=function(){this.shaderData.setInt("u_active",0)},n._createMaterial=function(){var e=new On(this.engine,Pt.find("particle-shader")),t=e.renderState,n=t.blendState.targetBlendState;return n.enabled=!0,n.sourceColorBlendFactor=at.SourceAlpha,n.destinationColorBlendFactor=at.OneMinusSourceAlpha,n.sourceAlphaBlendFactor=at.One,n.destinationAlphaBlendFactor=at.OneMinusSourceAlpha,t.depthState.writeEnabled=!1,e.renderQueueType=bn.Transparent,this.isUseOriginColor=!0,this.is2d=!0,this.isFadeOut=!0,e},n._createMesh=function(){var e=new si(this._entity.engine,"particleMesh"),n=4*this._maxCount,i=96*n,r=new Float32Array(i),a=null,o=!1;if(n>t._uint16VertexLimit){if(!this.engine._hardwareRenderer.canIUse(le.elementIndexUint))throw Error("The vertex count is over limit.");o=!0,a=new Uint32Array(6*this._maxCount)}else a=new Uint16Array(6*this._maxCount);for(var s=0,c=0;s<this._maxCount;++s){var l=4*s;a[c++]=l+0,a[c++]=l+1,a[c++]=l+2,a[c++]=l+0,a[c++]=l+2,a[c++]=l+3}var u=[new oi("a_position",0,Bn.Vector3,0),new oi("a_velocity",12,Bn.Vector3,0),new oi("a_acceleration",24,Bn.Vector3,0),new oi("a_color",36,Bn.Vector4,0),new oi("a_lifeAndSize",52,Bn.Vector4,0),new oi("a_rotation",68,Bn.Vector2,0),new oi("a_uv",76,Bn.Vector3,0),new oi("a_normalizedUv",88,Bn.Vector2,0)],h=new ti(this.engine,qn.VertexBuffer,4*i,zn.Dynamic),d=new ti(this.engine,qn.IndexBuffer,a,zn.Dynamic);return e.setVertexBufferBinding(h,96),e.setIndexBufferBinding(d,o?Un.UInt32:Un.UInt16),e.setVertexElements(u),e.addSubMesh(0,a.length),this._vertexBuffer=h,this._vertexStride=24,this._vertices=r,e},n._updateBuffer=function(){for(var e=0;e<this._maxCount;e++)this._updateSingleBuffer(e);this._vertexBuffer.setData(this._vertices)},n._updateSingleBuffer=function(e){var n=this._updateDirtyFlag,i=this._vertices,r=this._vertexStride,a=t._getRandom,s=4*e,c=s*r,l=(s+1)*r,u=(s+2)*r,h=(s+3)*r;if(n&ga.Position){var d=this._position,f=d.x,_=d.y,p=d.z,g=this._positionArray,v=this._positionRandomness;if(g){if(g.length!==this._maxCount)throw Error("The length of positionArray must be equal to maxCount.");var m=g[e];f+=m.x,_+=m.y,p+=m.z}else f+=a()*v.x,_+=a()*v.y,p+=a()*v.z;i[c]=i[l]=i[u]=i[h]=f,i[c+1]=i[l+1]=i[u+1]=i[h+1]=_,i[c+2]=i[l+2]=i[u+2]=i[h+2]=p}if(n&ga.Velocity){var y=this._velocity,x=this._velocityRandomness;i[c+3]=i[l+3]=i[u+3]=i[h+3]=y.x+a()*x.x,i[c+4]=i[l+4]=i[u+4]=i[h+4]=y.y+a()*x.y,i[c+5]=i[l+5]=i[u+5]=i[h+5]=y.z+a()*x.z}if(n&ga.Acceleration){var w=this._acceleration,b=this._accelerationRandomness;i[c+6]=i[l+6]=i[u+6]=i[h+6]=w.x+a()*b.x,i[c+7]=i[l+7]=i[u+7]=i[h+7]=w.y+a()*b.y,i[c+8]=i[l+8]=i[u+8]=i[h+8]=w.z+a()*b.z}if(n&ga.Color){var A=this._color,T=this._colorRandomness;i[c+9]=i[l+9]=i[u+9]=i[h+9]=o.clamp(A.r+a()*T,0,1),i[c+10]=i[l+10]=i[u+10]=i[h+10]=o.clamp(A.g+a()*T,0,1),i[c+11]=i[l+11]=i[u+11]=i[h+11]=o.clamp(A.b+a()*T,0,1)}if(n&ga.Apha&&(i[c+12]=i[l+12]=i[u+12]=i[h+12]=o.clamp(this._alpha+a()*this._alphaRandomness,0,1)),n&ga.StartTime&&(i[c+13]=i[l+13]=i[u+13]=i[h+13]=Math.random()*this._startTimeRandomness),n&ga.LifeTime){var M=this._lifetime;i[c+14]=i[l+14]=i[u+14]=i[h+14]=M+a()*M}if(n&ga.Size){var C=this._size;i[c+15]=i[l+15]=i[u+15]=i[h+15]=Math.max(C+a()*this._sizeRandomness*C*2,0)}n&ga.Scale&&(i[c+16]=i[l+16]=i[u+16]=i[h+16]=this._scale),n&ga.StartAngle&&(i[c+17]=i[l+17]=i[u+17]=i[h+17]=this._startAngle+a()*Math.PI*this._startAngleRandomness*2),n&ga.RotateVelocity&&(i[c+18]=i[l+18]=i[u+18]=i[h+18]=this._rotateVelocity+a()*this._rotateVelocityRandomness),this._updateSingleUv(e,c,l,u,h)},n._updateSingleUv=function(e,t,n,i,r){var a=this.spriteSheet,o=this.getMaterial().shaderData.getTexture("u_texture"),s=this._vertices;if(o){var c=o.width,l=o.height;if(a){var u=a[e%a.length],h=u.x,d=u.y,f=u.w,_=u.h,p=h/c,g=d/l,v=p+f/c,m=g+_/l,y=_/f;s[t+19]=p,s[t+20]=m,s[t+21]=y,s[n+19]=v,s[n+20]=m,s[n+21]=y,s[i+19]=v,s[i+20]=g,s[i+21]=y,s[r+19]=p,s[r+20]=g,s[r+21]=y}else{var x=l/c;s[t+19]=0,s[t+20]=1,s[t+21]=x,s[n+19]=1,s[n+20]=1,s[n+21]=x,s[i+19]=1,s[i+20]=0,s[i+21]=x,s[r+19]=0,s[r+20]=0,s[r+21]=x}}else s[t+19]=0,s[t+20]=0,s[t+21]=1,s[n+19]=1,s[n+20]=0,s[n+21]=1,s[i+19]=1,s[i+20]=1,s[i+21]=1,s[r+19]=0,s[r+20]=1,s[r+21]=1;s[t+22]=-.5,s[t+23]=-.5,s[n+22]=.5,s[n+23]=-.5,s[i+22]=.5,s[i+23]=.5,s[r+22]=-.5,s[r+23]=.5},T(t,[{key:"texture",get:function(){return this.getMaterial().shaderData.getTexture("u_texture")},set:function(e){e?(this.shaderData.enableMacro("particleTexture"),this.getMaterial().shaderData.setTexture("u_texture",e)):this.shaderData.disableMacro("particleTexture")}},{key:"position",get:function(){return this._position},set:function(e){this._updateDirtyFlag|=ga.Position,this._position=e}},{key:"positionRandomness",get:function(){return this._positionRandomness},set:function(e){this._updateDirtyFlag|=ga.Position,this._positionRandomness=e}},{key:"positionArray",get:function(){return this._positionArray},set:function(e){this._updateDirtyFlag|=ga.Position,this._positionArray=e}},{key:"velocity",get:function(){return this._velocity},set:function(e){this._updateDirtyFlag|=ga.Velocity,this._velocity=e}},{key:"velocityRandomness",get:function(){return this._velocityRandomness},set:function(e){this._updateDirtyFlag|=ga.Velocity,this._velocityRandomness=e}},{key:"acceleration",get:function(){return this._acceleration},set:function(e){this._updateDirtyFlag|=ga.Acceleration,this._acceleration=e}},{key:"accelerationRandomness",get:function(){return this._accelerationRandomness},set:function(e){this._updateDirtyFlag|=ga.Acceleration,this._accelerationRandomness=e}},{key:"color",get:function(){return this._color},set:function(e){this._updateDirtyFlag|=ga.Color,this._color=e}},{key:"colorRandomness",get:function(){return this._colorRandomness},set:function(e){this._updateDirtyFlag|=ga.Color,this._colorRandomness=e}},{key:"size",get:function(){return this._size},set:function(e){this._updateDirtyFlag|=ga.Size,this._size=e}},{key:"sizeRandomness",get:function(){return this._sizeRandomness},set:function(e){this._updateDirtyFlag|=ga.Size,this._sizeRandomness=e}},{key:"alpha",get:function(){return this._alpha},set:function(e){this._updateDirtyFlag|=ga.Apha,this._alpha=e}},{key:"alphaRandomness",get:function(){return this._alphaRandomness},set:function(e){this._updateDirtyFlag|=ga.Apha,this._alphaRandomness=e}},{key:"angle",get:function(){return this._startAngle},set:function(e){this._updateDirtyFlag|=ga.StartAngle,this._startAngle=e}},{key:"angleRandomness",get:function(){return this._startAngleRandomness},set:function(e){this._updateDirtyFlag|=ga.StartAngle,this._startAngleRandomness=e}},{key:"rotateVelocity",get:function(){return this._rotateVelocity},set:function(e){this._updateDirtyFlag|=ga.RotateVelocity,this._rotateVelocity=e}},{key:"rotateVelocityRandomness",get:function(){return this._rotateVelocityRandomness},set:function(e){this._updateDirtyFlag|=ga.RotateVelocity,this._rotateVelocityRandomness=e}},{key:"lifetime",get:function(){return this._lifetime},set:function(e){this._updateDirtyFlag|=ga.LifeTime,this._lifetime=e}},{key:"startTimeRandomness",get:function(){return this._startTimeRandomness},set:function(e){this._updateDirtyFlag|=ga.StartTime,this._startTimeRandomness=e}},{key:"scale",get:function(){return this._scale},set:function(e){this._updateDirtyFlag|=ga.Scale,this._scale=e}},{key:"maxCount",get:function(){return this._maxCount},set:function(e){this._isStart=!1,this._isInit=!1,this._maxCount=e,this._updateDirtyFlag=ga.Everything,this.mesh=this._createMesh(),this._updateBuffer(),this._isInit=!0}},{key:"isOnce",get:function(){return this._isOnce},set:function(e){this._time=0,this.shaderData.setInt("u_once",e?1:0),this._isOnce=e}},{key:"isRotateToVelocity",get:function(){return this._isRotateToVelocity},set:function(e){e?this.shaderData.enableMacro("rotateToVelocity"):this.shaderData.disableMacro("rotateToVelocity"),this._isRotateToVelocity=e}},{key:"isUseOriginColor",get:function(){return this._isUseOriginColor},set:function(e){e?this.shaderData.enableMacro("useOriginColor"):this.shaderData.disableMacro("useOriginColor"),this._isUseOriginColor=e}},{key:"isScaleByLifetime",get:function(){return this._isScaleByLifetime},set:function(e){e?this.shaderData.enableMacro("isScaleByLifetime"):this.shaderData.disableMacro("isScaleByLifetime"),this._isScaleByLifetime=e}},{key:"is2d",get:function(){return this._is2d},set:function(e){e?this.shaderData.enableMacro("is2d"):(this.shaderData.disableMacro("is2d"),this.getMaterial().renderState.rasterState.cullMode=ft.Off),this._is2d=e}},{key:"isFadeIn",get:function(){return this._isFadeIn},set:function(e){e?this.shaderData.enableMacro("fadeIn"):this.shaderData.disableMacro("fadeIn"),this._isFadeIn=e}},{key:"isFadeOut",get:function(){return this._isFadeOut},set:function(e){e?this.shaderData.enableMacro("fadeOut"):this.shaderData.disableMacro("fadeOut"),this._isFadeOut=e}},{key:"playOnEnable",get:function(){return this._playOnEnable},set:function(e){this._playOnEnable=e,e?this.start():this.stop()}},{key:"blendMode",get:function(){return this._blendMode},set:function(e){var t=this.getMaterial().renderState.blendState.targetBlendState;e===ma.Transparent?(t.enabled=!0,t.sourceColorBlendFactor=at.SourceAlpha,t.destinationColorBlendFactor=at.OneMinusSourceAlpha,t.sourceAlphaBlendFactor=at.One,t.destinationAlphaBlendFactor=at.OneMinusSourceAlpha):e===ma.Additive&&(t.enabled=!0,t.sourceColorBlendFactor=at.SourceAlpha,t.destinationColorBlendFactor=at.One,t.sourceAlphaBlendFactor=at.One,t.destinationAlphaBlendFactor=at.OneMinusSourceAlpha),this._blendMode=e}}]),t}(ua);Ta._uint16VertexLimit=65535;Pt.create("trail","#define GLSLIFY 1\nattribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;uniform mat4 u_projMat;uniform mat4 u_viewMat;void main(){gl_Position=u_projMat*u_viewMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;}","#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_texture;void main(void){gl_FragColor=texture2D(u_texture,v_uv);}"),new s;var Ma=function(e){function t(t){var n;return(n=e.call(this,t)||this)._center=new s,n._size=new s,n.isShowCollider=!0,n.center=n.center,n.size=n.size,n.isShowCollider=n.isShowCollider,n}return R(t,e),T(t,[{key:"center",get:function(){return this._center},set:function(e){this._center=e,this.setBoxCenterSize(this._center,this._size)}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this.setBoxCenterSize(this._center,this._size)}}]),t}(Hi),Ca=function(e){function t(t){var n;return(n=e.call(this,t)||this).__center=new s,n.__radius=1,n.isShowCollider=!0,n._center=n._center,n._radius=n._radius,n.isShowCollider=n.isShowCollider,n}return R(t,e),T(t,[{key:"_center",get:function(){return this.__center},set:function(e){this.__center=e,this.setSphere(this.__center,this.__radius)}},{key:"_radius",get:function(){return this.__radius},set:function(e){this.__radius=e,this.setSphere(this.__center,this.__radius)}}]),t}(nr);function Pa(e,t){var n=e.center,i=new s(Math.max(t.min.x,Math.min(n.x,t.max.x)),Math.max(t.min.y,Math.min(n.y,t.max.y)),Math.max(t.min.z,Math.min(n.z,t.max.z)));return s.distance(n,i)<e.radius}Nt.registerFeature(ki);var Sa,Ra=function(e){function t(t){var n;return(n=e.call(this,t)||this)._colliderManager=void 0,n._myCollider=void 0,n._overlopCollider=void 0,n._sphere=void 0,n._box=new l,n._evts=Object.create(null),n._evtCount=0,n}R(t,e);var n=t.prototype;return n.onUpdate=function(t){e.prototype.onUpdate.call(this,t);var n=null;if(this._colliderManager&&this._myCollider){var i=this._colliderManager.colliders;if(this._myCollider instanceof Hi){this._updateWorldBox(this._myCollider,this._box);for(var r=0,a=i.length;r<a;r++){var o=i[r];o!=this._myCollider&&this._boxCollision(o)&&(n=o,this.dispatch("collision",{collider:o}))}}else if(this._myCollider instanceof nr){this._sphere=this._getWorldSphere(this._myCollider);for(var s=0,c=i.length;s<c;s++){var l=i[s];l!=this._myCollider&&this._sphereCollision(l)&&(n=l,this.dispatch("collision",{collider:l}))}}}if(null!=n&&this._overlopCollider!=n&&this.dispatch("begin_overlop",{collider:n}),null!=this._overlopCollider&&this._overlopCollider!=n){var u=this._overlopCollider;this.dispatch("end_overlop",{collider:u})}this._overlopCollider=n},n._updateWorldBox=function(e,n){var i=e.entity.transform.worldMatrix,r=t._tempBox1;e.boxMax.cloneTo(r.max),e.boxMin.cloneTo(r.min),l.transform(r,i,n)},n._getWorldSphere=function(e){var t=new s;return s.transformCoordinate(e.center,e.entity.transform.worldMatrix,t),{radius:e.radius,center:t}},n._boxCollision=function(e){if(e instanceof Hi){var n=t._tempBox2;return this._updateWorldBox(e,n),i=n,r=this._box,i.min.x<=r.max.x&&i.max.x>=r.min.x&&i.min.y<=r.max.y&&i.max.y>=r.min.y&&i.min.z<=r.max.z&&i.max.z>=r.min.z}var i,r;return e instanceof nr&&Pa(this._getWorldSphere(e),this._box)},n._sphereCollision=function(e){if(e instanceof Hi){var n=t._tempBox2;return this._updateWorldBox(e,n),Pa(this._sphere,n)}if(e instanceof nr){var i=this._getWorldSphere(e);return r=i,a=this._sphere,s.distance(r.center,a.center)<r.radius+r.radius}var r,a;return!1},n.onAwake=function(){this._colliderManager=this.scene.findFeature(ki),this._myCollider=this.entity.getComponent(Vi)},T(t,[{key:"overlopCollider",get:function(){return this._overlopCollider}}]),t}(Ln);Ra._tempVec3=new s,Ra._tempBox1=new l,Ra._tempBox2=new l,Sa=Ra,[de].forEach((function(e){Object.getOwnPropertyNames(e.prototype).forEach((function(t){Sa.prototype[t]=e.prototype[t]}))})),Pt.getPropertyByName("u_fogColor"),Pt.getPropertyByName("u_fogDensity"),Pt.getPropertyByName("u_fogNear"),Pt.getPropertyByName("u_fogFar"),new s,new s,new s;var Ea=function(){function e(e,t){void 0===t&&(t={engine:null,width:512,height:512}),this._mapSize=void 0,this._renderTarget=void 0,this.light=void 0,this.bias=.005,this.intensity=.2,this.radius=1,this.projectionMatrix=new p,this.light=e;var n=t,i=n.engine,r=n.width,a=n.height;this._mapSize=new v(r,a),this._renderTarget=new gr(i,r,a,new vr(i,r,a))}e._updateShaderData=function(t){var n=e._combinedData;t.setFloatArray(e._viewMatFromLightProperty,n.viewMatrix),t.setFloatArray(e._projMatFromLightProperty,n.projectionMatrix),t.setFloatArray(e._shadowBiasProperty,n.bias),t.setFloatArray(e._shadowIntensityProperty,n.intensity),t.setFloatArray(e._shadowRadiusProperty,n.radius),t.setFloatArray(e._shadowMapSizeProperty,n.mapSize),t.setTextureArray(e._shadowMapsProperty,n.map)},e.clearMap=function(){e._combinedData.map.length=0};var t=e.prototype;return t.initShadowProjectionMatrix=function(e){if(e instanceof Et&&p.ortho(-5,5,-5,5,.1,50,this.projectionMatrix),e instanceof Ft&&p.perspective(o.degreeToRadian(50),1,.5,50,this.projectionMatrix),e instanceof Ot){var t=Math.min(Math.PI/2,2*e.angle*Math.sqrt(2));p.perspective(t,1,.1,e.distance+5,this.projectionMatrix)}},t.appendData=function(t){var n=16*t,i=16*t,r=t,a=t,o=t,s=2*t,c=t,l=e._combinedData;l.viewMatrix.set(this.light.viewMatrix.elements,n),l.projectionMatrix.set(this.projectionMatrix.elements,i),l.bias[r]=this.bias,l.intensity[a]=this.intensity,l.radius[o]=this.radius,l.mapSize[s]=this.mapSize.x,l.mapSize[s+1]=this.mapSize.y,l.map[c]=this.map},T(e,[{key:"renderTarget",get:function(){return this._renderTarget}},{key:"map",get:function(){return this._renderTarget.getColorTexture()}},{key:"mapSize",get:function(){return this._mapSize}}]),e}();Ea._viewMatFromLightProperty=Pt.getPropertyByName("u_viewMatFromLight"),Ea._projMatFromLightProperty=Pt.getPropertyByName("u_projMatFromLight"),Ea._shadowBiasProperty=Pt.getPropertyByName("u_shadowBias"),Ea._shadowIntensityProperty=Pt.getPropertyByName("u_shadowIntensity"),Ea._shadowRadiusProperty=Pt.getPropertyByName("u_shadowRadius"),Ea._shadowMapSizeProperty=Pt.getPropertyByName("u_shadowMapSize"),Ea._shadowMapsProperty=Pt.getPropertyByName("u_shadowMaps"),Ea._maxLight=3,Ea._combinedData={viewMatrix:new Float32Array(16*Ea._maxLight),projectionMatrix:new Float32Array(16*Ea._maxLight),bias:new Float32Array(Ea._maxLight),intensity:new Float32Array(Ea._maxLight),radius:new Float32Array(Ea._maxLight),mapSize:new Float32Array(2*Ea._maxLight),map:[]},Object.defineProperty(St.prototype,"enableShadow",{get:function(){return this._enableShadow},set:function(e){if(this._enableShadow=e,this._enableShadow){if(this instanceof Rt)return this._enableShadow=!1,void me.warn("Has no shadow!");this.shadow=this.shadow||new Ea(this,{engine:this.engine,width:512,height:512}),this.shadow.initShadowProjectionMatrix(this)}}}),Object.defineProperty(Qe.prototype,"recieveShadow",{get:function(){return this._recieveShadow},set:function(e){this._recieveShadow=e}}),Object.defineProperty(Qe.prototype,"castShadow",{get:function(){return this._castShadow},set:function(e){this._castShadow=e}});var La=function(e){function t(t){var n;return(n=e.call(this,t,Pt.find("shadow-map"))||this).shaderData.enableMacro("O3_GENERATE_SHADOW_MAP"),n}return R(t,e),t}(On),Fa=function(e){function t(t,n,i,r,a,o){var s;return(s=e.call(this,t,n,i,r,a,new m(1,1,1,1))||this).light=void 0,s.light=o,s}return R(t,e),t.prototype.preRender=function(e,n){var i=this.replaceMaterial.shaderData;i.setMatrix(t._viewMatFromLightProperty,this.light.viewMatrix),i.setMatrix(t._projMatFromLightProperty,this.light.shadow.projectionMatrix)},t}(Kn);Fa._viewMatFromLightProperty=Pt.getPropertyByName("u_viewMatFromLight"),Fa._projMatFromLightProperty=Pt.getPropertyByName("u_projMatFromLight");var Oa=function(e){function t(t){var n,i=(n=e.call(this,t,Pt.find("shadow"))||this).renderState.blendState.targetBlendState;return i.enabled=!0,i.sourceColorBlendFactor=i.sourceAlphaBlendFactor=at.DestinationColor,i.destinationColorBlendFactor=i.destinationAlphaBlendFactor=at.Zero,n.renderState.depthState.compareFunction=ht.LessEqual,n.renderQueueType=bn.Transparent,n}return R(t,e),t}(On),Ia=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).clearMode=ae.DONT_CLEAR,t}return R(t,e),t.prototype.preRender=function(e,t){this.enabled=!1;var n=e.scene.findFeature(It).visibleLights,i=this.replaceMaterial.shaderData,r=e._renderPipeline.defaultRenderPass;this.renderTarget=r.renderTarget;var a=0;Ea.clearMap();for(var o=0,s=n.length;o<s;o++){var c=n[o];c.enableShadow&&c.shadow.appendData(a++)}a?(this.enabled=!0,Ea._updateShaderData(i),i.enableMacro("O3_SHADOW_MAP_COUNT",a.toString())):i.disableMacro("O3_SHADOW_MAP_COUNT")},t}(Kn),za=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowPass=void 0,t._shadowMapMaterial=void 0,t}R(t,e);var n=t.prototype;return n.preRender=function(e,t){var n=e.findFeature(It).visibleLights;if(n.length>0){this._shadowPass||this.addShadowPass(t);for(var i=t._renderPipeline,r=0,a=n.length;r<a;r++){var o=n[r];o.enableShadow&&!o.shadowMapPass?o.shadowMapPass=this.addShadowMapPass(t,o):!o.enableShadow&&o.shadowMapPass&&(i.removeRenderPass(o.shadowMapPass),o.shadowMapPass=null)}this.updatePassRenderFlag(i._opaqueQueue),this.updatePassRenderFlag(i._alphaTestQueue),this.updatePassRenderFlag(i._transparentQueue)}},n.addShadowPass=function(e){var t=new Oa(e.engine);this._shadowPass=new Ia("ShadowPass",1,null,t,Ae.Layer30),e._renderPipeline.addRenderPass(this._shadowPass)},n.addShadowMapPass=function(e,t){this._shadowMapMaterial=this._shadowMapMaterial||new La(e.engine);var n=new Fa("ShadowMapPass",-1,t.shadow.renderTarget,this._shadowMapMaterial,Ae.Layer31,t);return e._renderPipeline.addRenderPass(n),n},n.updatePassRenderFlag=function(e){for(var t=e.items,n=0,i=t.length;n<i;n++){var r=t[n].component,a=r.recieveShadow,o=r.castShadow;!0===a?r.entity.layer|=Ae.Layer30:!1===a&&(r.entity.layer&=~Ae.Layer30),!0===o?r.entity.layer|=Ae.Layer31:!1===o&&(r.entity.layer&=~Ae.Layer31)}},t}(vt);function Da(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}Nt.registerFeature(za),Nt.registerFeature(It),Nt.prototype.hasLight=function(){return this.findFeature(It).visibleLights.length>0};var Ba,Na,Ua=function(){function e(e,t){var n=this;this._worker=void 0,this._costs={},this._currentLoad=0,this._callbacks={},this._worker=new Worker(e),this._worker.onmessage=function(e){var t=e.data;switch(t.type){case"decode":n._callbacks[t.id].resolve(t.geometry);break;case"error":n._callbacks[t.id].reject(t);break;default:me.error('DRACOWorker: Unexpected message, "'+t.type+'"')}},t?this._worker.postMessage({type:"init",decoderConfig:{wasmBinary:t}}):this._worker.postMessage({type:"init",decoderConfig:{}})}var t,n,i,r=e.prototype;return r.setCosts=function(e,t){this._costs[e]=t},r.addCurrentLoad=function(e){this._currentLoad+=e},r.setCallback=function(e,t,n){this._callbacks[e]={resolve:t,reject:n}},r.decode=function(e,t,n){this._worker.postMessage({type:"decode",id:e,taskConfig:t,buffer:n},[n])},r.releaseTask=function(e){this._currentLoad-=this._costs[e],delete this._callbacks[e],delete this._costs[e]},t=e,(n=[{key:"currentLoad",get:function(){return this._currentLoad}}])&&Da(t.prototype,n),i&&Da(t,i),e}(),Ga='let decoderPending;\nlet decoderConfig;\n\nonmessage = function(e) {\n  const message = e.data;\n\n  switch (message.type) {\n    case "init":\n      decoderConfig = message.decoderConfig;\n      decoderPending = new Promise(function(resolve /*, reject*/) {\n        decoderConfig.onModuleLoaded = function(draco) {\n          // Module is Promise-like. Wrap before resolving to avoid loop.\n          resolve({ draco: draco });\n        };\n        DracoDecoderModule(decoderConfig);\n      });\n      break;\n\n    case "decode":\n      const buffer = message.buffer;\n      const taskConfig = message.taskConfig;\n      decoderPending.then(module => {\n        const draco = module.draco;\n        const decoder = new draco.Decoder();\n        const decoderBuffer = new draco.DecoderBuffer();\n        decoderBuffer.Init(new Int8Array(buffer), buffer.byteLength);\n        try {\n          const geometry = decodeGeometry(draco, decoder, decoderBuffer, taskConfig);\n          const buffers = geometry.attributes.map(attr => attr.array.buffer);\n          if (geometry.index) buffers.push(geometry.index.array.buffer);\n          self.postMessage({ type: "decode", id: message.id, geometry }, buffers);\n        } catch (error) {\n          console.error(error);\n          self.postMessage({ type: "error", id: message.id, error: error.message });\n        } finally {\n          draco.destroy(decoderBuffer);\n          draco.destroy(decoder);\n        }\n      });\n      break;\n  }\n};\n\nfunction decodeGeometry(draco, decoder, decoderBuffer, taskConfig) {\n  const attributeIDs = taskConfig.attributeIDs;\n  const attributeTypes = taskConfig.attributeTypes;\n\n  let dracoGeometry;\n  let decodingStatus;\n\n  const geometryType = decoder.GetEncodedGeometryType(decoderBuffer);\n  if (geometryType === draco.TRIANGULAR_MESH) {\n    dracoGeometry = new draco.Mesh();\n    decodingStatus = decoder.DecodeBufferToMesh(decoderBuffer, dracoGeometry);\n  } else {\n    throw new Error("DRACODecoder worker: Unexpected geometry type.");\n  }\n\n  if (!decodingStatus.ok() || dracoGeometry.ptr === 0) {\n    throw new Error("DRACODecoder worker: Decoding failed: " + decodingStatus.error_msg());\n  }\n\n  const geometry = { index: null, attributes: [] };\n\n  // Gather all vertex attributes.\n  for (let attributeName in attributeIDs) {\n    const attributeType = self[attributeTypes[attributeName]];\n\n    let attribute;\n    let attributeID;\n\n    // A Draco file may be created with default vertex attributes, whose attribute IDs\n    // are mapped 1:1 from their semantic name (POSITION, NORMAL, ...). Alternatively,\n    // a Draco file may contain a custom set of attributes, identified by known unique\n    // IDs. glTF files always do the latter, and .drc files typically do the former.\n    if (taskConfig.useUniqueIDs) {\n      attributeID = attributeIDs[attributeName];\n      attribute = decoder.GetAttributeByUniqueId(dracoGeometry, attributeID);\n    } else {\n      attributeID = decoder.GetAttributeId(dracoGeometry, draco[attributeIDs[attributeName]]);\n      if (attributeID === -1) continue;\n      attribute = decoder.GetAttribute(dracoGeometry, attributeID);\n    }\n    geometry.attributes.push(decodeAttribute(draco, decoder, dracoGeometry, attributeName, attributeType, attribute));\n  }\n  // Add index.\n  if (geometryType === draco.TRIANGULAR_MESH) {\n    // Generate mesh faces.\n    const numFaces = dracoGeometry.num_faces();\n    const numIndices = numFaces * 3;\n    let dataSize;\n    let ptr;\n    let index;\n    const indexType = self[taskConfig.indexType];\n\n    switch (indexType) {\n      case Uint16Array:\n        dataSize = numIndices * 2;\n        ptr = draco._malloc(dataSize);\n        decoder.GetTrianglesUInt16Array(dracoGeometry, dataSize, ptr);\n        index = new Uint16Array(draco.HEAPU16.buffer, ptr, numIndices).slice();\n        draco._free(ptr);\n        break;\n      case Uint32Array:\n        dataSize = numIndices * 4;\n        ptr = draco._malloc(dataSize);\n        decoder.GetTrianglesUInt32Array(dracoGeometry, dataSize, ptr);\n        index = new Uint32Array(draco.HEAPU32.buffer, ptr, numIndices).slice();\n        draco._free(ptr);\n        break;\n      default:\n        throw new Error("DRACODecoder: Unexpected index type.");\n    }\n    geometry.index = { array: index, itemSize: 1 };\n  }\n  draco.destroy(dracoGeometry);\n  return geometry;\n}\n\nfunction decodeAttribute(draco, decoder, dracoGeometry, attributeName, attributeType, attribute) {\n  const numComponents = attribute.num_components();\n  const numPoints = dracoGeometry.num_points();\n  const numValues = numPoints * numComponents;\n  let ptr;\n  let array;\n  let dataSize;\n  switch (attributeType) {\n    case Float32Array:\n      dataSize = numValues * 4;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_FLOAT32, dataSize, ptr);\n      array = new Float32Array(draco.HEAPF32.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Int8Array:\n      ptr = draco._malloc(numValues);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT8, numValues, ptr);\n      array = new Int8Array(draco.HEAP8.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Int16Array:\n      dataSize = numValues * 2;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT16, dataSize, ptr);\n      array = new Int16Array(draco.HEAP16.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Int32Array:\n      dataSize = numValues * 4;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT32, dataSize, ptr);\n      array = new Int32Array(draco.HEAP32.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Uint8Array:\n      ptr = draco._malloc(numValues);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT8, numValues, ptr);\n      array = new Uint8Array(draco.HEAPU8.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Uint16Array:\n      dataSize = numValues * 2;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT16, dataSize, ptr);\n      array = new Uint16Array(draco.HEAPU16.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Uint32Array:\n      dataSize = numValues * 4;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT32, dataSize, ptr);\n      array = new Uint32Array(draco.HEAPU32.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    default:\n      throw new Error("DRACODecoder: Unexpected attribute type.");\n  }\n\n  return {\n    name: attributeName,\n    array: array,\n    itemSize: numComponents\n  };\n}\n',ka="https://gw.alipayobjects.com/os/lib/alipay/draco-javascript/1.3.6/lib/",Va=function(){function e(e){var t;(void 0===e&&(e={type:"wasm",workerLimit:4}),this.pool=[],this.workerLimit=Math.min(navigator.hardwareConcurrency||4,4),this.useJS=void 0,this.currentTaskId=1,this.taskCache=new WeakMap,this.loadLibPromise=void 0,e.workerLimit>this.workerLimit)?me.warn("DRACOWorkerPool: Can not initialize worker pool with limit:"+e.workerLimit):this.workerLimit=null!=(t=e.workerLimit)?t:4;this.useJS="object"!=typeof WebAssembly||"js"===e.type,this.loadLibPromise=this.preloadLib()}var t=e.prototype;return t.preloadLib=function(){var e=this;return this.loadLibPromise?this.loadLibPromise:new Promise((function(t,n){e.useJS?Ii(ka+"draco_decoder_gltf.js",{type:"text"}).then((function(e){var n=[e,Ga].join("\n"),i=URL.createObjectURL(new Blob([n]));t({workerSourceURL:i,decoderWASMBinary:null})})).catch((function(e){n(e)})):Promise.all([Ii(ka+"draco_wasm_wrapper_gltf.js",{type:"text"}),Ii(ka+"draco_decoder_gltf.r3bin",{type:"arraybuffer"})]).then((function(e){var n=e[0],i=e[1],r=[n,Ga].join("\n"),a=URL.createObjectURL(new Blob([r]));t({workerSourceURL:a,decoderWASMBinary:i})})).catch((function(e){n(e)}))}))},t.getWorker=function(){var e=this;return this.preloadLib().then((function(t){if(e.pool.length<e.workerLimit){var n=new Ua(t.workerSourceURL,t.decoderWASMBinary);e.pool.push(n)}else e.pool.sort((function(e,t){return e.currentLoad>t.currentLoad?-1:1}));return e.pool[e.pool.length-1]}))},t.decode=function(e,t){var n=this,i=JSON.stringify(t);if(this.taskCache.has(e)){var r=this.taskCache.get(e);if(r.key===i)return r.promise;if(0===e.byteLength)throw new Error("DRACODecoder: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var a,o=this.currentTaskId++,s=e.byteLength,c=new Promise((function(i,r){n.getWorker().then((function(n){a=n,n.setCosts(o,s),n.addCurrentLoad(s),n.setCallback(o,i,r),n.decode(o,t,e)})).catch((function(e){r(e)}))}));return c.finally((function(){a&&o&&a.releaseTask(o)})),this.taskCache.set(e,{key:i,promise:c}),c},e}();function Ha(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function ja(e,t,n){return t&&Ha(e.prototype,t),n&&Ha(e,n),e}function Wa(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Xa(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Ka(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,qa(e,t)}function qa(e,t){return(qa=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}(Na=Ba||(Ba={}))[Na.RGBA_ASTC_4X4_KHR=37808]="RGBA_ASTC_4X4_KHR",Na[Na.RGBA_ASTC_5X4_KHR=37809]="RGBA_ASTC_5X4_KHR",Na[Na.RGBA_ASTC_5X5_KHR=37810]="RGBA_ASTC_5X5_KHR",Na[Na.RGBA_ASTC_6X5_KHR=37811]="RGBA_ASTC_6X5_KHR",Na[Na.RGBA_ASTC_6X6_KHR=37812]="RGBA_ASTC_6X6_KHR",Na[Na.RGBA_ASTC_8X5_KHR=37813]="RGBA_ASTC_8X5_KHR",Na[Na.RGBA_ASTC_8X6_KHR=37814]="RGBA_ASTC_8X6_KHR",Na[Na.RGBA_ASTC_8X8_KHR=37815]="RGBA_ASTC_8X8_KHR",Na[Na.RGBA_ASTC_10X5_KHR=37816]="RGBA_ASTC_10X5_KHR",Na[Na.RGBA_ASTC_10X6_KHR=37817]="RGBA_ASTC_10X6_KHR",Na[Na.RGBA_ASTC_10X8_KHR=37818]="RGBA_ASTC_10X8_KHR",Na[Na.RGBA_ASTC_10X10_KHR=37819]="RGBA_ASTC_10X10_KHR",Na[Na.RGBA_ASTC_12X10_KHR=37820]="RGBA_ASTC_12X10_KHR",Na[Na.RGBA_ASTC_12X12_KHR=37821]="RGBA_ASTC_12X12_KHR",Na[Na.SRGB8_ALPHA8_ASTC_4X4_KHR=37840]="SRGB8_ALPHA8_ASTC_4X4_KHR",Na[Na.SRGB8_ALPHA8_ASTC_5X4_KHR=37841]="SRGB8_ALPHA8_ASTC_5X4_KHR",Na[Na.SRGB8_ALPHA8_ASTC_5X5_KHR=37842]="SRGB8_ALPHA8_ASTC_5X5_KHR",Na[Na.SRGB8_ALPHA8_ASTC_6X5_KHR=37843]="SRGB8_ALPHA8_ASTC_6X5_KHR",Na[Na.SRGB8_ALPHA8_ASTC_6X6_KHR=37844]="SRGB8_ALPHA8_ASTC_6X6_KHR",Na[Na.SRGB8_ALPHA8_ASTC_8X5_KHR=37845]="SRGB8_ALPHA8_ASTC_8X5_KHR",Na[Na.SRGB8_ALPHA8_ASTC_8X6_KHR=37846]="SRGB8_ALPHA8_ASTC_8X6_KHR",Na[Na.SRGB8_ALPHA8_ASTC_8X8_KHR=37847]="SRGB8_ALPHA8_ASTC_8X8_KHR",Na[Na.SRGB8_ALPHA8_ASTC_10X5_KHR=37848]="SRGB8_ALPHA8_ASTC_10X5_KHR",Na[Na.SRGB8_ALPHA8_ASTC_10X6_KHR=37849]="SRGB8_ALPHA8_ASTC_10X6_KHR",Na[Na.SRGB8_ALPHA8_ASTC_10X8_KHR=37850]="SRGB8_ALPHA8_ASTC_10X8_KHR",Na[Na.SRGB8_ALPHA8_ASTC_10X10_KHR=37851]="SRGB8_ALPHA8_ASTC_10X10_KHR",Na[Na.SRGB8_ALPHA8_ASTC_12X10_KHR=37852]="SRGB8_ALPHA8_ASTC_12X10_KHR",Na[Na.SRGB8_ALPHA8_ASTC_12X12_KHR=37853]="SRGB8_ALPHA8_ASTC_12X12_KHR",Na[Na.RGB_ETC1_WEBGL=36196]="RGB_ETC1_WEBGL",Na[Na.R11_EAC=37488]="R11_EAC",Na[Na.SIGNED_R11_EAC=37489]="SIGNED_R11_EAC",Na[Na.RG11_EAC=37490]="RG11_EAC",Na[Na.SIGNED_RG11_EAC=37491]="SIGNED_RG11_EAC",Na[Na.RGB8_ETC2=37492]="RGB8_ETC2",Na[Na.SRGB8_ETC2=37493]="SRGB8_ETC2",Na[Na.RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="RGB8_PUNCHTHROUGH_ALPHA1_ETC2",Na[Na.SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",Na[Na.RGBA8_ETC2_EAC=37496]="RGBA8_ETC2_EAC",Na[Na.SRGB8_ALPHA8_ETC2_EAC=37497]="SRGB8_ALPHA8_ETC2_EAC",Na[Na.RGB_PVRTC_4BPPV1_IMG=35840]="RGB_PVRTC_4BPPV1_IMG",Na[Na.RGB_PVRTC_2BPPV1_IMG=35841]="RGB_PVRTC_2BPPV1_IMG",Na[Na.RGBA_PVRTC_4BPPV1_IMG=35842]="RGBA_PVRTC_4BPPV1_IMG",Na[Na.RGBA_PVRTC_2BPPV1_IMG=35843]="RGBA_PVRTC_2BPPV1_IMG",Na[Na.RGB_S3TC_DXT1_EXT=33776]="RGB_S3TC_DXT1_EXT",Na[Na.RGBA_S3TC_DXT1_EXT=33777]="RGBA_S3TC_DXT1_EXT",Na[Na.RGBA_S3TC_DXT3_EXT=33778]="RGBA_S3TC_DXT3_EXT",Na[Na.RGBA_S3TC_DXT5_EXT=33779]="RGBA_S3TC_DXT5_EXT";var Ya=function(){var e=t.prototype;function t(e){this._webCanvas=void 0,this._width=void 0,this._height=void 0,this._scale=new v;var t=e.width,n=e.height;this._webCanvas=e,this._width=t,this._height=n}return e.resizeByClientSize=function(e){void 0===e&&(e=window.devicePixelRatio);var t=this._webCanvas;if(t instanceof HTMLCanvasElement){var n=t.clientWidth,i=t.clientHeight;this.width=n*e,this.height=i*e}},e.setScale=function(e,t){this._scale.setValue(e,t),this.scale=this._scale},ja(t,[{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._webCanvas.width=e,this._width=e)}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._webCanvas.height=e,this._height=e)}},{key:"scale",get:function(){var e=this._webCanvas;return e instanceof HTMLCanvasElement&&this._scale.setValue(e.clientWidth*devicePixelRatio/e.width,e.clientHeight*devicePixelRatio/e.height),this._scale},set:function(e){var t=this._webCanvas;t instanceof HTMLCanvasElement&&(t.style.transformOrigin="left top",t.style.transform="scale("+e.x+", "+e.y+")")}}]),t}(),Qa=function(){function e(e){this._maxDrawBuffers=void 0,this._maxAnisoLevel=void 0,this._maxAntiAliasing=void 0,this._rhi=void 0,this.capabilityList=void 0,this._rhi=e,this.capabilityList=new Map,this._init(),this._compatibleAllInterface()}var t=e.prototype;return t.canIUse=function(e){return this.capabilityList.get(e)},t.canIUseCompressedTextureInternalFormat=function(e){var t=Ba.RGBA_ASTC_4X4_KHR,n=Ba.RGBA_ASTC_12X12_KHR,i=Ba.SRGB8_ALPHA8_ASTC_4X4_KHR,r=Ba.SRGB8_ALPHA8_ASTC_12X12_KHR,a=Ba.RGB_ETC1_WEBGL,o=Ba.R11_EAC,s=Ba.SRGB8_ALPHA8_ETC2_EAC,c=Ba.RGB_PVRTC_4BPPV1_IMG,l=Ba.RGBA_PVRTC_2BPPV1_IMG,u=Ba.RGB_S3TC_DXT1_EXT,h=Ba.RGBA_S3TC_DXT5_EXT;return e>=t&&n<=n||e>=i&&e<=r?this.canIUse(le.astc):e===a?this.canIUse(le.etc1):e>=o&&e<=s?this.canIUse(le.etc):e>=c&&e<=l?this.canIUse(le.pvrtc):e>=u&&e<=h&&this.canIUse(le.s3tc)},t._init=function(){var e=this.capabilityList,t=this.rhi.isWebGL2,n=this.rhi.requireExtension.bind(this.rhi),i=le.standardDerivatives,r=le.shaderTextureLod,a=le.elementIndexUint,o=le.depthTexture,s=le.vertexArrayObject,c=le.instancedArrays,l=le.multipleSample,u=le.drawBuffers,h=le.astc,d=le.astc_webkit,f=le.etc,_=le.etc_webkit,p=le.etc1,g=le.etc1_webkit,v=le.pvrtc,m=le.pvrtc_webkit,y=le.s3tc,x=le.s3tc_webkit,w=le.textureFloat,b=le.textureHalfFloat,A=le.textureFloatLinear,T=le.textureHalfFloatLinear,M=le.WEBGL_colorBufferFloat,C=le.colorBufferFloat,P=le.colorBufferHalfFloat,S=le.textureFilterAnisotropic;e.set(i,t||!!n(i)),e.set(r,t||!!n(r)),e.set(a,t||!!n(a)),e.set(o,t||!!n(o)),e.set(s,t||!!n(s)),e.set(c,t||!!n(c)),e.set(l,t),e.set(u,t||!!n(u)),e.set(w,t||!!n(w)),e.set(b,t||!!n(b)),e.set(A,!!n(A)),e.set(T,t||!!n(T)),e.set(C,t&&!!n(C)||!!n(M)),e.set(P,t&&!!n(C)||!!n(P)),e.set(S,!!n(S)),e.set(h,!(!n(h)&&!n(d))),e.set(f,!(!n(f)&&!n(_))),e.set(p,!(!n(p)&&!n(g))),e.set(v,!(!n(v)&&!n(m))),e.set(y,!(!n(y)&&!n(x)))},t._compatibleInterface=function(e,t){var n,i=this.rhi,r=i.gl;if(n=i.requireExtension(e))for(var a in t){var o=n[t[a]];null!=o&&o.bind?r[a]=o.bind(n):r[a]=o}},t._compatibleAllInterface=function(){var e=le.depthTexture,t=le.vertexArrayObject,n=le.instancedArrays,i=le.drawBuffers,r=le.textureFilterAnisotropic,a=le.textureHalfFloat,o=le.colorBufferHalfFloat,s=le.WEBGL_colorBufferFloat;if(!this.rhi.isWebGL2){this._compatibleInterface(e,{UNSIGNED_INT_24_8:"UNSIGNED_INT_24_8_WEBGL"}),this._compatibleInterface(t,{createVertexArray:"createVertexArrayOES",deleteVertexArray:"deleteVertexArrayOES",isVertexArray:"isVertexArrayOES",bindVertexArray:"bindVertexArrayOES"}),this._compatibleInterface(n,{drawArraysInstanced:"drawArraysInstancedANGLE",drawElementsInstanced:"drawElementsInstancedANGLE",vertexAttribDivisor:"vertexAttribDivisorANGLE"}),this._compatibleInterface(i,{MAX_DRAW_BUFFERS:"MAX_DRAW_BUFFERS_WEBGL"});var c={};if(this.canIUse(le.drawBuffers)){for(var l=this.maxDrawBuffers,u=0;u<l;u++)0!=u&&(c["COLOR_ATTACHMENT"+u]="COLOR_ATTACHMENT"+u+"_WEBGL"),c["DRAW_BUFFER"+u]="DRAW_BUFFER"+u+"_WEBGL";this._compatibleInterface(i,function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Xa(Object(n),!0).forEach((function(t){Wa(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Xa(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({drawBuffers:"drawBuffersWEBGL"},c))}this._compatibleInterface(a,{HAFL_FLOAT:"HALF_FLOAT_OES"}),this._compatibleInterface(o,{RGBA16F:"RBGA16F_EXT"}),this._compatibleInterface(s,{RGBA32F:"RBGA32F_EXT"})}this._compatibleInterface(r,{TEXTURE_MAX_ANISOTROPY_EXT:"TEXTURE_MAX_ANISOTROPY_EXT"})},ja(e,[{key:"canIUseMoreJoints",get:function(){return this.canIUse(le.textureFloat)&&this.rhi.renderStates.getParameter(this.rhi.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0}},{key:"maxDrawBuffers",get:function(){return this._maxDrawBuffers||(this.canIUse(le.drawBuffers)?this._maxDrawBuffers=this._rhi.gl.getParameter(this._rhi.gl.MAX_DRAW_BUFFERS):this._maxDrawBuffers=1),this._maxDrawBuffers}},{key:"maxAnisoLevel",get:function(){if(!this._maxAnisoLevel){var e=this._rhi.requireExtension(le.textureFilterAnisotropic);this._maxAnisoLevel=e?this._rhi.gl.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1}return this._maxAnisoLevel}},{key:"maxAntiAliasing",get:function(){if(!this._maxAntiAliasing){var e=this._rhi.gl,t=this.canIUse(le.multipleSample);this._maxAntiAliasing=t?e.getParameter(e.MAX_SAMPLES):1}return this._maxAntiAliasing}},{key:"rhi",get:function(){return this._rhi}}]),e}(),Za=function(){function e(e){this.rhi=void 0,this._requireResult=void 0,this.rhi=e,this._requireResult={}}return e.prototype.requireExtension=function(e){return void 0!==this._requireResult[e]||(this._requireResult[e]=this.rhi.gl.getExtension(e)),this._requireResult[e]},e}(),Ja=function(){function e(e,t){this._primitive=void 0,this.attribLocArray=void 0,this.canUseInstancedArrays=void 0,this.gl=void 0,this.vao=new Map,this._useVao=void 0,this._primitive=t,this.canUseInstancedArrays=e.canIUse(le.instancedArrays),this._useVao=e.canIUse(le.vertexArrayObject),this.gl=e.gl}var t=e.prototype;return t.draw=function(e,t){var n=this.gl,i=this._primitive;if(this._useVao){this.vao.has(e.id)||this.registerVAO(e);var r=this.vao.get(e.id);n.bindVertexArray(r)}else this.bindBufferAndAttrib(e);var a=i._indexBufferBinding,o=i._instanceCount,s=i._glIndexType,c=i._glIndexByteCount,l=t.topology,u=t.start,h=t.count;if(o)if(this.canUseInstancedArrays)if(a)if(this._useVao)n.drawElementsInstanced(l,h,s,u*c,o);else{var d=a.buffer._nativeBuffer;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,d),n.drawElementsInstanced(l,h,s,u*c,o),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null)}else n.drawArraysInstanced(l,u,h,o);else me.error("ANGLE_instanced_arrays extension is not supported");else if(a)if(this._useVao)n.drawElements(l,h,s,u*c);else{var f=a.buffer._nativeBuffer;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,f),n.drawElements(l,h,s,u*c),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null)}else n.drawArrays(l,u,h);this._useVao?n.bindVertexArray(null):this.disableAttrib()},t.destroy=function(){if(this._useVao){var e=this.gl;this.vao.forEach((function(t){e.deleteVertexArray(t)}))}},t.bindBufferAndAttrib=function(e){var t=this.gl,n=this._primitive,i=n._vertexBufferBindings;this.attribLocArray=[];var r,a,o=e.attributeLocation,s=n._vertexElementMap;for(var c in o){var l=o[c];if(-1!==l){var u=s[c];if(u){var h=i[u.bindingIndex],d=h.buffer,f=h.stride;a!==(r=d._nativeBuffer)&&(a=r,t.bindBuffer(t.ARRAY_BUFFER,r)),t.enableVertexAttribArray(l);var _=u._glElementInfo,p=_.size,g=_.type;t.vertexAttribPointer(l,p,g,u.normalized,f,u.offset),this.canUseInstancedArrays&&t.vertexAttribDivisor(l,u.instanceDivisor),this.attribLocArray.push(l)}else me.warn("vertex attribute not found: "+c)}}t.bindBuffer(t.ARRAY_BUFFER,null)},t.disableAttrib=function(){for(var e=this.gl,t=0,n=this.attribLocArray.length;t<n;t++)e.disableVertexAttribArray(this.attribLocArray[t])},t.registerVAO=function(e){var t=this.gl,n=t.createVertexArray();t.bindVertexArray(n);var i=this._primitive._indexBufferBinding;i&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i.buffer._nativeBuffer),this.bindBufferAndAttrib(e),t.bindVertexArray(null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this.disableAttrib(),this.vao.set(e.id,n)},e}(),$a=function(){function e(e,t,n){this._texture=void 0,this._glTexture=void 0,this._rhi=void 0,this._gl=void 0,this._isWebGL2=void 0,this._target=void 0,this._formatDetail=void 0,this._texture=t,this._rhi=e,this._gl=e.gl,this._isWebGL2=e.isWebGL2,this._target=n,this._glTexture=this._gl.createTexture()}e._isPowerOf2=function(e){return 0==(e&e-1)},e._getFormatDetail=function(e,t,n){switch(e){case Ji.R8G8B8:return{internalFormat:n?t.RGB8:t.RGB,baseFormat:t.RGB,dataType:t.UNSIGNED_BYTE,isCompressed:!1};case Ji.R8G8B8A8:return{internalFormat:n?t.RGBA8:t.RGBA,baseFormat:t.RGBA,dataType:t.UNSIGNED_BYTE,isCompressed:!1};case Ji.R4G4B4A4:return{internalFormat:n?t.RGBA4:t.RGBA,baseFormat:t.RGBA,dataType:t.UNSIGNED_SHORT_4_4_4_4,isCompressed:!1};case Ji.R5G5B5A1:return{internalFormat:n?t.RGB5_A1:t.RGBA,baseFormat:t.RGBA,dataType:t.UNSIGNED_SHORT_5_5_5_1,isCompressed:!1};case Ji.R5G6B5:return{internalFormat:n?t.RGB565:t.RGB,baseFormat:t.RGB,dataType:t.UNSIGNED_SHORT_5_6_5,isCompressed:!1};case Ji.Alpha8:return{internalFormat:t.ALPHA,baseFormat:t.ALPHA,dataType:t.UNSIGNED_BYTE,isCompressed:!1};case Ji.R32G32B32A32:return{internalFormat:t.RGBA32F,baseFormat:t.RGBA,dataType:t.FLOAT,isCompressed:!1};case Ji.DXT1:return{internalFormat:Ba.RGB_S3TC_DXT1_EXT,isCompressed:!0};case Ji.DXT5:return{internalFormat:Ba.RGBA_S3TC_DXT5_EXT,isCompressed:!0};case Ji.ETC1_RGB:return{internalFormat:Ba.RGB_ETC1_WEBGL,isCompressed:!0};case Ji.ETC2_RGB:return{internalFormat:Ba.RGB8_ETC2,isCompressed:!0};case Ji.ETC2_RGBA5:return{internalFormat:Ba.RGB8_PUNCHTHROUGH_ALPHA1_ETC2,isCompressed:!0};case Ji.ETC2_RGBA8:return{internalFormat:Ba.RGBA8_ETC2_EAC,isCompressed:!0};case Ji.PVRTC_RGB2:return{internalFormat:Ba.RGB_PVRTC_2BPPV1_IMG,isCompressed:!0};case Ji.PVRTC_RGBA2:return{internalFormat:Ba.RGBA_PVRTC_2BPPV1_IMG,isCompressed:!0};case Ji.PVRTC_RGB4:return{internalFormat:Ba.RGB_PVRTC_4BPPV1_IMG,isCompressed:!0};case Ji.PVRTC_RGBA4:return{internalFormat:Ba.RGBA_PVRTC_4BPPV1_IMG,isCompressed:!0};case Ji.ASTC_4x4:return{internalFormat:Ba.RGBA_ASTC_4X4_KHR,isCompressed:!0};case Ji.ASTC_5x5:return{internalFormat:Ba.RGBA_ASTC_5X5_KHR,isCompressed:!0};case Ji.ASTC_6x6:return{internalFormat:Ba.RGBA_ASTC_6X6_KHR,isCompressed:!0};case Ji.ASTC_8x8:return{internalFormat:Ba.RGBA_ASTC_8X8_KHR,isCompressed:!0};case Ji.ASTC_10x10:return{internalFormat:Ba.RGBA_ASTC_10X10_KHR,isCompressed:!0};case Ji.ASTC_12x12:return{internalFormat:Ba.RGBA_ASTC_12X12_KHR,isCompressed:!0};default:throw new Error("this TextureFormat is not supported in Oasis Engine: "+e)}},e._getRenderBufferColorFormatDetail=function(e,t,n){switch(e){case ji.R8G8B8:return{internalFormat:n?t.RGB8:t.RGB,baseFormat:t.RGB,dataType:t.UNSIGNED_BYTE,isCompressed:!1};case ji.R8G8B8A8:return{internalFormat:n?t.RGBA8:t.RGBA,baseFormat:t.RGBA,dataType:t.UNSIGNED_BYTE,isCompressed:!1};case ji.R4G4B4A4:return{internalFormat:n?t.RGBA4:t.RGBA,baseFormat:t.RGBA,dataType:t.UNSIGNED_SHORT_4_4_4_4,isCompressed:!1};case ji.R5G5B5A1:return{internalFormat:n?t.RGB5_A1:t.RGBA,baseFormat:t.RGBA,dataType:t.UNSIGNED_SHORT_5_5_5_1,isCompressed:!1};case ji.R5G6B5:return{internalFormat:n?t.RGB565:t.RGB,baseFormat:t.RGB,dataType:t.UNSIGNED_SHORT_5_6_5,isCompressed:!1};case ji.Alpha8:return{internalFormat:t.ALPHA,baseFormat:t.ALPHA,dataType:t.UNSIGNED_BYTE,isCompressed:!1};case ji.R16G16B16A16:return{internalFormat:t.RGBA16F,baseFormat:t.RGBA,dataType:t.HALF_FLOAT,isCompressed:!1};case ji.R32G32B32A32:return{internalFormat:t.RGBA32F,baseFormat:t.RGBA,dataType:t.FLOAT,isCompressed:!1};default:throw new Error("this RenderBufferColorFormat is not supported in Oasis Engine: "+e)}},e._getRenderBufferDepthFormatDetail=function(e,t,n){switch(e){case Xi.Depth:return{internalFormat:n?t.DEPTH_COMPONENT32F:t.DEPTH_COMPONENT16,baseFormat:t.DEPTH_COMPONENT,dataType:n?t.FLOAT:t.UNSIGNED_INT,isCompressed:!1,attachment:t.DEPTH_ATTACHMENT};case Xi.DepthStencil:return{internalFormat:n?t.DEPTH24_STENCIL8:t.DEPTH_STENCIL,baseFormat:t.DEPTH_STENCIL,dataType:t.UNSIGNED_INT_24_8,isCompressed:!1,attachment:t.DEPTH_STENCIL_ATTACHMENT};case Xi.Stencil:return{internalFormat:t.STENCIL_INDEX8,baseFormat:t.STENCIL_ATTACHMENT,dataType:t.UNSIGNED_BYTE,isCompressed:!1,attachment:t.STENCIL_ATTACHMENT};case Xi.Depth16:return{internalFormat:t.DEPTH_COMPONENT16,baseFormat:t.DEPTH_COMPONENT,dataType:t.UNSIGNED_INT,isCompressed:!1,attachment:t.DEPTH_ATTACHMENT};case Xi.Depth24:return{internalFormat:t.DEPTH_COMPONENT24,baseFormat:t.DEPTH_COMPONENT,dataType:t.UNSIGNED_INT,isCompressed:!1,attachment:t.DEPTH_ATTACHMENT};case Xi.Depth32:return{internalFormat:t.DEPTH_COMPONENT32F,baseFormat:t.DEPTH_COMPONENT,dataType:t.FLOAT,isCompressed:!1,attachment:t.DEPTH_ATTACHMENT};case Xi.Depth24Stencil8:return{internalFormat:n?t.DEPTH24_STENCIL8:t.DEPTH_STENCIL,baseFormat:t.DEPTH_STENCIL,dataType:t.UNSIGNED_INT_24_8,isCompressed:!1,attachment:t.DEPTH_STENCIL_ATTACHMENT};case Xi.Depth32Stencil8:return{internalFormat:t.DEPTH32F_STENCIL8,baseFormat:t.DEPTH_STENCIL,dataType:t.FLOAT_32_UNSIGNED_INT_24_8_REV,isCompressed:!1,attachment:t.DEPTH_STENCIL_ATTACHMENT};default:throw new Error("this RenderBufferDepthFormat is not supported in Oasis Engine: "+e)}},e._supportTextureFormat=function(e,t){var n=!0;switch(e){case Ji.R32G32B32A32:t.canIUse(le.textureFloat)||(n=!1)}return n},e._supportRenderBufferColorFormat=function(e,t){var n=!0;switch(e){case ji.R32G32B32A32:t.canIUse(le.colorBufferFloat)&&t.canIUse(le.textureFloat)||(n=!1);break;case ji.R16G16B16A16:t.canIUse(le.colorBufferHalfFloat)&&t.canIUse(le.textureHalfFloat)||(n=!1)}return n},e._supportRenderBufferDepthFormat=function(e,t,n){var i=t.isWebGL2,r=!0;if(n&&!t.canIUse(le.depthTexture))return!1;switch(e){case Xi.Stencil:r=!1;break;case Xi.Depth24:case Xi.Depth32:case Xi.Depth32Stencil8:i||(r=!1)}return r};var t=e.prototype;return t.destroy=function(){this._gl.deleteTexture(this._glTexture),this._texture=null,this._glTexture=null,this._formatDetail=null},t.generateMipmaps=function(){this._bind(),this._gl.generateMipmap(this._target)},t._bind=function(){this._rhi.bindTexture(this)},t._initMipmap=function(e){var t=this._gl,n=this._isWebGL2,i=this._formatDetail,r=i.internalFormat,a=i.baseFormat,o=i.dataType,s=this._texture,c=s.mipmapCount,l=s.width,u=s.height;if(this._bind(),n)t.texStorage2D(this._target,c,r,l,u);else if(a!==r&&(r=a),e)for(var h=0;h<c;h++)for(var d=Math.max(1,l>>h),f=0;f<6;f++)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+f,h,r,d,d,0,a,o,null);else for(var _=0;_<c;_++){var p=Math.max(1,l>>_),g=Math.max(1,u>>_);t.texImage2D(this._target,_,r,p,g,0,a,o,null)}},t._getPixelBuffer=function(t,n,i,r,a,o){var s=this._gl,c=this._formatDetail,l=c.baseFormat,u=c.dataType;e._readFrameBuffer||(e._readFrameBuffer=s.createFramebuffer()),s.bindFramebuffer(s.FRAMEBUFFER,e._readFrameBuffer),null!=t?s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_CUBE_MAP_POSITIVE_X+t,this._glTexture,0):s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this._glTexture,0),s.readPixels(n,i,r,a,l,u,o),s.bindFramebuffer(s.FRAMEBUFFER,null)},t._setWrapMode=function(t,n){var i=this._gl,r=this._isWebGL2,a=this._target,o=this._texture,s=o.width,c=o.height;switch(r||t===er.Clamp||e._isPowerOf2(s)&&e._isPowerOf2(c)||(me.warn("non-power-2 texture is not supported for REPEAT or MIRRORED_REPEAT in WebGL1,and has automatically downgraded to CLAMP_TO_EDGE"),t=er.Clamp),t){case er.Clamp:i.texParameteri(a,n,i.CLAMP_TO_EDGE);break;case er.Repeat:i.texParameteri(a,n,i.REPEAT);break;case er.Mirror:i.texParameteri(a,n,i.MIRRORED_REPEAT)}},ja(e,[{key:"wrapModeU",set:function(e){this._bind(),this._setWrapMode(e,this._gl.TEXTURE_WRAP_S)}},{key:"wrapModeV",set:function(e){this._bind(),this._setWrapMode(e,this._gl.TEXTURE_WRAP_T)}},{key:"filterMode",set:function(e){var t=this._gl,n=this._target,i=this._texture._mipmap;switch(this._bind(),e){case Qi.Point:t.texParameteri(n,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(n,t.TEXTURE_MIN_FILTER,i?t.NEAREST_MIPMAP_NEAREST:t.NEAREST);break;case Qi.Bilinear:t.texParameteri(n,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(n,t.TEXTURE_MIN_FILTER,i?t.LINEAR_MIPMAP_NEAREST:t.LINEAR);break;case Qi.Trilinear:t.texParameteri(n,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(n,t.TEXTURE_MIN_FILTER,i?t.LINEAR_MIPMAP_LINEAR:t.LINEAR)}}},{key:"anisoLevel",set:function(e){var t=this._gl;this._bind(),t.texParameterf(this._target,t.TEXTURE_MAX_ANISOTROPY_EXT,e)}}]),e}();$a._readFrameBuffer=null;var eo,to,no=function(e){function t(t,n){var i;i=e.call(this,t,n,n.isCube?t.gl.TEXTURE_CUBE_MAP:t.gl.TEXTURE_2D)||this;var r=n.format,a=n._mipmap,o=n.width,s=n.height,c=n.isCube,l=i._isWebGL2;if(!$a._supportRenderBufferColorFormat(r,t))throw new Error("RenderBufferColorFormat is not supported:"+ji[r]);if(c&&o!==s)throw new Error("The cube texture must have the same width and height");return!a||l||$a._isPowerOf2(o)&&$a._isPowerOf2(s)||(me.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),n._mipmap=!1,n._mipmapCount=n._getMipmapCount()),i._formatDetail=$a._getRenderBufferColorFormatDetail(r,i._gl,l),i._initMipmap(c),i}return Ka(t,e),t.prototype.getPixelBuffer=function(t,n,i,r,a,o){e.prototype._getPixelBuffer.call(this,t,n,i,r,a,o)},t}($a),io=function(e){function t(t,n){var i;i=e.call(this,t,n,n.isCube?t.gl.TEXTURE_CUBE_MAP:t.gl.TEXTURE_2D)||this;var r=n.format,a=n._mipmap,o=n.width,s=n.height,c=n.isCube,l=i._isWebGL2;if(!$a._supportRenderBufferDepthFormat(r,t,!0))throw new Error("RenderBufferDepthFormat is not supported:"+Xi[r]);if(c&&o!==s)throw new Error("The cube texture must have the same width and height");return!a||l||$a._isPowerOf2(o)&&$a._isPowerOf2(s)||(me.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),n._mipmap=!1,n._mipmapCount=n._getMipmapCount()),i._formatDetail=$a._getRenderBufferDepthFormatDetail(r,i._gl,l),i._initMipmap(c),i}return Ka(t,e),t}($a),ro=function(){function e(e){this._gl=void 0,this._parameters={},this._gl=e,this._parameters={},this._parameters[e.MAX_COMBINED_TEXTURE_IMAGE_UNITS]=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this._parameters[e.MAX_VERTEX_UNIFORM_VECTORS]=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._parameters[e.MAX_VERTEX_ATTRIBS]=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._parameters[e.MAX_VERTEX_TEXTURE_IMAGE_UNITS]=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.enable(e.DEPTH_TEST),e.depthFunc(e.LESS),e.depthMask(!0),e.disable(e.STENCIL_TEST),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,0,255),e.stencilFuncSeparate(e.BACK,e.ALWAYS,0,255),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMask(255),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0)}return e.prototype.getParameter=function(e){return this._parameters[e]},e}(),ao=function(){function e(e,t){this._gl=void 0,this._isWebGL2=void 0,this._target=void 0,this._frameBuffer=void 0,this._MSAAFrameBuffer=void 0,this._depthRenderBuffer=void 0,this._MSAAColorRenderBuffers=[],this._MSAADepthRenderBuffer=void 0,this._oriDrawBuffers=void 0,this._blitDrawBuffers=void 0,this._gl=e.gl,this._isWebGL2=e.isWebGL2,this._target=t;var n=t._colorTextures,i=t._depth,r=t.width,a=t.height;if(!(i instanceof pr||$a._supportRenderBufferDepthFormat(i,e,!1)))throw new Error("RenderBufferDepthFormat is not supported:"+Xi[i]);if(n.length>1&&!e.canIUse(le.drawBuffers))throw new Error("MRT is not supported");if(n.some((function(e){return e.width!==r||e.height!==a})))throw new Error("RenderColorTexture's size must as same as RenderTarget");if(i instanceof pr&&(i.width!==r||i.height!==a))throw new Error("RenderDepthTexture's size must as same as RenderTarget");if(n.length>1&&n.some((function(e){return e.isCube})))throw new Error("MRT+Cube+[,MSAA] is not supported");var o=e.capability.maxAntiAliasing;t.antiAliasing>o&&(me.warn("MSAA antiAliasing exceeds the limit and is automatically downgraded to:"+o),t._antiAliasing=o),this._frameBuffer=this._gl.createFramebuffer(),this._bindMainFBO(),t.antiAliasing>1&&(this._MSAAFrameBuffer=this._gl.createFramebuffer(),this._bindMSAAFBO())}var t=e.prototype;return t.setRenderTargetFace=function(e){var t=this._gl,n=this._target.getColorTexture(0),i=this._target.depthTexture;t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),null!=n&&n.isCube&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n._platformTexture._glTexture,0),null!=i&&i.isCube&&t.framebufferTexture2D(t.FRAMEBUFFER,i._platformTexture._formatDetail.attachment,t.TEXTURE_CUBE_MAP_POSITIVE_X+e,i._platformTexture._glTexture,0),this._activeRenderTarget()},t.blitRenderTarget=function(){if(this._MSAAFrameBuffer){var e=this._gl,t=e.COLOR_BUFFER_BIT|(this._target.depthTexture?e.DEPTH_BUFFER_BIT:0),n=this._target,i=n.colorTextureCount,r=n.width,a=n.height;e.bindFramebuffer(e.READ_FRAMEBUFFER,this._MSAAFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this._frameBuffer);for(var o=0;o<i;o++){var s=e.COLOR_ATTACHMENT0+o;this._blitDrawBuffers[o]=s,e.readBuffer(s),e.drawBuffers(this._blitDrawBuffers),e.blitFramebuffer(0,0,r,a,0,0,r,a,t,e.NEAREST),this._blitDrawBuffers[o]=e.NONE}e.bindFramebuffer(e.FRAMEBUFFER,null)}},t.destroy=function(){var e=this._gl;this._frameBuffer&&e.deleteFramebuffer(this._frameBuffer),this._depthRenderBuffer&&e.deleteRenderbuffer(this._depthRenderBuffer),this._MSAAFrameBuffer&&e.deleteFramebuffer(this._MSAAFrameBuffer),this._MSAADepthRenderBuffer&&e.deleteRenderbuffer(this._MSAADepthRenderBuffer);for(var t=0;t<this._MSAAColorRenderBuffers.length;t++)e.deleteRenderbuffer(this._MSAAColorRenderBuffers[t]);this._frameBuffer=null,this._depthRenderBuffer=null,this._MSAAFrameBuffer=null,this._MSAAColorRenderBuffers.length=0,this._MSAADepthRenderBuffer=null},t._activeRenderTarget=function(){var e=this._gl;this._MSAAFrameBuffer?e.bindFramebuffer(e.FRAMEBUFFER,this._MSAAFrameBuffer):e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer)},t._bindMainFBO=function(){var e=this._gl,t=this._isWebGL2,n=this._target,i=n._depth,r=n.colorTextureCount,a=n.width,o=n.height,s=new Array(r);e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer);for(var c=0;c<r;c++){var l=this._target.getColorTexture(c),u=e.COLOR_ATTACHMENT0+c;s[c]=u,l.isCube||e.framebufferTexture2D(e.FRAMEBUFFER,u,e.TEXTURE_2D,l._platformTexture._glTexture,0)}if(r>1&&e.drawBuffers(s),this._oriDrawBuffers=s,null!==i)if(i instanceof pr)i.isCube||e.framebufferTexture2D(e.FRAMEBUFFER,i._platformTexture._formatDetail.attachment,e.TEXTURE_2D,i._platformTexture._glTexture,0);else if(this._target.antiAliasing<=1){var h=$a._getRenderBufferDepthFormatDetail(i,e,t),d=h.internalFormat,f=h.attachment,_=e.createRenderbuffer();this._depthRenderBuffer=_,e.bindRenderbuffer(e.RENDERBUFFER,_),e.renderbufferStorage(e.RENDERBUFFER,d,a,o),e.framebufferRenderbuffer(e.FRAMEBUFFER,f,e.RENDERBUFFER,_)}e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null)},t._bindMSAAFBO=function(){var e=this._gl,t=this._isWebGL2,n=e.createRenderbuffer(),i=this._target,r=i._depth,a=i.colorTextureCount,o=i.antiAliasing,s=i.width,c=i.height;this._blitDrawBuffers=new Array(a),this._MSAADepthRenderBuffer=n,e.bindFramebuffer(e.FRAMEBUFFER,this._MSAAFrameBuffer);for(var l=0;l<a;l++){var u=e.createRenderbuffer();this._MSAAColorRenderBuffers[l]=u,this._blitDrawBuffers[l]=e.NONE,e.bindRenderbuffer(e.RENDERBUFFER,u),e.renderbufferStorageMultisample(e.RENDERBUFFER,o,this._target.getColorTexture(l)._platformTexture._formatDetail.internalFormat,s,c),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+l,e.RENDERBUFFER,u)}if(e.drawBuffers(this._oriDrawBuffers),null!==r){var h=r instanceof pr?r._platformTexture._formatDetail:$a._getRenderBufferDepthFormatDetail(r,e,t),d=h.internalFormat,f=h.attachment;e.bindRenderbuffer(e.RENDERBUFFER,n),e.renderbufferStorageMultisample(e.RENDERBUFFER,o,d,s,c),e.framebufferRenderbuffer(e.FRAMEBUFFER,f,e.RENDERBUFFER,n)}this._checkFrameBuffer(),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null)},t._checkFrameBuffer=function(){var e=this._gl,t=this._isWebGL2,n=e.checkFramebufferStatus(e.FRAMEBUFFER);switch(n){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete");case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment");case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error(" Height and width of the attachment are not the same.");case e.FRAMEBUFFER_UNSUPPORTED:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer")}if(t&&n===e.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE)throw new Error("The values of gl.RENDERBUFFER_SAMPLES are different among attached renderbuffers, or are non-zero if the attached images are a mix of renderbuffers and textures.")},e}(),oo=function(e){function t(t,n){var i;(i=e.call(this,t,n,t.gl.TEXTURE_2D)||this)._compressedMipFilled=0;var r=n.format,a=n._mipmap,o=n.width,s=n.height,c=i._isWebGL2;if(!$a._supportTextureFormat(r,t))throw new Error("Texture format is not supported:"+Ji[r]);return!a||c||$a._isPowerOf2(o)&&$a._isPowerOf2(s)||(me.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),n._mipmap=!1,n._mipmapCount=n._getMipmapCount()),i._formatDetail=$a._getFormatDetail(r,i._gl,c),i._formatDetail.isCompressed&&!c||i._initMipmap(!1),i}Ka(t,e);var n=t.prototype;return n.setPixelBuffer=function(e,t,n,i,r,a){void 0===t&&(t=0);var o=this._gl,s=this._isWebGL2,c=this._formatDetail,l=c.internalFormat,u=c.baseFormat,h=c.dataType,d=c.isCompressed,f=Math.max(1,this._texture.width>>t),_=Math.max(1,this._texture.height>>t);if(n=n||0,i=i||0,r=r||f-n,a=a||_-i,this._bind(),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,0),o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),d){var p=1<<t;s||this._compressedMipFilled&p?o.compressedTexSubImage2D(this._target,t,n,i,r,a,l,e):(o.compressedTexImage2D(this._target,t,l,r,a,0,e),this._compressedMipFilled|=p)}else o.texSubImage2D(this._target,t,n,i,r,a,u,h,e)},n.setImageSource=function(e,t,n,i,r,a){void 0===t&&(t=0),void 0===n&&(n=!1),void 0===i&&(i=!1);var o=this._gl,s=this._formatDetail,c=s.baseFormat,l=s.dataType;this._bind(),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,+n),o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+i),o.texSubImage2D(this._target,t,r||0,a||0,c,l,e)},n.getPixelBuffer=function(t,n,i,r,a){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");e.prototype._getPixelBuffer.call(this,null,t,n,i,r,a)},t}($a),so=function(e){function t(t,n){var i;(i=e.call(this,t,n,t.gl.TEXTURE_CUBE_MAP)||this)._compressedFaceFilled=[0,0,0,0,0,0];var r=n.format,a=n._mipmap,o=n.width,s=i._isWebGL2;if(!$a._supportTextureFormat(r,t))throw new Error("Texture format is not supported:"+Ji[r]);return!a||s||$a._isPowerOf2(o)||(me.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),n._mipmap=!1,n._mipmapCount=n._getMipmapCount()),i._formatDetail=$a._getFormatDetail(r,i._gl,s),i._formatDetail.isCompressed&&!s||i._initMipmap(!0),i}Ka(t,e);var n=t.prototype;return n.setPixelBuffer=function(e,t,n,i,r,a,o){void 0===n&&(n=0);var s=this._gl,c=this._isWebGL2,l=this._formatDetail,u=l.internalFormat,h=l.baseFormat,d=l.dataType,f=l.isCompressed,_=Math.max(1,this._texture.width>>n);if(i=i||0,r=r||0,a=a||_-i,o=o||_-r,this._bind(),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,0),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),f){var p=1<<n;c||this._compressedFaceFilled[e]&p?s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,i,r,a,o,u,t):(s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,u,a,o,0,t),this._compressedFaceFilled[e]|=p)}else s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,i,r,a,o,h,d,t)},n.setImageSource=function(e,t,n,i,r,a,o){void 0===n&&(n=0),void 0===i&&(i=!1),void 0===r&&(r=!1);var s=this._gl,c=this._formatDetail,l=c.baseFormat,u=c.dataType;this._bind(),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,+i),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+r),s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,a||0,o||0,l,u,t)},n.getPixelBuffer=function(t,n,i,r,a,o){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");e.prototype._getPixelBuffer.call(this,t,n,i,r,a,o)},t}($a);(to=eo||(eo={}))[to.Auto=0]="Auto",to[to.WebGL2=1]="WebGL2",to[to.WebGL1=2]="WebGL1";var co=function(){function e(e){void 0===e&&(e={}),this._currentBind=void 0,this._options=void 0,this._gl=void 0,this._renderStates=void 0,this._extensions=void 0,this._spriteBatcher=void 0,this._capability=void 0,this._isWebGL2=void 0,this._activedTextureID=void 0,this._activeTextures=new Array(32),this._options=e}var t=e.prototype;return t.init=function(e){var t,n=this._options,i=e._webCanvas,r=n.webGLMode||eo.Auto;if(r!=eo.Auto&&r!=eo.WebGL2||(!(t=i.getContext("webgl2",n))&&i instanceof HTMLCanvasElement&&(t=i.getContext("experimental-webgl2",n)),this._isWebGL2=!0,t&&!t.deleteQuery&&(this._isWebGL2=!1)),t||r!=eo.Auto&&r!=eo.WebGL1||(!(t=i.getContext("webgl",n))&&i instanceof HTMLCanvasElement&&(t=i.getContext("experimental-webgl",n)),this._isWebGL2=!1),!t)throw new Error("Get GL Context FAILED.");this._gl=t,this._renderStates=new ro(t),this._extensions=new Za(this),this._capability=new Qa(this),this._options=null},t.createPlatformPrimitive=function(e){return new Ja(this,e)},t.createPlatformTexture2D=function(e){return new oo(this,e)},t.createPlatformTextureCubeMap=function(e){return new so(this,e)},t.createPlatformRenderColorTexture=function(e){return new no(this,e)},t.createPlatformRenderDepthTexture=function(e){return new io(this,e)},t.createPlatformRenderTarget=function(e){return new ao(this,e)},t.requireExtension=function(e){return this._extensions.requireExtension(e)},t.canIUse=function(e){return this.capability.canIUse(e)},t.canIUseCompressedTextureInternalFormat=function(e){return this.capability.canIUseCompressedTextureInternalFormat(e)},t.viewport=function(e,t,n,i){var r=this._gl;r.viewport(e,r.drawingBufferHeight-t-i,n,i)},t.colorMask=function(e,t,n,i){this._gl.colorMask(e,t,n,i)},t.clearRenderTarget=function(e,t,n){var i,r=this._gl,a=e._lastRenderState,o=a.blendState.targetBlendState,s=a.depthState,c=a.stencilState;switch(t){case ae.SOLID_COLOR:r.clearColor(n.x,n.y,n.z,n.w),i=r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT;break;case ae.DEPTH_ONLY:i=r.DEPTH_BUFFER_BIT;break;case ae.COLOR_ONLY:r.clearColor(n.x,n.y,n.z,n.w),i=r.COLOR_BUFFER_BIT;break;case ae.STENCIL_ONLY:r.clear(r.STENCIL_BUFFER_BIT),i=r.STENCIL_BUFFER_BIT;break;case ae.ALL_CLEAR:r.clearColor(n.x,n.y,n.z,n.w),i=r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT|r.STENCIL_BUFFER_BIT}i&r.COLOR_BUFFER_BIT&&o.colorWriteMask!==lt.All&&(r.colorMask(!0,!0,!0,!0),o.colorWriteMask=lt.All),i&r.DEPTH_BUFFER_BIT&&!0!==s.writeEnabled&&(r.depthMask(!0),s.writeEnabled=!0),i&r.STENCIL_BUFFER_BIT&&255!==c.writeMask&&(r.stencilMask(255),c.writeMask=255),i&&r.clear(i)},t.drawPrimitive=function(e,t,n){e?e._draw(n,t):me.error("draw primitive failed.")},t.activeRenderTarget=function(e,t){var n=this._gl;if(e){var i;null===(i=e._platformRenderTarget)||void 0===i||i._activeRenderTarget();var r=e.width,a=e.height;n.viewport(0,0,r,a)}else{n.bindFramebuffer(n.FRAMEBUFFER,null);var o=t.viewport,s=n.drawingBufferWidth,c=n.drawingBufferHeight;this.viewport(o.x*s,o.y*c,o.z*s,o.w*c)}},t.destroy=function(){},t.activeTexture=function(e){this._activedTextureID!==e&&(this._gl.activeTexture(e),this._activedTextureID=e)},t.bindTexture=function(e){var t=this._gl;this._activeTextures[this._activedTextureID-t.TEXTURE0]!==e&&(t.bindTexture(e._target,e._glTexture),this._activeTextures[this._activedTextureID-t.TEXTURE0]=e)},ja(e,[{key:"isWebGL2",get:function(){return this._isWebGL2}},{key:"gl",get:function(){return this._gl}},{key:"renderStates",get:function(){return this._renderStates}},{key:"capability",get:function(){return this._capability}},{key:"canIUseMoreJoints",get:function(){return this.capability.canIUseMoreJoints}}]),e}(),lo=function(e){function t(t,n){var i=new Ya("string"==typeof t?document.getElementById(t):t),r=new co(n);return e.call(this,i,r)||this}return Ka(t,e),ja(t,[{key:"canvas",get:function(){return this._canvas}}]),t}(Sn);function uo(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function ho(e,t,n){return t&&uo(e.prototype,t),n&&uo(e,n),e}function fo(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _o(){return(_o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function po(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function go(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?po(Object(n),!0).forEach((function(t){fo(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):po(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function vo(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,mo(e,t)}function mo(e,t){return(mo=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function yo(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function xo(e,t,n){return(xo=yo()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&mo(r,n.prototype),r}).apply(null,arguments)}function wo(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function bo(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function Ao(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return bo(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?bo(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function To(e,t,n,i,r){var a={};return Object.keys(i).forEach((function(e){a[e]=i[e]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=n.slice().reverse().reduce((function(n,i){return i(e,t,n)||n}),a),r&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}H(Bi.Buffer,["bin","r3bin"],!1)(function(e){function t(){return e.apply(this,arguments)||this}return vo(t,e),t.prototype.load=function(e){var t=e.url;return function(e){return/^data:(.+?);base64,/.test(e)}(t)?new G((function(e){var n=t.slice(13+RegExp.$1.length);e(Uint8Array.from(atob(n),(function(e){return e.charCodeAt(0)})).buffer)})):this.request(t,go(go({},e),{},{type:"arraybuffer"}))},t}(Gi));var Mo,Co={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function Po(e){return{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16}[e]}function So(e){return Co[e]}function Ro(e,t,n){var i,r,a=e.bufferViews[t.bufferView],o=n[a.buffer],s=t.hasOwnProperty("byteOffset")?t.byteOffset:0,c=a.hasOwnProperty("byteOffset")?a.byteOffset:0,l=s+c,u=Po(t.type),h=u*t.count,d=null!=(i=a.byteStride)?i:0,f=So(t.componentType);if(d){r=new Uint8Array(h*f.BYTES_PER_ELEMENT);for(var _=new Uint8Array(o,c,a.byteLength),p=0,g=u*f.BYTES_PER_ELEMENT,v=0;v<t.count;v++){p=v*d+s;for(var m=0;m<g;m++)r[v*g+m]=_[p+m]}}else r=new Uint8Array(o,l,h*f.BYTES_PER_ELEMENT),r=new Uint8Array(r);return new f(r.buffer)}function Eo(e,t){var n=t[e.buffer],i=e.byteOffset||0;return n.slice(i,i+e.byteLength)}function Lo(e){return Po(e.type)*So(e.componentType).BYTES_PER_ELEMENT}function Fo(e,t,n,i){var r=Po(n.type);return new oi(t,0,function(e,t){if(e==se.FLOAT)switch(t){case 1:return Bn.Float;case 2:return Bn.Vector2;case 3:return Bn.Vector3;case 4:return Bn.Vector4}if(e==se.UNSIGNED_SHORT)switch(t){case 2:return Bn.UShort2;case 4:return Bn.UShort4}}(n.componentType,r),i)}function Oo(e,t){return new Promise((function(n,i){var r=new window.Blob([e],{type:t}),a=new Image;a.src=URL.createObjectURL(r),a.crossOrigin="anonymous",a.onerror=function(){i(new Error("Failed to load image buffer"))},a.onload=function(){requestAnimationFrame((function(){n(a)}))}}))}function Io(e,t){return/^(?:http|blob|data:|\/)/.test(t)?t:e.substring(0,e.lastIndexOf("/")+1)+t}var zo={init:function(){Mo||(Mo=new Va)},parse:function(e,t,n,i){var r=n.bufferViews,a=n.accessors,o=e.bufferView,s=e.attributes,c={},l={};for(var u in s)c[u]=s[u];for(var h in t.attributes)if(void 0!==s[h]){var d=a[t.attributes[h]];l[h]=So(d.componentType).name}var f={attributeIDs:c,attributeTypes:l,useUniqueIDs:!0,indexType:So(a[t.indices].componentType).name},_=Eo(r[o],i);return Mo.decode(_,f).then((function(e){return e}))}},Do={translation:"position",rotation:"rotation",scale:"scale",weights:"weights"},Bo=0,No=function(e){var t=new kn(e);return t.emissiveColor=new w(.749,.749,.749,1),t},Uo="KHR_draco_mesh_compression",Go={KHR_lights:null,KHR_materials_unlit:Wn,KHR_materials_pbrSpecularGlossiness:jn,KHR_techniques_webgl:On,KHR_draco_mesh_compression:zo},ko=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).defaultSceneRoot=void 0,t.defaultScene=void 0,t.scenes=void 0,t.textures=void 0,t.animations=void 0,t.materials=void 0,t.meshes=void 0,t.skins=void 0,t.cameras=void 0,t.meta=void 0,t}return vo(t,e),t}(he);function Vo(e,t){var n={engine:t,gltf:e.gltf,buffers:e.buffers,asset:new ko(t)};return n.asset.textures=e.textures,n.asset.meta=e.gltf,n.gltf.asset&&n.gltf.asset.version&&(n.gltf.version=Number(n.gltf.asset.version),n.gltf.isGltf2=n.gltf.version>=2&&n.gltf.version<=3),function(e){var t=e.gltf;e.asset,t.extensions;var n=t.extensionsUsed,i=t.extensionsRequired;if(n){me.info("extensionsUsed: ",n);for(var r=0;r<n.length;r++)Object.keys(Go).indexOf(n[r])>-1?Go[n[r]]||me.warn("extension "+n[r]+" is used, you can add this extension into gltf"):me.warn("extensionsUsed has unsupported extension "+n[r])}if(i){me.info("extensionsRequired: "+i);for(var a=0;a<i.length;a++)(Object.keys(Go).indexOf(i[a])<0||!Go[i[a]])&&me.error("model has not supported required extension "+i[a]),i[a]===Uo&&Go.KHR_draco_mesh_compression.init()}}(n),Ho(n,"materials",jo).then((function(){return Ho(n,"meshes",Ko)})).then((function(){return Ho(n,"nodes",Yo)})).then((function(){return Ho(n,"scenes",Qo)})).then((function(){return Ho(n,"skins",Wo)})).then((function(){return Ho(n,"animations",qo)})).then((function(){return function(e){var t,n=e.asset,i=e.gltf,r=i.nodes||[],a=i.meshes;n.defaultScene=Zo("scenes",null!=(t=i.scene)?t:0,e);for(var o=r.length-1;o>=0;o--){var s=r[o],c=Zo("nodes",o,e);if(s.hasOwnProperty("children"))for(var l=s.children||[],u=l.length-1;u>=0;u--){var h=Zo("nodes",l[u],e);c.addChild(h)}if(s.hasOwnProperty("mesh")){var d=s.mesh;c.meshIndex=d;for(var f=a[d].primitives,_=Zo("meshes",d,e),p=0;p<_.length;p++){var g=_[p],v=void 0;if(s.hasOwnProperty("skin")||g.hasOwnProperty("weights")){var m=Zo("skins",s.skin,e),y=c.addComponent(ha);y.mesh=g,y.skin=m,v=y}else(v=c.addComponent(ua)).mesh=g;var x=f[p].material,w=void 0!==x?Zo("materials",x,e):No(c.engine);v.setMaterial(p,w)}}}var b=n.defaultScene.nodes;if(1===b.length)n.defaultSceneRoot=b[0];else{for(var A=new $e(e.engine),T=0;T<b.length;T++)A.addChild(b[T]);n.defaultSceneRoot=A}var M=n.defaultSceneRoot.addComponent(fa),C=n.animations;C&&C.forEach((function(e){M.addAnimationClip(e,e.name)}));return e.asset}(n)}))}function Ho(e,t,n){var i=e.gltf,r=e.asset;if(r[t]||(r[t]=[]),i.hasOwnProperty(t)){var a=i[t]||[];me.debug(t+":",a);for(var o=[],s=a.length-1;s>=0;s--)o.push(n(a[s],e));return Promise.all(o).then((function(e){for(var n=0;n<e.length;n++)r[t].push(e[n])}))}return Promise.resolve()}function jo(e,t){var n=t.gltf,i=t.engine;if(n.isGltf2&&void 0===e.technique){var r=e.extensions,a=void 0===r?{}:r,o=e.pbrMetallicRoughness,s=e.normalTexture,c=e.emissiveTexture,l=e.emissiveFactor,u=e.occlusionTexture,h=e.alphaMode,d=e.alphaCutoff,f=e.doubleSided,_=a.KHR_materials_unlit,p=a.KHR_materials_pbrSpecularGlossiness,g=null;switch((g=_?new Wn(i):p?new jn(i):new Hn(i)).renderFace=f?Tn.Double:Tn.Front,h){case"OPAQUE":g.isTransparent=!1;break;case"BLEND":g.isTransparent=!0;break;case"MASK":g.alphaCutoff=void 0===d?.5:d}if(o){var v=o.baseColorFactor,m=o.baseColorTexture,y=o.metallicFactor,x=o.roughnessFactor,b=o.metallicRoughnessTexture;m&&(g.baseTexture=Zo("textures",m.index||0,t,!1)),v&&(g.baseColor=xo(w,v)),_||((g=g).metallicFactor=void 0!==y?y:1,g.roughnessFactor=void 0!==x?x:1,b&&(g.metallicRoughnessTexture=Zo("textures",b.index||0,t,!1)))}if(_)return Promise.resolve(g);if(g=g,c&&(g.emissiveTexture=Zo("textures",c.index||0,t,!1)),l&&(g.emissiveColor=xo(w,l)),s){var A=s.index;s.texCoord;var T=s.scale;(g=g).normalTexture=Zo("textures",A||0,t,!1),void 0!==T&&(g.normalIntensity=T)}if(u&&((g=g).occlusionTexture=Zo("textures",u.index||0,t,!1),void 0!==u.strength&&(g.occlusionStrength=u.strength)),p){var M=a.KHR_materials_pbrSpecularGlossiness,C=M.diffuseFactor,P=M.diffuseTexture,S=M.specularFactor,R=M.glossinessFactor,E=M.specularGlossinessTexture;g=g,C&&(g.baseColor=xo(w,C)),P&&(g.baseTexture=Zo("textures",P.index||0,t,!1)),S&&(g.specularColor=xo(w,S)),void 0!==R&&(g.glossinessFactor=R),E&&(g.specularGlossinessTexture=Zo("textures",E.index||0,t,!1))}return Promise.resolve(g)}var L=e.technique;if(me.warn("Deprecated: Please use a model that meets the glTF 2.0 specification"),"Texture"===L){var F=new Wn(i),O=e.values._MainTex[0];return F.baseTexture=Zo("textures",O||0,t,!1),Promise.resolve(F)}return Promise.resolve()}function Wo(e,t){for(var n=t.gltf,i=t.buffers,r=e.joints.length,a=new xa(e.name),o=Ro(n,n.accessors[e.inverseBindMatrices],i),s=0;s<r;s++){var c=16*s,l=c+16;a.inverseBindMatrices[s]=xo(p,o.subarray(c,l))}for(var u=0;u<r;u++){var h=Zo("nodes",e.joints[u],t);a.joints[u]=h.name}var d=Zo("nodes",null==e.skeleton?e.joints[0]:e.skeleton,t);return a.skeleton=d.name,Promise.resolve(a)}function Xo(e,t,n,i,r,a,o){var c,l=0,u=[];for(var h in n.attributes){var d=n.attributes[h],f=i.accessors[d],_=Lo(f),p=Fo(0,h,f,l);u.push(p);var g=r(h),v=new ti(o,qn.VertexBuffer,g.byteLength,zn.Static);if(v.setData(g),e.setVertexBufferBinding(v,_,l++),"POSITION"==p.semantic){var m=new s;c=g.length/3;for(var y=e.bounds,x=y.min,w=y.max,b=0;b<c;b++){var A=3*b;m.setValue(g[A],g[A+1],g[A+2]),s.min(x,m,x),s.max(w,m,w)}}}if(e.setVertexElements(u),void 0!==n.indices){var T=i.accessors[n.indices],M=a(),C=T.count,P=function(e){switch(e){case se.UNSIGNED_BYTE:return Un.UInt8;case se.UNSIGNED_SHORT:return Un.UInt16;case se.UNSIGNED_INT:return Un.UInt32}}(T.componentType),S=P==Un.UInt32?4:P==Un.UInt16?2:1,R=new ti(o,qn.IndexBuffer,C*S,zn.Static);R.setData(M),e.setIndexBufferBinding(new ni(R,P)),e.addSubMesh(0,C)}else t.start=0,t.count=c;return Promise.resolve(e)}function Ko(e,t){for(var n=t.gltf,i=t.buffers,r=t.engine,a=[],o=function(o){a.push(new Promise((function(a,s){var c,l=e.primitives[o],u=new si(r,l.name||e.name||o),h=new ii;if(h.topology=null==l.mode?$n.Triangles:l.mode,l.hasOwnProperty("targets")&&(u.weights=e.weights||new Array(l.targets.length).fill(0)),l.extensions&&l.extensions[Uo]){var d=Go.KHR_draco_mesh_compression,f=l.extensions[Uo];c=d.parse(f,l,n,i).then((function(e){return Xo(u,h,l,n,(function(t){for(var n=0;n<e.attributes.length;n++)if(e.attributes[n].name===t)return e.attributes[n].array;return null}),(function(){return e.index.array}),t.engine)}))}else c=Xo(u,h,l,n,(function(e){var t=l.attributes[e],r=n.accessors[t];return Ro(n,r,i)}),(function(){var e=n.accessors[l.indices];return Ro(n,e,i)}),t.engine);c.then((function(e){a(e)})).catch((function(e){s(e)}))})))},s=0;s<e.primitives.length;s++)o(s);return Promise.all(a).then((function(e){return e}))}function qo(e,t){for(var n=t.gltf,i=t.buffers,r=e.samplers||[],a=e.channels||[],o=n.animations.indexOf(e),s=new Xr(e.name||"Animation"+o),c=-1,l=-1,u=0;u<r.length;u++){var h=r[u],d=n.accessors[h.input],f=n.accessors[h.output],_=Ro(n,d,i),p=Ro(n,f,i),g=Po(f.type);g*_.length!==p.length&&(g=p.length/_.length);var v=Dr.LINEAR;switch(h.interpolation){case"CUBICSPLINE":v=Dr.CUBICSPLINE;break;case"STEP":v=Dr.STEP}var m=_[_.length-1];m>c&&(c=m,l=u),s.addSampler(_,p,g,v)}s.durationIndex=l,s.duration=c;for(var y=0;y<a.length;y++){var x=a[y],w=x.target,b=x.sampler,A=Zo("nodes",w.node,t),T=Do[w.path];s.addChannel(b,A.name,T)}return Promise.resolve(s)}function Yo(e,t){var n=new $e(t.engine,e.name||"GLTF_NODE_"+Bo++);if(e.hasOwnProperty("matrix")){var i=e.matrix,r=new p;r.setValueByArray(i);var a=new s,o=new s(1,1,1),c=new _;r.decompose(a,c,o),n.transform.position=a,n.transform.rotationQuaternion=c,n.transform.scale=o}else for(var l in Do)if(e.hasOwnProperty(l)){var u=Do[l];if("weights"===u)n[u]=e[l];else{var h=e[l],d=h.length,f=n[u];2===d?f.setValue(h[0],h[1]):3===d?f.setValue(h[0],h[1],h[2]):4===d&&f.setValue(h[0],h[1],h[2],h[3]),n[u]=f}}if(void 0!==e.camera){var g=t.gltf.cameras[e.camera],v=n.addComponent(Fi);if("orthographic"===g.type){v.isOrthographic=!0;var m=g.orthographic,y=m.ymag,x=m.xmag,w=m.zfar,b=m.znear;void 0!==b&&(v.nearClipPlane=b),void 0!==w&&(v.farClipPlane=w),y&&x&&(v.orthographicSize=Math.max(y,x)/2),void 0!==y&&x&&(v.orthographicSize=x/2),void 0!==x&&y&&(v.orthographicSize=y/2)}else{var A=g.perspective,T=A.aspectRatio,M=A.yfov,C=A.zfar,P=A.znear;void 0!==T&&(v.aspectRatio=T),void 0!==M&&(v.fieldOfView=M),void 0!==C&&(v.farClipPlane=C),void 0!==P&&(v.nearClipPlane=P)}}return e.extensions,Promise.resolve(n)}function Qo(e,t){for(var n=[],i=0;i<e.nodes.length;i++){var r=Zo("nodes",e.nodes[i],t);n.push(r)}return e.extensions,Promise.resolve({nodes:n})}function Zo(e,t,n,i){void 0===i&&(i=!0);var r=n.asset,a=i?r[e].length-t-1:t;return r[e][a]}function Jo(e){var t=1313821514,n=5130562,i=new DataView(e),r={magic:i.getUint32(0,!0),version:i.getUint32(4,!0),length:i.getUint32(8,!0)};if(1179937895!==r.magic)return console.error("Invalid glb magic number. Expected 0x46546C67, found 0x"+r.magic.toString(16)),null;var a=i.getUint32(12,!0),o=i.getUint32(16,!0);if(o!==t)return console.error("Invalid glb chunk type. Expected 0x004E4942, found 0x"+o.toString(16)),null;for(var s=new Uint8Array(e,20,a),c=JSON.parse(function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);for(var t="",n=0,i=e.length;n<i;n++)t+=String.fromCharCode(e[n]);return decodeURIComponent(encodeURIComponent(t))}(s)),l=[],u=20+a;u<r.length;){if(a=i.getUint32(u,!0),(o=i.getUint32(u+4,!0))!==n)return console.error("Invalid glb chunk type. Expected 0x004E4942, found 0x"+o.toString(16)),null;var h=u+8,d=e.slice(h,h+a);l.push(d),u+=a+8}return{gltf:c,buffers:l}}H(Bi.Perfab,["gltf","glb"])(function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).baseUrl=void 0,t.requestGLTF=function(e,n){return t.request(e.url,go(go({},e),{},{type:"json"})).then((function(i){return t._loadGLTFResources(e,i,n)}))},t.requestGLB=function(e,n){return t.request(e.url,go(go({},e),{},{type:"arraybuffer"})).then(Jo).then((function(t){return go(go({},t),{},{baseUrl:e.url,resourceManager:n})})).then(t._loadImages)},t._loadImages=function(e){var t=e.gltf,n=e.buffers,i=e.baseUrl,r=e.resourceManager;return t.images?Promise.all(t.images.map((function(e){var a=e.uri,o=e.bufferView,s=e.mimeType;return a?r.load({url:Io(i,a),type:Bi.Texture2D}):Oo(Eo(t.bufferViews[o],n),s).then((function(e){var t=new fr(r.engine,e.width,e.height);return t.setImageSource(e),t.generateMipmaps(),t}))}))).then((function(e){return{gltf:t,buffers:n,textures:e}})):Promise.resolve({gltf:t,buffers:n})},t}vo(t,e);var n=t.prototype;return n.load=function(e,t){var n=this;return new G((function(i,r){(n.isGLB(e.url)?n.requestGLB:n.requestGLTF)(e,t).then((function(e){Vo(e,t.engine).then((function(e){i(e)}))})).catch((function(t){console.error(t),r("Error loading glTF JSON from "+e.url)}))}))},n.isGLB=function(e){return"glb"===e.substring(e.lastIndexOf(".")+1)},n._loadGLTFResources=function(e,t,n){return this._loadBuffers(e.url,t,n).then(this._loadImages)},n._loadBuffers=function(e,t,n){return t.buffers?Promise.all(t.buffers.map((function(t){return t instanceof ArrayBuffer?Promise.resolve(t):n.load({url:Io(e,t.uri),type:Bi.Buffer})}))).then((function(i){return{buffers:i,gltf:t,baseUrl:e,resourceManager:n}})):Promise.resolve({baseUrl:e,gltf:t,resourceManager:n})},t}(Gi)),H(Bi.JSON,["json"],!1)(function(e){function t(){return e.apply(this,arguments)||this}return vo(t,e),t.prototype.load=function(e){return this.request(e.url,go(go({},e),{},{type:"json"}))},t}(Gi));var $o=function(e,t,n,i){if(void 0===i&&(i=!1),!function(e){if(e.byteLength>=12){var t=new Uint8Array(e,0,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&49===t[5]&&49===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return!0}return!1}(e))throw new Error("khronosTextureContainerParser: invalid KTX file, texture missing KTX identifier");var r=Uint32Array.BYTES_PER_ELEMENT,a=new DataView(e,12,13*r),o=67305985===a.getUint32(0,!0),s={buffer:e,glType:a.getUint32(1*r,o),glTypeSize:a.getUint32(2*r,o),glFormat:a.getUint32(3*r,o),glInternalFormat:a.getUint32(4*r,o),glBaseInternalFormat:a.getUint32(5*r,o),pixelWidth:a.getUint32(6*r,o),pixelHeight:a.getUint32(7*r,o),pixelDepth:a.getUint32(8*r,o),numberOfArrayElements:a.getUint32(9*r,o),numberOfFaces:a.getUint32(10*r,o),numberOfMipmapLevels:a.getUint32(11*r,o),bytesOfKeyValueData:a.getUint32(12*r,o),loadType:0};if(0!==s.glType)throw new Error("only compressed formats currently supported");if(s.numberOfMipmapLevels=Math.max(1,s.numberOfMipmapLevels),0===s.pixelHeight||0!==s.pixelDepth)throw new Error("only 2D textures currently supported");if(0!==s.numberOfArrayElements)throw new Error("texture arrays not currently supported");if(s.numberOfFaces!==t)throw new Error("number of faces expected"+t+", but found "+s.numberOfFaces);return n&&(s.mipmaps=function(e,t){for(var n=[],i=64+e.bytesOfKeyValueData,r=e.pixelWidth,a=e.pixelHeight,o=t?e.numberOfMipmapLevels:1,s=0;s<o;s++){var c=new Int32Array(e.buffer,i,1)[0];i+=4;for(var l=0;l<e.numberOfFaces;l++){var u=new Uint8Array(e.buffer,i,c);n.push({data:u,width:r,height:a}),i+=c,i+=3-(c+3)%4}r=Math.max(1,.5*r),a=Math.max(1,.5*a)}return n}(s,!0)),i&&(s.engineFormat=function(e){switch(e){case Ba.RGB_S3TC_DXT1_EXT:return Ji.DXT1;case Ba.RGBA_S3TC_DXT5_EXT:return Ji.DXT5;case Ba.RGB_ETC1_WEBGL:return Ji.ETC1_RGB;case Ba.RGB8_ETC2:return Ji.ETC2_RGB;case Ba.RGB8_PUNCHTHROUGH_ALPHA1_ETC2:return Ji.ETC2_RGBA5;case Ba.RGBA8_ETC2_EAC:return Ji.ETC2_RGBA8;case Ba.RGB_PVRTC_2BPPV1_IMG:return Ji.PVRTC_RGB2;case Ba.RGBA_PVRTC_2BPPV1_IMG:return Ji.PVRTC_RGBA2;case Ba.RGB_PVRTC_4BPPV1_IMG:return Ji.PVRTC_RGB4;case Ba.RGBA_PVRTC_4BPPV1_IMG:return Ji.PVRTC_RGBA4;case Ba.RGBA_ASTC_4X4_KHR:return Ji.ASTC_4x4;case Ba.RGBA_ASTC_5X5_KHR:return Ji.ASTC_5x5;case Ba.RGBA_ASTC_6X6_KHR:return Ji.ASTC_6x6;case Ba.RGBA_ASTC_8X8_KHR:return Ji.ASTC_8x8;case Ba.RGBA_ASTC_10X10_KHR:return Ji.ASTC_10x10;case Ba.RGBA_ASTC_12X12_KHR:return Ji.ASTC_12x12;default:var t=Ba[e];throw new Error("this format is not supported in Oasis Engine: "+t)}}(s.glInternalFormat)),s};H(Bi.KTXCube,[])(function(e){function t(){return e.apply(this,arguments)||this}return vo(t,e),t.prototype.load=function(e,t){var n=this;return new G((function(i,r){Promise.all(e.urls.map((function(t){return n.request(t,go(go({},e),{},{type:"arraybuffer"}))}))).then((function(e){for(var n=function(e){for(var t,n,i,r,a=[],o=0;o<e.length;o++){var s=$o(e[o],1,!0,!0);a.push(s.mipmaps),0===o&&(i=s.pixelWidth,r=s.pixelHeight,t=s.glInternalFormat,n=s.engineFormat)}return{mipmapsFaces:a,engineFormat:n,internalFormat:t,width:i,height:r}}(e),r=n.width,a=n.mipmapsFaces,o=n.engineFormat,s=a[0].length>1,c=new _r(t.engine,r,o,s),l=0;l<6;l++)for(var u=a[l].length,h=0;h<u;h++){var d=a[l][h],f=d.data,_=d.width,p=d.height;c.setPixelBuffer(qi.PositiveX+l,f,h,0,0,_,p)}i(c)})).catch((function(e){r(e)}))}))},t}(Gi)),H(Bi.KTX,["ktx"])(function(e){function t(){return e.apply(this,arguments)||this}return vo(t,e),t.prototype.load=function(e,t){var n=this;return new G((function(i,r){n.request(e.url,go(go({},e),{},{type:"arraybuffer"})).then((function(e){for(var n=function(e){var t=$o(e,1,!0,!0);return{mipmaps:t.mipmaps,engineFormat:t.engineFormat,internalFormat:t.glInternalFormat,width:t.pixelWidth,height:t.pixelHeight}}(e),r=n.width,a=n.height,o=n.mipmaps,s=n.engineFormat,c=o.length>1,l=new fr(t.engine,r,a,s,c),u=0;u<o.length;u++){var h=o[u],d=h.width,f=h.height,_=h.data;l.setPixelBuffer(_,u,0,0,d,f)}i(l)})).catch((function(e){r(e)}))}))},t}(Gi)),H(Bi.Texture2D,["png","jpg","webp","jpeg"])(function(e){function t(){return e.apply(this,arguments)||this}return vo(t,e),t.prototype.load=function(e,t){var n=this;return new G((function(i,r){n.request(e.url,go(go({},e),{},{type:"image"})).then((function(n){var r=new fr(t.engine,n.width,n.height);if(r._platformTexture){if(r.setImageSource(n),r.generateMipmaps(),0!==e.url.indexOf("data:")){var a=e.url.split("/");r.name=a[a.length-1]}i(r)}})).catch((function(e){r(e)}))}))},t}(Gi)),H(Bi.TextureCube,[""])(function(e){function t(){return e.apply(this,arguments)||this}return vo(t,e),t.prototype.load=function(e,t){var n=this;return new G((function(i,r){Promise.all(e.urls.map((function(t){return n.request(t,go(go({},e),{},{type:"image"}))}))).then((function(e){var n=e[0],r=n.width;if(r===n.height){var a=new _r(t.engine,r);if(a._platformTexture){for(var o=0;o<6;o++)a.setImageSource(qi.PositiveX+o,e[o],0);a.generateMipmaps(),i(a)}}else console.error("The cube texture must have the same width and height")})).catch((function(e){r(e)}))}))},t}(Gi));var es,ts,ns=function(e){function t(t){var n;return(n=e.call(this,t)||this)._animator=void 0,n.animationsNames=void 0,n._asset=void 0,n.GLTFNode=void 0,n._loop=void 0,n._autoPlay=void 0,n._hasBuiltNode=!1,n}vo(t,e);var n=t.prototype;return n.init=function(e){var t=e.asset,n=void 0===t?null:t,i=e.autoPlay,r=e.loop;if(e.isClone){var a=e.gltfRootName;a&&(this.GLTFNode=this.entity.findByName(a))}if(this.GLTFNode)this._hasBuiltNode=!0;else{var o="GLTF-"+Date.now();e.gltfRootName=o,this.GLTFNode=this.entity.createChild(o),this._hasBuiltNode=!1}this.asset=n,this.loop=r,this.autoPlay=i},n._onEnable=function(){this.GLTFNode&&(this.GLTFNode.isActive=!0)},n._onDisable=function(){this.GLTFNode&&(this.GLTFNode.isActive=!1)},ho(t,[{key:"asset",get:function(){return this._asset},set:function(e){e&&e.defaultSceneRoot===this.GLTFNode||(this._hasBuiltNode||(this.GLTFNode.clearChildren(),null!==e&&(this.GLTFNode&&this.GLTFNode.destroy(),this.GLTFNode=e.defaultSceneRoot.clone(),this._animator=this.GLTFNode.getComponent(fa),this.entity.addChild(this.GLTFNode))),this._asset=e)}},{key:"animator",get:function(){return this._animator}},{key:"autoPlay",get:function(){return this._autoPlay},set:function(e){this._animator&&(e?this._animator.playAnimationClip(e,{wrapMode:this._loop}):this._animator.stop(!1)),this._autoPlay=e}},{key:"loop",get:function(){return this._loop},set:function(e){this._animator&&this.autoPlay&&this._animator.playAnimationClip(this._autoPlay,{wrapMode:e}),this._loop=e}}]),t}(Qe),is=function(e){function t(t){var n;return(n=e.call(this,t)||this)._geometryType=void 0,n.setMaterial(new kn(n.engine)),n.geometryType=es.Box,n}return vo(t,e),ho(t,[{key:"geometryType",get:function(){return this._geometryType},set:function(e){switch(e){case"Sphere":this.mesh=wa.createSphere(this._engine);break;case"Cylinder":this.mesh=wa.createCylinder(this._engine);break;case"Plane":this.mesh=wa.createPlane(this._engine);break;case"Box":this.mesh=wa.createCuboid(this._engine)}this._geometryType=e}},{key:"material",get:function(){return this.getMaterial()},set:function(e){this.setMaterial(e)}}]),t}(ua);(ts=es||(es={})).Box="Box",ts.Cylinder="Cylinder",ts.Plane="Plane",ts.Sphere="Sphere";var rs=function(){function e(){this.registeredPlugins=new Set,this.plugins=[]}var t=e.prototype;return t.register=function(e){this.registeredPlugins.add(e)},t.boot=function(e){for(var t,n=Ao(this.registeredPlugins.values());!(t=n()).done;){var i=t.value;"function"==typeof i&&(i=i(e)),this.plugins.push(i)}},t.reset=function(){this.registeredPlugins.clear(),this.plugins=[]},t.nodeAdded=function(e){this.delegateMethod("nodeAdded",e)},t.delegateMethod=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];this.plugins.forEach((function(t){return t[e]&&t[e].apply(t,n)}))},e}();function as(e){return function(t,n,i){var r=i.value;i.value=function(){for(var t,n=this,i=arguments.length,a=new Array(i),o=0;o<i;o++)a[o]=arguments[o];return e.before&&(t=this.oasis.pluginManager).delegateMethod.apply(t,[e.before].concat(a)),Promise.resolve(r.apply(this,arguments)).then((function(t){return e.after&&n.oasis.pluginManager.delegateMethod(e.after,t),t}))}}}function os(e){for(var t=Object.keys(e),n=0,i=t.length;n<i;++n){var r=t[n],a=e[r];Array.isArray(a)&&(-1!==["color","diffuseColor","specularColor"].indexOf(r)?e[r]=new w(a[0],a[1],a[2],a[3]):4===a.length?e[r]=new m(a[0],a[1],a[2],a[3]):3===a.length?e[r]=new s(a[0],a[1],a[2]):2===a.length&&(e[r]=new v(a[0],a[1])))}}function ss(e){if(void 0===e&&(e={}),e)for(var t=Object.keys(e),n=0,i=t.length;n<i;n++){var r=t[n],a=e[r];"newMaterial"!==r&&"scripts"!==r&&(Array.isArray(a)&&(-1!==["emissiveColor","diffuseColor","specularColor","baseColor"].indexOf(r)?e[r]=new w(a[0],a[1],a[2],a[3]):4===a.length?e[r]=new m(a[0],a[1],a[2],a[3]):3===a.length?e[r]=new s(a[0],a[1],a[2]):2===a.length&&(e[r]=new v(a[0],a[1]))))}}var cs=function(){var e=t.prototype;function t(){this.pluginManager=new rs}return e.parse=function(e){var t,n;3!==(null==e||null===(t=e.config)||void 0===t?void 0:t.version)&&console.warn('schema-parser: schema version "'+(null==e||null===(n=e.config)||void 0===n?void 0:n.version)+'" is out of date, please re-pull the latest version (version 3) of the schema');return function(e){for(var t=e.abilities,n=void 0===t?{}:t,i=e.assets,r=void 0===i?{}:i,a=Object.keys(n),o=Object.keys(r),s=0,c=a.length;s<c;++s)os(n[a[s]].props);for(var l=0,u=o.length;l<u;++l)ss(r[o[l]].props)}(e.config),Qs.create(e,this.pluginManager)},e.register=function(e){this.pluginManager.register(e)},e.resetPlugins=function(){this.pluginManager.reset()},t.create=function(){return new t},t.registerComponents=function(e,t){this._components[e]||(this._components[e]={}),_o(this._components[e],t)},t}();function ls(e,t,n){if(t!==n&&null!=n){var i=[e[n],e[t]];e[t]=i[0],e[n]=i[1]}}function us(e){return e&&"asset"===e.type}function hs(e){for(var t=[],n=Object.getPrototypeOf(e),i=Object.getOwnPropertyDescriptors(n),r=0,a=Object.entries(i);r<a.length;r++){var o=a[r],s=o[0];"function"==typeof o[1].get&&t.push(s)}return t}cs._components={},cs.create();var ds,fs,_s=function(){var e=t.prototype;function t(e,t){this.resourceManager=e,this._resource=t,this._meta={},this._attachedResources=[],this.setMeta()}return e.setMeta=function(){},e.loadWithAttachedResources=function(e,t,n){var i=this;return new Promise((function(r,a){i.load(e,t,n).then((function(){r({resources:[i],structure:{index:0,props:{}}})})).catch((function(e){a(e)}))}))},e.getProps=function(){return{}},e.bind=function(){},e.attach=function(){},e.update=function(e,t){if(us(t)){var n=this.resourceManager.get(t.id);n?this._resource[e]=n.resource:me.warn("SchemaResource: "+this.meta.name+" can't find asset, which id is: "+t.id)}else this._resource[e]=t},e.updateMeta=function(e,t){this._meta[e]=t},e.onDestroy=function(){},ho(t,[{key:"resource",get:function(){return this._resource}},{key:"meta",get:function(){return this._meta}},{key:"attachedResources",get:function(){return this._attachedResources}}]),t}(),ps=function(e){function t(){return e.apply(this,arguments)||this}vo(t,e);var n=t.prototype;return n.load=function(e,t,n){var i=this;return new Promise((function(r,a){var o,s,c,l,u=Bi.Texture2D;if(i.resourceManager.useCompressedTexture&&null!=t&&null!==(o=t.props)&&void 0!==o&&null!==(s=o.compression)&&void 0!==s&&s.compressions.length)for(var h=n.engine._hardwareRenderer,d=t.props.compression.compressions,f=0;f<d.length;f++){var _=d[f];if("ktx"===_.container&&h.canIUse(le[_.type])){l=_.url,u=Bi.KTX;break}}l=null!=(c=l)?c:t.url,e.load({url:l,type:u}).then((function(e){i._resource=e,r(i)})).catch((function(e){a(e)}))}))},n.setMeta=function(){this.resource&&(this._meta.name=this.resource.name,this.resource.image&&(this._meta.url=this.resource.image.src))},t}(_s),gs=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).configProps=void 0,t}vo(t,e);var n=t.prototype;return n.load=function(e,t){var n=this;return new Promise((function(i){var r=new kn(e.engine);for(var a in n.configProps=t.props,n._resource=r,n.configProps)us(n.configProps[a])||(r[a]=n.configProps[a]);n.setMeta(),i(n)}))},n.loadWithAttachedResources=function(e,t){var n=this;return new Promise((function(i,r){var a;t.resource instanceof kn?a=new Promise((function(e){n._resource=t.resource,n.setMeta(),e(n)})):t.props?a=n.load(e,t):r("Load BlinnPhongMaterial Error"),a&&a.then((function(){var e={resources:[n],structure:{index:0,props:{}}},t=n._resource;hs(n._resource).forEach((function(i){if(t[i]instanceof Dt){var r=new ps(n.resourceManager,t[i]);n.attachedResources.push(r),e.resources.push(r),e.structure.props[i]={index:e.resources.length-1}}})),i(e)}))}))},n.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},n.bind=function(){var e=this,t=this._resource;Object.keys(this.configProps).forEach((function(n){var i=e.configProps[n];if(us(i)){var r=e.resourceManager.get(i.id);r&&r instanceof ps?(t[n]=r.resource,e._attachedResources.push(r)):(t[n]=null,me.warn("BlinnPhongMaterialResource: "+e.meta.name+" can't find asset \""+n+'", which id is: '+i.id))}else t[n]=i}))},t}(_s),vs=["metallicFactor","roughnessFactor","metallicTexture","roughnessTexture","metallicRoughnessTexture","tilingOffset","baseColor","normalIntensity","emissiveColor","occlusionStrength","envMapIntensity","refractionRatio","refractionDepth","perturbationUOffset","perturbationVOffset","baseTexture","opacityTexture","normalTexture","emissiveTexture","occlusionTexture","refractionTexture","perturbationTexture","srgb","srgbFast","gamma","getOpacityFromRGB","isTransparent","alphaCutoff","renderFace","blendMode"],ms=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).configProps=void 0,t}vo(t,e);var n=t.prototype;return n.load=function(e,t){var n=this;return new Promise((function(i){var r=new Hn(e.engine);for(var a in n.configProps=t.props,n.configProps)us(n.configProps[a])||(r[a]=n.configProps[a]);n._resource=r,n.setMeta(),i(n)}))},n.loadWithAttachedResources=function(e,t){var n=this;return new Promise((function(i,r){var a;t.resource instanceof Hn?a=new Promise((function(e){n._resource=t.resource,n.setMeta(),e(n)})):t.props?a=n.load(e,t):r("Load PBRMaterial Error"),a&&a.then((function(){var e={resources:[n],structure:{index:0,props:{}}},t=n._resource;vs.forEach((function(i){if(t[i]instanceof Dt){var r=new ps(n.resourceManager,t[i]);n.attachedResources.push(r),e.resources.push(r),e.structure.props[i]={index:e.resources.length-1}}})),i(e)}))}))},n.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},n.getProps=function(){var e=this,t={};return vs.forEach((function(n){return t[n]=e.resource[n]})),t},n.bind=function(){var e=this,t=this._resource;Object.keys(this.configProps).forEach((function(n){var i=e.configProps[n];if(us(i)){var r=e.resourceManager.get(i.id);r&&r instanceof ps?(t[n]=r.resource,e._attachedResources.push(r)):(t[n]=null,me.warn("PBRMaterialResource: "+e.meta.name+" can't find asset \""+n+'", which id is: '+i.id))}else t[n]=i}))},t}(_s),ys=["specularColor","glossinessFactor","specularGlossinessTexture","tilingOffset","baseColor","normalIntensity","emissiveColor","occlusionStrength","envMapIntensity","refractionRatio","refractionDepth","perturbationUOffset","perturbationVOffset","baseTexture","opacityTexture","normalTexture","emissiveTexture","occlusionTexture","refractionTexture","perturbationTexture","srgb","srgbFast","gamma","getOpacityFromRGB","isTransparent","alphaCutoff","renderFace","blendMode"],xs=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).configProps=void 0,t}vo(t,e);var n=t.prototype;return n.load=function(e,t){var n=this;return new Promise((function(i){var r=new jn(e.engine);for(var a in n.configProps=t.props,n._resource=r,n.configProps)us(n.configProps[a])||(r[a]=n.configProps[a]);n.setMeta(),i(n)}))},n.loadWithAttachedResources=function(e,t){var n=this;return new Promise((function(i,r){var a;t.resource instanceof jn?a=new Promise((function(e){n._resource=t.resource,n.setMeta(),e(n)})):t.props?a=n.load(e,t):r("Load PBRSpecularMaterial Error"),a&&a.then((function(){var e={resources:[n],structure:{index:0,props:{}}},t=n._resource;Object.keys(n._resource).forEach((function(i){if(t[i]instanceof Dt){var r=new ps(n.resourceManager,t[i]);n.attachedResources.push(r),e.resources.push(r),e.structure.props[i]={index:e.resources.length-1}}})),i(e)}))}))},n.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},n.getProps=function(){var e=this,t={};return ys.forEach((function(n){return t[n]=e.resource[n]})),t},n.bind=function(){var e=this,t=this._resource;Object.keys(this.configProps).forEach((function(n){var i=e.configProps[n];if(us(i)){var r=e.resourceManager.get(i.id);r&&r instanceof ps?(t[n]=r.resource,e._attachedResources.push(r)):(t[n]=null,me.warn("PBRSpecularMaterialResource: "+e.meta.name+" can't find asset \""+n+'", which id is: '+i.id))}else t[n]=i}))},t}(_s),ws=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).configProps=void 0,t}vo(t,e);var n=t.prototype;return n.load=function(e,t){var n=this;return new Promise((function(i){var r=new Wn(e.engine);for(var a in n.configProps=t.props,n.configProps)us(n.configProps[a])||(r[a]=n.configProps[a]);n._resource=r,n.setMeta(),i(n)}))},n.loadWithAttachedResources=function(e,t){var n=this;return new Promise((function(i,r){var a;t.resource instanceof Wn?a=new Promise((function(e){n._resource=t.resource,n.setMeta(),e(n)})):t.props?a=n.load(e,t):r("Load PBRMaterial Error"),a&&a.then((function(){var e={resources:[n],structure:{index:0,props:{}}},t=n._resource;hs(n._resource).forEach((function(i){if(t[i]instanceof Dt){var r=new ps(n.resourceManager,t[i]);n.attachedResources.push(r),e.resources.push(r),e.structure.props[i]={index:e.resources.length-1}}})),i(e)}))}))},n.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},n.getProps=function(){var e=this,t={};return hs(this.resource).forEach((function(n){return t[n]=e.resource[n]})),t},n.bind=function(){var e=this,t=this._resource;Object.keys(this.configProps).forEach((function(n){var i=e.configProps[n];if(us(i)){var r=e.resourceManager.get(i.id);r&&r instanceof ps?(t[n]=r.resource,e._attachedResources.push(r)):(t[n]=null,me.warn("PBRMaterialResource: "+e.meta.name+" can't find asset \""+n+'", which id is: '+i.id))}else t[n]=i}))},t}(_s),bs=function(e){function t(){return e.apply(this,arguments)||this}vo(t,e);var n=t.prototype;return n.load=function(e,t,n){var i,r=this;return null!==(i=t.props)&&void 0!==i&&i.compression&&zo.init(),e.load({url:t.url,type:Bi.Perfab}).then((function(e){var n=e;t.props&&(n.newMaterial=t.props.newMaterial),r._resource=n}))},n.loadWithAttachedResources=function(e,t,n){var i=this;return new Promise((function(r){i.load(e,t,n).then((function(){for(var t=i.resource.materials,n=[],a={resources:[i],structure:{index:0,props:{newMaterial:[]}}},o=0;o<t.length;o++){var s=t[o],c=null,l="";s instanceof Hn?(c=new ms(i.resourceManager),l="PBRMaterial"):s instanceof Wn?(c=new ws(i.resourceManager),l="UnlitMaterial"):s instanceof jn?(c=new xs(i.resourceManager),l="PBRSpecularMaterial"):(c=new gs(i.resourceManager),l="BlinnPhongMaterial"),i._attachedResources.push(c),n.push(c.loadWithAttachedResources(e,{type:l,name:s.name,resource:s}))}Promise.all(n).then((function(e){var t=a.structure.props.newMaterial;e.forEach((function(e){var n=e.structure,i=e.resources[n.index];for(var r in a.resources.push(i),n.index=a.resources.length-1,n.props)if(n.props.hasOwnProperty(r)){var o=n.props[r],s=e.resources[o.index];a.resources.push(s),o.index=a.resources.length-1}t.push(n)})),r(a)}))}))}))},n.setMeta=function(e){e&&(this.meta.name=e.name)},n.bind=function(){var e=this._resource;this.bindMaterials(e.newMaterial)},n.update=function(e,t){"newMaterial"===e?this.bindMaterials(t):this._resource[e]=t},n.bindMaterials=function(e){var t=e.length;if(e&&e.length){var n=this._resource,i=new Array(t);n.newMaterial=i;for(var r=0;r<e.length;r++){var a=this.resourceManager.get(e[r].id);a?(this._attachedResources.push(a),i[r]=a.resource):me.warn("GLTFResource: "+this.meta.name+' can\'t find asset "material", which id is: '+e[r].id)}for(var o=n.defaultSceneRoot,s=n.materials,c=o.getComponentsIncludeChildren(ua,[]),l=0;l<t;l++)for(var u=i[l],h=s[l],d=0;d<c.length;d++)for(var f=c[d],_=f.getMaterials(),p=0;p<_.length;p++)h===_[p]&&f.setMaterial(p,u)}},t}(_s),As={},Ts=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).isInit=!1,t}vo(t,e);var n=t.prototype;return n.initScriptContext=function(){this.isInit||(this.isInit=!0,window.__o3_script_context__={o3:cs._components.o3,script:function(e){return function(t){As[e]=t}}})},n.load=function(e,t,n){var i=this;return this.initScriptContext(),new Promise((function(e){var r=t.props.scripts;if(i.resourceManager.isLocal){for(var a=0;a<r.length;a++){var o,s=r[a].name;As[s]=null===(o=n.options)||void 0===o?void 0:o.scripts[s]}e(i)}else{var c=document.createElement("script");c.crossOrigin="anonymous",i.setMeta(t),c.onload=function(){for(var t=window.o3Scripts,n=0;n<r.length;n++){var a=r[n].name;i._resource=t&&t[a],As[a]=i._resource}e(i)},c.src=t.url,document.body.appendChild(c)}}))},n.setMeta=function(e){e&&(this._meta.name=e.name,this._meta.url=e.url,this._meta.source=e.source)},t}(_s),Ms=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).configProps=void 0,t}vo(t,e);var n=t.prototype;return n.load=function(e,t){var n=this;return new Promise((function(i){var r=new mr(e.engine);n.configProps=t.props;var a=n.configProps,o=a.pivotType,s=a.pivot;if(void 0!==s&&void 0!==o&&o!==ds.Custom)switch(o){case ds.Center:s.x=.5,s.y=.5;break;case ds.TopLeft:s.x=0,s.y=1;break;case ds.Top:s.x=.5,s.y=1;break;case ds.TopRight:s.x=1,s.y=1;break;case ds.Left:s.x=0,s.y=.5;break;case ds.Right:s.x=1,s.y=.5;break;case ds.BottomLeft:s.x=0,s.y=0;break;case ds.Bottom:s.x=.5,s.y=0;break;case ds.BottomRight:s.x=1,s.y=0}for(var c in a)us(a[c])||(r[c]=a[c]);n._resource=r,n.setMeta(),i(n)}))},n.loadWithAttachedResources=function(e,n){var i=this;return new Promise((function(r,a){var o;n.resource instanceof t?o=new Promise((function(e){i._resource=n.resource,i.setMeta(),e(i)})):n.props?o=i.load(e,n):a("Load Sprite Error"),o&&o.then((function(){var e={resources:[i],structure:{index:0,props:{}}},t=i._resource;hs(i._resource).forEach((function(n){if(t[n]instanceof Dt){var r=new ps(i.resourceManager,t[n]);i.attachedResources.push(r),e.resources.push(r),e.structure.props[n]={index:e.resources.length-1}}})),r(e)}))}))},n.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},n.getProps=function(){var e=this,t={};return hs(this.resource).forEach((function(n){return t[n]=e.resource[n]})),t},n.bind=function(){var e=this,t=this._resource;Object.keys(this.configProps).forEach((function(n){var i=e.configProps[n];if(us(i)){var r=e.resourceManager.get(i.id);r&&r instanceof ps?(t[n]=r.resource,e._attachedResources.push(r)):(t[n]=null,me.warn("SpriteResource: "+e.meta.name+" can't find asset \""+n+'", which id is: '+i.id))}else t[n]=i}))},t}(_s);(fs=ds||(ds={}))[fs.Center=0]="Center",fs[fs.TopLeft=1]="TopLeft",fs[fs.Top=2]="Top",fs[fs.TopRight=3]="TopRight",fs[fs.Left=4]="Left",fs[fs.Right=5]="Right",fs[fs.BottomLeft=6]="BottomLeft",fs[fs.Bottom=7]="Bottom",fs[fs.BottomRight=8]="BottomRight",fs[fs.Custom=9]="Custom";var Cs,Ps,Ss,Rs,Es,Ls,Fs,Os,Is,zs,Ds,Bs={px:0,nx:1,py:2,ny:3,pz:4,nz:5},Ns=function(e){function t(){return e.apply(this,arguments)||this}vo(t,e);var n=t.prototype;return n.load=function(e,t,n){var i=this;return new Promise((function(r,a){var o,s,c=[],l=Bi.TextureCube;if(i.resourceManager.useCompressedTexture&&null!=t&&null!==(o=t.props)&&void 0!==o&&null!==(s=o.compression)&&void 0!==s&&s.compressions.length)for(var u=n.engine._hardwareRenderer,h=t.props.compression.compressions,d=0;d<h.length;d++){var f=h[d];if("ktx"===f.container&&u.canIUse(le[f.type])){for(var _ in f.files)if(f.files.hasOwnProperty(_)){var p=f.files[_];c[Bs[_]]=p.url}console.warn(f.type),l=Bi.KTXCube;break}}if(l===Bi.TextureCube)for(var g in t.props.images)if(t.props.images.hasOwnProperty(g)){var v=t.props.images[g];c[Bs[g]]=v.url}e.load({urls:c,type:l}).then((function(e){i._resource=e,r(i)})).catch((function(e){a(e)}))}))},n.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},t}(_s),Us=function(e){function t(){return e.apply(this,arguments)||this}vo(t,e);var n=t.prototype;return n.load=function(e,t){var n=this;return new Promise((function(e){n._resource=t,n.setMetaData("name",n.resource.name),n.setMetaData("url",n.resource.url),e(n)}))},n.setMetaData=function(e,t){this._meta[e]=t},t}(_s),Gs=(Cs=as({after:"abilityAdded",before:"beforeAbilityAdded"}),Ps=as({before:"beforeAbilityUpdated",after:"abilityUpdated"}),Ss=as({after:"abilityDeleted",before:"beforeAbilityDeleted"}),To((Rs=function(){function e(e){this.oasis=e,this.abilityMap={}}var t=e.prototype;return t.add=function(e){var t=e.type,n=e.node,i=e.props,r=e.id,a=e.index,o=this.oasis.nodeManager.get(n),s=this.getCompConstructor(t);if(s){var c=this.mixPropsToExplicitProps(i),l=o.addComponent(s),u=c.enabled;if(void 0!==u&&(l.enabled=u),"GLTFModel"===t)l.init(c);else for(var h in c)null!==c[h]&&(l[h]=c[h]);var d=o._components;return ls(d,d.length-1,a),l.id=r,this.abilityMap[r]=l,l}me.error(t+" abiltiy is not defined")},t.update=function(e,t,n){return"Model"===this.get(e).constructor.name?n&&this.checkIsAsset(n)?this.get(e).setProp(t,this.oasis.resourceManager.get(n.id).resource):this.get(e).setProp(t,n):n&&this.checkIsAsset(n)?this.get(e)[t]=this.oasis.resourceManager.get(n.id).resource:this.get(e)[t]=n,{id:e,key:t,value:n}},t.get=function(e){return this.abilityMap[e]},t.delete=function(e){return this.abilityMap[e].destroy(),delete this.abilityMap[e],e},t.getCompConstructor=function(e){var t=e.split(".");if("script"===t[0])return As[t[1]];var n=cs._components.o3[e];if(!n)throw new Error(e+" is not defined");return n},t.mixPropsToExplicitProps=function(e){var t=go({},e);for(var n in e){var i=e[n];if(i&&this.checkIsAsset(i)){var r=this.oasis.resourceManager.get(i.id);r?t[n]=r.resource:(t[n]=null,me.warn("AbilityManager: can't get asset \""+n+'", which id is '+i.id))}}return t},t.checkIsAsset=function(e){return"asset"===e.type},e}()).prototype,"add",[Cs],Object.getOwnPropertyDescriptor(Rs.prototype,"add"),Rs.prototype),To(Rs.prototype,"update",[Ps],Object.getOwnPropertyDescriptor(Rs.prototype,"update"),Rs.prototype),To(Rs.prototype,"delete",[Ss],Object.getOwnPropertyDescriptor(Rs.prototype,"delete"),Rs.prototype),Rs),ks=(Es=as({after:"nodeAdded"}),Ls=as({before:"beforeNodeUpdated",after:"nodeUpdated"}),Fs=as({before:"beforeNodeDeleted"}),To((Os=function(){function e(e){this.oasis=e,this.nodeMap={},this.root=void 0,this.root=new $e(this.oasis.engine,"root")}var t=e.prototype;return t.addRootEntity=function(){this.oasis.engine.sceneManager.activeScene.addRootEntity(this.root)},t.add=function(e){return this.create(e),this.append(e.id,e.parent,e.index),this.get(e.id)},t.update=function(e,t,n){return this.get(e)[t]=n,{id:e,key:t,value:n}},t.get=function(e){return this.nodeMap[e]},t.reset=function(){this.nodeMap={}},t.delete=function(e){this.nodeMap[e].destroy(),delete this.nodeMap[e]},t.create=function(e){var t=e.isActive,n=e.position,i=e.rotation,r=e.scale,a=e.id,o=e.name,c=new $e(this.oasis.engine,o);return c.isActive=t,c.transform.position=new s(n[0],n[1],n[2]),c.transform.rotation=new s(i[0],i[1],i[2]),c.transform.scale=new s(r[0],r[1],r[2]),c.id=a,this.nodeMap[a]=c,c},t.append=function(e,t,n){var i=this.nodeMap[e],r=this.nodeMap[t]||this.root;r.addChild(i);var a=r._children;ls(a,a.length-1,n)},e}()).prototype,"add",[Es],Object.getOwnPropertyDescriptor(Os.prototype,"add"),Os.prototype),To(Os.prototype,"update",[Ls],Object.getOwnPropertyDescriptor(Os.prototype,"update"),Os.prototype),To(Os.prototype,"delete",[Fs],Object.getOwnPropertyDescriptor(Os.prototype,"delete"),Os.prototype),Os),Vs={script:Ts,gltf:bs,texture:ps,cubeTexture:Ns,PBRMaterial:ms,PBRSpecularMaterial:xs,UnlitMaterial:ws,BlinnPhongMaterial:gs,base:Us,sprite:Ms},Hs=new Map;for(var js in Vs)if(Vs.hasOwnProperty(js)){var Ws=Vs[js];Hs.set(Ws,js)}var Xs,Ks,qs=function(e,t){return new Vs[t](e)},Ys=(Is=as({before:"beforeResourceRemove"}),zs=as({after:"resourceUpdated",before:"beforeResourceUpdate"}),To((Ds=function(){function e(e){this.oasis=e,this.resourceMap={},this.resourceIdMap=new WeakMap,this.maxId=0,this.engineResourceManager=void 0,this.engineResourceManager=this.oasis.engine.resourceManager}var t=e.prototype;return t.load=function(e){var t=this,n=qs(this,e.type),i=n.load(this.oasis.engine.resourceManager,e,this.oasis);return this.maxId=Math.max(+e.id,this.maxId),i.then((function(){t.resourceMap[e.id]=n,t.resourceIdMap.set(n,e.id)})),i},t.add=function(e){var t=this,n=qs(this,e.type);return new Promise((function(i){n.loadWithAttachedResources(t.oasis.engine.resourceManager,e,t.oasis).then((function(e){i(t.getAddResourceResult(e.resources,e.structure))}))}))},t.remove=function(e){var t=this;return new Promise((function(n){var i=t.resourceMap[e],r=[e],a=!1;if(delete t.resourceMap[e],i)for(var o=i.attachedResources,s=0;s<o.length;s++){var c=o[s],l=t.resourceIdMap.get(c);l&&(a=!0,t.remove(l).then((function(e){r.push.apply(r,e),n(r)})))}a||n(r)}))},t.update=function(e,t,n){var i=this.get(e);return i&&i.update(t,n),{resource:i,id:e,key:t,value:n}},t.updateMeta=function(e,t,n){var i=this.get(e);i&&i.updateMeta(t,n)},t.get=function(e){return this.resourceMap[e]},t.getAll=function(){return k(this.resourceMap)},t.getAddResourceResult=function(e,t){var n=this,i={},r=e[t.index],a=""+ ++this.maxId;for(var o in this.resourceMap[a]=r,this.resourceIdMap.set(r,a),i.id=this.maxId,i.type=Hs.get(r.constructor),i.meta=r.meta,i.props={},t.props)if(t.props.hasOwnProperty(o)){var s=t.props[o];s&&(Array.isArray(s)?i.props[o]=s.map((function(t){return n.getAddResourceResult(e,t)})):i.props[o]=this.getAddResourceResult(e,s))}return i},ho(e,[{key:"isLocal",get:function(){return this.oasis.options.local}},{key:"useCompressedTexture",get:function(){var e;return null==(e=this.oasis.options.useCompressedTexture)||e}}]),e}()).prototype,"remove",[Is],Object.getOwnPropertyDescriptor(Ds.prototype,"remove"),Ds.prototype),To(Ds.prototype,"update",[zs],Object.getOwnPropertyDescriptor(Ds.prototype,"update"),Ds.prototype),Ds),Qs=(Xs=as({after:"schemaParsed"}),To((Ks=function(e){function t(t,n){var i,r;return(r=e.call(this,t.engine)||this)._options=t,r.pluginManager=n,r.engine=null,r.nodeManager=void 0,r.abilityManager=void 0,r.resourceManager=void 0,r._canvas=void 0,r.schema=void 0,r.timeout=void 0,r.oasis=wo(r),r.engine=t.engine,r.schema=t.config,r.timeout=t.timeout,t.scripts=null!=(i=t.scripts)?i:{},r.nodeManager=new ks(wo(r)),r.abilityManager=new Gs(wo(r)),r.nodeManager.add=r.nodeManager.add.bind(r.nodeManager),r.abilityManager.add=r.abilityManager.add.bind(r.abilityManager),r.resourceManager=new Ys(wo(r)),t.fps&&(r.engine.targetFrameRate=t.fps,r.engine.vSyncCount=0),r}vo(t,e);var n=t.prototype;return n.updateConfig=function(e){this.schema=e,this.init()},n.init=function(){var e=this;return this.loadResources().then((function(){e.bindResources(),e.parseEntities(),e.attach(),e.nodeManager.addRootEntity(),e.parseNodeAbilities(),e.pluginManager.boot(e)}))},n.loadResources=function(){var e=this,t=this.schema.assets,n=k(void 0===t?{}:t).filter((function(e){return!!Vs[e.type]||(console.warn(e.type+" loader is not defined. the "+e.type+" type will be ignored."),!1)})).map((function(t){return e.resourceManager.load(t)}));return Promise.all(n)},n.bindResources=function(){this.resourceManager.getAll().forEach((function(e){e.bind()}))},n.parseEntities=function(){var e=this.schema.nodes;this.bfsNodes().map((function(t){return e[t]})).forEach(this.nodeManager.add)},n.parseNodeAbilities=function(){var e=this.schema.abilities;Object.keys(e).map((function(t){return go({id:t},e[t])})).forEach(this.abilityManager.add)},n.bfsNodes=function(){var e=this.schema.nodes,t=k(e).filter((function(t){return!e[t.parent]})).map((function(e){return e.id})),n=[];return function t(i){n=n.concat(i),i.forEach((function(n){var i=e[n].children;i&&t(i)}))}(t),n},n.attach=function(){this.resourceManager.getAll().forEach((function(e){e.attach()}))},t.create=function(e,n){var i=new t(e,n);return i.init().then((function(){return e.autoPlay&&i.engine.run(),i}))},ho(t,[{key:"canvas",get:function(){return this._options.canvas}},{key:"options",get:function(){return this._options}}]),t}(de)).prototype,"init",[Xs],Object.getOwnPropertyDescriptor(Ks.prototype,"init"),Ks.prototype),Ks);cs.registerComponents("o3",{GLTFModel:ns,SpriteRenderer:Gr,PointLight:Ft,AmbientLight:Rt,DirectLight:Et,EnvironmentMapLight:Lt,ParticleRenderer:Ta,SkyBox:Aa,BoxCollider:Ma,Camera:Fi,Model:is,Component:Qe,SphereCollider:Ca});function Zs(e,t){return(Zs=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Js(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}console.log("oasis engine version: 0.3.3");var $s=o.zeroTolerance,ec=function(){function e(e,t,n){this.radius=void 0,this.phi=void 0,this.theta=void 0,this.radius=void 0!==e?e:1,this.phi=void 0!==t?t:0,this.theta=void 0!==n?n:0}var t=e.prototype;return t.set=function(e,t,n){return this.radius=e,this.phi=t,this.theta=n,this},t.makeSafe=function(){return this.phi=o.clamp(this.phi,$s,Math.PI-$s),this},t.setFromVec3=function(e){return this.radius=e.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e.x,e.z),this.phi=Math.acos(o.clamp(e.y/this.radius,-1,1))),this},t.setToVec3=function(e){var t=Math.sin(this.phi)*this.radius;return e.x=t*Math.sin(this.theta),e.y=Math.cos(this.phi)*this.radius,e.z=t*Math.cos(this.theta),this},e}(),tc=function(e){var t,n;function i(t){var n;return(n=e.call(this,t)||this).camera=void 0,n.domElement=void 0,n.mainElement=void 0,n.fov=void 0,n.target=void 0,n.up=void 0,n.minDistance=void 0,n.maxDistance=void 0,n.minZoom=void 0,n.maxZoom=void 0,n.enableDamping=void 0,n.zoomFactor=void 0,n.enableRotate=void 0,n.keyPanSpeed=void 0,n.minPolarAngle=void 0,n.maxPolarAngle=void 0,n.minAzimuthAngle=void 0,n.maxAzimuthAngle=void 0,n.enableZoom=void 0,n.dampingFactor=void 0,n.zoomSpeed=void 0,n.enablePan=void 0,n.autoRotate=void 0,n.autoRotateSpeed=Math.PI,n.rotateSpeed=void 0,n.enableKeys=void 0,n.keys=void 0,n.mouseButtons=void 0,n.touchFingers=void 0,n.STATE=void 0,n.mouseUpEvents=void 0,n.constEvents=void 0,n._position=void 0,n._offset=void 0,n._spherical=void 0,n._sphericalDelta=void 0,n._sphericalDump=void 0,n._zoomFrag=void 0,n._scale=void 0,n._panOffset=void 0,n._isMouseUp=void 0,n._vPan=void 0,n._state=void 0,n._rotateStart=void 0,n._rotateEnd=void 0,n._rotateDelta=void 0,n._panStart=void 0,n._panEnd=void 0,n._panDelta=void 0,n._zoomStart=void 0,n._zoomEnd=void 0,n._zoomDelta=void 0,n.camera=t,n.mainElement=n.engine.canvas._webCanvas,n.domElement=document,n.fov=45,n.target=new s,n.up=new s(0,1,0),n.minDistance=.1,n.maxDistance=1/0,n.minZoom=0,n.maxZoom=1/0,n.minPolarAngle=0,n.maxPolarAngle=Math.PI,n.minAzimuthAngle=-1/0,n.maxAzimuthAngle=1/0,n.enableDamping=!0,n.dampingFactor=.1,n.zoomFactor=.2,n.enableZoom=!0,n.zoomSpeed=1,n.enableRotate=!0,n.rotateSpeed=1,n.enablePan=!0,n.keyPanSpeed=7,n.autoRotate=!1,n.enableKeys=!1,n.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},n.mouseButtons={ORBIT:0,ZOOM:1,PAN:2},n.touchFingers={ORBIT:1,ZOOM:2,PAN:3},n._position=new s,n._offset=new s,n._spherical=new ec,n._sphericalDelta=new ec,n._sphericalDump=new ec,n._zoomFrag=0,n._scale=1,n._panOffset=new s,n._isMouseUp=!0,n._vPan=new s,n._rotateStart=new v,n._rotateEnd=new v,n._rotateDelta=new v,n._panStart=new v,n._panEnd=new v,n._panDelta=new v,n._zoomStart=new v,n._zoomEnd=new v,n._zoomDelta=new v,n.STATE={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM:4,TOUCH_PAN:5},n._state=n.STATE.NONE,n.constEvents=[{type:"mousedown",listener:n.onMouseDown.bind(Js(n))},{type:"wheel",listener:n.onMouseWheel.bind(Js(n))},{type:"keydown",listener:n.onKeyDown.bind(Js(n)),element:window},{type:"touchstart",listener:n.onTouchStart.bind(Js(n))},{type:"touchmove",listener:n.onTouchMove.bind(Js(n))},{type:"touchend",listener:n.onTouchEnd.bind(Js(n))},{type:"contextmenu",listener:n.onContextMenu.bind(Js(n))}],n.mouseUpEvents=[{type:"mousemove",listener:n.onMouseMove.bind(Js(n))},{type:"mouseup",listener:n.onMouseUp.bind(Js(n))}],n.constEvents.forEach((function(e){e.element?e.element.addEventListener(e.type,e.listener,!1):n.mainElement.addEventListener(e.type,e.listener,!1)})),n}n=e,(t=i).prototype=Object.create(n.prototype),t.prototype.constructor=t,Zs(t,n);var r=i.prototype;return r.onDisable=function(){var e=this.domElement===document?this.domElement.body:this.domElement;this.mainElement.removeEventListener(this.mouseUpEvents[0].type,this.mouseUpEvents[0].listener,!1),e.removeEventListener(this.mouseUpEvents[1].type,this.mouseUpEvents[1].listener,!1)},r.onDestroy=function(){var e=this;this.constEvents.forEach((function(t){t.element?t.element.removeEventListener(t.type,t.listener,!1):e.mainElement.removeEventListener(t.type,t.listener,!1)}));var t=this.domElement===document?this.domElement.body:this.domElement;this.mainElement.removeEventListener(this.mouseUpEvents[0].type,this.mouseUpEvents[0].listener,!1),t.removeEventListener(this.mouseUpEvents[1].type,this.mouseUpEvents[1].listener,!1)},r.onUpdate=function(e){this.enabled&&(this.camera.transform.position.cloneTo(this._offset),this._offset.subtract(this.target),this._spherical.setFromVec3(this._offset),this.autoRotate&&this._state===this.STATE.NONE&&this.rotateLeft(this.getAutoRotationAngle(e)),this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi,this._spherical.theta=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),1!==this._scale&&(this._zoomFrag=this._spherical.radius*(this._scale-1)),this._spherical.radius+=this._zoomFrag,this._spherical.radius=Math.max(this.minDistance,Math.min(this.maxDistance,this._spherical.radius)),this.target.add(this._panOffset),this._spherical.setToVec3(this._offset),this.target.cloneTo(this._position),this._position.add(this._offset),this.camera.transform.position=this._position,this.camera.transform.lookAt(this.target,this.up),!0===this.enableDamping?(this._sphericalDump.theta*=1-this.dampingFactor,this._sphericalDump.phi*=1-this.dampingFactor,this._zoomFrag*=1-this.zoomFactor,this._isMouseUp?(this._sphericalDelta.theta=this._sphericalDump.theta,this._sphericalDelta.phi=this._sphericalDump.phi):this._sphericalDelta.set(0,0,0)):(this._sphericalDelta.set(0,0,0),this._zoomFrag=0),this._scale=1,this._panOffset.setValue(0,0,0))},r.getAutoRotationAngle=function(e){return this.autoRotateSpeed/1e3*e},r.getZoomScale=function(){return Math.pow(.95,this.zoomSpeed)},r.rotateLeft=function(e){this._sphericalDelta.theta-=e,this.enableDamping&&(this._sphericalDump.theta=-e)},r.rotateUp=function(e){this._sphericalDelta.phi-=e,this.enableDamping&&(this._sphericalDump.phi=-e)},r.panLeft=function(e,t){var n=t.elements;this._vPan.setValue(n[0],n[1],n[2]),this._vPan.scale(e),this._panOffset.add(this._vPan)},r.panUp=function(e,t){var n=t.elements;this._vPan.setValue(n[4],n[5],n[6]),this._vPan.scale(e),this._panOffset.add(this._vPan)},r.pan=function(e,t){var n=this.domElement===document?this.domElement.body:this.domElement;this.camera.position.cloneTo(this._vPan),this._vPan.subtract(this.target);var i=this._vPan.length();i*=this.fov/2*(Math.PI/180),this.panLeft(-2*e*(i/n.clientHeight),this.camera.transform.worldMatrix),this.panUp(2*t*(i/n.clientHeight),this.camera.transform.worldMatrix)},r.zoomIn=function(e){this._scale*=e},r.zoomOut=function(e){this._scale/=e},r.handleMouseDownRotate=function(e){this._rotateStart.setValue(e.clientX,e.clientY)},r.handleMouseDownZoom=function(e){this._zoomStart.setValue(e.clientX,e.clientY)},r.handleMouseDownPan=function(e){this._panStart.setValue(e.clientX,e.clientY)},r.handleMouseMoveRotate=function(e){this._rotateEnd.setValue(e.clientX,e.clientY),v.subtract(this._rotateEnd,this._rotateStart,this._rotateDelta);var t=this.domElement===document?document.body:this.domElement;this.rotateLeft(2*Math.PI*(this._rotateDelta.x/t.clientWidth)*this.rotateSpeed),this.rotateUp(2*Math.PI*(this._rotateDelta.y/t.clientHeight)*this.rotateSpeed),this._rotateEnd.cloneTo(this._rotateStart)},r.handleMouseMoveZoom=function(e){this._zoomEnd.setValue(e.clientX,e.clientY),v.subtract(this._zoomEnd,this._zoomStart,this._zoomDelta),this._zoomDelta.y>0?this.zoomOut(this.getZoomScale()):this._zoomDelta.y<0&&this.zoomIn(this.getZoomScale()),this._zoomEnd.cloneTo(this._zoomStart)},r.handleMouseMovePan=function(e){this._panEnd.setValue(e.clientX,e.clientY),v.subtract(this._panEnd,this._panStart,this._panDelta),this.pan(this._panDelta.x,this._panDelta.y),this._panEnd.cloneTo(this._panStart)},r.handleMouseWheel=function(e){e.deltaY<0?this.zoomIn(this.getZoomScale()):e.deltaY>0&&this.zoomOut(this.getZoomScale())},r.handleKeyDown=function(e){switch(e.keyCode){case this.keys.UP:this.pan(0,this.keyPanSpeed);break;case this.keys.BOTTOM:this.pan(0,-this.keyPanSpeed);break;case this.keys.LEFT:this.pan(this.keyPanSpeed,0);break;case this.keys.RIGHT:this.pan(-this.keyPanSpeed,0)}},r.handleTouchStartRotate=function(e){this._rotateStart.setValue(e.touches[0].pageX,e.touches[0].pageY)},r.handleTouchStartZoom=function(e){var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,i=Math.sqrt(t*t+n*n);this._zoomStart.setValue(0,i)},r.handleTouchStartPan=function(e){this._panStart.setValue(e.touches[0].pageX,e.touches[0].pageY)},r.handleTouchMoveRotate=function(e){this._rotateEnd.setValue(e.touches[0].pageX,e.touches[0].pageY),v.subtract(this._rotateEnd,this._rotateStart,this._rotateDelta);var t=this.domElement===document?this.domElement.body:this.domElement;this.rotateLeft(2*Math.PI*this._rotateDelta.x/t.clientWidth*this.rotateSpeed),this.rotateUp(2*Math.PI*this._rotateDelta.y/t.clientHeight*this.rotateSpeed),this._rotateEnd.cloneTo(this._rotateStart)},r.handleTouchMoveZoom=function(e){var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,i=Math.sqrt(t*t+n*n);this._zoomEnd.setValue(0,i),v.subtract(this._zoomEnd,this._zoomStart,this._zoomDelta),this._zoomDelta.y>0?this.zoomIn(this.getZoomScale()):this._zoomDelta.y<0&&this.zoomOut(this.getZoomScale()),this._zoomEnd.cloneTo(this._zoomStart)},r.handleTouchMovePan=function(e){this._panEnd.setValue(e.touches[0].pageX,e.touches[0].pageY),v.subtract(this._panEnd,this._panStart,this._panDelta),this.pan(this._panDelta.x,this._panDelta.y),this._panEnd.cloneTo(this._panStart)},r.onMouseDown=function(e){if(!1!==this.enabled){switch(e.preventDefault(),this._isMouseUp=!1,e.button){case this.mouseButtons.ORBIT:if(!1===this.enableRotate)return;this.handleMouseDownRotate(e),this._state=this.STATE.ROTATE;break;case this.mouseButtons.ZOOM:if(!1===this.enableZoom)return;this.handleMouseDownZoom(e),this._state=this.STATE.ZOOM;break;case this.mouseButtons.PAN:if(!1===this.enablePan)return;this.handleMouseDownPan(e),this._state=this.STATE.PAN}if(this._state!==this.STATE.NONE){var t=this.domElement===document?this.domElement.body:this.domElement;this.mainElement.addEventListener(this.mouseUpEvents[0].type,this.mouseUpEvents[0].listener,!1),t.addEventListener(this.mouseUpEvents[1].type,this.mouseUpEvents[1].listener,!1)}}},r.onMouseMove=function(e){if(!1!==this.enabled)switch(e.preventDefault(),this._state){case this.STATE.ROTATE:if(!1===this.enableRotate)return;this.handleMouseMoveRotate(e);break;case this.STATE.ZOOM:if(!1===this.enableZoom)return;this.handleMouseMoveZoom(e);break;case this.STATE.PAN:if(!1===this.enablePan)return;this.handleMouseMovePan(e)}},r.onMouseUp=function(){var e=this;!1!==this.enabled&&(this._isMouseUp=!0,this.mouseUpEvents.forEach((function(t){(e.domElement===document?e.domElement.body:e.domElement).removeEventListener(t.type,t.listener,!1),e.mainElement.removeEventListener(t.type,t.listener,!1)})),this._state=this.STATE.NONE)},r.onMouseWheel=function(e){!1===this.enabled||!1===this.enableZoom||this._state!==this.STATE.NONE&&this._state!==this.STATE.ROTATE||(e.preventDefault(),e.stopPropagation(),this.handleMouseWheel(e))},r.onKeyDown=function(e){!1!==this.enabled&&!1!==this.enableKeys&&!1!==this.enablePan&&this.handleKeyDown(e)},r.onTouchStart=function(e){if(!1!==this.enabled)switch(this._isMouseUp=!1,e.touches.length){case this.touchFingers.ORBIT:if(!1===this.enableRotate)return;this.handleTouchStartRotate(e),this._state=this.STATE.TOUCH_ROTATE;break;case this.touchFingers.ZOOM:if(!1===this.enableZoom)return;this.handleTouchStartZoom(e),this._state=this.STATE.TOUCH_ZOOM;break;case this.touchFingers.PAN:if(!1===this.enablePan)return;this.handleTouchStartPan(e),this._state=this.STATE.TOUCH_PAN;break;default:this._state=this.STATE.NONE}},r.onTouchMove=function(e){if(!1!==this.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case this.touchFingers.ORBIT:if(!1===this.enableRotate)return;if(this._state!==this.STATE.TOUCH_ROTATE)return;this.handleTouchMoveRotate(e);break;case this.touchFingers.ZOOM:if(!1===this.enableZoom)return;if(this._state!==this.STATE.TOUCH_ZOOM)return;this.handleTouchMoveZoom(e);break;case this.touchFingers.PAN:if(!1===this.enablePan)return;if(this._state!==this.STATE.TOUCH_PAN)return;this.handleTouchMovePan(e);break;default:this._state=this.STATE.NONE}},r.onTouchEnd=function(){!1!==this.enabled&&(this._isMouseUp=!0,this._state=this.STATE.NONE)},r.onContextMenu=function(e){!1!==this.enabled&&e.preventDefault()},i}(Ln);function nc(e,t){return(nc=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ic(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];me.info.apply(me,["🚀 [o3-engine-stats]"].concat(t))}var rc=function(){function e(e){this.drawCall=0,this.triangles=0,this.lines=0,this.points=0,this.hooked=void 0,this.realDrawElements=void 0,this.realDrawArrays=void 0,this.gl=void 0,this.realDrawElements=e.drawElements,this.realDrawArrays=e.drawArrays,e.drawElements=this.hookedDrawElements.bind(this),e.drawArrays=this.hookedDrawArrays.bind(this),this.hooked=!0,this.gl=e,ic("DrawCall is hooked.")}var t=e.prototype;return t.hookedDrawElements=function(e,t,n,i){this.realDrawElements.call(this.gl,e,t,n,i),this.update(t,e)},t.hookedDrawArrays=function(e,t,n){this.realDrawArrays.call(this.gl,e,t,n),this.update(n,e)},t.update=function(e,t){var n=this.gl;switch(this.drawCall++,t){case n.TRIANGLES:this.triangles+=e/3;break;case n.TRIANGLE_STRIP:case n.TRIANGLE_FAN:this.triangles+=e-2;break;case n.LINES:this.lines+=e/2;break;case n.LINE_STRIP:this.lines+=e-1;break;case n.LINE_LOOP:this.lines+=e;break;case n.POINTS:this.points+=e;break;default:!function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];me.error.apply(me,["🚀 [o3-engine-stats]"].concat(t))}("Unknown draw mode: "+t)}},t.reset=function(){this.drawCall=0,this.triangles=0,this.lines=0,this.points=0},t.release=function(){this.hooked&&(this.gl.drawElements=this.realDrawElements,this.gl.drawArrays=this.realDrawArrays),this.hooked=!1},e}(),ac=function(){function e(e){this.shaders=0,this.realAttachShader=void 0,this.realDetachShader=void 0,this.hooked=void 0,this.gl=void 0,this.realAttachShader=e.attachShader,this.realDetachShader=e.detachShader,e.attachShader=this.hookedAttachShader.bind(this),e.detachShader=this.hookedDetachShader.bind(this),this.hooked=!0,this.gl=e,ic("Shader is hooked.")}var t=e.prototype;return t.hookedAttachShader=function(e,t){this.realAttachShader.call(this.gl,e,t),this.shaders++,ic("AttachShader:",t,"shaders: "+this.shaders)},t.hookedDetachShader=function(e,t){this.realDetachShader.call(this.gl,e,t),this.shaders--,ic("DetachShader. shaders: "+this.shaders)},t.reset=function(){this.shaders=0},t.release=function(){this.hooked&&(this.gl.attachShader=this.realAttachShader,this.gl.detachShader=this.realDetachShader),this.hooked=!1},e}(),oc=function(){function e(e){this.textures=0,this.realCreateTexture=void 0,this.realDeleteTexture=void 0,this.hooked=void 0,this.gl=void 0,this.realCreateTexture=e.createTexture,this.realDeleteTexture=e.deleteTexture,e.createTexture=this.hookedCreateTexture.bind(this),e.deleteTexture=this.hookedDeleteTexture.bind(this),this.hooked=!0,this.gl=e,ic("Texture is hooked.")}var t=e.prototype;return t.hookedCreateTexture=function(){var e=this.realCreateTexture.call(this.gl);return this.textures++,ic("CreateTexture:",e,"textures: "+this.textures),e},t.hookedDeleteTexture=function(e){this.realDeleteTexture.call(this.gl,e),this.textures--,ic("DeleteTexture. textures: "+this.textures)},t.reset=function(){this.textures=0},t.release=function(){this.hooked&&(this.gl.createTexture=this.realCreateTexture,this.gl.deleteTexture=this.realDeleteTexture),this.hooked=!1},e}(),sc=function(){function e(e){this.gl=void 0,this.drawCallHook=void 0,this.textureHook=void 0,this.shaderHook=void 0,this.samplingFrames=60,this.samplingIndex=0,this.updateCounter=0,this.updateTime=0,this.gl=e,this.hook(e)}var t=e.prototype;return t.hook=function(e){this.drawCallHook=new rc(e),this.textureHook=new oc(e),this.shaderHook=new ac(e)},t.reset=function(){this.drawCallHook&&this.drawCallHook.reset()},t.release=function(){this.drawCallHook&&this.drawCallHook.release(),this.textureHook&&this.textureHook.release(),this.shaderHook&&this.shaderHook.release()},t.update=function(){this.updateCounter++;var e=performance.now();if(!(e-this.updateTime<1e3)){if(this.samplingIndex!==this.samplingFrames)return this.reset(),void this.samplingIndex++;this.samplingIndex=0;var t={fps:Math.round(1e3*this.updateCounter/(e-this.updateTime)),memory:performance.memory&&performance.memory.usedJSHeapSize/1048576>>0,drawCall:this.drawCallHook.drawCall,triangles:this.drawCallHook.triangles,lines:this.drawCallHook.lines,points:this.drawCallHook.points,textures:this.textureHook.textures,shaders:this.shaderHook.shaders,webglContext:window.hasOwnProperty("WebGL2RenderingContext")&&this.gl instanceof WebGL2RenderingContext?"2.0":"1.0"};return this.reset(),this.updateCounter=0,this.updateTime=e,t}},e}(),cc=function(){function e(e){this.core=void 0,this.doms=void 0,this.items=void 0,this.container=void 0,this.core=new sc(e),this.items=[],this.items=["fps","memory","drawCall","triangles","textures","shaders","webglContext"],this.createContainer(),this.update=this.update.bind(this)}var t=e.prototype;return t.createContainer=function(){var e=document.createElement("div");e.classList.add("gl-perf"),e.innerHTML='\n  <dl>\n    <dt>FPS</dt>\n    <dd>0</dd>\n    <dt>Memory <span class="unit">(MB)</span></dt>\n    <dd>0</dd>\n    <dt>DrawCall</dt>\n    <dd>0</dd>\n    <dt>Triangles</dt>\n    <dd>0</dd>\n    <dt>Textures</dt>\n    <dd>0</dd>\n    <dt>Shaders</dt>\n    <dd>0</dd>\n    <dt>WebGL</dt>\n    <dd></dd>\n  </dl>\n',e.appendChild(this.createStyle()),document.body.appendChild(e),this.doms=Array.prototype.slice.apply(e.querySelectorAll("dd")),this.container=e},t.createStyle=function(){var e=document.createElement("style");return e.type="text/css",e.appendChild(document.createTextNode("\n  .gl-perf {\n    pointer-events: none;\n    user-select: none;\n    position: fixed;\n    top: 0;\n    left: 0;\n    padding: 1.3333333333333333vh 1.3333333333333333vh 0 1.3333333333333333vh;\n    background: rgba(0, 0, 0, 0.3);\n    color: #fff;\n    font: 1.3333333333333333vh arial;\n  }\n\n  .gl-perf dl,\n  .gl-perf dt,\n  .gl-perf dd {\n    padding: 0;\n    margin: 0;\n  }\n\n  .gl-perf dt {\n    color: #fff;\n    text-shadow: #000 0 0 1px;\n  }\n\n  .gl-perf dt .unit{\n    font-size: 1.3333333333333333vh;\n  }\n\n  .gl-perf dd {\n    font-size: 2.6666666666666665vh;\n    padding: 1.3333333333333333vh 0 1.3333333333333333vh;\n  }\n")),e},t.update=function(){var e=this,t=this.core.update();if(t)for(var n=function(n,i){var r=e.doms[n],a=e.items[n],o=t[a]||0;requestAnimationFrame((function(){r.innerText=o}))},i=0,r=this.items.length;i<r;i++)n(i)},t.reset=function(){this.core.reset()},t.release=function(){this.core.release()},t.destroy=function(){this.release(),document.body.removeChild(this.container)},e}(),lc=function(e){var t,n;function i(){var t;return(t=e.call(this)||this).monitor=void 0,t}n=e,(t=i).prototype=Object.create(n.prototype),t.prototype.constructor=t,nc(t,n);var r=i.prototype;return r.preTick=function(e,t){if(!this.monitor){var n=t.engine._hardwareRenderer.gl;n&&(this.monitor=new cc(n))}},r.postTick=function(e,t){this.monitor&&this.monitor.update()},i}(En);Sn.registerFeature(lc);var uc={sky:["https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*Gi7CTZqKuacAAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*iRRMQIExwKMAAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*ZIcPQZo20sAAAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*SPYuTbHT-KgAAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*mGUERbY77roAAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*ilkPS7A1_JsAAAAAAAAAAABkARQnAQ"],house:["https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*1gjTQ7P2mQoAAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*entSR7DylL0AAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*izQBQY_vs_4AAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*x3XnRpq1U-EAAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*k7FsT5Gprn0AAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*8LdBQ6ixiQAAAAAAAAAAAABkARQnAQ"],sunnyDay:["https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*4ZY8T4GpKwYAAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*8QbJQZwS1wUAAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*a54kSZ3LmAQAAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*8CbfTb1yG8MAAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*Yi4ZRZbdj8MAAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*KddxSriLYjoAAAAAAAAAAABkARQnAQ"],miniSampler:["https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*IuyGR4bdwg4AAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*4rv5RZ0kll4AAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*cHitTpWoJjoAAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*RCEbS6k5x18AAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*IRc7R7cl4CcAAAAAAAAAAABkARQnAQ","https://gw.alipayobjects.com/mdn/rms_475770/afts/img/A*y_4hRYVgzQ4AAAAAAAAAAABkARQnAQ"]};me.enable();class hc{constructor(){this.meshes=[],this.materials=[],this.cubeTextures={},this.textures={},this.engine=new lo("o3-canvas"),this.scene=this.engine.sceneManager.activeScene,this.rootEntity=this.scene.createRootEntity("root"),this.cameraEntity=this.rootEntity.createChild("camera"),this.gltfRootEntity=this.rootEntity.createChild("gltf"),this.pointLightEntity1=this.rootEntity.createChild("point_light1"),this.pointLightEntity2=this.rootEntity.createChild("point_light2"),this.camera=this.cameraEntity.addComponent(Fi),this.controler=this.cameraEntity.addComponent(tc),this.envLight=this.rootEntity.addComponent(Lt),this.pointLight1=this.pointLightEntity1.addComponent(Ft),this.pointLight2=this.pointLightEntity2.addComponent(Ft),this.skybox=this.rootEntity.addComponent(Aa),this.gui=new e,this.materialFolder=null,this.animationFolder=null,this.state={background:!1,wireframe:!1,autoRotate:!1,envTexture:"miniSampler",envIntensity:1,addLights:!0,lightColor:hc.colorToGui(new w(1,1,1)),lightIntensity:.8},this._boundingBox=new l,this._center=new s,this._extent=new s,this.$spinner=document.getElementById("spinner"),this.$dropZone=document.getElementById("dropZone"),this.$input=document.getElementById("input"),this.$close=document.getElementById("close"),this.initResources().then((()=>{this.initScene(),this.initDropZone(),this.addSceneGUI(),this.initDefaultDebugMesh()}))}static guiToColor(e,t){t.setValue(e[0]/255,e[1]/255,e[2]/255,t.a)}static colorToGui(e){const t=[];return t[0]=255*e.r,t[1]=255*e.g,t[2]=255*e.b,t}initResources(){const e=Object.keys(uc);return new Promise((t=>{this.engine.resourceManager.load(e.map((e=>({type:Bi.TextureCube,urls:uc[e]})))).then((n=>{n.forEach(((t,n)=>{const i=e[n];this.cubeTextures[i]=t,i===this.state.envTexture&&(this.envLight.specularTexture=t,this.skybox.skyBoxMap=t)})),t(!0)}))}))}initScene(){const e=Rn.devicePixelRatio;this.engine.canvas.width=window.innerWidth*e,this.engine.canvas.height=window.innerHeight*e,this.controler.autoRotateSpeed=Math.PI/5,this.controler.minDistance=0,this.state.background||(this.skybox.enabled=!1),this.state.addLights||(this.pointLight1.enabled=!1,this.pointLight2.enabled=!1),this.state.autoRotate&&(this.controler.autoRotate=!0),this.pointLight1.intensity=this.state.lightIntensity,this.pointLight2.intensity=this.state.lightIntensity,this.envLight.specularIntensity=this.state.envIntensity,this.camera.backgroundColor=new m(0,0,0,0),this.engine.run()}addSceneGUI(){const{gui:e}=this,t=e.addFolder("Scene");t.add(this.state,"background").onChange((e=>{this.skybox.enabled=e})),t.add(this.state,"wireframe").onChange((e=>{this.meshes.forEach((t=>{t.subMesh.topology=e?$n.LineStrip:$n.Triangles}))})),t.add(this.state,"autoRotate").onChange((e=>{this.controler.autoRotate=e}));const n=e.addFolder("Lighting");n.add(this.state,"envTexture",["None",...Object.keys(this.cubeTextures)]).name("IBL").onChange((e=>{this.envLight.specularTexture=this.skybox.skyBoxMap="None"===e?null:this.cubeTextures[e]})),n.add(this.state,"envIntensity",0,2).onChange((e=>{this.envLight.specularIntensity=e})).name("间接光强度"),n.add(this.state,"addLights").onChange((e=>{this.pointLight1.enabled=e,this.pointLight2.enabled=e})).name("直接光"),n.addColor(this.state,"lightColor").onChange((e=>{hc.guiToColor(e,this.pointLight1.color),hc.guiToColor(e,this.pointLight2.color)})),n.add(this.state,"lightIntensity",0,2).onChange((e=>{this.pointLight1.intensity=e,this.pointLight2.intensity=e})).name("直接光强度"),t.open(),n.open()}initDefaultDebugMesh(){const e=wa.createSphere(this.engine,5,64),t=new Hn(this.engine);t.metallicFactor=0,t.roughnessFactor=0,t.name="default";const n=this.gltfRootEntity.addComponent(ua);n.mesh=e,n.setMaterial(t),this.materials=[t],this.meshes=[e],this.loadMaterialGUI(),this.setCenter()}setCenter(){const e=this._boundingBox,t=this._center,n=this._extent;e.min.setValue(0,0,0),e.max.setValue(0,0,0),this.meshes.forEach((t=>{l.merge(t.bounds,e,e)})),e.getExtent(n);const i=n.length();e.getCenter(t),this.controler.target.setValue(t.x,t.y,t.z),this.cameraEntity.transform.setPosition(t.x,t.y,2*i),this.camera.farClipPlane=12*i,this.controler.maxDistance=10*i,this.pointLightEntity1.transform.setPosition(0,2*i,2*i),this.pointLightEntity2.transform.setPosition(0,2*-i,2*-i)}initDropZone(){new t(document.body,this.$input).on("drop",(({files:e})=>this.loadFileMaps(e))),this.$close.onclick=()=>{this.$dropZone.classList.add("hide")}}loadFileMaps(e){const t=/\.(gltf|glb)$/i,n=/\.(jpg|jpeg|png)$/i;let i,r="gltf";const a={},o=Array.from(e);if(o.some((([e,n])=>{if(t.test(n.name))return r=RegExp.$1,i=n,e.replace(n.name,""),!0})),o.forEach((([e,i])=>{if(!t.test(i.name)){const e=URL.createObjectURL(i),t=i.name;a[t]=e,n.test(t)&&this.addTexture(t,e)}})),i){this.dropStart();const e=URL.createObjectURL(i);this.loadModel(e,a,r)}}loadModel(e,t,n){this.destoryGLTF(),"gltf"===n.toLowerCase()?this.engine.resourceManager.load({type:Bi.JSON,url:e}).then((e=>{e.buffers.concat(e.images).forEach((e=>{if(!e)return;const n=e.uri;t[n]&&(e.uri=t[n])}));const n=new Blob([JSON.stringify(e)]),i=URL.createObjectURL(n);this.engine.resourceManager.load({type:Bi.Perfab,url:i+"#.gltf"}).then((e=>{this.handleGltfResource(e)})).catch((()=>{this.dropError()}))})):this.engine.resourceManager.load({type:Bi.Perfab,url:e+"#.glb"}).then((e=>{this.handleGltfResource(e)})).catch((()=>{this.dropError()}))}handleGltfResource(e){const{defaultSceneRoot:t,materials:n,meshes:i,animations:r}=e;this.dropSuccess(),this.meshes=i.map((e=>e[0])),this.materials=n,this.gltfRootEntity=t,this.rootEntity.addChild(t),this.setCenter(),this.loadMaterialGUI(),this.loadAnimationGUI(r)}addTexture(e,t){Object.keys(this.textures).find((t=>t===e))?console.warn(`${e} 已经存在，请更换图片名字重新上传`):this.engine.resourceManager.load({type:Bi.Texture2D,url:t}).then((t=>{this.textures[e]=t,this.loadMaterialGUI(),console.log("图片上传成功！",e)}))}dropStart(){this.$dropZone.classList.add("hide"),this.$spinner.classList.remove("hide")}dropError(){this.$dropZone.classList.remove("hide"),this.$spinner.classList.add("hide")}dropSuccess(){this.$dropZone.classList.add("hide"),this.$spinner.classList.add("hide")}destoryGLTF(){this.gltfRootEntity.destroy(),this.materials.length=0,this.meshes.length=0}loadMaterialGUI(){const{gui:e}=this;if(this.materialFolder&&(e.removeFolder(this.materialFolder),this.materialFolder=null),!this.materials.length)return;const t=this.materialFolder=e.addFolder("Material"),n={};this.materials.forEach((e=>{if(!(e instanceof Vn))return;e.name||(e.name="default");const i={baseColor:hc.colorToGui(e.baseColor),emissiveColor:hc.colorToGui(e.emissiveColor),specularColor:hc.colorToGui(e.specularColor||new w(1,1,1)),baseTexture:e.baseTexture?"origin":"",metallicRoughnessTexture:e.metallicRoughnessTexture?"origin":"",normalTexture:e.normalTexture?"origin":"",emissiveTexture:e.emissiveTexture?"origin":"",occlusionTexture:e.occlusionTexture?"origin":"",opacityTexture:e.opacityTexture?"origin":"",specularGlossinessTexture:e.specularGlossinessTexture?"origin":""},r={baseTexture:e.baseTexture,metallicRoughnessTexture:e.metallicRoughnessTexture,normalTexture:e.normalTexture,emissiveTexture:e.emissiveTexture,occlusionTexture:e.occlusionTexture,opacityTexture:e.opacityTexture,specularGlossinessTexture:e.specularGlossinessTexture},a=t.addFolder(n[e.name]?`${e.name}_${n[e.name]+1}`:e.name);if(n[e.name]=null==n[e.name]?1:n[e.name]+1,e instanceof Hn){const t=a.addFolder("金属模式");t.add(e,"metallicFactor",0,1).step(.01),t.add(e,"roughnessFactor",0,1).step(.01),t.add(i,"metallicRoughnessTexture",["None","origin",...Object.keys(this.textures)]).onChange((t=>{e.metallicRoughnessTexture="None"===t?null:this.textures[t]||r.metallicRoughnessTexture})),t.open()}else if(e instanceof jn){const t=a.addFolder("高光模式");t.add(e,"glossinessFactor",0,1).step(.01),t.addColor(i,"specularColor").onChange((t=>{hc.guiToColor(t,e.specularColor)})),t.add(i,"specularGlossinessTexture",["None","origin",...Object.keys(this.textures)]).onChange((t=>{e.specularGlossinessTexture="None"===t?null:this.textures[t]||r.specularGlossinessTexture})),t.open()}const o=a.addFolder("通用");o.add(e,"envMapIntensity",0,2).step(.01),o.add(e,"opacity",0,1).step(.01).onChange((e=>i.baseColor[3]=e)),o.add(e,"isTransparent"),o.add(e,"alphaCutoff",0,1).step(.01),o.add(e,"getOpacityFromRGB"),o.addColor(i,"baseColor").onChange((t=>{hc.guiToColor(t,e.baseColor)})).listen(),o.addColor(i,"emissiveColor").onChange((t=>{hc.guiToColor(t,e.emissiveColor)})),o.add(i,"baseTexture",["None","origin",...Object.keys(this.textures)]).onChange((t=>{e.baseTexture="None"===t?null:this.textures[t]||r.baseTexture})),o.add(i,"normalTexture",["None","origin",...Object.keys(this.textures)]).onChange((t=>{e.normalTexture="None"===t?null:this.textures[t]||r.normalTexture})),o.add(i,"emissiveTexture",["None","origin",...Object.keys(this.textures)]).onChange((t=>{e.emissiveTexture="None"===t?null:this.textures[t]||r.emissiveTexture})),o.add(i,"occlusionTexture",["None","origin",...Object.keys(this.textures)]).onChange((t=>{e.occlusionTexture="None"===t?null:this.textures[t]||r.occlusionTexture})),o.add(i,"opacityTexture",["None","origin",...Object.keys(this.textures)]).onChange((t=>{e.opacityTexture="None"===t?null:this.textures[t]||r.opacityTexture})),o.open()})),t.open()}loadAnimationGUI(e){if(this.animationFolder&&(this.gui.removeFolder(this.animationFolder),this.animationFolder=null),null==e?void 0:e.length){this.animationFolder=this.gui.addFolder("Animation"),this.animationFolder.open();const t=this.gltfRootEntity.getComponent(fa);t.playAnimationClip(e[0].name);const n={animation:e[0].name};this.animationFolder.add(n,"animation",["None",...e.map((e=>e.name))]).onChange((e=>{"None"===e?t.stop(!0):t.playAnimationClip(e)}))}}}new hc;
